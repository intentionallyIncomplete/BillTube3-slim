BTFW.define("feature:player",["feature:layout"],async ({}) =>{const PLAYER_SELECTOR = "#videowrap .video-js";const DEFAULT_SKIN_CLASS = "vjs-default-skin";const CITY_THEME_CLASS = "vjs-theme-city";const BIG_PLAY_CLASS = "vjs-big-play-centered";const INLINE_VIDEO_SELECTORS = [ "#videowrap video","#ytapiplayer video","#videowrap .video-js video","#videowrap .video-js .vjs-tech" ].join(",");const INLINE_VIDEO_ATTRIBUTES ={playsinline:"","webkit-playsinline":"","x5-video-player-type":"h5","x5-video-player-fullscreen":"false","x5-video-orientation":"portrait"};const BASE_STYLES_LINK_ID = "btfw-videojs-base-css";const CITY_STYLES_LINK_ID = "btfw-videojs-city-css";const BASE_STYLES_URLS = ["https://vjs.zencdn.net/7.20.3/video-js.css"];const CITY_STYLES_URLS = [ "https://cdn.jsdelivr.net/npm/@videojs/themes@1/dist/city/index.css","https://unpkg.com/@videojs/themes@1/dist/city/index.css" ];function ensureStylesheet(id,urls){const doc = document;if (!doc || !doc.head) return;if (doc.getElementById(id)) return;const link = doc.createElement("link");link.id = id;link.rel = "stylesheet";const sources = Array.isArray(urls) ? urls.slice():[urls];const tryNext = () =>{if (!sources.length) return false;const href = sources.shift();if (!href) return tryNext();link.href = href;return true;};link.addEventListener("error",() =>{if (tryNext()) return;link.remove();});if (tryNext()){doc.head.appendChild(link);}}function baseStylesActive(){if (typeof window === "undefined" || !document.body) return false;const probe = document.createElement("div");probe.className = `video-js ${DEFAULT_SKIN_CLASS}`;probe.style.position = "absolute";probe.style.opacity = "0";probe.style.pointerEvents = "none";probe.style.width = "1px";probe.style.height = "1px";document.body.appendChild(probe);const fontSize = window.getComputedStyle(probe).fontSize;probe.remove();return fontSize && Math.abs(parseFloat(fontSize) - 10) < 0.2;}function ensureBaseStylesheet(){if (baseStylesActive()) return;const existing = document.querySelector( 'link[href*="video-js"],link[href*="videojs"],style[data-vjs-styles]' );if (existing) return;ensureStylesheet(BASE_STYLES_LINK_ID,BASE_STYLES_URLS);}function ensureCityStylesheet(){const existing = document.querySelector( 'link[href*="videojs" i][href*="city" i],link[href*="@videojs/themes" i][href*="city" i]' );if (existing) return;ensureStylesheet(CITY_STYLES_LINK_ID,CITY_STYLES_URLS);}function applyCityTheme(){ensureBaseStylesheet();ensureCityStylesheet();document.querySelectorAll(PLAYER_SELECTOR).forEach((player) =>{if (player.classList.contains(DEFAULT_SKIN_CLASS)){player.classList.remove(DEFAULT_SKIN_CLASS);}Array.from(player.classList).forEach((cls) =>{if (cls.startsWith("vjs-theme-") && cls !== CITY_THEME_CLASS){player.classList.remove(cls);}});if (!player.classList.contains(CITY_THEME_CLASS)){player.classList.add(CITY_THEME_CLASS);}if (!player.classList.contains(BIG_PLAY_CLASS)){player.classList.add(BIG_PLAY_CLASS);}});}function applyPosterUrl(){if (typeof window === "undefined") return;const posterUrl = window.BTFW?.channelPosterUrl;if (!posterUrl) return;document.querySelectorAll(PLAYER_SELECTOR).forEach(player =>{// Set the poster attribute on the video element if (player.poster !== posterUrl){player.poster = posterUrl;}// Update VideoJS poster component if it exists try{const vjsPlayer = player.player || player.player_ || (window.videojs && window.videojs.players && window.videojs.players[player.id]);if (vjsPlayer && typeof vjsPlayer.poster === "function"){vjsPlayer.poster(posterUrl);}}catch (_){// Fallback:manually update the poster div const posterDiv = player.querySelector('.vjs-poster');if (posterDiv){posterDiv.style.backgroundImage = `url("${posterUrl}")`;}}});}function togglePosterVisibility(){if (typeof window === "undefined") return;// Check if we have a global PLAYER object like in billtube2 const mediaType = window.PLAYER?.mediaType;const posterElements = document.querySelectorAll('.vjs-poster');posterElements.forEach(poster =>{// Hide poster for embedded video platforms (they have their own thumbnails) if (mediaType === 'yt' || mediaType === 'dm' || mediaType === 'vi' || mediaType === 'tw'){poster.classList.add('hidden');}else{// Show poster for direct files (fi),Google Drive (gd),and other media poster.classList.remove('hidden');}});}function ensureInlinePlayback(){const nodes = document.querySelectorAll(INLINE_VIDEO_SELECTORS);nodes.forEach((node) =>{if (!(node instanceof HTMLVideoElement)) return;if (typeof node.playsInline === "boolean"){node.playsInline = true;}Object.entries(INLINE_VIDEO_ATTRIBUTES).forEach(([attr,value]) =>{try{node.setAttribute(attr,value);}catch (_){}});});}function patchVideojsTextContent(){if (typeof window === "undefined") return false;const vjs = window.videojs;if (!vjs) return false;const dom = vjs.dom || vjs;if (!dom || typeof dom.textContent !== "function") return false;if (dom.textContent && dom.textContent._btfwOptimized) return true;const original = dom.textContent.bind(dom);const patched = function patchedTextContent(el,text){if (!el) return el;let currentValue;try{if (typeof el.textContent !== "undefined"){currentValue = el.textContent;}else if (typeof el.innerText !== "undefined"){currentValue = el.innerText;}}catch (_){currentValue = undefined;}if (currentValue !== undefined){const nextValue = text === null || text === undefined ? "":String(text);if (currentValue === nextValue){return el;}}return original(el,text);};patched._btfwOptimized = true;patched._btfwOriginal = original;dom.textContent = patched;return true;}function ensureTextContentPatch(){if (patchVideojsTextContent()){ensureTextContentPatch._tries = 0;return;}if (ensureTextContentPatch._tries > 20) return;ensureTextContentPatch._tries = (ensureTextContentPatch._tries || 0) + 1;setTimeout(ensureTextContentPatch,250);}const GUARD_MARK = "_btfwGuarded";function shouldAllowClick(target){if (!target) return false;const allowSelectors = [ ".vjs-control-bar",".vjs-control",".vjs-menu",".vjs-menu-content",".vjs-slider",".vjs-volume-panel",".vjs-text-track-settings",".vjs-tech .alert",".vjs-tech [role=\"alert\"]",".vjs-tech [role=\"dialog\"]",".vjs-tech .modal",".vjs-tech .modal-dialog" ].join(",");if (target.closest(allowSelectors)){return true;}return false;}function attachGuardsTo(el){if (!el || el[GUARD_MARK]) return;el[GUARD_MARK] = true;const block = (e) =>{if (shouldAllowClick(e.target)) return;if (e.type === "click" && e.button !== 0) return;e.preventDefault();e.stopImmediatePropagation();};el.addEventListener("click",block,true);el.addEventListener("pointerdown",(e) =>{if (!shouldAllowClick(e.target)){e.preventDefault();e.stopImmediatePropagation();}},true);el.addEventListener("contextmenu",block,true);}function attachGuards(){document.querySelectorAll(PLAYER_SELECTOR).forEach(attachGuardsTo);}function watchPlayerMount(){if (watchPlayerMount._mo) return;const target = document.getElementById("videowrap") || document.body;const mo = new MutationObserver((mutations) =>{let shouldReact = false;for (const mutation of mutations){for (const node of mutation.addedNodes){if (node.nodeType === 1 && (node.classList?.contains('video-js') || node.tagName === 'VIDEO' || node.tagName === 'IFRAME' || node.querySelector?.(PLAYER_SELECTOR))){shouldReact = true;break;}}for (const node of mutation.removedNodes){if (node.nodeType === 1 && (node.classList?.contains('video-js') || node.tagName === 'VIDEO' || node.tagName === 'IFRAME')){shouldReact = true;break;}}}if (shouldReact){applyCityTheme();attachGuards();ensureInlinePlayback();applyPosterUrl();togglePosterVisibility();}});mo.observe(target,{childList:true,subtree:true,characterData:false});watchPlayerMount._mo = mo;}function handleVideoChange(){setTimeout(() =>{ensureInlinePlayback();applyPosterUrl();togglePosterVisibility();},100);}function boot(){applyCityTheme();attachGuards();ensureInlinePlayback();ensureTextContentPatch();applyPosterUrl();togglePosterVisibility();watchPlayerMount();// Periodic check like billtube2.js setInterval(() =>{togglePosterVisibility();},1000);if (typeof window !== "undefined" && window.socket && typeof socket.on === "function"){try{if (typeof socket.off === "function"){socket.off("changeMedia",handleVideoChange);}socket.on("changeMedia",handleVideoChange);}catch (err){console.warn("[feature:player] Unable to bind changeMedia handler",err);}}}if (document.readyState === "loading"){document.addEventListener("DOMContentLoaded",boot);}else{boot();}document.addEventListener("btfw:layoutReady",() => setTimeout(boot,0));return{name:"feature:player",applyCityTheme,attachGuards,ensureInlinePlayback,applyPosterUrl,togglePosterVisibility};});BTFW.define("feature:stack",["feature:layout"],async ({}) =>{const SKEY="btfw-stack-order";const PLAYLIST_VISIBILITY_KEY = "btfw-stack-playlist-open";let compactSpacing = true;// Define what should be grouped together const GROUPS = [{id:"motd-group",title:"Message of the Day",selectors:["#motdwrap","#motdrow","#motd","#announcements"],priority:1},{id:"playlist-group",title:"Playlist",selectors:["#playlistrow","#playlistwrap","#queuecontainer","#queue"],priority:2},{id:"channels-group",title:"Featured Channels",selectors:["#btfw-channels"],priority:3},{id:"poll-group",title:"Polls & Voting",selectors:["#pollwrap","#btfw-poll-parking","#btfw-poll-history"],priority:4}];// Skip these - they're either empty or handled elsewhere const SKIP_SELECTORS = ["#main","#mainpage","#mainpane"];const ADD_MEDIA_SECTIONS = [{id:"addfromurl",title:"From URL",default:true},{id:"searchcontrol",title:"Library & YouTube"},{id:"customembed",title:"Custom embed"}];function ensureAddMediaUI(mainContainer,controlsBar,actionsCluster){if (!mainContainer || !controlsBar || !actionsCluster) return null;const available = ADD_MEDIA_SECTIONS.map(cfg =>{const el = document.getElementById(cfg.id);if (!el) return null;return{...cfg,el};}).filter(Boolean);if (!available.length){const existingPanel = document.getElementById("btfw-addmedia-panel");if (existingPanel) existingPanel.remove();return null;}let panel = document.getElementById("btfw-addmedia-panel");if (!panel){panel = document.createElement("section");panel.id = "btfw-addmedia-panel";panel.className = "btfw-addmedia-panel";panel.dataset.open = "false";panel.setAttribute("role","region");panel.setAttribute("aria-label","Add media controls");panel.setAttribute("aria-hidden","true");panel.setAttribute("hidden","hidden");panel.innerHTML = ` <div class="btfw-addmedia-panel__inner"> <header class="btfw-addmedia-panel__header"> <nav class="btfw-addmedia-tabs" role="tablist"></nav> <button type="button" class="btfw-addmedia-close" aria-label="Close add media"> <span aria-hidden="true">&times;</span> </button> </header> <div class="btfw-addmedia-panel__body"> <div class="btfw-addmedia-views"></div> <p class="btfw-addmedia-help">Queue media by URL,browse your library,or embed custom players without leaving the playlist.</p> </div> </div> `;}if (panel.parentElement !== mainContainer){const anchor = controlsBar.parentElement === mainContainer ? controlsBar.nextSibling:null;mainContainer.insertBefore(panel,anchor);}const tabs = panel.querySelector(".btfw-addmedia-tabs");const viewsHost = panel.querySelector(".btfw-addmedia-views");const closeBtn = panel.querySelector(".btfw-addmedia-close");if (!tabs || !viewsHost) return null;while (tabs.firstChild) tabs.removeChild(tabs.firstChild);while (viewsHost.firstChild) viewsHost.removeChild(viewsHost.firstChild);available.forEach(({id,title,el}) =>{el.classList.remove("collapse","in","plcontrol-collapse");el.style.removeProperty("display");el.style.removeProperty("height");el.removeAttribute("aria-expanded");el.setAttribute("role","tabpanel");el.setAttribute("data-btfw-addmedia","panel");const tab = document.createElement("button");tab.type = "button";tab.className = "btfw-addmedia-tab";tab.dataset.target = id;tab.textContent = title;tab.setAttribute("role","tab");tabs.appendChild(tab);const view = document.createElement("div");view.className = "btfw-addmedia-view";view.dataset.target = id;view.setAttribute("role","tabpanel");view.setAttribute("aria-hidden","true");view.appendChild(el);viewsHost.appendChild(view);});const defaultSection = available.find(sec => sec.default) || available[0];const setActive = (targetId) =>{const activeId = targetId || panel.dataset.active || defaultSection.id;panel.dataset.active = activeId;tabs.querySelectorAll(".btfw-addmedia-tab").forEach(tab =>{const match = tab.dataset.target === activeId;tab.classList.toggle("is-active",match);tab.setAttribute("aria-selected",match ? "true":"false");tab.setAttribute("tabindex",match ? "0":"-1");});viewsHost.querySelectorAll(".btfw-addmedia-view").forEach(view =>{const match = view.dataset.target === activeId;view.classList.toggle("is-active",match);view.setAttribute("aria-hidden",match ? "false":"true");});};const toggle = (force) =>{const open = force != null ? !!force:panel.dataset.open !== "true";panel.dataset.open = open ? "true":"false";panel.classList.toggle("is-open",open);panel.setAttribute("aria-hidden",open ? "false":"true");if (open){panel.removeAttribute("hidden");setActive(panel.dataset.active || defaultSection.id);}else{panel.setAttribute("hidden","hidden");}panel.dispatchEvent(new CustomEvent("btfw:addmedia:state",{detail:{open}}));return open;};if (!panel._btfwWired){tabs.addEventListener("click",(ev) =>{const btn = ev.target.closest(".btfw-addmedia-tab");if (!btn) return;ev.preventDefault();setActive(btn.dataset.target);});if (closeBtn){closeBtn.addEventListener("click",() => toggle(false));}panel._btfwWired = true;}setActive(panel.dataset.active || defaultSection.id);panel._btfwToggle = toggle;panel._btfwSetActive = setActive;const wireLegacyTriggers = () =>{const triggers = [{id:"showsearch",target:"searchcontrol"},{id:"showcustomembed",target:"customembed"}];triggers.forEach(({id,target}) =>{const btn = document.getElementById(id);if (!btn) return;if (btn.dataset.btfwAddmedia === target) return;btn.dataset.btfwAddmedia = target;btn.setAttribute("aria-controls","btfw-addmedia-panel");btn.addEventListener("click",(ev) =>{ev.preventDefault();ev.stopPropagation();setActive(target);toggle(true);btn.blur();});});};wireLegacyTriggers();return{panel,toggle,setActive};}function applyCompactSpacing(enabled){const stack = document.getElementById("btfw-stack");if (!stack) return;const want = !!enabled;stack.classList.toggle("btfw-stack--compact",want);stack.querySelectorAll(".btfw-stack-list").forEach(list =>{list.classList.toggle("btfw-stack-list--compact",want);});}function ensureStack(){const left=document.getElementById("btfw-leftpad");if(!left) return null;let stack=document.getElementById("btfw-stack");if(!stack){stack=document.createElement("div");stack.id="btfw-stack";stack.className="btfw-stack";const v=document.getElementById("videowrap");if(v&&v.nextSibling) v.parentNode.insertBefore(stack,v.nextSibling);else left.appendChild(stack);// Just create the list - no header with "Page Modules" const list=document.createElement("div");list.className="btfw-stack-list";stack.appendChild(list);const footer=document.createElement("div");footer.id="btfw-stack-footer";footer.className="btfw-stack-footer";stack.appendChild(footer);}applyCompactSpacing(compactSpacing);return{list:stack.querySelector(".btfw-stack-list"),footer:stack.querySelector("#btfw-stack-footer")};}// function normalizeId(el){// if(!el) return null;// if(!el.id) el.id="stackitem-"+Math.random().toString(36).slice(2,7);// return el.id;//}// function titleOf(el){// return el.getAttribute("data-title")||el.getAttribute("title")||el.id;//}function mergeMotdElements(){const motdwrap = document.getElementById("motdwrap");const motdrow = document.getElementById("motdrow");const motd = document.getElementById("motd");if (!motdwrap && !motdrow) return;// Use motdwrap as the main container,or create it let container = motdwrap;if (!container && motdrow){container = motdrow;container.id = "motdwrap";}// Merge motd content into container (avoid circular reference) if (motd && container && !container.contains(motd) && !motd.contains(container)){// Move motd's content directly into container while (motd.firstChild){container.appendChild(motd.firstChild);}motd.remove();}// Ensure the merged container still exposes an element with id="motd" if (container && !container.querySelector("#motd")){const host = document.createElement("div");host.id = "motd";while (container.firstChild){host.appendChild(container.firstChild);}container.appendChild(host);}// Remove duplicate motdrow if we're using motdwrap (avoid circular reference) if (motdwrap && motdrow && motdrow !== motdwrap && !motdwrap.contains(motdrow) && !motdrow.contains(motdwrap)){while (motdrow.firstChild){motdwrap.appendChild(motdrow.firstChild);}motdrow.remove();}}function mergePlaylistControls(){const controlsRow = document.getElementById("controlsrow");const rightControls = document.getElementById("rightcontrols");const plBar = document.getElementById("btfw-plbar");const playlistWrap = document.getElementById("playlistwrap");const queueContainer = document.getElementById("queuecontainer");const playlistRow = document.getElementById("playlistrow");const stackPlaylist = document.querySelector('#btfw-stack .btfw-stack-item[data-bind="playlist-group"] .btfw-stack-item__body');// Find any floating controls row (legacy CyTube layout) const controlsRows = document.querySelectorAll(".btfw-controls-row");// Find the main playlist container let mainContainer = playlistRow || playlistWrap || queueContainer || stackPlaylist;if (!mainContainer) return;// Create or enhance the playlist bar let controlsBar = plBar;if (!controlsBar){controlsBar = document.createElement("div");controlsBar.id = "btfw-plbar";controlsBar.className = "btfw-plbar";}else{controlsBar.classList.add("btfw-plbar");}// Build a modern layout scaffold once let layout = controlsBar.querySelector(".btfw-plbar__layout");let primary;// search + playlist tools let aside;// playlist actions from rightcontrols if (!layout){layout = document.createElement("div");layout.className = "btfw-plbar__layout";primary = document.createElement("div");primary.className = "btfw-plbar__primary";aside = document.createElement("div");aside.className = "btfw-plbar__aside";layout.append(primary,aside);while (controlsBar.firstChild){primary.appendChild(controlsBar.firstChild);}controlsBar.appendChild(layout);const searchBlock = primary.querySelector(".field.has-addons");if (searchBlock) searchBlock.classList.add("btfw-plbar__search");const countBadge = primary.querySelector("#btfw-pl-count");if (countBadge){countBadge.classList.add("btfw-plbar__count");aside.appendChild(countBadge);}}else{primary = layout.querySelector(".btfw-plbar__primary") || layout;aside = layout.querySelector(".btfw-plbar__aside") || layout;}// Drop legacy controls that conflict with the modern bar controlsBar.querySelectorAll("#showmediaurl,#btfw-pl-poll").forEach(btn => btn.remove());// Ensure we have an actions cluster for playlist controls let actionsCluster = controlsBar.querySelector(".btfw-plbar__actions");if (!actionsCluster){actionsCluster = document.createElement("div");actionsCluster.className = "btfw-plbar__actions";(aside || controlsBar).appendChild(actionsCluster);}let addMediaBtn = document.getElementById("btfw-addmedia-btn");const styleActionButton = (btn) =>{if (!btn) return;btn.classList.add("btfw-plbar__action-btn");if (btn.tagName === "BUTTON" || btn.tagName === "A"){btn.classList.add("button","is-dark","is-small");}else if (btn.tagName === "INPUT"){const type = (btn.type || "").toLowerCase();if (type === "button" || type === "submit" || type === "reset"){btn.classList.add("button","is-dark","is-small");}else{btn.classList.remove("button","is-dark","is-small");}}};if (controlsBar.parentElement !== mainContainer){mainContainer.insertBefore(controlsBar,mainContainer.firstChild);}const addMedia = ensureAddMediaUI(mainContainer,controlsBar,actionsCluster);if (addMedia){if (!addMediaBtn || !document.body.contains(addMediaBtn)){addMediaBtn = document.createElement("button");addMediaBtn.id = "btfw-addmedia-btn";addMediaBtn.type = "button";addMediaBtn.className = "button is-small";addMediaBtn.innerHTML = `<i class="fa fa-plus"></i><span>Add media</span>`;actionsCluster.prepend(addMediaBtn);}else if (!actionsCluster.contains(addMediaBtn)){actionsCluster.prepend(addMediaBtn);}}else if (addMediaBtn){if (addMediaBtn.parentElement) addMediaBtn.parentElement.removeChild(addMediaBtn);addMediaBtn = null;}const moveControls = (root) =>{if (!root) return;const elements = Array.from(root.children || []);elements.forEach(el =>{if (!el) return;el.classList.add("btfw-plbar__control");actionsCluster.appendChild(el);});};// Move rightcontrols buttons into the enhanced bar if (rightControls){moveControls(rightControls);rightControls.remove();}// Move any remaining legacy controls into the bar if (controlsRow){moveControls(controlsRow);controlsRow.remove();}actionsCluster.querySelectorAll("button,a.btn,input[type=button],input[type=submit],input[type=reset],select").forEach(styleActionButton);if (addMedia && addMediaBtn){addMediaBtn.classList.remove("is-dark");addMediaBtn.classList.add("is-primary");if (!addMediaBtn.dataset.iconified){addMediaBtn.innerHTML = `<i class="fa fa-plus"></i><span>Add media</span>`;addMediaBtn.dataset.iconified = "1";}addMediaBtn.setAttribute("aria-controls","btfw-addmedia-panel");const syncState = (open) =>{addMediaBtn.setAttribute("aria-expanded",open ? "true":"false");};if (!addMediaBtn.dataset.btfwBound){addMediaBtn.dataset.btfwBound = "1";addMediaBtn.addEventListener("click",(ev) =>{ev.preventDefault();const panel = document.getElementById("btfw-addmedia-panel");const toggleFn = panel && panel._btfwToggle;const open = typeof toggleFn === "function" ? toggleFn():false;syncState(open);});}const panel = addMedia.panel || document.getElementById("btfw-addmedia-panel");if (panel){syncState(panel.dataset.open === "true");if (!panel._btfwButtonSync){panel.addEventListener("btfw:addmedia:state",(ev) =>{syncState(!!(ev.detail && ev.detail.open));});panel._btfwButtonSync = true;}}}// Move any floating controls rows into the playlist container controlsRows.forEach(row =>{if (row && !mainContainer.contains(row)){row.style.cssText += ` margin-top:8px;position:relative !important;bottom:auto !important;left:auto !important;right:auto !important;width:auto !important;`;row.remove();mainContainer.appendChild(row);console.log('[stack] Moved floating controls row into playlist container');}});// Hide the legacy controls row if it no longer contains useful content // Ensure the bar is at the top of the playlist container if (!mainContainer.contains(controlsBar)){mainContainer.insertBefore(controlsBar,mainContainer.firstChild);}}function createGroupItem(group,elements){// Special handling for MOTD group if (group.id === "motd-group"){mergeMotdElements();// Re-get the element after merging elements = [document.getElementById("motdwrap")].filter(Boolean);}// Special handling for playlist group if (group.id === "playlist-group"){mergePlaylistControls();// Re-get elements after merging elements = elements.filter(el => el && el.id !== "rightcontrols");// rightcontrols is now merged}// âœ… FIX:Allow channels-group to be created even with zero elements (slider will be added later) if (group.id !== "channels-group" && elements.length === 0) return null;// Filter out any elements that are already in the stack to avoid circular references const stackList = document.querySelector("#btfw-stack .btfw-stack-list");if (stackList){elements = elements.filter(el => el && !stackList.contains(el) && !el.contains(stackList));}// Continue creating the wrapper even if elements is empty (for channels-group) const wrapper = document.createElement("section");wrapper.className = "btfw-stack-item btfw-group-item";wrapper.dataset.bind = group.id;wrapper.dataset.group = "true";const header = document.createElement("header");header.className = "btfw-stack-item__header";header.innerHTML = ` <span class="btfw-stack-item__title">${group.title}</span> <span class="btfw-stack-arrows"> <button class="btfw-arrow btfw-up">â†‘</button> <button class="btfw-arrow btfw-down">â†“</button> </span> `;const body = document.createElement("div");body.className = "btfw-stack-item__body btfw-group-body";// Add all elements to this group with safety checks elements.forEach(el =>{if (el && el.parentElement !== body && !body.contains(el) && !el.contains(body)){try{body.appendChild(el);}catch (error){console.warn('[stack] Failed to move element:',el.id || el.className,error);}}});wrapper.appendChild(header);wrapper.appendChild(body);if (group.id === "playlist-group"){const storedVisibility = getStoredPlaylistVisibility();if (!wrapper.hasAttribute("data-open")){const shouldOpen = storedVisibility !== null ? storedVisibility:true;wrapper.dataset.open = shouldOpen ? "true":"false";}wrapper.classList.toggle("is-open",wrapper.dataset.open !== "false");const arrows = header.querySelector(".btfw-stack-arrows");if (arrows && !arrows.querySelector(".btfw-playlist-toggle")){const toggleBtn = document.createElement("button");toggleBtn.type = "button";toggleBtn.className = "btfw-arrow btfw-playlist-toggle";toggleBtn.setAttribute("aria-label","Toggle playlist visibility");toggleBtn.style.display = "flex";toggleBtn.style.alignItems = "center";toggleBtn.style.justifyContent = "center";const updateToggle = () =>{const isOpen = wrapper.dataset.open !== "false";toggleBtn.textContent = isOpen ? "ðŸ‘ï¸":"ðŸ‘ï¸â€ðŸ—¨ï¸";toggleBtn.title = isOpen ? "Hide playlist (improves performance)":"Show playlist";toggleBtn.setAttribute("aria-expanded",isOpen ? "true":"false");wrapper.classList.toggle("is-open",isOpen);};const setOpenState = (open,options ={}) =>{const isOpen = !!open;wrapper.dataset.open = isOpen ? "true":"false";updateToggle();if (options.persist !== false){storePlaylistVisibility(isOpen);}};toggleBtn.addEventListener("click",(ev) =>{ev.preventDefault();ev.stopPropagation();const currentlyOpen = wrapper.dataset.open !== "false";setOpenState(!currentlyOpen);console.log("[Playlist Toggle]",currentlyOpen ? "Collapsed":"Expanded");});if (storedVisibility !== null){setOpenState(storedVisibility,{persist:false});}else{updateToggle();}const observer = new MutationObserver((mutations) =>{for (const mutation of mutations){if (mutation.type === "attributes"){updateToggle();storePlaylistVisibility(wrapper.dataset.open !== "false");}}});observer.observe(wrapper,{attributes:true,attributeFilter:["data-open"]});arrows.appendChild(toggleBtn);}}// Wire up/down buttons wrapper.querySelector(".btfw-up").onclick = function(){const p = wrapper.parentElement;const prev = wrapper.previousElementSibling;if(prev) p.insertBefore(wrapper,prev);save(p);};wrapper.querySelector(".btfw-down").onclick = function(){const p = wrapper.parentElement;const next = wrapper.nextElementSibling;if(next) p.insertBefore(next,wrapper);else p.appendChild(wrapper);save(p);};return wrapper;}function save(list){try{const items = Array.from(list.children).map(n => ({id:n.dataset.bind,isGroup:n.dataset.group === "true"}));localStorage.setItem(SKEY,JSON.stringify(items));}catch(e){}}function load(){try{return JSON.parse(localStorage.getItem(SKEY)||"[]");}catch(e){return [];}}function getStoredPlaylistVisibility(){try{const stored = localStorage.getItem(PLAYLIST_VISIBILITY_KEY);if (stored === null) return null;return stored === "true";}catch(e){return null;}}function storePlaylistVisibility(isOpen){try{localStorage.setItem(PLAYLIST_VISIBILITY_KEY,isOpen ? "true":"false");}catch(e){}}function attachFooter(footer){if (!footer) return;if (footer.querySelector("#btfw-footer")) return;const themed = document.getElementById("btfw-footer");if (themed && themed !== footer && !footer.contains(themed)){footer.innerHTML = "";footer.appendChild(themed);return;}const real=document.getElementById("footer")||document.querySelector("footer");if(real && !footer.contains(real)){real.classList.add("btfw-footer");footer.innerHTML="";footer.appendChild(real);}}function movePollButton(){// Move poll button from leftcontrols to pollwrap const leftControls = document.getElementById("leftcontrols");const pollWrap = document.getElementById("pollwrap");if (leftControls && pollWrap){// Find poll-related buttons const pollButtons = leftControls.querySelectorAll('button[onclick*="poll"],button[title*="poll"],.poll-btn,#newpollbtn');pollButtons.forEach(btn =>{// Create a container if pollwrap doesn't have one let btnContainer = pollWrap.querySelector('.poll-controls');if (!btnContainer){btnContainer = document.createElement('div');btnContainer.className = 'poll-controls';btnContainer.style.cssText = 'margin-bottom:8px;padding:4px;display:flex;gap:6px;';pollWrap.insertBefore(btnContainer,pollWrap.firstChild);}// Style the button to match the theme btn.classList.add('button','is-small','is-link');btnContainer.appendChild(btn);});// Remove leftcontrols if it's empty if (leftControls.children.length === 0){leftControls.remove();}}}function populate(refs){const list = refs.list;const footer = refs.footer;// Move poll button first movePollButton();// Group elements const groupedElements = new Map();// Process groups with better safety checks GROUPS.forEach(group =>{const elements = [];group.selectors.forEach(sel =>{const el = document.querySelector(sel);if (!el) return;if (list.contains(el) || el.contains(list)) return;if (SKIP_SELECTORS.includes(sel)) return;if (sel === "#pollwrap"){const overlayState = el.dataset && el.dataset.btfwPollOverlay;const attrState = el.getAttribute && el.getAttribute("data-btfw-poll-overlay");if (overlayState === "video" || attrState === "video"){return;}}elements.push(el);});// âœ… FIX:Always create channels-group if slider is enabled,even if #btfw-channels doesn't exist yet if (group.id === "channels-group" && elements.length === 0){// Check if channel slider is enabled via multiple possible sources const btfw = window.BTFW ||{};// Check modern config paths let sliderEnabled = btfw.channelSliderEnabled || (btfw.channelSlider && btfw.channelSlider.enabled) || (btfw.channelTheme && btfw.channelTheme.slider && btfw.channelTheme.slider.enabled);// Also check legacy global variables (for backwards compatibility) if (typeof sliderEnabled === 'undefined' && typeof window.UI_ChannelList !== 'undefined'){sliderEnabled = window.UI_ChannelList === '1' || window.UI_ChannelList === 1;}// If we found a URL but no explicit enabled flag,assume enabled if (!sliderEnabled){const hasUrl = btfw.channelSliderJSON || (btfw.channelSlider && btfw.channelSlider.feedUrl) || (btfw.channelTheme && btfw.channelTheme.slider && btfw.channelTheme.slider.feedUrl) || window.Channel_JSON;if (hasUrl) sliderEnabled = true;}if (sliderEnabled){// Don't skip this group - allow it to be created with zero elements // The channel slider will be added to it later via placeSliderInStack() groupedElements.set(group.id,{group,elements:[]});return;// Continue to next group}}if (elements.length > 0){groupedElements.set(group.id,{group,elements});}});// Create items by priority/order const savedOrder = load();const itemsToAdd = [];// Add groups groupedElements.forEach(({group,elements},groupId) =>{const existingItem = Array.from(list.children).find(n => n.dataset.bind === groupId);if (!existingItem){try{const groupItem = createGroupItem(group,elements);if (groupItem){itemsToAdd.push({item:groupItem,id:groupId,priority:group.priority,isGroup:true});}}catch (error){console.warn('[stack] Failed to create group item:',groupId,error);}}});// Sort by saved order,then by priority if (savedOrder.length > 0){itemsToAdd.sort((a,b) =>{const aIndex = savedOrder.findIndex(s => s.id === a.id);const bIndex = savedOrder.findIndex(s => s.id === b.id);if (aIndex >= 0 && bIndex >= 0) return aIndex - bIndex;if (aIndex >= 0) return -1;if (bIndex >= 0) return 1;return a.priority - b.priority;});}else{itemsToAdd.sort((a,b) => a.priority - b.priority);}// Add items to list with safety checks itemsToAdd.forEach(({item}) =>{try{if (item && !list.contains(item) && !item.contains(list)){list.appendChild(item);}}catch (error){console.warn('[stack] Failed to add item to list:',error);}});applyCompactSpacing(compactSpacing);save(list);attachFooter(footer);}function setCompactSpacing(enabled){compactSpacing = !!enabled;applyCompactSpacing(compactSpacing);}function getCompactSpacing(){return compactSpacing;}function boot(){const refs=ensureStack();if(!refs) return;populate(refs);const observer=new MutationObserver(()=>populate(refs));const leftpad = document.getElementById('btfw-leftpad');const main = document.getElementById('main');if (leftpad){observer.observe(leftpad,{childList:true,subtree:false});}if (main){observer.observe(main,{childList:true,subtree:false});}setTimeout(() =>{const playlistGroup = document.querySelector('.btfw-stack-item[data-bind="playlist-group"]');if (!playlistGroup) return;const storedVisibility = getStoredPlaylistVisibility();const shouldBeOpen = storedVisibility !== null ? storedVisibility:true;playlistGroup.dataset.open = shouldBeOpen ? 'true':'false';playlistGroup.classList.toggle('is-open',shouldBeOpen);},1000);let n=0;const iv=setInterval(()=>{populate(refs);if(++n>8) clearInterval(iv);},700);}document.addEventListener("btfw:layoutReady",boot);setTimeout(boot,1200);document.addEventListener("btfw:channelThemeTint",() =>{const refs = ensureStack();if (refs){setTimeout(() => populate(refs),100);}});document.addEventListener("btfw:layout:orientation",() =>{requestAnimationFrame(() => applyCompactSpacing(compactSpacing));});document.addEventListener("btfw:stack:compactChanged",(ev) =>{if (ev && ev.detail && "enabled" in ev.detail){setCompactSpacing(!!ev.detail.enabled);}else{applyCompactSpacing(compactSpacing);}});return{name:"feature:stack",setCompactSpacing,getCompactSpacing};});BTFW.define("feature:videoOverlay",[],async () =>{const $ = (selector,root = document) => root.querySelector(selector);const CONTROL_SELECTORS = [ "#mediarefresh","#voteskip","#fullscreenbtn" ];const LS ={localSubs:"btfw:video:localsubs"};const DEFAULT_OWNER_RANK = 5;// Cytube owners default to rank 5 when CHANNEL perms are unavailable const PERMISSION_KEYS ={owner:["chanowner","owner","founder","admin","administrator"]};function getMediaType(){try{return window.PLAYER?.mediaType || null;}catch (_){return null;}}function isDirectMedia(){const type = (getMediaType() || "").toLowerCase();return type === "fi" || type === "gd";}function getClient(){try{return window.CLIENT || window.client || null;}catch (_){return null;}}function getChannel(){try{return window.CHANNEL || window.channel || null;}catch (_){return null;}}function getChannelPermissions(){const channel = getChannel();if (channel && typeof channel.perms === "object" && channel.perms){return channel.perms;}try{return window.CHANNEL_PERMS || window.channelPermissions ||{};}catch (_){return{};}}function getPermissionThreshold(keys = []){const perms = getChannelPermissions();for (const key of keys){const value = perms?.[key];if (typeof value === "number") return value;}return undefined;}function getOwnerRankThreshold(){const ownerRank = getPermissionThreshold(PERMISSION_KEYS.owner);return typeof ownerRank === "number" ? ownerRank:DEFAULT_OWNER_RANK;}function hasOwnerPermission(client){if (!client) return false;try{if (typeof client.hasPermission === "function" && client.hasPermission("chanowner")){return true;}}catch (_){}try{if (typeof window.hasPermission === "function" && window.hasPermission("chanowner")){return true;}}catch (_){}return false;}function isChannelOwner(){const client = getClient();if (!client) return false;const rank = Number(client.rank);if (!Number.isFinite(rank)) return false;if (rank >= getOwnerRankThreshold()) return true;if (hasOwnerPermission(client)) return true;return false;}const localSubsEnabled = () =>{try{return localStorage.getItem(LS.localSubs) !== "0";}catch (_){return true;}};const setLocalSubs = (value) =>{try{localStorage.setItem(LS.localSubs,value ? "1":"0");}catch (_){}document.dispatchEvent( new CustomEvent("btfw:video:localsubs:changed",{detail:{enabled:!!value}}) );};let refreshClickCount = 0;let refreshCooldownUntil = 0;let lastRefreshTimestamp = 0;const USER_REFRESH_INTERVAL = 2000;const AUTO_REFRESH_BASE_INTERVAL = 8000;const AUTO_REFRESH_MAX_INTERVAL = 45000;const AUTO_IDLE_RESET_INTERVAL = 120000;let autoRefreshInterval = AUTO_REFRESH_BASE_INTERVAL;let airplayListenerAttached = false;let trackedAirplayVideo = null;function ensureCSS(){if ($("#btfw-vo-css")) return;const st = document.createElement("style");st.id = "btfw-vo-css";st.textContent = ` #btfw-video-overlay{position:absolute;inset:0;pointer-events:none;z-index:1000;opacity:0;transition:opacity 0.3s ease;background:linear-gradient(to bottom,rgba(0,0,0,0.95) 0%,rgba(0,0,0,0.15) 12%,rgba(0,0,0,0) 32%,rgba(0,0,0,0) 55%,transparent 75%);}#btfw-video-overlay.btfw-vo-visible{opacity:1;}#btfw-video-overlay .btfw-vo-bar{position:absolute;right:12px;top:12px;left:12px;display:flex;gap:8px;pointer-events:auto;background:transparent;}#btfw-video-overlay .btfw-vo-section{display:flex;align-items:center;gap:8px;pointer-events:auto;}#btfw-video-overlay .btfw-vo-section--right{margin-left:auto;}#btfw-video-overlay .btfw-vo-btn,#btfw-video-overlay .btfw-vo-adopted{all:unset;box-sizing:border-box;display:inline-grid;place-items:center;min-width:44px;height:44px;padding:0;border-radius:22px;border:0;background:rgba(0,0,0,0.42);color:#fff;cursor:pointer;font:600 14px/1.05 "Inter","Segoe UI",system-ui,-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,sans-serif;letter-spacing:0.01em;backdrop-filter:blur(12px) saturate(120%);box-shadow:0 2px 8px rgba(0,0,0,0.18);transition:all 0.2s cubic-bezier(0.4,0,0.2,1);text-decoration:none;}#btfw-video-overlay .btfw-vo-btn i,#btfw-video-overlay .btfw-vo-adopted i{transition:transform 0.2s ease;font-size:16px;}#btfw-video-overlay .btfw-vo-btn:hover,#btfw-video-overlay .btfw-vo-adopted:hover{background:rgba(109,77,246,0.82);transform:translateY(-1px);box-shadow:0 4px 16px rgba(109,77,246,0.36);}#btfw-video-overlay .btfw-vo-btn:hover i,#btfw-video-overlay .btfw-vo-adopted:hover i{transform:scale(1.08);}#btfw-video-overlay .btfw-vo-btn:active,#btfw-video-overlay .btfw-vo-adopted:active{transform:translateY(0);}#btfw-video-overlay .btfw-vo-btn:focus-visible,#btfw-video-overlay .btfw-vo-adopted:focus-visible{outline:2px solid rgba(109,77,246,0.95);outline-offset:2px;}.btfw-notification{position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:12px;color:#ffffff;font-size:14px;font-weight:500;z-index:10000;transform:translateX(100%);opacity:0;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);backdrop-filter:blur(12px) saturate(120%);box-shadow:0 4px 20px rgba(0,0,0,0.2);max-width:300px;}.btfw-notification--show{transform:translateX(0);opacity:1;}.btfw-notification--success{background:rgba(34,197,94,0.9);border:1px solid rgba(34,197,94,0.3);}.btfw-notification--error{background:rgba(239,68,68,0.9);border:1px solid rgba(239,68,68,0.3);}.btfw-notification--warning{background:rgba(245,158,11,0.9);border:1px solid rgba(245,158,11,0.3);}.btfw-notification--info{background:rgba(59,130,246,0.9);border:1px solid rgba(59,130,246,0.3);}#btfw-mini-toast{position:fixed;right:12px;bottom:12px;background:#111a;color:#fff;padding:8px 12px;border-radius:8px;font:12px/1.2 system-ui,Segoe UI,Arial;z-index:99999;pointer-events:none;opacity:0;transition:opacity .2s}@media (max-width:768px){#btfw-video-overlay .btfw-vo-bar{top:8px;right:8px;left:8px;gap:6px;}#btfw-video-overlay .btfw-vo-section{gap:6px;flex-wrap:wrap;}#btfw-video-overlay .btfw-vo-btn,#btfw-video-overlay .btfw-vo-adopted{min-width:40px;height:40px;border-radius:20px;font-size:12px;}}`;document.head.appendChild(st);}function ensureOverlay(){const wrap = $("#videowrap");if (!wrap) return null;let overlay = $("#btfw-video-overlay");if (!overlay){overlay = document.createElement("div");overlay.id = "btfw-video-overlay";}overlay.classList.add("btfw-video-overlay");if (overlay.parentElement !== wrap) wrap.appendChild(overlay);let bar = overlay.querySelector("#btfw-vo-bar");if (!bar){bar = document.createElement("div");bar.className = "btfw-vo-bar";bar.id = "btfw-vo-bar";overlay.appendChild(bar);}const sections = ensureOverlaySections(overlay,bar);setupHoverEffects(wrap,overlay);ensureLocalSubsButton(sections.left);ensureCustomButtons(sections);adoptNativeControls(sections);restyleOverlayButtons(overlay);return overlay;}function restyleOverlayButtons(overlay){if (!overlay) return;overlay .querySelectorAll("button") .forEach((btn) =>{if (!btn.classList.contains("btfw-vo-btn")){btn.classList.add("btfw-vo-btn");}});}function ensureOverlaySections(overlay,bar){const leftId = "btfw-vo-left";const rightId = "btfw-vo-right";let left = bar.querySelector(`#${leftId}`);if (!left){left = document.createElement("div");left.id = leftId;left.className = "btfw-vo-section btfw-vo-section--left";bar.insertBefore(left,bar.firstChild);}let right = bar.querySelector(`#${rightId}`);if (!right){right = document.createElement("div");right.id = rightId;right.className = "btfw-vo-section btfw-vo-section--right";bar.appendChild(right);}Array.from(bar.children).forEach((child) =>{if (child === left || child === right) return;right.appendChild(child);});overlay.dataset.leftSection = `#${leftId}`;overlay.dataset.rightSection = `#${rightId}`;bar.dataset.leftSection = `#${leftId}`;bar.dataset.rightSection = `#${rightId}`;return{left,right};}function getAirplayCandidate(){return document.querySelector("#ytapiplayer video,video");}function hasAirplaySupport(video = getAirplayCandidate()){if (!video) return false;return ( typeof window.WebKitPlaybackTargetAvailabilityEvent !== "undefined" || typeof video.webkitShowPlaybackTargetPicker === "function" );}function unbindAirplayAvailability(){if (!trackedAirplayVideo) return;const handler = trackedAirplayVideo._btfwAirplayHandler;if (handler){try{trackedAirplayVideo.removeEventListener("webkitplaybacktargetavailabilitychanged",handler);}catch (_){}delete trackedAirplayVideo._btfwAirplayHandler;}trackedAirplayVideo = null;}function bindAirplayAvailability(video){if (!video || typeof video.addEventListener !== "function"){unbindAirplayAvailability();return;}if (trackedAirplayVideo === video) return;unbindAirplayAvailability();const handler = (event) =>{const available = !event || event.availability === "available";const btn = $("#btfw-airplay");if (!btn) return;btn.style.display = available ? "":"none";};try{video.addEventListener("webkitplaybacktargetavailabilitychanged",handler);video._btfwAirplayHandler = handler;trackedAirplayVideo = video;}catch (_){}}function updateAirplayButtonVisibility(){const btn = $("#btfw-airplay");if (!btn) return;const video = getAirplayCandidate();const supported = hasAirplaySupport(video);if (!supported){btn.style.display = "none";unbindAirplayAvailability();return;}btn.style.display = "";bindAirplayAvailability(video);}function setupHoverEffects(videowrap,overlay){if (overlay._hoverSetup) return;overlay._hoverSetup = true;let hideTimer = null;function showOverlay(){clearTimeout(hideTimer);overlay.classList.add("btfw-vo-visible");overlay.style.pointerEvents = "none";}function hideOverlay(){overlay.classList.remove("btfw-vo-visible");}function scheduleHide(){clearTimeout(hideTimer);hideTimer = setTimeout(hideOverlay,3000);}videowrap.addEventListener("mouseenter",showOverlay);videowrap.addEventListener("mousemove",() =>{showOverlay();scheduleHide();});videowrap.addEventListener("mouseleave",hideOverlay);overlay.addEventListener("mouseenter",() =>{clearTimeout(hideTimer);showOverlay();});overlay.addEventListener("mouseleave",scheduleHide);}function ensureCustomButtons(sections){if (!sections?.right || !sections?.left) return;const customButtons = [];if (!document.querySelector("#fullscreenbtn")){customButtons.push({id:"btfw-fullscreen",icon:"fas fa-expand",tooltip:"Fullscreen",action:toggleFullscreen,section:"right"});}customButtons.push({id:"btfw-airplay",icon:"fas fa-cast",tooltip:"AirPlay",action:enableAirplay,section:"right"});customButtons.forEach((btnConfig) =>{let btn = document.querySelector(`#${btnConfig.id}`);const target = btnConfig.section === "left" ? sections.left:sections.right;if (!btn){btn = document.createElement("button");btn.id = btnConfig.id;btn.className = "btfw-vo-btn";btn.innerHTML = `<i class="${btnConfig.icon}"></i>`;btn.title = btnConfig.tooltip;btn.addEventListener("click",btnConfig.action);(target || sections.right).appendChild(btn);}else if (target && btn.parentElement !== target){target.appendChild(btn);}});updateAirplayButtonVisibility();}function adoptNativeControls(sections){const targetSection = sections?.right;if (!targetSection) return;CONTROL_SELECTORS.forEach((selector) =>{const el = document.querySelector(selector);if (!el) return;if (el.dataset.btfwOverlay === "1"){if (el.parentElement !== targetSection) targetSection.appendChild(el);return;}const placeholder = document.createElement("span");placeholder.hidden = true;placeholder.setAttribute("data-btfw-ph",selector);try{el.insertAdjacentElement("afterend",placeholder);}catch (_){}el.classList.add("btfw-vo-adopted");el.dataset.btfwOverlay = "1";if (el.id === "mediarefresh"){const original = el.onclick;el.onclick = (event) =>{event.preventDefault();const isUserAction = !!(event && event.isTrusted);handleMediaRefresh(() =>{if (typeof original === "function"){try{original.call(el,event);return true;}catch (err){console.warn("[video-overlay] native refresh handler failed:",err);}}return false;},{isUserAction});};}targetSection.appendChild(el);});}function emitNativeRefresh(){try{if (window.socket){socket.emit("playerReady");return true;}}catch (e){console.warn("[video-overlay] Media refresh failed:",e);}return false;}function handleMediaRefresh(triggerOriginal,options ={}){const{isUserAction = false}= options;const now = Date.now();if (lastRefreshTimestamp && now - lastRefreshTimestamp > AUTO_IDLE_RESET_INTERVAL){autoRefreshInterval = AUTO_REFRESH_BASE_INTERVAL;refreshClickCount = 0;}if (now < refreshCooldownUntil){const remainingSeconds = Math.ceil((refreshCooldownUntil - now) / 1000);showNotification( isUserAction ? `Refresh available in ${remainingSeconds}s`:`Auto refresh paused. Next attempt in ${remainingSeconds}s`,"warning" );return false;}const minInterval = isUserAction ? USER_REFRESH_INTERVAL:autoRefreshInterval;if (lastRefreshTimestamp && now - lastRefreshTimestamp < minInterval){const waitMs = minInterval - (now - lastRefreshTimestamp);const waitSeconds = Math.ceil(waitMs / 1000);refreshCooldownUntil = now + waitMs;showNotification( isUserAction ? `Refresh available in ${waitSeconds}s`:`Auto refresh paused. Next attempt in ${waitSeconds}s`,"warning" );return false;}refreshClickCount++;if (refreshClickCount >= 10){refreshCooldownUntil = now + 30000;refreshClickCount = 0;showNotification("Refresh limit reached. 30s cooldown active.","error");return false;}const decayMs = isUserAction ? 6000:Math.max(12000,autoRefreshInterval + 2000);setTimeout(() =>{if (refreshClickCount > 0) refreshClickCount--;},decayMs);let handled = false;if (typeof triggerOriginal === "function"){try{handled = triggerOriginal() === true;}catch (err){console.warn("[video-overlay] Refresh handler error:",err);}}if (!handled){handled = emitNativeRefresh();}lastRefreshTimestamp = Date.now();if (isUserAction){autoRefreshInterval = AUTO_REFRESH_BASE_INTERVAL;}else{const multiplier = handled ? 1.25:1.5;autoRefreshInterval = Math.min( AUTO_REFRESH_MAX_INTERVAL,Math.max(AUTO_REFRESH_BASE_INTERVAL,Math.round(autoRefreshInterval * multiplier)) );}const nextWindow = isUserAction ? USER_REFRESH_INTERVAL:autoRefreshInterval;refreshCooldownUntil = Math.max(refreshCooldownUntil,lastRefreshTimestamp + nextWindow);if (!isUserAction && handled){showNotification( `Auto refresh sent. Next attempt in ${Math.ceil(autoRefreshInterval / 1000)}s`,"info" );}else{showNotification( handled ? "Media refreshed":"Unable to refresh media",handled ? "success":"error" );}return handled;}function toggleFullscreen(){const videowrap = $("#videowrap");if (!videowrap) return;if (!document.fullscreenElement){if (videowrap.requestFullscreen){videowrap.requestFullscreen();}else if (videowrap.webkitRequestFullscreen){videowrap.webkitRequestFullscreen();}else if (videowrap.mozRequestFullScreen){videowrap.mozRequestFullScreen();}}else{if (document.exitFullscreen){document.exitFullscreen();}else if (document.webkitExitFullscreen){document.webkitExitFullscreen();}else if (document.mozCancelFullScreen){document.mozCancelFullScreen();}}}function applyAirplayAttributes(video,showPicker = true){if (!video || !hasAirplaySupport(video)) return false;video.setAttribute("airplay","allow");video.setAttribute("x-webkit-airplay","allow");if (showPicker && typeof video.webkitShowPlaybackTargetPicker === "function"){try{video.webkitShowPlaybackTargetPicker();}catch (err){console.warn("[video-overlay] AirPlay picker failed:",err);}}updateAirplayButtonVisibility();return true;}function attachAirplayListener(){if (airplayListenerAttached || !window.socket) return;airplayListenerAttached = true;try{socket.on("changeMedia",() =>{setTimeout(() =>{const video = getAirplayCandidate();if (video){applyAirplayAttributes(video,false);bindAirplayAvailability(video);}updateAirplayButtonVisibility();},1000);});}catch (err){console.warn("[video-overlay] Failed to attach AirPlay listener:",err);}}function enableAirplay(){const video = getAirplayCandidate();if (!hasAirplaySupport(video)){updateAirplayButtonVisibility();showNotification("AirPlay not available","warning");return false;}if (applyAirplayAttributes(video)){showNotification("AirPlay enabled","success");attachAirplayListener();return true;}showNotification("AirPlay not available","warning");return false;}function showNotification(message,type = "info"){let notification = document.getElementById("btfw-notification");if (!notification){notification = document.createElement("div");notification.id = "btfw-notification";notification.className = "btfw-notification";document.body.appendChild(notification);}notification.textContent = message;notification.className = `btfw-notification btfw-notification--${type}btfw-notification--show`;clearTimeout(notification._hideTimer);notification._hideTimer = setTimeout(() =>{notification.classList.remove("btfw-notification--show");},3000);}function getHTML5Video(){return $("video");}function srtToVtt(text){let s = (text || "").replace(/\r\n/g,"\n").trim() + "\n";s = s.replace(/^\d+\s*$\n/gm,"");s = s.replace(/(\d{2}:\d{2}:\d{2}),(\d{3})/g,"$1.$2");s = s.replace(/(\d{2}:\d{2}:\d{2}\.\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2}\.\d{3})/g,"$1 --> $2");return "WEBVTT\n\n" + s;}async function pickLocalSubs(){const video = getHTML5Video();if (!video){toast("Local subs only for HTML5 sources.");return;}const inp = document.createElement("input");inp.type = "file";inp.accept = ".vtt,.srt,text/vtt,text/plain";inp.style.display = "none";document.body.appendChild(inp);const done = new Promise((resolve) =>{inp.addEventListener( "change",async () =>{const f = inp.files && inp.files[0];document.body.removeChild(inp);if (!f) return resolve(false);try{const txt = await f.text();const ext = (f.name.split(".").pop() || "").toLowerCase();const vtt = ext === "srt" ? srtToVtt(txt):txt.startsWith("WEBVTT") ? txt:"WEBVTT\n\n" + txt;const url = URL.createObjectURL(new Blob([vtt],{type:"text/vtt"}));attachTrack(video,url,f.name.replace(/\.[^.]+$/,"") || "Local");toast("Subtitles loaded.");resolve(true);}catch (e){console.error(e);toast("Failed to load subtitles.");resolve(false);}},{once:true});});inp.click();await done;}function attachTrack(video,url,label){$("track[data-btfw=\"1\"]",video)?.remove();const tr = document.createElement("track");tr.kind = "subtitles";tr.label = label || "Local";tr.srclang = "en";tr.src = url;tr.default = true;tr.setAttribute("data-btfw","1");video.appendChild(tr);try{for (const t of video.textTracks) t.mode = t.label === tr.label ? "showing":"disabled";}catch (_){}}function toast(msg){let t = $("#btfw-mini-toast");if (!t){t = document.createElement("div");t.id = "btfw-mini-toast";document.body.appendChild(t);}t.textContent = msg;t.style.opacity = "1";clearTimeout(t._hid);t._hid = setTimeout(() => (t.style.opacity = "0"),1400);}function ensureLocalSubsButton(section){if (!section) return;let btn = document.querySelector("#btfw-vo-subs");if (!btn){btn = document.createElement("button");btn.id = "btfw-vo-subs";btn.className = "btfw-vo-btn";btn.title = "Load local subtitles (.vtt/.srt)";btn.innerHTML = `<i class="fa fa-closed-captioning"></i>`;btn.addEventListener("click",(e) =>{e.preventDefault();pickLocalSubs();});section.insertBefore(btn,section.firstChild || null);}const enabled = localSubsEnabled() && isDirectMedia();btn.style.display = enabled ? "":"none";}function boot(){ensureCSS();ensureOverlay();const targets = [ $("#videowrap"),$("#rightcontrols"),$("#leftcontrols"),document.body ].filter(Boolean);const mo = new MutationObserver(() => ensureOverlay());targets.forEach((target) => mo.observe(target,{childList:true,subtree:true}));document.addEventListener("btfw:video:localsubs:changed",() => ensureOverlay());try{if (window.socket && typeof socket.on === "function"){socket.on("changeMedia",() =>{setTimeout(() => ensureOverlay(),0);});}}catch (_){}}if (document.readyState === "loading") document.addEventListener("DOMContentLoaded",boot);else boot();return{name:"feature:videoOverlay",setLocalSubsEnabled:setLocalSubs,toggleFullscreen,enableAirplay};});BTFW.define("feature:videoEnhancements",[],async () =>{// Title length CSS variable handling function updateTitleLength(){const titleElements = document.querySelectorAll("#currenttitle,.current-title");titleElements.forEach(el =>{const text = (el.textContent || el.innerText || "").trim();el.style.setProperty("--length",text.length);});}// Remove the fullscreen button if present function removeVjsFullscreenButton(){const fullscreenBtn = document.querySelector(".vjs-fullscreen-control");if (fullscreenBtn){fullscreenBtn.remove();}}// Hide the quality button when there are no real options function handleQualityButton(){const qualityBtn = document.querySelector(".vjs-resolution-button");if (!qualityBtn) return;const qualityMenu = qualityBtn.querySelector(".vjs-menu");if (!qualityMenu){qualityBtn.style.display = "none";return;}const menuItems = qualityMenu.querySelectorAll(".vjs-menu-item");if (menuItems.length <= 1){qualityBtn.style.display = "none";}}// Ensure the fullscreen button is hidden via CSS as a fallback function ensureFullscreenCss(){if (document.getElementById("btfw-video-enhancements-style")) return;const style = document.createElement("style");style.id = "btfw-video-enhancements-style";style.textContent = ` .vjs-fullscreen-control{display:none !important;}`;document.head.appendChild(style);}// Try to remove fullscreen controls and hide unused quality options function tryHideQuality(){removeVjsFullscreenButton();handleQualityButton();}// Media URL processing and title extraction function processMediaUrl(urlInput){if (!urlInput || !urlInput.value) return;let url = urlInput.value.trim();if (!url) return;// Dropbox URL transformation url = url.replace("//www.dropbox.com/s/","//dl.dropbox.com/s/") .replace("?dl=0","") .replace("?a=view","");urlInput.value = url;// Auto-title extraction setTimeout(() =>{const titleInput = document.querySelector("#addfromurl-title-val,#mediaurl-title,.media-title-input");if (titleInput && !titleInput.value.trim()){try{const decodedUrl = decodeURI(url);const pathParts = decodedUrl.split("/");const filename = pathParts[pathParts.length - 1];const nameParts = filename.split("?")[0].split(".");// Build title from filename parts (exclude extension) let title = "";for (let i = 0;i < nameParts.length - 1;i++){title += nameParts[i] + (i < nameParts.length - 2 ? ".":"");}// Clean up title title = title.replace(/[._-]/g," ") .replace(/\s+/g," ") .trim();if (title){titleInput.value = title;}}catch (err){console.warn("[video-enhancements] Title extraction failed:",err);}}},100);}// Setup media URL processing function bindMediaUrlProcessing(){const urlInputs = document.querySelectorAll("#mediaurl,.media-url-input");urlInputs.forEach(input =>{if (input._btfwUrlBound) return;input._btfwUrlBound = true;input.addEventListener("paste",() =>{setTimeout(() => processMediaUrl(input),50);});input.addEventListener("input",() =>{setTimeout(() => processMediaUrl(input),50);});});}// changeMedia event handler function handleChangeMedia(){setTimeout(() =>{updateTitleLength();},100);setTimeout(tryHideQuality,500);setTimeout(tryHideQuality,1000);setTimeout(tryHideQuality,2000);}// Initialize function boot(){// Initial setup updateTitleLength();bindMediaUrlProcessing();ensureFullscreenCss();tryHideQuality();setTimeout(tryHideQuality,500);setTimeout(tryHideQuality,1000);setTimeout(tryHideQuality,2000);// Bind to changeMedia event if (window.socket){try{socket.on("changeMedia",handleChangeMedia);}catch (err){console.warn("[video-enhancements] Failed to bind changeMedia:",err);}}// Watch for DOM changes to rebind URL processing const observer = new MutationObserver(() =>{bindMediaUrlProcessing();});observer.observe(document.body,{childList:true,subtree:true});}if (document.readyState === "loading"){document.addEventListener("DOMContentLoaded",boot);}else{boot();}return{name:"feature:videoEnhancements",updateTitleLength:updateTitleLength};});BTFW.define("feature:ambient",[],async () =>{// const STORAGE_KEY = "btfw:ambient:enabled";const $ = (selector,root = document) => root.querySelector(selector);function getMediaType(){try{return window.PLAYER?.mediaType || null;}catch (_){return null;}}function isDirectMedia(){const type = (getMediaType() || "").toLowerCase();return type === "fi" || type === "gd";}let active = false;let wrap = null;let monitorTimer = null;let currentVideo = null;let glowVideo = null;let glowContainer = null;let waitForWrapPromise = null;let socketListenerAttached = false;let syncHandler = null;function ensureCSS(){if (document.getElementById("btfw-ambient-css")) return;const st = document.createElement("style");st.id = "btfw-ambient-css";st.textContent = ` .btfw-ambient-glow-bg{position:fixed;pointer-events:none;z-index:-1;opacity:0;transition:opacity 0.6s ease;will-change:opacity;mix-blend-mode:screen;}.btfw-ambient-glow-bg.btfw-ambient-active{opacity:1;}.btfw-ambient-glow-bg video{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(1.3);width:100%;height:100%;object-fit:cover;filter:blur(clamp(60px,8vw,90px)) saturate(280%) brightness(1.8) contrast(1.3);opacity:1;}body.btfw-ambient-active #main,body.btfw-ambient-active #videowrap,body.btfw-ambient-active #chatwrap{position:relative;z-index:2;}body.btfw-ambient-active,html[data-btfw-theme] body.btfw-ambient-active{background-color:color-mix(in srgb,var(--btfw-theme-bg,#13030c) 40%,transparent) !important;}body.btfw-ambient-active #main,body.btfw-ambient-active #chatwrap,body.btfw-ambient-active #videowrap,body.btfw-ambient-active .panel,body.btfw-ambient-active #userlist,body.btfw-ambient-active #messagebuffer,body.btfw-ambient-active #chatline{background-color:color-mix(in srgb,var(--btfw-theme-bg) 40%,transparent) !important;}body.btfw-ambient-active #chatwrap,body.btfw-ambient-active #userlist{background-color:color-mix(in srgb,var(--btfw-theme-surface) 40%,transparent) !important;}body.btfw-ambient-active .panel-heading,body.btfw-ambient-active .panel-body{background-color:color-mix(in srgb,var(--btfw-theme-panel) 40%,transparent) !important;}#videowrap.btfw-ambient-ready{isolation:isolate;}@media (max-width:768px){.btfw-ambient-glow-bg video{transform:translate(-50%,-50%) scale(1.2);filter:blur(clamp(50px,10vw,70px)) saturate(260%) brightness(1.7) contrast(1.25);opacity:0.95;}}`;document.head.appendChild(st);}// function removeCSS(){// const st = document.getElementById("btfw-ambient-css");// if (st && st.parentNode){// st.parentNode.removeChild(st);//}//}function waitForWrap(timeout = 5000){if (waitForWrapPromise) return waitForWrapPromise;const immediate = $("#videowrap");if (immediate) return Promise.resolve(immediate);waitForWrapPromise = new Promise((resolve) =>{if (!document.body){resolve(null);return;}const deadline = Date.now() + timeout;const observer = new MutationObserver(() =>{const found = $("#videowrap");if (found){observer.disconnect();waitForWrapPromise = null;resolve(found);}else if (Date.now() > deadline){observer.disconnect();waitForWrapPromise = null;resolve(null);}});observer.observe(document.body,{childList:true,subtree:true});setTimeout(() =>{observer.disconnect();waitForWrapPromise = null;resolve($("#videowrap"));},timeout);});return waitForWrapPromise;}function ensureAmbientRoot(preferredWrap = null){const nextWrap = preferredWrap || $("#videowrap");if (!nextWrap) return null;if (wrap && wrap !== nextWrap){wrap.classList.remove("btfw-ambient-ready");wrap = null;}wrap = nextWrap;// Add ready class when enabling if (active){wrap.classList.add("btfw-ambient-ready");}return wrap;}// function getStoredPreference(){// // Always return false - don't remember state between sessions // return false;//}// function setStoredPreference(value){// // Don't store preference - always start disabled // return;//}function findVideoElement(){return $("#ytapiplayer video") || $("#videowrap video") || document.querySelector("video");}function cleanupGlowElements(){// Remove from DOM completely const existingGlow = document.querySelector(".btfw-ambient-glow-bg");if (existingGlow && existingGlow.parentNode){existingGlow.parentNode.removeChild(existingGlow);}glowContainer = null;glowVideo = null;}function createGlowElements(){// Always clean up first to prevent duplicates cleanupGlowElements();if (!wrap) return;const videoElement = findVideoElement();if (!videoElement) return;// Create glow container on body for full page glow glowContainer = document.createElement("div");glowContainer.className = "btfw-ambient-glow-bg";glowContainer.setAttribute("aria-hidden","true");// Create cloned video for glow effect glowVideo = document.createElement("video");glowVideo.muted = true;glowVideo.playsInline = true;glowVideo.loop = true;glowVideo.preload = "auto";glowVideo.setAttribute("aria-hidden","true");glowVideo.controls = false;glowVideo.disablePictureInPicture = true;glowContainer.appendChild(glowVideo);document.body.appendChild(glowContainer);// Position and activate updateGlowPosition();if (active){glowContainer.classList.add("btfw-ambient-active");}}function updateGlowPosition(){if (!glowContainer || !wrap) return;const rect = wrap.getBoundingClientRect();const padding = 100;glowContainer.style.top = `${rect.top - padding}px`;glowContainer.style.left = `${rect.left - padding}px`;glowContainer.style.width = `${rect.width + padding * 2}px`;glowContainer.style.height = `${rect.height + padding * 2}px`;}function syncVideos(){if (!currentVideo || !glowVideo) return;try{const src = currentVideo.src || currentVideo.currentSrc;if (src && glowVideo.src !== src){glowVideo.src = src;}const timeDiff = Math.abs(currentVideo.currentTime - glowVideo.currentTime);if (timeDiff > 0.3){glowVideo.currentTime = currentVideo.currentTime;}if (!currentVideo.paused && glowVideo.paused){glowVideo.play().catch(() =>{});}else if (currentVideo.paused && !glowVideo.paused){glowVideo.pause();}}catch (_){}}function detachVideoListeners(){if (!currentVideo || !syncHandler) return;const events = ["loadeddata","play","pause","seeked","timeupdate","ended","emptied"];events.forEach((evt) =>{try{currentVideo.removeEventListener(evt,syncHandler);}catch (_){}});syncHandler = null;currentVideo = null;}function attachVideo(video){if (currentVideo === video) return;detachVideoListeners();currentVideo = video && video.tagName === "VIDEO" ? video:null;if (!currentVideo){return;}// Create glow elements if they don't exist if (!glowContainer){createGlowElements();}syncHandler = () => syncVideos();const events = ["loadeddata","play","pause","seeked","timeupdate"];events.forEach((evt) =>{try{currentVideo.addEventListener(evt,syncHandler);}catch (_){}});syncVideos();}function startMonitoring(){if (monitorTimer) return;monitorTimer = window.setInterval(() =>{if (!active) return;const wrapNow = $("#videowrap");if (!wrapNow){if (wrap && !wrap.isConnected){wrap.classList.remove("btfw-ambient-ready");wrap = null;}}else if (wrapNow !== wrap || !wrap || !wrap.classList.contains("btfw-ambient-ready")){ensureAmbientRoot(wrapNow);}const videoEl = findVideoElement();if (videoEl !== currentVideo){attachVideo(videoEl);}// Update glow position updateGlowPosition();},500);// Update position on scroll and resize const throttledUpdate = () =>{if (active) updateGlowPosition();};window.addEventListener('scroll',throttledUpdate,{passive:true});window.addEventListener('resize',throttledUpdate,{passive:true});wireSocketListener();}function stopMonitoring(){if (monitorTimer){clearInterval(monitorTimer);monitorTimer = null;}window.removeEventListener('scroll',updateGlowPosition);window.removeEventListener('resize',updateGlowPosition);detachVideoListeners();}function wireSocketListener(){if (socketListenerAttached) return;try{if (window.socket && typeof socket.on === "function"){socketListenerAttached = true;socket.on("changeMedia",() =>{if (!active) return;setTimeout(() =>{if (!active) return;if (!isDirectMedia()){disable();return;}ensureAmbientRoot();attachVideo(findVideoElement());},400);});}}catch (_){}}async function enable(){if (active) return true;if (!isDirectMedia()){console.warn("[ambient] Ambient mode requires direct media (fi/gd).");return false;}ensureCSS();const wrapEl = $("#videowrap") || (await waitForWrap());if (!wrapEl){console.warn("[ambient] Unable to locate #videowrap for ambient mode.");return false;}active = true;ensureAmbientRoot(wrapEl);// Add ambient class to body for background transparency document.body.classList.add("btfw-ambient-active");// Create glow and activate it const videoEl = findVideoElement();if (videoEl){createGlowElements();attachVideo(videoEl);}startMonitoring();dispatchState();return true;}async function disable(){if (!active) return true;active = false;// Remove ambient class from body document.body.classList.remove("btfw-ambient-active");if (wrap){wrap.classList.remove("btfw-ambient-ready");}// Remove glow with fade out if (glowContainer){glowContainer.classList.remove("btfw-ambient-active");setTimeout(() =>{cleanupGlowElements();},600);}stopMonitoring();dispatchState();return true;}async function toggle(){return (await (active ? disable():enable())) && active;}function refresh(){if (!active) return;ensureAmbientRoot();createGlowElements();attachVideo(findVideoElement());}function isActive(){return !!active;}function isSupported(){return true;}function dispatchState(){document.dispatchEvent( new CustomEvent("btfw:ambient:state",{detail:{active:!!active}}) );}function boot(){// Always start disabled - no memory of previous state // Feature will dispatch initial state as disabled dispatchState();}if (document.readyState === "loading"){document.addEventListener("DOMContentLoaded",boot);}else{boot();}return{name:"feature:ambient",enable,disable,toggle,refresh,isActive,isSupported};});BTFW.define("feature:pip",["feature:layout"],async ({}) =>{const KEY = "btfw:pip";function pref(){try{return localStorage.getItem(KEY)==="1";}catch(e){return !!window.BTFW_PIP;}}function setPref(v){try{localStorage.setItem(KEY,v ? "1":"0");}catch(e){}window.BTFW_PIP = !!v;document.dispatchEvent(new CustomEvent("btfw:pip:refresh"));}let io=null,originalParent=null,beforeNode=null;function ensureDock(){const chatcol=document.getElementById("btfw-chatcol");if(!chatcol) return null;let dock=document.getElementById("btfw-pip-dock");if(!dock){dock=document.createElement("div");dock.id="btfw-pip-dock";chatcol.prepend(dock);}return dock;}function toDock(){const video=document.getElementById("videowrap");if(!video) return;const dock=ensureDock();if(!dock) return;if(dock.contains(video)) return;originalParent=video.parentNode;beforeNode=video.nextSibling;dock.appendChild(video);video.classList.add("btfw-pip");}function toOriginal(){const video=document.getElementById("videowrap");if(!video) return;if(originalParent && !originalParent.contains(video)){if(beforeNode) originalParent.insertBefore(video,beforeNode);else originalParent.appendChild(video);}video.classList.remove("btfw-pip");}function start(){stop();const video=document.getElementById("videowrap");if(!video) return;io = new IntersectionObserver(entries =>{const e=entries[0];if(!e) return;if(e.intersectionRatio < 0.1) toDock();else toOriginal();},{threshold:[0,0.1,0.5,1]});io.observe(video);}function stop(){if(io){io.disconnect();io=null;}toOriginal();}document.addEventListener("btfw:pip:refresh",function(){if (pref()) start();else stop();});if (pref()) start();window.BTFW_setPiP = setPref;return{name:"feature:pip",set:setPref};});BTFW.define('feature:resize',[],async () => ({name:'feature:resize'}));// BTFW Audio Processing System - Combined Boost + Normalization + Reconnect-safe auto-reproxy watchdog (function(){'use strict';const INTERNAL_SET_GRACE_MS = 2000;// time window where changes are considered ours const WATCHDOG_TICK_MS = 800;// polling backup const REAPPLY_DEBOUNCE_MS = 800;// avoid rapid re-sets const TRUSTED_DOMAINS = [ 'cytube.billtube.workers.dev','billtube.workers.dev' ];function safeNow(){return Date.now();}window.BTFW_AUDIO ={audioContext:null,sourceNode:null,compressorNode:null,gainNode:null,player:null,// URL state originalSrc:null,proxiedSrc:null,isProxied:false,// Feature flags boostEnabled:false,normalizationEnabled:false,// Proxy and params CORS_PROXY:'https://vidprox.billtube.workers.dev/?url=',BOOST_MULTIPLIER:2.5,currentNormPreset:'youtube',// Watchdog state _watchdogInterval:null,_mutationObserver:null,_lastKnownSrc:null,_lastInternalSrcSetAt:0,_lastAutoReapplyAt:0,NORM_PRESETS:{gentle:{threshold:-12,knee:20,ratio:6,attack:0.01,release:0.5,label:'Gentle'},youtube:{threshold:-24,knee:30,ratio:12,attack:0.003,release:0.25,label:'YouTube'},aggressive:{threshold:-50,knee:40,ratio:12,attack:0.001,release:0.25,label:'Aggressive'}},// Core utilities _isTrusted(urlStr){try{const u = new URL(urlStr);return TRUSTED_DOMAINS.some(d => u.hostname === d);}catch{return false;}},_markInternalSrcSet(){this._lastInternalSrcSetAt = safeNow();},_isInsideInternalWindow(){return safeNow() - this._lastInternalSrcSetAt <= INTERNAL_SET_GRACE_MS;},_shouldForceProxy(){// We proxy iff any processing is on. (You can change this policy if you want Ã¢â‚¬Å“always proxyÃ¢â‚¬Â.) return this.boostEnabled || this.normalizationEnabled;},_same(a,b){// video.js may normalize encodings;compare decoded when proxied return String(a || '') === String(b || '');},disconnectChain(){if (this.sourceNode){try{this.sourceNode.disconnect();}catch (_){}}if (this.compressorNode){try{this.compressorNode.disconnect();}catch (_){}this.compressorNode = null;}if (this.gainNode){try{this.gainNode.disconnect();}catch (_){}this.gainNode = null;}},cleanup(){this.disconnectChain();if (this.audioContext && this.audioContext.state !== 'closed'){this.audioContext.close().catch(() =>{});this.audioContext = null;}this.sourceNode = null;if (this.player && this.player.tech_ && this.player.tech_.el_){this.player.tech_.el_.disableRemotePlayback = false;}this.stopWatchdog();},// Watchdog startWatchdog(){if (!this.player) return;this.stopWatchdog();const videoEl = this.player.tech_?.el?.() || this.player.tech_?.el_ || document.querySelector('#ytapiplayer video');// Mutation observer for attribute/src/source changes if (videoEl && typeof MutationObserver !== 'undefined'){this._mutationObserver = new MutationObserver(() =>{this._checkAndReapply('mutation');});this._mutationObserver.observe(videoEl,{attributes:true,attributeFilter:['src','crossorigin']});// Also observe <source> children swaps const sourceObserver = new MutationObserver(() =>{this._checkAndReapply('sources');});sourceObserver.observe(videoEl,{childList:true,subtree:true});// Save both;if one is null,it's fine this._mutationObserver._sourceObserver = sourceObserver;}// Video.js hooks that often fire on internal resets try{this.player.on('sourceset',() => this._checkAndReapply('sourceset'));this.player.on('loadstart',() => this._checkAndReapply('loadstart'));this.player.on('loadedmetadata',() => this._checkAndReapply('loadedmetadata'));this.player.on('stalled',() => this._checkAndReapply('stalled'));this.player.on('error',() => this._checkAndReapply('error'));}catch{}// Lightweight interval backup this._watchdogInterval = setInterval(() => this._checkAndReapply('interval'),WATCHDOG_TICK_MS);// Prime last known this._lastKnownSrc = this.player.currentSrc();},stopWatchdog(){if (this._watchdogInterval){clearInterval(this._watchdogInterval);this._watchdogInterval = null;}if (this._mutationObserver){try{this._mutationObserver.disconnect();}catch{}try{this._mutationObserver._sourceObserver?.disconnect();}catch{}this._mutationObserver = null;}},_checkAndReapply(reason){if (!this.player) return;const current = this.player.currentSrc();if (!current) return;this._lastKnownSrc = current;// If we intentionally set src recently,ignore if (this._isInsideInternalWindow()) return;// If it's already proxied (or trusted and we opted to allow),nothing to do const isAlreadyProxied = current.includes(this.CORS_PROXY);if (isAlreadyProxied){this.isProxied = true;this.proxiedSrc = current;return;}// Allow trusted domains to stay unproxied but ensure crossOrigin for processing if (this._isTrusted(current)){if (this._shouldForceProxy()){// For processing,trusted + crossOrigin is okay;just ensure CORS attribute try{this.player.crossOrigin('anonymous');}catch{}}this.isProxied = false;this.originalSrc = current;return;}// If processing is on and URL silently reverted -> reapply proxy if (this._shouldForceProxy()){const since = safeNow() - this._lastAutoReapplyAt;if (since < REAPPLY_DEBOUNCE_MS) return;this._lastAutoReapplyAt = safeNow();// console.log('[BTFW_AUDIO] Auto-reproxy due to',reason);this._forceProxyPreservingState(current);}},async _forceProxyPreservingState(currentSrc){// Preserve playstate/time and re-set proxied URL if (!this.player) return;const t = this.player.currentTime();const wasPlaying = !this.player.paused();this.originalSrc = currentSrc;this.proxiedSrc = this.CORS_PROXY + encodeURIComponent(currentSrc);try{this.player.pause();}catch{}try{this.player.crossOrigin('anonymous');}catch{}this._markInternalSrcSet();this.player.src({src:this.proxiedSrc,type:'video/mp4'});try{this.player.load();}catch{}const resume = () =>{try{this.player.currentTime(t);}catch{}this.isProxied = true;if (wasPlaying){this.player.play().catch(() =>{});}};if (typeof this.player.ready === 'function'){this.player.ready(resume);}else{setTimeout(resume,300);}},// Proxy/application helpers async ensureProxy(){if (!this.player) return false;const currentSrc = this.player.currentSrc();if (!currentSrc) return false;if (currentSrc.includes(this.CORS_PROXY)){this.isProxied = true;this.proxiedSrc = currentSrc;return true;}try{const url = new URL(currentSrc);if (this._isTrusted(currentSrc)){// Use trusted as-is but make sure crossOrigin is set for WebAudio const currentTime = this.player.currentTime();const wasPlaying = !this.player.paused();this.originalSrc = currentSrc;try{this.player.pause();}catch{}try{this.player.crossOrigin('anonymous');}catch{}this._markInternalSrcSet();this.player.src({src:currentSrc,type:'video/mp4'});try{this.player.load();}catch{}return new Promise((resolve) =>{this.player.ready(() =>{try{this.player.currentTime(currentTime);}catch{}this.isProxied = false;if (wasPlaying){this.player.play().catch(() =>{});}resolve(true);});});}}catch (e){console.warn('[BTFW_AUDIO] Invalid URL:',e);}// Fallback:force proxy return this._forceProxyPreservingState(currentSrc),true;},async rebuildAudioChain(){if (!this.player || !this.player.tech_ || !this.player.tech_.el_){console.error('[BTFW_AUDIO] Player not ready');return false;}if (this.boostEnabled || this.normalizationEnabled){if (!this.isProxied && !this._isTrusted(this.player.currentSrc())){await this.ensureProxy();}else{// Ensure CORS for trusted sources when processing try{this.player.crossOrigin('anonymous');}catch{}}}this.disconnectChain();try{if (!this.audioContext || this.audioContext.state === 'closed'){this.audioContext = new (window.AudioContext || window.webkitAudioContext)();}const videoEl = this.player.tech().el();if (this.player.tech_ && this.player.tech_.el_){this.player.tech_.el_.disableRemotePlayback = true;}if (!this.sourceNode){this.sourceNode = this.audioContext.createMediaElementSource(videoEl);}let currentNode = this.sourceNode;if (this.normalizationEnabled){this.compressorNode = this.audioContext.createDynamicsCompressor();const preset = this.NORM_PRESETS[this.currentNormPreset];this.compressorNode.threshold.setValueAtTime(preset.threshold,this.audioContext.currentTime);this.compressorNode.knee.setValueAtTime(preset.knee,this.audioContext.currentTime);this.compressorNode.ratio.setValueAtTime(preset.ratio,this.audioContext.currentTime);this.compressorNode.attack.setValueAtTime(preset.attack,this.audioContext.currentTime);this.compressorNode.release.setValueAtTime(preset.release,this.audioContext.currentTime);currentNode.connect(this.compressorNode);currentNode = this.compressorNode;}if (this.boostEnabled){this.gainNode = this.audioContext.createGain();this.gainNode.gain.value = this.BOOST_MULTIPLIER;currentNode.connect(this.gainNode);currentNode = this.gainNode;}currentNode.connect(this.audioContext.destination);// Make sure watchdog is active while processing is enabled this.startWatchdog();console.log('[BTFW_AUDIO] Chain rebuilt:',{normalization:this.normalizationEnabled,boost:this.boostEnabled,proxied:this.isProxied});return true;}catch (e){console.error('[BTFW_AUDIO] Error building audio chain:',e);this.cleanup();return false;}},// Public feature toggles async enableBoost(){this.boostEnabled = true;const ok = await this.rebuildAudioChain();if (ok) this.startWatchdog();return ok;},async disableBoost(){this.boostEnabled = false;if (this.normalizationEnabled){const ok = await this.rebuildAudioChain();if (!this._shouldForceProxy()) this.stopWatchdog();return ok;}else{this.cleanup();// If we forced proxy only because of boost,we can return to original if (this.originalSrc && this.isProxied){const currentTime = this.player.currentTime();const wasPlaying = !this.player.paused();try{this.player.pause();}catch{}try{this.player.crossOrigin(null);}catch{}this._markInternalSrcSet();this.player.src({src:this.originalSrc,type:'video/mp4'});try{this.player.load();}catch{}this.player.ready(() =>{try{this.player.currentTime(currentTime);}catch{}this.isProxied = false;if (wasPlaying){this.player.play().catch(() =>{});}});}return true;}},async enableNormalization(){this.normalizationEnabled = true;const ok = await this.rebuildAudioChain();if (ok) this.startWatchdog();return ok;},async setNormPreset(presetKey){if (!this.NORM_PRESETS[presetKey]) return false;this.currentNormPreset = presetKey;if (this.normalizationEnabled){return await this.rebuildAudioChain();}return true;},async setBoostMultiplier(multiplier){this.BOOST_MULTIPLIER = multiplier;if (this.boostEnabled){return await this.rebuildAudioChain();}return true;},async disableNormalization(){this.normalizationEnabled = false;if (this.boostEnabled){const ok = await this.rebuildAudioChain();if (!this._shouldForceProxy()) this.stopWatchdog();return ok;}else{this.cleanup();if (this.originalSrc && this.isProxied){const currentTime = this.player.currentTime();const wasPlaying = !this.player.paused();try{this.player.pause();}catch{}try{this.player.crossOrigin(null);}catch{}this._markInternalSrcSet();this.player.src({src:this.originalSrc,type:'video/mp4'});try{this.player.load();}catch{}this.player.ready(() =>{try{this.player.currentTime(currentTime);}catch{}this.isProxied = false;if (wasPlaying){this.player.play().catch(() =>{});}});}return true;}}};})();// Audio Boost Module (function(){'use strict';function waitForBTFW(callback){if (window.BTFW && typeof BTFW.define === 'function'){callback();}else{setTimeout(() => waitForBTFW(callback),100);}}waitForBTFW(function(){BTFW.define("feature:audioboost",[],async () =>{const $ = (selector,root = document) => root.querySelector(selector);const sharedAudio = window.BTFW_AUDIO;let boostButton = null;let shouldBoostAfterMediaChange = false;let contextMenu = null;const BOOST_PRESETS = [{multiplier:1.5,label:'150%'},{multiplier:2.5,label:'250%'},{multiplier:3.5,label:'350%'}];function updateButtonState(active){if (!boostButton) return;if (active){boostButton.classList.add('active');boostButton.style.background = 'rgba(46,213,115,0.3)';boostButton.style.borderColor = '#2ed573';boostButton.style.color = '#2ed573';boostButton.style.boxShadow = '0 0 12px rgba(46,213,115,0.6)';}else{boostButton.classList.remove('active');boostButton.style.background = '';boostButton.style.borderColor = '';boostButton.style.color = '';boostButton.style.boxShadow = '';}}function showToast(message,type = 'info'){let toast = $('#btfw-audioboost-toast');if (!toast){toast = document.createElement('div');toast.id = 'btfw-audioboost-toast';toast.style.cssText = ` position:fixed;top:20px;right:20px;background:${type === 'success' ? 'rgba(46,213,115,0.9)':'rgba(235,77,75,0.9)'};color:white;padding:12px 20px;border-radius:8px;font-size:14px;font-family:system-ui,-apple-system,sans-serif;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:10000;opacity:0;transition:opacity 0.3s ease;pointer-events:none;`;document.body.appendChild(toast);}toast.textContent = message;toast.style.background = type === 'success' ? 'rgba(46,213,115,0.9)':'rgba(235,77,75,0.9)';toast.style.opacity = '1';setTimeout(() =>{toast.style.opacity = '0';},2000);}async function activateAudioBoost(){const success = await sharedAudio.enableBoost();if (success){shouldBoostAfterMediaChange = true;const percentage = Math.round(sharedAudio.BOOST_MULTIPLIER * 100);showToast(`Boosted by ${percentage}%`,'success');updateButtonState(true);}else{showToast('Failed to activate boost','error');}}async function deactivateAudioBoost(){await sharedAudio.disableBoost();shouldBoostAfterMediaChange = false;updateButtonState(false);}function createButton(){const btn = document.createElement('button');btn.id = 'btfw-vo-audioboost';btn.className = 'btn btn-sm btn-default btfw-vo-adopted';const percentage = Math.round(sharedAudio.BOOST_MULTIPLIER * 100);btn.title = `Toggle Audio Boost (${percentage}%)`;btn.setAttribute('data-btfw-overlay','1');btn.innerHTML = '<i class="fa-solid fa-megaphone"></i>';btn.addEventListener('click',() =>{if (sharedAudio.boostEnabled){deactivateAudioBoost();}else{activateAudioBoost();}});btn.addEventListener('mouseenter',() => showContextMenu());btn.addEventListener('mouseleave',() =>{setTimeout(() =>{if (!contextMenu?.matches(':hover') && !btn.matches(':hover')){hideContextMenu();}},100);});return btn;}function createContextMenu(){if (contextMenu) return contextMenu;const menu = document.createElement('div');menu.id = 'btfw-boost-context-menu';menu.style.cssText = ` position:absolute;background:rgba(20,31,54,0.95);backdrop-filter:blur(10px);border:1px solid rgba(109,77,246,0.3);border-radius:8px;padding:6px;display:none;z-index:10000;min-width:100px;box-shadow:0 4px 12px rgba(0,0,0,0.4);`;BOOST_PRESETS.forEach(preset =>{const item = document.createElement('button');item.className = 'btfw-context-item';item.textContent = preset.label;item.style.cssText = ` display:block;width:100%;padding:6px 12px;background:transparent;border:none;color:#e0e0e0;text-align:left;cursor:pointer;border-radius:4px;font-size:13px;transition:all 0.2s ease;`;if (sharedAudio.BOOST_MULTIPLIER === preset.multiplier){item.style.background = 'rgba(46,213,115,0.2)';item.style.color = '#2ed573';}item.addEventListener('mouseenter',() =>{if (sharedAudio.BOOST_MULTIPLIER !== preset.multiplier){item.style.background = 'rgba(109,77,246,0.2)';}});item.addEventListener('mouseleave',() =>{if (sharedAudio.BOOST_MULTIPLIER !== preset.multiplier){item.style.background = 'transparent';}});item.addEventListener('click',async () =>{await sharedAudio.setBoostMultiplier(preset.multiplier);updateContextMenuSelection();if (boostButton){const percentage = Math.round(preset.multiplier * 100);boostButton.title = `Toggle Audio Boost (${percentage}%)`;}if (sharedAudio.boostEnabled){showToast(`Boost set to ${preset.label}`,'success');}});menu.appendChild(item);});menu.addEventListener('mouseleave',() =>{setTimeout(() =>{if (!boostButton?.matches(':hover')){hideContextMenu();}},100);});document.body.appendChild(menu);contextMenu = menu;return menu;}function showContextMenu(){if (!boostButton) return;const menu = createContextMenu();const rect = boostButton.getBoundingClientRect();menu.style.left = rect.left + 'px';menu.style.top = (rect.bottom + 5) + 'px';menu.style.display = 'block';}function hideContextMenu(){if (contextMenu) contextMenu.style.display = 'none';}function updateContextMenuSelection(){if (!contextMenu) return;const items = contextMenu.querySelectorAll('.btfw-context-item');items.forEach((item,idx) =>{const preset = BOOST_PRESETS[idx];if (sharedAudio.BOOST_MULTIPLIER === preset.multiplier){item.style.background = 'rgba(46,213,115,0.2)';item.style.color = '#2ed573';}else{item.style.background = 'transparent';item.style.color = '#e0e0e0';}});}function addButtonToOverlay(){const voLeft = $('#btfw-vo-left');if (!voLeft) return false;const existing = $('#btfw-vo-audioboost');if (existing) existing.remove();boostButton = createButton();voLeft.appendChild(boostButton);return true;}function waitForOverlayBar(callback,maxAttempts = 20){let attempts = 0;const interval = setInterval(() =>{attempts++;if (addButtonToOverlay()){clearInterval(interval);callback();}else if (attempts >= maxAttempts){clearInterval(interval);}},500);}function initializePlayer(){if (typeof videojs === 'undefined'){setTimeout(initializePlayer,500);return;}const playerElement = $('#ytapiplayer');if (!playerElement){setTimeout(initializePlayer,500);return;}sharedAudio.player = videojs('ytapiplayer');sharedAudio.originalSrc = sharedAudio.player.currentSrc();sharedAudio.startWatchdog();// console.log('[audioboost] Player initialized');}function handleMediaChange(){setTimeout(() =>{sharedAudio.cleanup();sharedAudio.isProxied = false;updateButtonState(false);initializePlayer();if (shouldBoostAfterMediaChange){setTimeout(() =>{activateAudioBoost();},1200);}},600);}function hookSocketReconnects(){if (typeof socket === 'undefined' || !socket.on) return;socket.on('disconnect',() =>{// keep time;watchdog will handle reapply after reconnect});socket.on('connect',() =>{// After reconnect,enforce proxy if needed setTimeout(() => sharedAudio._checkAndReapply('socket-connect'),500);});socket.on('reconnect',() =>{setTimeout(() => sharedAudio._checkAndReapply('socket-reconnect'),500);});socket.on('changeMedia',handleMediaChange);}function boot(){waitForOverlayBar(() =>{initializePlayer();});hookSocketReconnects();}if (document.readyState === 'loading'){document.addEventListener('DOMContentLoaded',boot);}else{boot();}return{name:"feature:audioboost",activate:activateAudioBoost,deactivate:deactivateAudioBoost,isActive:() => sharedAudio.boostEnabled};});if (window.BTFW && typeof BTFW.init === 'function'){BTFW.init("feature:audioboost").catch(() =>{});}});})();(function(){'use strict';function waitForBTFW(callback){if (window.BTFW && typeof BTFW.define === 'function'){callback();}else{setTimeout(() => waitForBTFW(callback),100);}}waitForBTFW(function(){BTFW.define("feature:audionorm",[],async () =>{const $ = (selector,root = document) => root.querySelector(selector);const sharedAudio = window.BTFW_AUDIO;let normButton = null;let shouldNormalizeAfterMediaChange = false;let contextMenu = null;function updateButtonState(active){if (!normButton) return;if (active){normButton.classList.add('active');normButton.style.background = 'rgba(52,152,219,0.3)';normButton.style.borderColor = '#3498db';normButton.style.color = '#3498db';normButton.style.boxShadow = '0 0 12px rgba(52,152,219,0.6)';}else{normButton.classList.remove('active');normButton.style.background = '';normButton.style.borderColor = '';normButton.style.color = '';normButton.style.boxShadow = '';}}function showToast(message,type = 'info'){let toast = $('#btfw-audionorm-toast');if (!toast){toast = document.createElement('div');toast.id = 'btfw-audionorm-toast';toast.style.cssText = ` position:fixed;top:70px;right:20px;background:${type === 'success' ? 'rgba(52,152,219,0.9)':'rgba(235,77,75,0.9)'};color:white;padding:12px 20px;border-radius:8px;font-size:14px;font-family:system-ui,-apple-system,sans-serif;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:10000;opacity:0;transition:opacity 0.3s ease;pointer-events:none;`;document.body.appendChild(toast);}toast.textContent = message;toast.style.background = type === 'success' ? 'rgba(52,152,219,0.9)':'rgba(235,77,75,0.9)';toast.style.opacity = '1';setTimeout(() =>{toast.style.opacity = '0';},2000);}async function activateNormalization(){const success = await sharedAudio.enableNormalization();if (success){shouldNormalizeAfterMediaChange = true;showToast('Normalization enabled','success');updateButtonState(true);}else{showToast('Failed to activate','error');}}async function deactivateNormalization(){await sharedAudio.disableNormalization();shouldNormalizeAfterMediaChange = false;updateButtonState(false);}function createButton(){const btn = document.createElement('button');btn.id = 'btfw-vo-audionorm';btn.className = 'btn btn-sm btn-default btfw-vo-adopted';const presetLabel = sharedAudio.NORM_PRESETS[sharedAudio.currentNormPreset].label;btn.title = `Toggle Audio Normalization (${presetLabel})`;btn.setAttribute('data-btfw-overlay','1');btn.innerHTML = '<i class="fa-solid fa-waveform-lines"></i>';btn.addEventListener('click',() =>{if (sharedAudio.normalizationEnabled){deactivateNormalization();}else{activateNormalization();}});btn.addEventListener('mouseenter',() => showContextMenu());btn.addEventListener('mouseleave',() =>{setTimeout(() =>{if (!contextMenu?.matches(':hover') && !btn.matches(':hover')){hideContextMenu();}},100);});return btn;}function createContextMenu(){if (contextMenu) return contextMenu;const menu = document.createElement('div');menu.id = 'btfw-norm-context-menu';menu.style.cssText = ` position:absolute;background:rgba(20,31,54,0.95);backdrop-filter:blur(10px);border:1px solid rgba(52,152,219,0.3);border-radius:8px;padding:6px;display:none;z-index:10000;min-width:110px;box-shadow:0 4px 12px rgba(0,0,0,0.4);`;Object.keys(sharedAudio.NORM_PRESETS).forEach(key =>{const preset = sharedAudio.NORM_PRESETS[key];const item = document.createElement('button');item.className = 'btfw-context-item';item.textContent = preset.label;item.style.cssText = ` display:block;width:100%;padding:6px 12px;background:transparent;border:none;color:#e0e0e0;text-align:left;cursor:pointer;border-radius:4px;font-size:13px;transition:all 0.2s ease;`;if (sharedAudio.currentNormPreset === key){item.style.background = 'rgba(52,152,219,0.2)';item.style.color = '#3498db';}item.addEventListener('mouseenter',() =>{if (sharedAudio.currentNormPreset !== key){item.style.background = 'rgba(109,77,246,0.2)';}});item.addEventListener('mouseleave',() =>{if (sharedAudio.currentNormPreset !== key){item.style.background = 'transparent';}});item.addEventListener('click',async () =>{await sharedAudio.setNormPreset(key);updateContextMenuSelection();if (normButton){normButton.title = `Toggle Audio Normalization (${preset.label})`;}if (sharedAudio.normalizationEnabled){showToast(`Preset:${preset.label}`,'success');}});menu.appendChild(item);});menu.addEventListener('mouseleave',() =>{setTimeout(() =>{if (!normButton?.matches(':hover')){hideContextMenu();}},100);});document.body.appendChild(menu);contextMenu = menu;return menu;}function showContextMenu(){if (!normButton) return;const menu = createContextMenu();const rect = normButton.getBoundingClientRect();menu.style.left = rect.left + 'px';menu.style.top = (rect.bottom + 5) + 'px';menu.style.display = 'block';}function hideContextMenu(){if (contextMenu) contextMenu.style.display = 'none';}function updateContextMenuSelection(){if (!contextMenu) return;const items = contextMenu.querySelectorAll('.btfw-context-item');Object.keys(sharedAudio.NORM_PRESETS).forEach((key,idx) =>{const item = items[idx];if (sharedAudio.currentNormPreset === key){item.style.background = 'rgba(52,152,219,0.2)';item.style.color = '#3498db';}else{item.style.background = 'transparent';item.style.color = '#e0e0e0';}});}function addButtonToOverlay(){const voLeft = $('#btfw-vo-left');if (!voLeft) return false;const existing = $('#btfw-vo-audionorm');if (existing) existing.remove();normButton = createButton();voLeft.appendChild(normButton);return true;}function waitForOverlayBar(callback,maxAttempts = 20){let attempts = 0;const interval = setInterval(() =>{attempts++;if (addButtonToOverlay()){clearInterval(interval);callback();}else if (attempts >= maxAttempts){clearInterval(interval);}},500);}function initializePlayer(){if (typeof videojs === 'undefined'){setTimeout(initializePlayer,500);return;}const playerElement = $('#ytapiplayer');if (!playerElement){setTimeout(initializePlayer,500);return;}if (!sharedAudio.player){sharedAudio.player = videojs('ytapiplayer');sharedAudio.originalSrc = sharedAudio.player.currentSrc();}sharedAudio.startWatchdog();// console.log('[audionorm] Player initialized');}function handleMediaChange(){setTimeout(() =>{sharedAudio.cleanup();sharedAudio.isProxied = false;updateButtonState(false);initializePlayer();if (shouldNormalizeAfterMediaChange){setTimeout(() =>{activateNormalization();},1200);}},600);}function hookSocketReconnects(){if (typeof socket === 'undefined' || !socket.on) return;socket.on('disconnect',() =>{});socket.on('connect',() => setTimeout(() => sharedAudio._checkAndReapply('socket-connect'),500));socket.on('reconnect',() => setTimeout(() => sharedAudio._checkAndReapply('socket-reconnect'),500));socket.on('changeMedia',handleMediaChange);}function boot(){waitForOverlayBar(() =>{initializePlayer();});hookSocketReconnects();}if (document.readyState === 'loading'){document.addEventListener('DOMContentLoaded',boot);}else{boot();}return{name:"feature:audionorm",activate:activateNormalization,deactivate:deactivateNormalization,isActive:() => sharedAudio.normalizationEnabled};});if (window.BTFW && typeof BTFW.init === 'function'){BTFW.init("feature:audionorm").catch(() =>{});}});})();// BTFW Ã¢â‚¬â€ ext:autosubs // Auto-fetch subtitles from Wyzie API for current media // External module for Channel Theme Toolkit BTFW.define("ext:autosubs",[],async () =>{const $ = (s,r = document) => r.querySelector(s);const WYZIE_API = 'https://sub.wyzie.ru/search';const TMDB_API = 'https://api.themoviedb.org/3';let currentTitle = '';let tmdbApiKey = null;let subsCache = new Map();let lastAddedTracks = [];let currentSubtitles = null;let player = null;let socket = null;let isFetching = false;let trackWatcher = null;function getTMDBKey(){try{const cfg = (window.BTFW_CONFIG && typeof window.BTFW_CONFIG === "object") ? window.BTFW_CONFIG:{};const tmdbObj = (cfg.tmdb && typeof cfg.tmdb === "object") ? cfg.tmdb:{};const integrations = (cfg.integrations && typeof cfg.integrations === "object") ? cfg.integrations:{};const intTmdb = (integrations.tmdb && typeof integrations.tmdb === "object") ? integrations.tmdb:{};const cfgKey = typeof tmdbObj.apiKey === "string" ? tmdbObj.apiKey.trim():"";const intKey = typeof intTmdb.apiKey === "string" ? intTmdb.apiKey.trim():"";const legacyCfg = typeof cfg.tmdbKey === "string" ? cfg.tmdbKey.trim():"";let lsKey = "";try{lsKey = (localStorage.getItem("btfw:tmdb:key") || "").trim();}catch(_){}const g = v => (v == null ? "":String(v)).trim();const globalKey = g(window.TMDB_API_KEY) || g(window.BTFW_TMDB_KEY) || g(window.tmdb_key) || g(window.moviedbkey);const bodyKey = (document.body?.dataset?.tmdbKey || "").trim();return intKey || cfgKey || legacyCfg || lsKey || globalKey || bodyKey || null;}catch(e){return null;}}function shouldLoadSubtitles(){const mediaType = window.PLAYER?.mediaType;return mediaType === 'fi' || mediaType === 'gd';}function getPlayer(){if (player && typeof player.addRemoteTextTrack === 'function') return player;const vw = $('#videowrap');if (!vw) return null;const vid = vw.querySelector('video');if (!vid) return null;if (typeof videojs === 'function'){try{player = videojs(vid);return player;}catch(e){}}return null;}function getSocket(){if (socket) return socket;if (window.socket && typeof window.socket.on === 'function'){socket = window.socket;return socket;}return null;}function getCurrentTitle(){const titleEl = $('#currenttitle');return titleEl ? titleEl.textContent.trim():'';}function normalizeTitle(title){return title.toLowerCase() .replace(/[^\w\s]/g,' ') .replace(/\s+/g,' ') .trim();}function cleanMovieTitle(title){const unwantedWords = ['Extended','Director\'s Cut','Directors Cut','Unrated','Theatrical Cut','Remastered'];let cleanTitle = title;unwantedWords.forEach(word =>{const regex = new RegExp(`\\b${word}\\b`,'gi');cleanTitle = cleanTitle.replace(regex,'');});return cleanTitle.replace(/\s{2,}/g,' ').trim();}function extractYearAndTitle(title){const yearParenMatch = title.match(/^(.+?)\s*\((\d{4})\)\s*$/);if (yearParenMatch){return{title:yearParenMatch[1].trim(),year:parseInt(yearParenMatch[2]),originalTitle:title};}const yearPlainMatch = title.match(/^(.+?)\s+(\d{4})\s*$/);if (yearPlainMatch){return{title:yearPlainMatch[1].trim(),year:parseInt(yearPlainMatch[2]),originalTitle:title};}return{title:title.trim(),year:null,originalTitle:title};}function isExactTitleMatch(searchTitle,resultTitle,targetYear = null,resultYear = null){const normalizedSearch = normalizeTitle(searchTitle);const normalizedResult = normalizeTitle(resultTitle);const titleMatch = normalizedSearch === normalizedResult || normalizedResult === normalizedSearch || normalizedResult.replace(/^(the|a|an)\s+/,'') === normalizedSearch.replace(/^(the|a|an)\s+/,'');if (!titleMatch) return false;if (targetYear && resultYear){return Math.abs(targetYear - resultYear) <= 1;}return true;}function clearExistingTracks(){const p = getPlayer();if (!p) return;lastAddedTracks.forEach(trackEl =>{try{if (trackEl && trackEl.track){const src = trackEl.track.src;if (src && src.startsWith('blob:')){URL.revokeObjectURL(src);}p.removeRemoteTextTrack(trackEl.track);}}catch(e){}});lastAddedTracks = [];try{const tracks = p.remoteTextTracks();const toRemove = [];for (let i = 0;i < tracks.length;i++){const track = tracks[i];if (track.src && track.src.startsWith('blob:')){toRemove.push(track);}}toRemove.forEach(track =>{try{URL.revokeObjectURL(track.src);p.removeRemoteTextTrack(track);}catch(e){}});}catch(e){}}async function searchTMDB(title,year){if (!tmdbApiKey) return null;let apiUrl = `${TMDB_API}/search/movie?api_key=${tmdbApiKey}&query=${encodeURIComponent(title)}`;if (year){apiUrl += `&primary_release_year=${year}`;}try{const response = await fetch(apiUrl);const data = await response.json();if (data.results && data.results.length > 0){for (const movie of data.results){const movieYear = movie.release_date ? parseInt(movie.release_date.substring(0,4)):null;if (isExactTitleMatch(title,movie.title,year,movieYear)){const extIdsResp = await fetch(`${TMDB_API}/movie/${movie.id}/external_ids?api_key=${tmdbApiKey}`);const extIds = await extIdsResp.json();return extIds.imdb_id || null;}}if (year){for (const movie of data.results){const movieYear = movie.release_date ? parseInt(movie.release_date.substring(0,4)):null;if (movieYear === year){const extIdsResp = await fetch(`${TMDB_API}/movie/${movie.id}/external_ids?api_key=${tmdbApiKey}`);const extIds = await extIdsResp.json();return extIds.imdb_id || null;}}}}}catch (error){}if (year){const apiUrlNoYear = `${TMDB_API}/search/movie?api_key=${tmdbApiKey}&query=${encodeURIComponent(title)}`;try{const response = await fetch(apiUrlNoYear);const data = await response.json();if (data.results && data.results.length > 0){const movie = data.results[0];const extIdsResp = await fetch(`${TMDB_API}/movie/${movie.id}/external_ids?api_key=${tmdbApiKey}`);const extIds = await extIdsResp.json();return extIds.imdb_id || null;}}catch (error){}}return null;}async function fetchSubtitles(imdbId,season,episode){const sources = ['opensubtitles','subdl','all'];for (const source of sources){const params = new URLSearchParams({id:imdbId});if (season !== null && episode !== null){params.append('season',season);params.append('episode',episode);}params.append('language','en');params.append('format','srt');params.append('source',source);const url = `${WYZIE_API}?${params}`;try{const resp = await fetch(url);if (!resp.ok) continue;const data = await resp.json();if (Array.isArray(data) && data.length > 0){const converted = await Promise.all( data.slice(0,10).map(sub => convertSrtToVtt(sub)) );const filtered = converted.filter(Boolean);if (filtered.length > 0){return filtered;}}}catch(e){continue;}}return null;}async function convertSrtToVtt(subtitle){if (!subtitle.url) return null;try{const srtResp = await fetch(subtitle.url);if (!srtResp.ok) return null;const srtText = await srtResp.text();const vttText = srtToVtt(srtText);const blob = new Blob([vttText],{type:'text/vtt'});const vttUrl = URL.createObjectURL(blob);return{url:vttUrl,lang:'en'};}catch(e){return null;}}function srtToVtt(srt){let vtt = 'WEBVTT\n\n';vtt += srt .replace(/\r\n/g,'\n') .replace(/\r/g,'\n') .replace(/(\d{2}):(\d{2}):(\d{2}),(\d{3})/g,'$1:$2:$3.$4') .replace(/^\d+\n/gm,'') .trim();return vtt;}function addSubtitlesToPlayer(subtitles){const p = getPlayer();if (!p || !Array.isArray(subtitles) || subtitles.length === 0) return false;if (typeof p.addRemoteTextTrack !== 'function') return false;const existingTracks = p.remoteTextTracks();const hasBlobTracks = existingTracks && Array.from(existingTracks).some(t => t.src && t.src.startsWith('blob:'));if (hasBlobTracks) return false;clearExistingTracks();const added = [];subtitles.forEach((sub,idx) =>{if (!sub.url) return;const label = `Sub ${idx + 1}`;try{const trackEl = p.addRemoteTextTrack({kind:'subtitles',src:sub.url,srclang:'en',label:label},false);if (trackEl) added.push(trackEl);}catch(e){}});lastAddedTracks = added;currentSubtitles = subtitles;return added.length > 0;}function startTrackWatcher(){if (trackWatcher) return;trackWatcher = setInterval(() =>{// Check if we should still be watching based on media type if (!shouldLoadSubtitles()){stopTrackWatcher();clearExistingTracks();return;}const p = getPlayer();if (!p || !currentSubtitles || currentSubtitles.length === 0) return;const existingTracks = p.remoteTextTracks();const hasBlobTracks = existingTracks && Array.from(existingTracks).some(t => t.src && t.src.startsWith('blob:'));if (!hasBlobTracks && lastAddedTracks.length > 0){lastAddedTracks = [];setTimeout(() =>{addSubtitlesToPlayer(currentSubtitles);},100);}},1000);}function stopTrackWatcher(){if (trackWatcher){clearInterval(trackWatcher);trackWatcher = null;}}async function processCurrentTitle(){const title = getCurrentTitle();if (!title || isFetching) return;if (title === currentTitle) return;// Check media type before processing if (!shouldLoadSubtitles()){currentTitle = title;clearExistingTracks();stopTrackWatcher();return;}currentTitle = title;isFetching = true;try{const p = getPlayer();if (!p || typeof p.addRemoteTextTrack !== 'function') return;if (subsCache.has(title)){const cached = subsCache.get(title);if (cached){const added = addSubtitlesToPlayer(cached);if (added){startTrackWatcher();}}return;}let imdbId = null;let season = null;let episode = null;const episodeMatch = title.match(/S(\d+)E(\d+)/i);if (episodeMatch){season = parseInt(episodeMatch[1],10);episode = parseInt(episodeMatch[2],10);}const{title:cleanTitle,year}= extractYearAndTitle(title);const finalTitle = cleanMovieTitle(cleanTitle);imdbId = await searchTMDB(finalTitle,year);if (!imdbId){subsCache.set(title,null);return;}const subtitles = await fetchSubtitles(imdbId,season,episode);if (subtitles && subtitles.length > 0){subsCache.set(title,subtitles);const added = addSubtitlesToPlayer(subtitles);if (added){startTrackWatcher();}}else{subsCache.set(title,null);}}catch(e){}finally{isFetching = false;}}function hookSocketEvents(){const sock = getSocket();if (!sock) return false;sock.on('changeMedia',(media) =>{player = null;currentTitle = '';currentSubtitles = null;stopTrackWatcher();setTimeout(() =>{player = getPlayer();if (player){processCurrentTitle();}},1000);});return true;}function boot(){tmdbApiKey = getTMDBKey();if (!tmdbApiKey){console.error('[autosubs] TMDB API key not configured in Theme Settings Ã¢â€ â€™ Integrations');return;}let attempts = 0;const maxAttempts = 20;const checkInterval = setInterval(() =>{attempts++;const p = getPlayer();const s = getSocket();if (p && s){clearInterval(checkInterval);clearExistingTracks();hookSocketEvents();// Only start if media type is correct if (shouldLoadSubtitles()){startTrackWatcher();setTimeout(processCurrentTitle,1000);}}if (attempts >= maxAttempts){clearInterval(checkInterval);}},500);}if (document.readyState === 'loading'){document.addEventListener('DOMContentLoaded',boot);}else{setTimeout(boot,100);}return{name:'ext:autosubs',clearCache:() => subsCache.clear(),refresh:() =>{currentTitle = '';processCurrentTitle();},stopWatcher:stopTrackWatcher};});(function(){function tryInit(){if (window.BTFW && typeof BTFW.init === 'function'){BTFW.init('ext:autosubs').catch(() =>{});}else{setTimeout(tryInit,100);}}if (document.readyState === 'loading'){document.addEventListener('DOMContentLoaded',() =>{document.addEventListener('btfw:ready',tryInit);setTimeout(tryInit,500);});}else{document.addEventListener('btfw:ready',tryInit);setTimeout(tryInit,500);}})();// Movie Info Module for BillTube Framework // Displays movie information with backdrop,poster,and rating when hovering over current title (function(){'use strict';const MODULE_ID = 'movie-info';const MODULE_NAME = 'Movie Info';const MODULE_VERSION = '2.0.0';// Configuration const CONFIG ={CONTAINER_ID:'btfw-movie-header',TITLE_SELECTOR:'#currenttitle',TOPBAR_SELECTOR:'.btfw-chat-topbar',ENABLE_BACKDROP:true,ENABLE_RATING:true,SHOW_SUMMARY:true};// Module state let isInitialized = false;let movieHeaderElement = null;let currentTitle = '';function getTMDBKey(){try{const cfg = (window.BTFW_CONFIG && typeof window.BTFW_CONFIG === "object") ? window.BTFW_CONFIG:{};const tmdbObj = (cfg.tmdb && typeof cfg.tmdb === "object") ? cfg.tmdb:{};const cfgKey = typeof tmdbObj.apiKey === "string" ? tmdbObj.apiKey.trim():"";const legacyCfg = typeof cfg.tmdbKey === "string" ? cfg.tmdbKey.trim():"";let lsKey = "";try{lsKey = (localStorage.getItem("btfw:tmdb:key") || "").trim();}catch(_){}const g = v => (v == null ? "":String(v)).trim();const globalKey = g(window.TMDB_API_KEY) || g(window.BTFW_TMDB_KEY) || g(window.tmdb_key);const bodyKey = (document.body?.dataset?.tmdbKey || "").trim();const key = cfgKey || legacyCfg || lsKey || globalKey || bodyKey;return key || null;}catch(_){return null;}}function init(){if (isInitialized){return;}try{const topbar = document.querySelector(CONFIG.TOPBAR_SELECTOR);if (!topbar){setTimeout(init,500);return;}createMovieHeader();setupEventListeners();injectStyles();isInitialized = true;setTimeout(handleMediaChange,100);}catch (error){setTimeout(init,1000);}}// Create the movie header container function createMovieHeader(){const topbar = document.querySelector(CONFIG.TOPBAR_SELECTOR);if (!topbar){throw new Error('Chat topbar not found');}// Remove existing movie header if it exists const existingHeader = document.getElementById(CONFIG.CONTAINER_ID);if (existingHeader){existingHeader.remove();}// Create new movie header movieHeaderElement = document.createElement('div');movieHeaderElement.id = CONFIG.CONTAINER_ID;movieHeaderElement.className = 'btfw-movie-header hide';// Insert after the topbar topbar.insertAdjacentElement('afterend',movieHeaderElement);}// Setup event listeners for module functionality function setupEventListeners(){// Listen for media changes via socket if (window.socket && typeof window.socket.on === 'function'){window.socket.on('changeMedia',handleMediaChange);}else{let retryCount = 0;const retrySocket = () =>{retryCount++;if (window.socket && typeof window.socket.on === 'function'){window.socket.on('changeMedia',handleMediaChange);}else if (retryCount < 10){setTimeout(retrySocket,1000);}};setTimeout(retrySocket,2000);}// Setup hover effects for showing/hiding movie info setupHoverEffects();// Handle window resize for responsive design window.addEventListener('resize',debounce(handleResize,250));}// Setup hover effects for the title and movie header function setupHoverEffects(){const titleElement = document.querySelector(CONFIG.TITLE_SELECTOR);if (titleElement){titleElement.addEventListener('mouseenter',showMovieHeader);titleElement.addEventListener('mouseleave',hideMovieHeaderDelayed);}else{const observer = new MutationObserver(() =>{const titleEl = document.querySelector(CONFIG.TITLE_SELECTOR);if (titleEl){titleEl.addEventListener('mouseenter',showMovieHeader);titleEl.addEventListener('mouseleave',hideMovieHeaderDelayed);observer.disconnect();}});observer.observe(document.body,{childList:true,subtree:true});}if (movieHeaderElement){movieHeaderElement.addEventListener('mouseenter',cancelHideTimer);movieHeaderElement.addEventListener('mouseleave',hideMovieHeaderDelayed);}}let hideTimer;function showMovieHeader(){if (hideTimer){clearTimeout(hideTimer);hideTimer = null;}if (movieHeaderElement){movieHeaderElement.classList.remove('hide');movieHeaderElement.classList.add('show');}}function hideMovieHeaderDelayed(){hideTimer = setTimeout(() =>{if (movieHeaderElement){movieHeaderElement.classList.remove('show');movieHeaderElement.classList.add('hide');// Remove hide class after animation completes to reset state setTimeout(() =>{if (movieHeaderElement && movieHeaderElement.classList.contains('hide')){movieHeaderElement.classList.remove('hide');}},300);}},300);}function cancelHideTimer(){if (hideTimer){clearTimeout(hideTimer);hideTimer = null;}}// Handle media changes async function handleMediaChange(){const titleElement = document.querySelector(CONFIG.TITLE_SELECTOR);if (!titleElement || !movieHeaderElement){return;}const newTitle = titleElement.textContent?.trim() || '';// Don't refetch if title hasn't changed if (newTitle === currentTitle){return;}currentTitle = newTitle;if (!newTitle){resetMovieHeader();return;}try{showLoadingState();const movieInfo = await fetchMovieInfo(newTitle);displayMovieInfo(movieInfo);}catch (error){showErrorState();}}// Clean movie title by removing unwanted words function cleanMovieTitle(title){const unwantedWords = ['Extended','Director\'s Cut','Directors Cut','Unrated','Theatrical Cut'];let cleanTitle = title;unwantedWords.forEach(word =>{const regex = new RegExp(`\\b${word}\\b`,'gi');cleanTitle = cleanTitle.replace(regex,'');});return cleanTitle.replace(/\s{2,}/g,' ').trim();}// Fetch movie information from TMDB async function fetchMovieInfo(movieTitle){const apiKey = getTMDBKey();if (!apiKey){throw new Error('TMDB API key not configured. Please set it in Theme Settings Ã¢â€ â€™ Integrations');}// Try to extract year in parentheses first:"Movie Title (1992)" let match = movieTitle.match(/(.+)\s*\((\d{4})\)/);let title = match ? match[1].trim():movieTitle;let year = match ? match[2]:'';// If no parentheses year found,try standalone year:"Movie Title 1992" if (!year){match = movieTitle.match(/(.+?)\s+(\d{4})\s*$/);if (match){title = match[1].trim();year = match[2];}}const cleanTitle = cleanMovieTitle(title);const searchUrl = `https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${encodeURIComponent(cleanTitle)}&year=${year}`;try{const response = await fetch(searchUrl);if (!response.ok){throw new Error(`HTTP ${response.status}:${response.statusText}`);}const data = await response.json();if (data?.results?.length > 0){const movie = data.results[0];return{title:movieTitle,backdrop:movie.backdrop_path ? `https://image.tmdb.org/t/p/w1280${movie.backdrop_path}`:null,poster:movie.poster_path ? `https://image.tmdb.org/t/p/w500${movie.poster_path}`:null,summary:movie.overview || '',rating:movie.vote_average || 0,releaseDate:movie.release_date || '',voteCount:movie.vote_count || 0};}}catch (error){throw error;}return{title:movieTitle,backdrop:null,poster:null,summary:'',rating:0,releaseDate:'',voteCount:0};}// Show loading state function showLoadingState(){if (!movieHeaderElement) return;resetBackdrop();movieHeaderElement.innerHTML = ` <div class="btfw-movie-content"> <div class="btfw-movie-loading"> <i class="fa fa-spinner fa-spin"></i> <p>Loading movie information...</p> </div> </div> `;}// Show error state function showErrorState(){if (!movieHeaderElement) return;resetBackdrop();movieHeaderElement.innerHTML = ` <div class="btfw-movie-content"> <div class="btfw-movie-error"> <i class="fa fa-exclamation-triangle"></i> <p>Unable to fetch movie information</p> <small>Check TMDB API key in Theme Settings</small> </div> </div> `;}// Reset movie header to default state function resetMovieHeader(){if (!movieHeaderElement) return;resetBackdrop();movieHeaderElement.innerHTML = ` <div class="btfw-movie-content"> <p>No movie information available</p> </div> `;}// Reset backdrop style function resetBackdrop(){if (!movieHeaderElement) return;movieHeaderElement.style.backgroundImage = '';movieHeaderElement.style.backgroundColor = '';}// Display movie information function displayMovieInfo(movie){if (!movieHeaderElement) return;// Clear existing content movieHeaderElement.innerHTML = '';// Set backdrop if available and enabled if (CONFIG.ENABLE_BACKDROP && movie.backdrop){movieHeaderElement.style.backgroundImage = `url(${movie.backdrop})`;movieHeaderElement.style.backgroundSize = 'cover';movieHeaderElement.style.backgroundPosition = 'center';}else{resetBackdrop();}// Create overlay for better text readability const overlay = document.createElement('div');overlay.className = 'btfw-movie-overlay';movieHeaderElement.appendChild(overlay);// Create content container const contentDiv = document.createElement('div');contentDiv.className = 'btfw-movie-content';movieHeaderElement.appendChild(contentDiv);// Add poster if available if (movie.poster){const posterEl = document.createElement('img');posterEl.src = movie.poster;posterEl.alt = `${movie.title}Poster`;posterEl.className = 'btfw-movie-poster';contentDiv.appendChild(posterEl);}// Add movie details container const detailsDiv = document.createElement('div');detailsDiv.className = 'btfw-movie-details';contentDiv.appendChild(detailsDiv);// Add title const titleEl = document.createElement('h2');titleEl.textContent = movie.title;titleEl.className = 'btfw-movie-title';detailsDiv.appendChild(titleEl);// Add summary if available and enabled if (CONFIG.SHOW_SUMMARY && movie.summary){const summaryEl = document.createElement('p');summaryEl.textContent = movie.summary;summaryEl.className = 'btfw-movie-summary';detailsDiv.appendChild(summaryEl);}// Add rating if available and enabled if (CONFIG.ENABLE_RATING && movie.rating > 0){const ratingEl = createRatingElement(movie.rating,movie.voteCount);contentDiv.appendChild(ratingEl);}}// Create rating element with circular progress function createRatingElement(rating,voteCount){const container = document.createElement('div');container.className = 'btfw-movie-rating';const percentage = Math.round(rating * 10);const color = getRatingColor(percentage);const svgNS = "http://www.w3.org/2000/svg";const svg = document.createElementNS(svgNS,"svg");svg.setAttribute("width","60");svg.setAttribute("height","60");svg.setAttribute("viewBox","0 0 60 60");const radius = 25;const circumference = 2 * Math.PI * radius;const offset = circumference - (rating / 10) * circumference;// Background circle const circleBg = document.createElementNS(svgNS,"circle");circleBg.setAttribute("cx","30");circleBg.setAttribute("cy","30");circleBg.setAttribute("r",radius.toString());circleBg.setAttribute("stroke","#2a2a2a");circleBg.setAttribute("stroke-width","4");circleBg.setAttribute("fill","#1a1a1a");svg.appendChild(circleBg);// Progress circle const circle = document.createElementNS(svgNS,"circle");circle.setAttribute("cx","30");circle.setAttribute("cy","30");circle.setAttribute("r",radius.toString());circle.setAttribute("stroke",color);circle.setAttribute("stroke-width","3");circle.setAttribute("fill","none");circle.setAttribute("stroke-dasharray",circumference.toString());circle.setAttribute("stroke-dashoffset",offset.toString());circle.setAttribute("transform","rotate(-90 30 30)");circle.setAttribute("stroke-linecap","round");svg.appendChild(circle);// Rating text const text = document.createElementNS(svgNS,"text");text.setAttribute("x","50%");text.setAttribute("y","50%");text.setAttribute("text-anchor","middle");text.setAttribute("dominant-baseline","central");text.setAttribute("fill","#fff");text.setAttribute("font-size","10");text.setAttribute("font-weight","bold");text.textContent = `${percentage}%`;svg.appendChild(text);container.appendChild(svg);// Add vote count if available if (voteCount > 0){const voteEl = document.createElement('div');voteEl.className = 'btfw-movie-votes';voteEl.textContent = `${voteCount.toLocaleString()}votes`;container.appendChild(voteEl);}return container;}// Get color based on rating percentage function getRatingColor(rating){const clampedRating = Math.max(0,Math.min(rating,100));if (clampedRating >= 70) return '#4caf50';// Green if (clampedRating >= 50) return '#ff9800';// Orange return '#f44336';// Red}// Handle window resize function handleResize(){// Adjust layout for mobile if needed if (movieHeaderElement){const isMobile = window.innerWidth <= 768;movieHeaderElement.classList.toggle('btfw-mobile',isMobile);}}// Debounce function function debounce(func,wait){let timeout;return function executedFunction(...args){const later = () =>{clearTimeout(timeout);func(...args);};clearTimeout(timeout);timeout = setTimeout(later,wait);};}// Inject CSS styles function injectStyles(){const css = ` .btfw-movie-header{position:absolute;top:44px;right:0;height:auto;width:100%;max-width:90vw;background:rgba(20,20,20,0.95);border-radius:0 0 12px 12px;border:1px solid rgba(255,255,255,0.1);backdrop-filter:blur(10px);z-index:1000;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,0.4);opacity:0;transform:translateY(-20px) scale(0.95);pointer-events:none;}.btfw-movie-header.show{opacity:1;transform:translateY(0) scale(1);pointer-events:auto;animation:slideInDown 0.4s cubic-bezier(0.25,0.46,0.45,0.94) forwards;}.btfw-movie-header.hide{animation:slideOutUp 0.3s cubic-bezier(0.55,0.055,0.675,0.19) forwards;}@keyframes slideInDown{0%{opacity:0;transform:translateY(-30px) scale(0.9);}60%{opacity:0.8;transform:translateY(5px) scale(1.02);}100%{opacity:1;transform:translateY(0) scale(1);}}@keyframes slideOutUp{0%{opacity:1;transform:translateY(0) scale(1);}100%{opacity:0;transform:translateY(-25px) scale(0.95);}}.btfw-movie-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient( 135deg,rgba(0,0,0,0.7) 0%,rgba(0,0,0,0.5) 50%,rgba(0,0,0,0.8) 100% );z-index:1;}.btfw-movie-content{position:relative;z-index:2;padding:10px;display:flex;gap:15px;min-height:160px;}.btfw-movie-poster{width:100px;height:auto;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.5);flex-shrink:0;}.btfw-movie-details{flex:1;display:flex;flex-direction:column;gap:12px;}.btfw-movie-title{color:#fff;font-size:1.2em;font-weight:600;margin:0;text-shadow:2px 2px 4px rgba(0,0,0,0.8);line-height:1.3;}.btfw-movie-summary{color:#e0e0e0;font-size:0.85em;line-height:1.5;margin:0;text-shadow:1px 1px 2px rgba(0,0,0,0.8);display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden;}.btfw-movie-rating{position:sticky;bottom:16px;right:16px;display:flex;flex-direction:column;align-items:stretch;gap:4px;justify-content:flex-end;}.btfw-movie-votes{color:#ccc;font-size:0.7em;text-align:center;text-shadow:1px 1px 2px rgba(0,0,0,0.8);}.btfw-movie-loading,.btfw-movie-error{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:#ccc;text-align:center;min-height:120px;}.btfw-movie-loading i,.btfw-movie-error i{font-size:2em;opacity:0.7;}.btfw-movie-error i{color:#ff6b6b;}.btfw-movie-error small{font-size:0.8em;color:#aaa;}@media (max-width:768px){.btfw-movie-header{width:100%;right:0;left:0;border-radius:0;}.btfw-movie-content{padding:16px;flex-direction:column;min-height:auto;}.btfw-movie-poster{width:80px;align-self:center;}.btfw-movie-rating{position:static;align-self:center;margin-top:12px;}.btfw-movie-summary{-webkit-line-clamp:3;}}${CONFIG.TITLE_SELECTOR}:hover{color:#4fc3f7 !important;transition:color 0.2s ease;}`;const styleElement = document.createElement('style');styleElement.textContent = css;document.head.appendChild(styleElement);}// Cleanup function function cleanup(){if (movieHeaderElement){movieHeaderElement.remove();movieHeaderElement = null;}if (window.socket && typeof window.socket.off === 'function'){window.socket.off('changeMedia',handleMediaChange);}if (hideTimer){clearTimeout(hideTimer);hideTimer = null;}isInitialized = false;}// Auto-initialize when DOM is ready and BTFW is available function tryInit(){if (document.readyState === 'loading'){document.addEventListener('DOMContentLoaded',tryInit);return;}setTimeout(init,2000);}// Also listen for BTFW ready event if available document.addEventListener('btfw:ready',() =>{setTimeout(init,500);});tryInit();// Export module interface window.MovieInfoModule ={init,cleanup,isInitialized:() => isInitialized,moduleInfo:{id:MODULE_ID,name:MODULE_NAME,version:MODULE_VERSION}};})();// BTFW Ã¢â‚¬â€ ext:movie-suggestion // TMDB movie suggestions for chat BTFW.define("ext:movie-suggestion",[],async () =>{const $ = (s,r = document) => r.querySelector(s);const $$ = (s,r = document) => Array.from(r.querySelectorAll(s));let selectedMovieId = null;let selectedMovieTitle = null;let selectedPosterPath = null;// Inject CSS function injectStyles(){if (document.getElementById("btfw-movie-suggest-styles")) return;const style = document.createElement("style");style.id = "btfw-movie-suggest-styles";style.textContent = ` #btfw-movie-suggest-modal .btfw-movie-results{display:flex;gap:12px;overflow-x:auto;margin-top:16px;}#btfw-movie-suggest-modal .movie-result{min-width:150px;cursor:pointer;border:1px solid rgba(255,255,255,0.1);border-radius:8px;overflow:hidden;transition:all 0.2s ease;}#btfw-movie-suggest-modal .movie-result:hover{border-color:var(--btfw-color-accent,#6d4df6);transform:translateY(-2px);}#btfw-movie-suggest-modal .movie-result img{width:100%;display:block;}#btfw-movie-suggest-modal .movie-result__info{padding:8px;}#btfw-movie-suggest-modal .movie-result__title{font-weight:600;font-size:0.85rem;}#btfw-movie-suggest-modal .recent-suggestion{display:flex;align-items:center;gap:12px;margin-bottom:12px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.03);}#btfw-movie-suggest-modal .recent-suggestion img{width:46px;height:69px;border-radius:4px;object-fit:cover;}#btfw-movie-suggest-modal .recent-suggestion__title{font-weight:600;}#btfw-movie-suggest-modal .recent-suggestion__user{opacity:0.7;font-size:0.85rem;}.button.btfw-nav-pill#btfw-movie-suggest-btn:hover{background-color:var(--btfw-color-accent,#6d4df6);}`;document.head.appendChild(style);}// Get TMDB API key from config function getTMDBKey(){try{const cfg = (window.BTFW_CONFIG && typeof window.BTFW_CONFIG === "object") ? window.BTFW_CONFIG:{};const tmdbObj = (cfg.tmdb && typeof cfg.tmdb === "object") ? cfg.tmdb:{};const cfgKey = typeof tmdbObj.apiKey === "string" ? tmdbObj.apiKey.trim():"";const legacyCfg = typeof cfg.tmdbKey === "string" ? cfg.tmdbKey.trim():"";let lsKey = "";try{lsKey = (localStorage.getItem("btfw:tmdb:key") || "").trim();}catch(_){}const g = v => (v == null ? "":String(v)).trim();const globalKey = g(window.TMDB_API_KEY) || g(window.BTFW_TMDB_KEY) || g(window.tmdb_key) || g(window.moviedbkey);const bodyKey = (document.body?.dataset?.tmdbKey || "").trim();const key = cfgKey || legacyCfg || lsKey || globalKey || bodyKey;return key || null;}catch(_){return null;}}const userRank = CLIENT?.rank || 0;function findNavList(){const donateBtn = $("a[href*='donate'],#donate-btn,.donate-btn");if (donateBtn){const ul = donateBtn.closest("ul");if (ul) return{ul,insertAfter:donateBtn.parentElement};}const themeBtn = $("#btfw-theme-btn-nav");if (themeBtn){const ul = themeBtn.closest("ul");if (ul) return{ul,insertAfter:null};}return{ul:$(".navbar .nav.navbar-nav") || $(".navbar-nav") || $(".btfw-navbar ul") || $(".navbar ul"),insertAfter:null};}function addNavButton(){if ($("#btfw-movie-suggest-btn")) return true;const nav = findNavList();if (!nav.ul) return false;const li = document.createElement("li");const a = document.createElement("a");a.href = "javascript:void(0)";a.className = "btfw-nav-pill";a.id = "btfw-movie-suggest-btn";a.innerHTML = ` <span class="btfw-nav-pill__icon" aria-hidden="true"><i class="fa fa-film"></i></span> <span class="btfw-nav-pill__label">Request</span> `;li.appendChild(a);if (nav.insertAfter){nav.insertAfter.after(li);}else{nav.ul.insertBefore(li,nav.ul.firstChild);}a.addEventListener("click",openModal);return true;}function buildModal(){if ($("#btfw-movie-suggest-modal")) return;const modal = document.createElement("div");modal.id = "btfw-movie-suggest-modal";modal.className = "modal";modal.innerHTML = ` <div class="modal-background"></div> <div class="modal-card btfw-modal"> <header class="modal-card-head"> <p class="modal-card-title">Suggest a movie for the playlist</p> <button class="delete" aria-label="close"></button> </header> <section class="modal-card-body"> <div class="field"> <div class="control"> <input type="text" id="btfw-movie-search" class="input" placeholder="${userRank === 0 ? 'Please register to search and suggest movies':'Search for a movie...'}" ${userRank === 0 ? 'disabled':''}> </div> </div> <div class="btfw-movie-results"></div> <div style="margin-top:24px;"> <h6 style="font-weight:600;margin-bottom:12px;">Recent Suggestions:</h6> <div id="btfw-recent-suggestions"></div> </div> </section> </div> `;document.body.appendChild(modal);const bg = $(".modal-background",modal);const del = $(".delete",modal);bg.addEventListener("click",closeModal);del.addEventListener("click",closeModal);if (userRank === 0){const input = $("#btfw-movie-search",modal);input.addEventListener("focus",() =>{alert('You need to be registered to search and suggest movies.');input.blur();});}else{let searchTimeout;const input = $("#btfw-movie-search",modal);input.addEventListener("input",() =>{clearTimeout(searchTimeout);const query = input.value.trim();if (query.length > 2){searchTimeout = setTimeout(() => searchMovies(query),500);}else{$(".btfw-movie-results",modal).innerHTML = '';}});}}function buildConfirmModal(){if ($("#btfw-movie-confirm-modal")) return;const modal = document.createElement("div");modal.id = "btfw-movie-confirm-modal";modal.className = "modal";modal.innerHTML = ` <div class="modal-background"></div> <div class="modal-card btfw-modal"> <header class="modal-card-head"> <p class="modal-card-title">Confirm Suggestion</p> <button class="delete" aria-label="close"></button> </header> <section class="modal-card-body"> <p>Are you sure you want to suggest <strong id="btfw-confirm-movie-title"></strong>?</p> </section> <footer class="modal-card-foot"> <button class="button" id="btfw-movie-cancel">Cancel</button> <button class="button is-link" id="btfw-movie-confirm">Confirm</button> </footer> </div> `;document.body.appendChild(modal);const bg = $(".modal-background",modal);const del = $(".delete",modal);const cancel = $("#btfw-movie-cancel",modal);const confirm = $("#btfw-movie-confirm",modal);const close = () => modal.classList.remove("is-active");bg.addEventListener("click",close);del.addEventListener("click",close);cancel.addEventListener("click",close);confirm.addEventListener("click",confirmSuggestion);}function openModal(){const modal = $("#btfw-movie-suggest-modal");if (!modal) return;modal.classList.add("is-active");// Clear and reload suggestions every time modal opens const container = $("#btfw-recent-suggestions",modal);if (container) container.innerHTML = '';loadRecentSuggestions();}function closeModal(){const modal = $("#btfw-movie-suggest-modal");if (!modal) return;modal.classList.remove("is-active");$("#btfw-movie-search",modal).value = '';$(".btfw-movie-results",modal).innerHTML = '';$("#btfw-recent-suggestions",modal).innerHTML = '';selectedMovieId = null;selectedMovieTitle = null;selectedPosterPath = null;}function searchMovies(query){const apiKey = getTMDBKey();if (!apiKey){console.error('[movie-suggestion] TMDB API key not available');return;}const url = `https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${encodeURIComponent(query)}`;fetch(url) .then(res => res.json()) .then(data => displaySearchResults(data.results.slice(0,5))) .catch(err => console.error("[movie-suggestion] Error fetching movies:",err));}function displaySearchResults(movies){const modal = $("#btfw-movie-suggest-modal");if (!modal) return;const container = $(".btfw-movie-results",modal);container.innerHTML = movies.map(movie => ` <div class="movie-result" data-id="${movie.id}" data-title="${movie.title}" data-poster="${movie.poster_path}"> <img src="https://image.tmdb.org/t/p/w154${movie.poster_path}" alt="${movie.title}" onerror="this.src='https://via.placeholder.com/154x231?text=No+Image'"> <div class="movie-result__info"> <div class="movie-result__title">${movie.title}</div> <small style="opacity:0.7;">${movie.release_date ? movie.release_date.split('-')[0]:'N/A'}</small> </div> </div> `).join('');$$(".movie-result",container).forEach(el =>{el.addEventListener("click",() =>{selectedMovieId = el.dataset.id;selectedMovieTitle = el.dataset.title;selectedPosterPath = el.dataset.poster;const confirmModal = $("#btfw-movie-confirm-modal");if (!confirmModal) return;$("#btfw-confirm-movie-title",confirmModal).textContent = selectedMovieTitle;confirmModal.classList.add("is-active");});});}async function confirmSuggestion(){if (!selectedMovieId || !selectedMovieTitle) return;const confirmModal = $("#btfw-movie-confirm-modal");if (confirmModal) confirmModal.classList.remove("is-active");// Save the suggestion and wait for completion await suggestMovie(selectedMovieId,selectedMovieTitle,selectedPosterPath);// Give the worker a moment to process,then refresh await new Promise(resolve => setTimeout(resolve,400));loadRecentSuggestions();// Keep modal open briefly to show the new suggestion await new Promise(resolve => setTimeout(resolve,1200));closeModal();}function suggestMovie(movieId,movieTitle,posterPath){const username = CLIENT?.name || 'Anonymous';console.log(`[movie-suggestion] Suggesting:${movieTitle}(ID:${movieId}) by ${username}`);return saveSuggestionToCloudflare(movieId,movieTitle,username,posterPath);}function saveSuggestionToCloudflare(movieId,movieTitle,username,posterPath){const suggestion ={movieId,movieTitle,username,posterPath,timestamp:new Date().toISOString()};return fetch('https://movie-suggestions-worker.billtube.workers.dev',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(suggestion)}) .then(res => res.json()) .then(data =>{console.log('[movie-suggestion] Saved:',data);return data;}) .catch(err =>{console.error('[movie-suggestion] Save failed:',err);throw err;});}function loadRecentSuggestions(){const container = $("#btfw-recent-suggestions");if (!container) return;container.innerHTML = '';fetch('https://movie-suggestions-worker.billtube.workers.dev') .then(res => res.json()) .then(async data =>{// Fetch all movie details first,maintaining order const suggestions = await Promise.all( data.map(suggestion => fetchMovieDetails(suggestion.movieId).then(movie => ({movieId:suggestion.movieId,movieTitle:suggestion.movieTitle,username:suggestion.username,posterPath:movie.poster_path})) ) );// Add them in reverse order so newest appears at top suggestions.reverse().forEach(s =>{addRecentSuggestion(s.movieId,s.movieTitle,s.username,s.posterPath);});}) .catch(err => console.error('[movie-suggestion] Load failed:',err));}function addRecentSuggestion(movieId,movieTitle,username,posterPath){const container = $("#btfw-recent-suggestions");if (!container) return;const div = document.createElement('div');div.className = 'recent-suggestion';div.innerHTML = ` <img src="https://image.tmdb.org/t/p/w92${posterPath}" alt="${movieTitle}" onerror="this.src='https://via.placeholder.com/92x138?text=No+Image'"> <div> <div class="recent-suggestion__title">${movieTitle}</div> <small class="recent-suggestion__user">Suggested by:${username}</small> </div> `;container.appendChild(div);}function fetchMovieDetails(movieId){const apiKey = getTMDBKey();if (!apiKey){console.error('[movie-suggestion] TMDB API key not available');return Promise.reject('No API key');}const url = `https://api.themoviedb.org/3/movie/${movieId}?api_key=${apiKey}`;return fetch(url) .then(res => res.json()) .catch(err =>{console.error('[movie-suggestion] Fetch details failed:',err);return{poster_path:null};});}function boot(){const apiKey = getTMDBKey();if (!apiKey){console.warn('[movie-suggestion] TMDB API key not configured. Add it in Theme Settings Ã¢â€ â€™ Integrations.');return;}console.log('[movie-suggestion] Initializing with TMDB API key');injectStyles();buildModal();buildConfirmModal();let retryCount = 0;const maxRetries = 50;const tryAddButton = () =>{if (addNavButton()){console.log('[movie-suggestion] Button added successfully');return;}retryCount++;if (retryCount < maxRetries){setTimeout(tryAddButton,100);}else{console.warn('[movie-suggestion] Failed to add button after retries');}};tryAddButton();}document.addEventListener('btfw:layoutReady',() =>{setTimeout(boot,100);});if (document.readyState === 'loading'){document.addEventListener('DOMContentLoaded',() =>{setTimeout(boot,200);});}else{setTimeout(boot,200);}return{name:'ext:movie-suggestion',open:openModal,close:closeModal};});// Auto-initialize when BTFW is ready (function(){function tryInit(){if (window.BTFW && typeof BTFW.init === 'function'){BTFW.init('ext:movie-suggestion').catch(err =>{console.error('[movie-suggestion] Init failed:',err);});}else{setTimeout(tryInit,100);}}if (document.readyState === 'loading'){document.addEventListener('DOMContentLoaded',() =>{document.addEventListener('btfw:ready',tryInit);setTimeout(tryInit,500);});}else{document.addEventListener('btfw:ready',tryInit);setTimeout(tryInit,500);}})();