BTFW.define("feature:player",["feature:layout"],async({})=>{const e="#videowrap .video-js",t="vjs-default-skin",n="vjs-theme-city",o="vjs-big-play-centered",i=["#videowrap video","#ytapiplayer video","#videowrap .video-js video","#videowrap .video-js .vjs-tech"].join(","),r={playsinline:"","webkit-playsinline":"","x5-video-player-type":"h5","x5-video-player-fullscreen":"false","x5-video-orientation":"portrait"},a=["https://vjs.zencdn.net/7.20.3/video-js.css"],s=["https://cdn.jsdelivr.net/npm/@videojs/themes@1/dist/city/index.css","https://unpkg.com/@videojs/themes@1/dist/city/index.css"];function l(e,t){const n=document;if(!n||!n.head)return;if(n.getElementById(e))return;const o=n.createElement("link");o.id=e,o.rel="stylesheet";const i=Array.isArray(t)?t.slice():[t],r=()=>{if(!i.length)return!1;const e=i.shift();return e?(o.href=e,!0):r()};o.addEventListener("error",()=>{r()||o.remove()}),r()&&n.head.appendChild(o)}function c(){if(function(){if("undefined"==typeof window||!document.body)return!1;const e=document.createElement("div");e.className=`video-js ${t}`,e.style.position="absolute",e.style.opacity="0",e.style.pointerEvents="none",e.style.width="1px",e.style.height="1px",document.body.appendChild(e);const n=window.getComputedStyle(e).fontSize;return e.remove(),n&&Math.abs(parseFloat(n)-10)<.2}())return;document.querySelector('link[href*="video-js"], link[href*="videojs"], style[data-vjs-styles]')||l("btfw-videojs-base-css",a)}function d(){c(),document.querySelector('link[href*="videojs" i][href*="city" i], link[href*="@videojs/themes" i][href*="city" i]')||l("btfw-videojs-city-css",s),document.querySelectorAll(e).forEach(e=>{e.classList.contains(t)&&e.classList.remove(t),Array.from(e.classList).forEach(t=>{t.startsWith("vjs-theme-")&&t!==n&&e.classList.remove(t)}),e.classList.contains(n)||e.classList.add(n),e.classList.contains(o)||e.classList.add(o)})}function u(){if("undefined"==typeof window)return;const t=window.BTFW?.channelPosterUrl;t&&document.querySelectorAll(e).forEach(e=>{e.poster!==t&&(e.poster=t);try{const n=e.player||e.player_||window.videojs&&window.videojs.players&&window.videojs.players[e.id];n&&"function"==typeof n.poster&&n.poster(t)}catch(n){const o=e.querySelector(".vjs-poster");o&&(o.style.backgroundImage=`url("${t}")`)}})}function f(){if("undefined"==typeof window)return;const e=window.PLAYER?.mediaType;document.querySelectorAll(".vjs-poster").forEach(t=>{"yt"===e||"dm"===e||"vi"===e||"tw"===e?t.classList.add("hidden"):t.classList.remove("hidden")})}function m(){document.querySelectorAll(i).forEach(e=>{e instanceof HTMLVideoElement&&("boolean"==typeof e.playsInline&&(e.playsInline=!0),Object.entries(r).forEach(([t,n])=>{try{e.setAttribute(t,n)}catch(e){}}))})}function p(){!function(){if("undefined"==typeof window)return!1;const e=window.videojs;if(!e)return!1;const t=e.dom||e;if(!t||"function"!=typeof t.textContent)return!1;if(t.textContent&&t.textContent._btfwOptimized)return!0;const n=t.textContent.bind(t),o=function(e,t){if(!e)return e;let o;try{void 0!==e.textContent?o=e.textContent:void 0!==e.innerText&&(o=e.innerText)}catch(e){o=void 0}return void 0!==o&&o===(null==t?"":String(t))?e:n(e,t)};return o._btfwOptimized=!0,o._btfwOriginal=n,t.textContent=o,!0}()?p._tries>20||(p._tries=(p._tries||0)+1,setTimeout(p,250)):p._tries=0}const b="_btfwGuarded";function h(e){if(!e)return!1;const t=[".vjs-control-bar",".vjs-control",".vjs-menu",".vjs-menu-content",".vjs-slider",".vjs-volume-panel",".vjs-text-track-settings",".vjs-tech .alert",'.vjs-tech [role="alert"]','.vjs-tech [role="dialog"]',".vjs-tech .modal",".vjs-tech .modal-dialog"].join(",");return!!e.closest(t)}function y(e){if(!e||e[b])return;e[b]=!0;const t=e=>{h(e.target)||"click"===e.type&&0!==e.button||(e.preventDefault(),e.stopImmediatePropagation())};e.addEventListener("click",t,!0),e.addEventListener("pointerdown",e=>{h(e.target)||(e.preventDefault(),e.stopImmediatePropagation())},!0),e.addEventListener("contextmenu",t,!0)}function v(){document.querySelectorAll(e).forEach(y)}function w(){if(w._mo)return;const t=document.getElementById("videowrap")||document.body,n=new MutationObserver(t=>{let n=!1;for(const o of t){for(const t of o.addedNodes)if(1===t.nodeType&&(t.classList?.contains("video-js")||"VIDEO"===t.tagName||"IFRAME"===t.tagName||t.querySelector?.(e))){n=!0;break}for(const e of o.removedNodes)if(1===e.nodeType&&(e.classList?.contains("video-js")||"VIDEO"===e.tagName||"IFRAME"===e.tagName)){n=!0;break}}n&&(d(),v(),m(),u(),f())});n.observe(t,{childList:!0,subtree:!0,characterData:!1}),w._mo=n}function g(){setTimeout(()=>{m(),u(),f()},100)}function x(){if(d(),v(),m(),p(),u(),f(),w(),setInterval(()=>{f()},1e3),"undefined"!=typeof window&&window.socket&&"function"==typeof socket.on)try{"function"==typeof socket.off&&socket.off("changeMedia",g),socket.on("changeMedia",g)}catch(e){console.warn("[feature:player] Unable to bind changeMedia handler",e)}}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",x):x(),document.addEventListener("btfw:layoutReady",()=>setTimeout(x,0)),{name:"feature:player",applyCityTheme:d,attachGuards:v,ensureInlinePlayback:m,applyPosterUrl:u,togglePosterVisibility:f}}),BTFW.define("feature:stack",["feature:layout"],async({})=>{const e="btfw-stack-order",t="btfw-stack-playlist-open";let n=!0;const o=[{id:"motd-group",title:"Message of the Day",selectors:["#motdwrap","#motdrow","#motd","#announcements"],priority:1},{id:"playlist-group",title:"Playlist",selectors:["#playlistrow","#playlistwrap","#queuecontainer","#queue"],priority:2},{id:"channels-group",title:"Featured Channels",selectors:["#btfw-channels"],priority:3},{id:"poll-group",title:"Polls & Voting",selectors:["#pollwrap","#btfw-poll-parking","#btfw-poll-history"],priority:4}],i=["#main","#mainpage","#mainpane"],r=[{id:"addfromurl",title:"From URL",default:!0},{id:"searchcontrol",title:"Library & YouTube"},{id:"customembed",title:"Custom embed"}];function a(e){const t=document.getElementById("btfw-stack");if(!t)return;const n=!!e;t.classList.toggle("btfw-stack--compact",n),t.querySelectorAll(".btfw-stack-list").forEach(e=>{e.classList.toggle("btfw-stack-list--compact",n)})}function s(){const e=document.getElementById("btfw-leftpad");if(!e)return null;let t=document.getElementById("btfw-stack");if(!t){t=document.createElement("div"),t.id="btfw-stack",t.className="btfw-stack";const n=document.getElementById("videowrap");n&&n.nextSibling?n.parentNode.insertBefore(t,n.nextSibling):e.appendChild(t);const o=document.createElement("div");o.className="btfw-stack-list",t.appendChild(o);const i=document.createElement("div");i.id="btfw-stack-footer",i.className="btfw-stack-footer",t.appendChild(i)}return a(n),{list:t.querySelector(".btfw-stack-list"),footer:t.querySelector("#btfw-stack-footer")}}function l(){const e=document.getElementById("controlsrow"),t=document.getElementById("rightcontrols"),n=document.getElementById("btfw-plbar"),o=document.getElementById("playlistwrap"),i=document.getElementById("queuecontainer"),a=document.getElementById("playlistrow"),s=document.querySelector('#btfw-stack .btfw-stack-item[data-bind="playlist-group"] .btfw-stack-item__body'),l=document.querySelectorAll(".btfw-controls-row");let c=a||o||i||s;if(!c)return;let d=n;d?d.classList.add("btfw-plbar"):(d=document.createElement("div"),d.id="btfw-plbar",d.className="btfw-plbar");let u,f,m=d.querySelector(".btfw-plbar__layout");if(m)u=m.querySelector(".btfw-plbar__primary")||m,f=m.querySelector(".btfw-plbar__aside")||m;else{for(m=document.createElement("div"),m.className="btfw-plbar__layout",u=document.createElement("div"),u.className="btfw-plbar__primary",f=document.createElement("div"),f.className="btfw-plbar__aside",m.append(u,f);d.firstChild;)u.appendChild(d.firstChild);d.appendChild(m);const e=u.querySelector(".field.has-addons");e&&e.classList.add("btfw-plbar__search");const t=u.querySelector("#btfw-pl-count");t&&(t.classList.add("btfw-plbar__count"),f.appendChild(t))}d.querySelectorAll("#showmediaurl, #btfw-pl-poll").forEach(e=>e.remove());let p=d.querySelector(".btfw-plbar__actions");p||(p=document.createElement("div"),p.className="btfw-plbar__actions",(f||d).appendChild(p));let b=document.getElementById("btfw-addmedia-btn");d.parentElement!==c&&c.insertBefore(d,c.firstChild);const h=function(e,t,n){if(!e||!t||!n)return null;const o=r.map(e=>{const t=document.getElementById(e.id);return t?{...e,el:t}:null}).filter(Boolean);if(!o.length){const e=document.getElementById("btfw-addmedia-panel");return e&&e.remove(),null}let i=document.getElementById("btfw-addmedia-panel");if(i||(i=document.createElement("section"),i.id="btfw-addmedia-panel",i.className="btfw-addmedia-panel",i.dataset.open="false",i.setAttribute("role","region"),i.setAttribute("aria-label","Add media controls"),i.setAttribute("aria-hidden","true"),i.setAttribute("hidden","hidden"),i.innerHTML='\n        <div class="btfw-addmedia-panel__inner">\n          <header class="btfw-addmedia-panel__header">\n            <nav class="btfw-addmedia-tabs" role="tablist"></nav>\n            <button type="button" class="btfw-addmedia-close" aria-label="Close add media">\n              <span aria-hidden="true">&times;</span>\n            </button>\n          </header>\n          <div class="btfw-addmedia-panel__body">\n            <div class="btfw-addmedia-views"></div>\n            <p class="btfw-addmedia-help">Queue media by URL, browse your library, or embed custom players without leaving the playlist.</p>\n          </div>\n        </div>\n      '),i.parentElement!==e){const n=t.parentElement===e?t.nextSibling:null;e.insertBefore(i,n)}const a=i.querySelector(".btfw-addmedia-tabs"),s=i.querySelector(".btfw-addmedia-views"),l=i.querySelector(".btfw-addmedia-close");if(!a||!s)return null;for(;a.firstChild;)a.removeChild(a.firstChild);for(;s.firstChild;)s.removeChild(s.firstChild);o.forEach(({id:e,title:t,el:n})=>{n.classList.remove("collapse","in","plcontrol-collapse"),n.style.removeProperty("display"),n.style.removeProperty("height"),n.removeAttribute("aria-expanded"),n.setAttribute("role","tabpanel"),n.setAttribute("data-btfw-addmedia","panel");const o=document.createElement("button");o.type="button",o.className="btfw-addmedia-tab",o.dataset.target=e,o.textContent=t,o.setAttribute("role","tab"),a.appendChild(o);const i=document.createElement("div");i.className="btfw-addmedia-view",i.dataset.target=e,i.setAttribute("role","tabpanel"),i.setAttribute("aria-hidden","true"),i.appendChild(n),s.appendChild(i)});const c=o.find(e=>e.default)||o[0],d=e=>{const t=e||i.dataset.active||c.id;i.dataset.active=t,a.querySelectorAll(".btfw-addmedia-tab").forEach(e=>{const n=e.dataset.target===t;e.classList.toggle("is-active",n),e.setAttribute("aria-selected",n?"true":"false"),e.setAttribute("tabindex",n?"0":"-1")}),s.querySelectorAll(".btfw-addmedia-view").forEach(e=>{const n=e.dataset.target===t;e.classList.toggle("is-active",n),e.setAttribute("aria-hidden",n?"false":"true")})},u=e=>{const t=null!=e?!!e:"true"!==i.dataset.open;return i.dataset.open=t?"true":"false",i.classList.toggle("is-open",t),i.setAttribute("aria-hidden",t?"false":"true"),t?(i.removeAttribute("hidden"),d(i.dataset.active||c.id)):i.setAttribute("hidden","hidden"),i.dispatchEvent(new CustomEvent("btfw:addmedia:state",{detail:{open:t}})),t};return i._btfwWired||(a.addEventListener("click",e=>{const t=e.target.closest(".btfw-addmedia-tab");t&&(e.preventDefault(),d(t.dataset.target))}),l&&l.addEventListener("click",()=>u(!1)),i._btfwWired=!0),d(i.dataset.active||c.id),i._btfwToggle=u,i._btfwSetActive=d,[{id:"showsearch",target:"searchcontrol"},{id:"showcustomembed",target:"customembed"}].forEach(({id:e,target:t})=>{const n=document.getElementById(e);n&&n.dataset.btfwAddmedia!==t&&(n.dataset.btfwAddmedia=t,n.setAttribute("aria-controls","btfw-addmedia-panel"),n.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),d(t),u(!0),n.blur()}))}),{panel:i,toggle:u,setActive:d}}(c,d,p);h?b&&document.body.contains(b)?p.contains(b)||p.prepend(b):(b=document.createElement("button"),b.id="btfw-addmedia-btn",b.type="button",b.className="button is-small",b.innerHTML='<i class="fa fa-plus"></i><span>Add media</span>',p.prepend(b)):b&&(b.parentElement&&b.parentElement.removeChild(b),b=null);const y=e=>{if(!e)return;Array.from(e.children||[]).forEach(e=>{e&&(e.classList.add("btfw-plbar__control"),p.appendChild(e))})};if(t&&(y(t),t.remove()),e&&(y(e),e.remove()),p.querySelectorAll("button, a.btn, input[type=button], input[type=submit], input[type=reset], select").forEach(e=>{if(e)if(e.classList.add("btfw-plbar__action-btn"),"BUTTON"===e.tagName||"A"===e.tagName)e.classList.add("button","is-dark","is-small");else if("INPUT"===e.tagName){const t=(e.type||"").toLowerCase();"button"===t||"submit"===t||"reset"===t?e.classList.add("button","is-dark","is-small"):e.classList.remove("button","is-dark","is-small")}}),h&&b){b.classList.remove("is-dark"),b.classList.add("is-primary"),b.dataset.iconified||(b.innerHTML='<i class="fa fa-plus"></i><span>Add media</span>',b.dataset.iconified="1"),b.setAttribute("aria-controls","btfw-addmedia-panel");const e=e=>{b.setAttribute("aria-expanded",e?"true":"false")};b.dataset.btfwBound||(b.dataset.btfwBound="1",b.addEventListener("click",t=>{t.preventDefault();const n=document.getElementById("btfw-addmedia-panel"),o=n&&n._btfwToggle,i="function"==typeof o&&o();e(i)}));const t=h.panel||document.getElementById("btfw-addmedia-panel");t&&(e("true"===t.dataset.open),t._btfwButtonSync||(t.addEventListener("btfw:addmedia:state",t=>{e(!(!t.detail||!t.detail.open))}),t._btfwButtonSync=!0))}l.forEach(e=>{e&&!c.contains(e)&&(e.style.cssText+="\n          margin-top: 8px;\n          position: relative !important;\n          bottom: auto !important;\n          left: auto !important;\n          right: auto !important;\n          width: auto !important;\n        ",e.remove(),c.appendChild(e),console.log("[stack] Moved floating controls row into playlist container"))}),c.contains(d)||c.insertBefore(d,c.firstChild)}function c(e,t){if("motd-group"===e.id&&(!function(){const e=document.getElementById("motdwrap"),t=document.getElementById("motdrow"),n=document.getElementById("motd");if(!e&&!t)return;let o=e;if(!o&&t&&(o=t,o.id="motdwrap"),n&&o&&!o.contains(n)&&!n.contains(o)){for(;n.firstChild;)o.appendChild(n.firstChild);n.remove()}if(o&&!o.querySelector("#motd")){const e=document.createElement("div");for(e.id="motd";o.firstChild;)e.appendChild(o.firstChild);o.appendChild(e)}if(e&&t&&t!==e&&!e.contains(t)&&!t.contains(e)){for(;t.firstChild;)e.appendChild(t.firstChild);t.remove()}}(),t=[document.getElementById("motdwrap")].filter(Boolean)),"playlist-group"===e.id&&(l(),t=t.filter(e=>e&&"rightcontrols"!==e.id)),"channels-group"!==e.id&&0===t.length)return null;const n=document.querySelector("#btfw-stack .btfw-stack-list");n&&(t=t.filter(e=>e&&!n.contains(e)&&!e.contains(n)));const o=document.createElement("section");o.className="btfw-stack-item btfw-group-item",o.dataset.bind=e.id,o.dataset.group="true";const i=document.createElement("header");i.className="btfw-stack-item__header",i.innerHTML=`\n      <span class="btfw-stack-item__title">${e.title}</span>\n      <span class="btfw-stack-arrows">\n        <button class="btfw-arrow btfw-up">â†‘</button>\n        <button class="btfw-arrow btfw-down">â†“</button>\n      </span>\n    `;const r=document.createElement("div");if(r.className="btfw-stack-item__body btfw-group-body",t.forEach(e=>{if(e&&e.parentElement!==r&&!r.contains(e)&&!e.contains(r))try{r.appendChild(e)}catch(t){console.warn("[stack] Failed to move element:",e.id||e.className,t)}}),o.appendChild(i),o.appendChild(r),"playlist-group"===e.id){const e=u();if(!o.hasAttribute("data-open")){const t=null===e||e;o.dataset.open=t?"true":"false"}o.classList.toggle("is-open","false"!==o.dataset.open);const t=i.querySelector(".btfw-stack-arrows");if(t&&!t.querySelector(".btfw-playlist-toggle")){const n=document.createElement("button");n.type="button",n.className="btfw-arrow btfw-playlist-toggle",n.setAttribute("aria-label","Toggle playlist visibility"),n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center";const i=()=>{const e="false"!==o.dataset.open;n.textContent=e?"ðŸ‘ï¸":"ðŸ‘ï¸â€ðŸ—¨ï¸",n.title=e?"Hide playlist (improves performance)":"Show playlist",n.setAttribute("aria-expanded",e?"true":"false"),o.classList.toggle("is-open",e)},r=(e,t={})=>{const n=!!e;o.dataset.open=n?"true":"false",i(),!1!==t.persist&&f(n)};n.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const t="false"!==o.dataset.open;r(!t),console.log("[Playlist Toggle]",t?"Collapsed":"Expanded")}),null!==e?r(e,{persist:!1}):i();new MutationObserver(e=>{for(const t of e)"attributes"===t.type&&(i(),f("false"!==o.dataset.open))}).observe(o,{attributes:!0,attributeFilter:["data-open"]}),t.appendChild(n)}}return o.querySelector(".btfw-up").onclick=function(){const e=o.parentElement,t=o.previousElementSibling;t&&e.insertBefore(o,t),d(e)},o.querySelector(".btfw-down").onclick=function(){const e=o.parentElement,t=o.nextElementSibling;t?e.insertBefore(t,o):e.appendChild(o),d(e)},o}function d(t){try{const n=Array.from(t.children).map(e=>({id:e.dataset.bind,isGroup:"true"===e.dataset.group}));localStorage.setItem(e,JSON.stringify(n))}catch(e){}}function u(){try{const e=localStorage.getItem(t);return null===e?null:"true"===e}catch(e){return null}}function f(e){try{localStorage.setItem(t,e?"true":"false")}catch(e){}}function m(t){const r=t.list,s=t.footer;!function(){const e=document.getElementById("leftcontrols"),t=document.getElementById("pollwrap");e&&t&&(e.querySelectorAll('button[onclick*="poll"], button[title*="poll"], .poll-btn, #newpollbtn').forEach(e=>{let n=t.querySelector(".poll-controls");n||(n=document.createElement("div"),n.className="poll-controls",n.style.cssText="margin-bottom: 8px; padding: 4px; display: flex; gap: 6px;",t.insertBefore(n,t.firstChild)),e.classList.add("button","is-small","is-link"),n.appendChild(e)}),0===e.children.length&&e.remove())}();const l=new Map;o.forEach(e=>{const t=[];if(e.selectors.forEach(e=>{const n=document.querySelector(e);if(n&&!r.contains(n)&&!n.contains(r)&&!i.includes(e)){if("#pollwrap"===e){const e=n.dataset&&n.dataset.btfwPollOverlay,t=n.getAttribute&&n.getAttribute("data-btfw-poll-overlay");if("video"===e||"video"===t)return}t.push(n)}}),"channels-group"===e.id&&0===t.length){const t=window.BTFW||{};let n=t.channelSliderEnabled||t.channelSlider&&t.channelSlider.enabled||t.channelTheme&&t.channelTheme.slider&&t.channelTheme.slider.enabled;if(void 0===n&&void 0!==window.UI_ChannelList&&(n="1"===window.UI_ChannelList||1===window.UI_ChannelList),!n){(t.channelSliderJSON||t.channelSlider&&t.channelSlider.feedUrl||t.channelTheme&&t.channelTheme.slider&&t.channelTheme.slider.feedUrl||window.Channel_JSON)&&(n=!0)}if(n)return void l.set(e.id,{group:e,elements:[]})}t.length>0&&l.set(e.id,{group:e,elements:t})});const u=function(){try{return JSON.parse(localStorage.getItem(e)||"[]")}catch(e){return[]}}(),f=[];l.forEach(({group:e,elements:t},n)=>{if(!Array.from(r.children).find(e=>e.dataset.bind===n))try{const o=c(e,t);o&&f.push({item:o,id:n,priority:e.priority,isGroup:!0})}catch(e){console.warn("[stack] Failed to create group item:",n,e)}}),u.length>0?f.sort((e,t)=>{const n=u.findIndex(t=>t.id===e.id),o=u.findIndex(e=>e.id===t.id);return n>=0&&o>=0?n-o:n>=0?-1:o>=0?1:e.priority-t.priority}):f.sort((e,t)=>e.priority-t.priority),f.forEach(({item:e})=>{try{!e||r.contains(e)||e.contains(r)||r.appendChild(e)}catch(e){console.warn("[stack] Failed to add item to list:",e)}}),a(n),d(r),function(e){if(!e)return;if(e.querySelector("#btfw-footer"))return;const t=document.getElementById("btfw-footer");if(t&&t!==e&&!e.contains(t))return e.innerHTML="",void e.appendChild(t);const n=document.getElementById("footer")||document.querySelector("footer");n&&!e.contains(n)&&(n.classList.add("btfw-footer"),e.innerHTML="",e.appendChild(n))}(s)}function p(e){n=!!e,a(n)}function b(){const e=s();if(!e)return;m(e);const t=new MutationObserver(()=>m(e)),n=document.getElementById("btfw-leftpad"),o=document.getElementById("main");n&&t.observe(n,{childList:!0,subtree:!1}),o&&t.observe(o,{childList:!0,subtree:!1}),setTimeout(()=>{const e=document.querySelector('.btfw-stack-item[data-bind="playlist-group"]');if(!e)return;const t=u(),n=null===t||t;e.dataset.open=n?"true":"false",e.classList.toggle("is-open",n)},1e3);let i=0;const r=setInterval(()=>{m(e),++i>8&&clearInterval(r)},700)}return document.addEventListener("btfw:layoutReady",b),setTimeout(b,1200),document.addEventListener("btfw:channelThemeTint",()=>{const e=s();e&&setTimeout(()=>m(e),100)}),document.addEventListener("btfw:layout:orientation",()=>{requestAnimationFrame(()=>a(n))}),document.addEventListener("btfw:stack:compactChanged",e=>{e&&e.detail&&"enabled"in e.detail?p(!!e.detail.enabled):a(n)}),{name:"feature:stack",setCompactSpacing:p,getCompactSpacing:function(){return n}}}),BTFW.define("feature:videoOverlay",[],async()=>{const e=(e,t=document)=>t.querySelector(e),t=["#mediarefresh","#voteskip","#fullscreenbtn"],n="btfw:video:localsubs";function o(){const e=(function(){try{return window.PLAYER?.mediaType||null}catch(e){return null}}()||"").toLowerCase();return"fi"===e||"gd"===e}let i=0,r=0,a=0;const s=2e3,l=8e3,c=12e4;let d=l,u=!1,f=null;function m(){const u=e("#videowrap");if(!u)return null;let f=e("#btfw-video-overlay");f||(f=document.createElement("div"),f.id="btfw-video-overlay"),f.classList.add("btfw-video-overlay"),f.parentElement!==u&&u.appendChild(f);let m=f.querySelector("#btfw-vo-bar");m||(m=document.createElement("div"),m.className="btfw-vo-bar",m.id="btfw-vo-bar",f.appendChild(m));const p=function(e,t){const n="btfw-vo-left",o="btfw-vo-right";let i=t.querySelector(`#${n}`);i||(i=document.createElement("div"),i.id=n,i.className="btfw-vo-section btfw-vo-section--left",t.insertBefore(i,t.firstChild));let r=t.querySelector(`#${o}`);r||(r=document.createElement("div"),r.id=o,r.className="btfw-vo-section btfw-vo-section--right",t.appendChild(r));return Array.from(t.children).forEach(e=>{e!==i&&e!==r&&r.appendChild(e)}),e.dataset.leftSection=`#${n}`,e.dataset.rightSection=`#${o}`,t.dataset.leftSection=`#${n}`,t.dataset.rightSection=`#${o}`,{left:i,right:r}}(f,m);return function(e,t){if(t._hoverSetup)return;t._hoverSetup=!0;let n=null;function o(){clearTimeout(n),t.classList.add("btfw-vo-visible"),t.style.pointerEvents="none"}function i(){t.classList.remove("btfw-vo-visible")}function r(){clearTimeout(n),n=setTimeout(i,3e3)}e.addEventListener("mouseenter",o),e.addEventListener("mousemove",()=>{o(),r()}),e.addEventListener("mouseleave",i),t.addEventListener("mouseenter",()=>{clearTimeout(n),o()}),t.addEventListener("mouseleave",r)}(u,f),function(t){if(!t)return;let i=document.querySelector("#btfw-vo-subs");i||(i=document.createElement("button"),i.id="btfw-vo-subs",i.className="btfw-vo-btn",i.title="Load local subtitles (.vtt/.srt)",i.innerHTML='<i class="fa fa-closed-captioning"></i>',i.addEventListener("click",t=>{t.preventDefault(),async function(){const t=e("video");if(!t)return void k("Local subs only for HTML5 sources.");const n=document.createElement("input");n.type="file",n.accept=".vtt,.srt,text/vtt,text/plain",n.style.display="none",document.body.appendChild(n);const o=new Promise(o=>{n.addEventListener("change",async()=>{const i=n.files&&n.files[0];if(document.body.removeChild(n),!i)return o(!1);try{const n=await i.text(),r="srt"===(i.name.split(".").pop()||"").toLowerCase()?function(e){let t=(e||"").replace(/\r\n/g,"\n").trim()+"\n";return t=t.replace(/^\d+\s*$\n/gm,""),t=t.replace(/(\d{2}:\d{2}:\d{2}),(\d{3})/g,"$1.$2"),t=t.replace(/(\d{2}:\d{2}:\d{2}\.\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2}\.\d{3})/g,"$1 --\x3e $2"),"WEBVTT\n\n"+t}(n):n.startsWith("WEBVTT")?n:"WEBVTT\n\n"+n,a=URL.createObjectURL(new Blob([r],{type:"text/vtt"}));!function(t,n,o){e('track[data-btfw="1"]',t)?.remove();const i=document.createElement("track");i.kind="subtitles",i.label=o||"Local",i.srclang="en",i.src=n,i.default=!0,i.setAttribute("data-btfw","1"),t.appendChild(i);try{for(const e of t.textTracks)e.mode=e.label===i.label?"showing":"disabled"}catch(e){}}(t,a,i.name.replace(/\.[^.]+$/,"")||"Local"),k("Subtitles loaded."),o(!0)}catch(e){console.error(e),k("Failed to load subtitles."),o(!1)}},{once:!0})});n.click(),await o}()}),t.insertBefore(i,t.firstChild||null));const r=(()=>{try{return"0"!==localStorage.getItem(n)}catch(e){return!0}})()&&o();i.style.display=r?"":"none"}(p.left),function(e){if(!e?.right||!e?.left)return;const t=[];document.querySelector("#fullscreenbtn")||t.push({id:"btfw-fullscreen",icon:"fas fa-expand",tooltip:"Fullscreen",action:w,section:"right"});t.push({id:"btfw-airplay",icon:"fas fa-cast",tooltip:"AirPlay",action:x,section:"right"}),t.forEach(t=>{let n=document.querySelector(`#${t.id}`);const o="left"===t.section?e.left:e.right;n?o&&n.parentElement!==o&&o.appendChild(n):(n=document.createElement("button"),n.id=t.id,n.className="btfw-vo-btn",n.innerHTML=`<i class="${t.icon}"></i>`,n.title=t.tooltip,n.addEventListener("click",t.action),(o||e.right).appendChild(n))}),v()}(p),function(e){const n=e?.right;if(!n)return;t.forEach(e=>{const t=document.querySelector(e);if(!t)return;if("1"===t.dataset.btfwOverlay)return void(t.parentElement!==n&&n.appendChild(t));const o=document.createElement("span");o.hidden=!0,o.setAttribute("data-btfw-ph",e);try{t.insertAdjacentElement("afterend",o)}catch(e){}if(t.classList.add("btfw-vo-adopted"),t.dataset.btfwOverlay="1","mediarefresh"===t.id){const e=t.onclick;t.onclick=n=>{n.preventDefault();!function(e,t={}){const{isUserAction:n=!1}=t,o=Date.now();a&&o-a>c&&(d=l,i=0);if(o<r){const e=Math.ceil((r-o)/1e3);return E(n?`Refresh available in ${e}s`:`Auto refresh paused. Next attempt in ${e}s`,"warning"),!1}const u=n?s:d;if(a&&o-a<u){const e=u-(o-a),t=Math.ceil(e/1e3);return r=o+e,E(n?`Refresh available in ${t}s`:`Auto refresh paused. Next attempt in ${t}s`,"warning"),!1}if(i++,i>=10)return r=o+3e4,i=0,E("Refresh limit reached. 30s cooldown active.","error"),!1;const f=n?6e3:Math.max(12e3,d+2e3);setTimeout(()=>{i>0&&i--},f);let m=!1;if("function"==typeof e)try{m=!0===e()}catch(e){console.warn("[video-overlay] Refresh handler error:",e)}m||(m=function(){try{if(window.socket)return socket.emit("playerReady"),!0}catch(e){console.warn("[video-overlay] Media refresh failed:",e)}return!1}());if(a=Date.now(),n)d=l;else{const e=m?1.25:1.5;d=Math.min(45e3,Math.max(l,Math.round(d*e)))}const p=n?s:d;r=Math.max(r,a+p),!n&&m?E(`Auto refresh sent. Next attempt in ${Math.ceil(d/1e3)}s`,"info"):E(m?"Media refreshed":"Unable to refresh media",m?"success":"error")}(()=>{if("function"==typeof e)try{return e.call(t,n),!0}catch(e){console.warn("[video-overlay] native refresh handler failed:",e)}return!1},{isUserAction:!(!n||!n.isTrusted)})}}n.appendChild(t)})}(p),function(e){if(!e)return;e.querySelectorAll("button").forEach(e=>{e.classList.contains("btfw-vo-btn")||e.classList.add("btfw-vo-btn")})}(f),f}function p(){return document.querySelector("#ytapiplayer video, video")}function b(e=p()){return!!e&&(void 0!==window.WebKitPlaybackTargetAvailabilityEvent||"function"==typeof e.webkitShowPlaybackTargetPicker)}function h(){if(!f)return;const e=f._btfwAirplayHandler;if(e){try{f.removeEventListener("webkitplaybacktargetavailabilitychanged",e)}catch(e){}delete f._btfwAirplayHandler}f=null}function y(t){if(!t||"function"!=typeof t.addEventListener)return void h();if(f===t)return;h();const n=t=>{const n=!t||"available"===t.availability,o=e("#btfw-airplay");o&&(o.style.display=n?"":"none")};try{t.addEventListener("webkitplaybacktargetavailabilitychanged",n),t._btfwAirplayHandler=n,f=t}catch(e){}}function v(){const t=e("#btfw-airplay");if(!t)return;const n=p();if(!b(n))return t.style.display="none",void h();t.style.display="",y(n)}function w(){const t=e("#videowrap");t&&(document.fullscreenElement?document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen&&document.mozCancelFullScreen():t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.mozRequestFullScreen&&t.mozRequestFullScreen())}function g(e,t=!0){if(!e||!b(e))return!1;if(e.setAttribute("airplay","allow"),e.setAttribute("x-webkit-airplay","allow"),t&&"function"==typeof e.webkitShowPlaybackTargetPicker)try{e.webkitShowPlaybackTargetPicker()}catch(e){console.warn("[video-overlay] AirPlay picker failed:",e)}return v(),!0}function x(){const e=p();return b(e)?g(e)?(E("AirPlay enabled","success"),function(){if(!u&&window.socket){u=!0;try{socket.on("changeMedia",()=>{setTimeout(()=>{const e=p();e&&(g(e,!1),y(e)),v()},1e3)})}catch(e){console.warn("[video-overlay] Failed to attach AirPlay listener:",e)}}}(),!0):(E("AirPlay not available","warning"),!1):(v(),E("AirPlay not available","warning"),!1)}function E(e,t="info"){let n=document.getElementById("btfw-notification");n||(n=document.createElement("div"),n.id="btfw-notification",n.className="btfw-notification",document.body.appendChild(n)),n.textContent=e,n.className=`btfw-notification btfw-notification--${t} btfw-notification--show`,clearTimeout(n._hideTimer),n._hideTimer=setTimeout(()=>{n.classList.remove("btfw-notification--show")},3e3)}function k(t){let n=e("#btfw-mini-toast");n||(n=document.createElement("div"),n.id="btfw-mini-toast",document.body.appendChild(n)),n.textContent=t,n.style.opacity="1",clearTimeout(n._hid),n._hid=setTimeout(()=>n.style.opacity="0",1400)}function T(){!function(){if(e("#btfw-vo-css"))return;const t=document.createElement("style");t.id="btfw-vo-css",t.textContent='\n      #btfw-video-overlay{\n        position:absolute;\n        inset:0;\n        pointer-events:none;\n        z-index: 1000;\n        opacity: 0;\n        transition: opacity 0.3s ease;\n        background: linear-gradient(to bottom, rgba(0, 0, 0, 0.95) 0%, rgba(0, 0, 0, 0.15) 12%, rgba(0, 0, 0, 0) 32%, rgba(0, 0, 0, 0) 55%, transparent 75%);\n      }\n\n      #btfw-video-overlay.btfw-vo-visible {\n        opacity: 1;\n      }\n\n      #btfw-video-overlay .btfw-vo-bar{\n        position:absolute; right:12px; top:12px; left:12px; display:flex; gap:8px; pointer-events:auto;\n        background:transparent;\n      }\n\n      #btfw-video-overlay .btfw-vo-section {\n        display:flex;\n        align-items:center;\n        gap:8px;\n        pointer-events:auto;\n      }\n\n      #btfw-video-overlay .btfw-vo-section--right {\n        margin-left:auto;\n      }\n\n      #btfw-video-overlay .btfw-vo-btn,\n      #btfw-video-overlay .btfw-vo-adopted{\n        all: unset;\n        box-sizing: border-box;\n        display:inline-grid;\n        place-items:center;\n        min-width:44px;\n        height:44px;\n        padding:0;\n        border-radius:22px;\n        border:0;\n        background:rgba(0, 0, 0, 0.42);\n        color:#fff;\n        cursor:pointer;\n        font:600 14px/1.05 "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;\n        letter-spacing: 0.01em;\n        backdrop-filter: blur(12px) saturate(120%);\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.18);\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n        text-decoration:none;\n      }\n\n      #btfw-video-overlay .btfw-vo-btn i,\n      #btfw-video-overlay .btfw-vo-adopted i {\n        transition: transform 0.2s ease;\n        font-size: 16px;\n      }\n\n      #btfw-video-overlay .btfw-vo-btn:hover,\n      #btfw-video-overlay .btfw-vo-adopted:hover{\n        background: rgba(109, 77, 246, 0.82);\n        transform: translateY(-1px);\n        box-shadow: 0 4px 16px rgba(109, 77, 246, 0.36);\n      }\n\n      #btfw-video-overlay .btfw-vo-btn:hover i,\n      #btfw-video-overlay .btfw-vo-adopted:hover i {\n        transform: scale(1.08);\n      }\n\n      #btfw-video-overlay .btfw-vo-btn:active,\n      #btfw-video-overlay .btfw-vo-adopted:active {\n        transform: translateY(0);\n      }\n\n      #btfw-video-overlay .btfw-vo-btn:focus-visible,\n      #btfw-video-overlay .btfw-vo-adopted:focus-visible {\n        outline: 2px solid rgba(109, 77, 246, 0.95);\n        outline-offset: 2px;\n      }\n\n      .btfw-notification {\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        padding: 12px 20px;\n        border-radius: 12px;\n        color: #ffffff;\n        font-size: 14px;\n        font-weight: 500;\n        z-index: 10000;\n        transform: translateX(100%);\n        opacity: 0;\n        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n        backdrop-filter: blur(12px) saturate(120%);\n        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);\n        max-width: 300px;\n      }\n\n      .btfw-notification--show {\n        transform: translateX(0);\n        opacity: 1;\n      }\n\n      .btfw-notification--success {\n        background: rgba(34, 197, 94, 0.9);\n        border: 1px solid rgba(34, 197, 94, 0.3);\n      }\n\n      .btfw-notification--error {\n        background: rgba(239, 68, 68, 0.9);\n        border: 1px solid rgba(239, 68, 68, 0.3);\n      }\n\n      .btfw-notification--warning {\n        background: rgba(245, 158, 11, 0.9);\n        border: 1px solid rgba(245, 158, 11, 0.3);\n      }\n\n      .btfw-notification--info {\n        background: rgba(59, 130, 246, 0.9);\n        border: 1px solid rgba(59, 130, 246, 0.3);\n      }\n\n      #btfw-mini-toast{position:fixed;right:12px;bottom:12px;background:#111a;color:#fff;padding:8px 12px;border-radius:8px;font:12px/1.2 system-ui,Segoe UI,Arial;z-index:99999;pointer-events:none;opacity:0;transition:opacity .2s}\n\n      @media (max-width: 768px) {\n        #btfw-video-overlay .btfw-vo-bar {\n          top: 8px;\n          right: 8px;\n          left: 8px;\n          gap: 6px;\n        }\n\n        #btfw-video-overlay .btfw-vo-section {\n          gap: 6px;\n          flex-wrap: wrap;\n        }\n\n        #btfw-video-overlay .btfw-vo-btn,\n        #btfw-video-overlay .btfw-vo-adopted {\n          min-width: 40px;\n          height: 40px;\n          border-radius: 20px;\n          font-size: 12px;\n        }\n      }\n    ',document.head.appendChild(t)}(),m();const t=[e("#videowrap"),e("#rightcontrols"),e("#leftcontrols"),document.body].filter(Boolean),n=new MutationObserver(()=>m());t.forEach(e=>n.observe(e,{childList:!0,subtree:!0})),document.addEventListener("btfw:video:localsubs:changed",()=>m());try{window.socket&&"function"==typeof socket.on&&socket.on("changeMedia",()=>{setTimeout(()=>m(),0)})}catch(e){}}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",T):T(),{name:"feature:videoOverlay",setLocalSubsEnabled:e=>{try{localStorage.setItem(n,e?"1":"0")}catch(e){}document.dispatchEvent(new CustomEvent("btfw:video:localsubs:changed",{detail:{enabled:!!e}}))},toggleFullscreen:w,enableAirplay:x}}),BTFW.define("feature:videoEnhancements",[],async()=>{function e(){document.querySelectorAll("#currenttitle, .current-title").forEach(e=>{const t=(e.textContent||e.innerText||"").trim();e.style.setProperty("--length",t.length)})}function t(){!function(){const e=document.querySelector(".vjs-fullscreen-control");e&&e.remove()}(),function(){const e=document.querySelector(".vjs-resolution-button");if(!e)return;const t=e.querySelector(".vjs-menu");if(!t)return void(e.style.display="none");t.querySelectorAll(".vjs-menu-item").length<=1&&(e.style.display="none")}()}function n(e){if(!e||!e.value)return;let t=e.value.trim();t&&(t=t.replace("//www.dropbox.com/s/","//dl.dropbox.com/s/").replace("?dl=0","").replace("?a=view",""),e.value=t,setTimeout(()=>{const e=document.querySelector("#addfromurl-title-val, #mediaurl-title, .media-title-input");if(e&&!e.value.trim())try{const n=decodeURI(t).split("/"),o=n[n.length-1].split("?")[0].split(".");let i="";for(let e=0;e<o.length-1;e++)i+=o[e]+(e<o.length-2?".":"");i=i.replace(/[._-]/g," ").replace(/\s+/g," ").trim(),i&&(e.value=i)}catch(e){console.warn("[video-enhancements] Title extraction failed:",e)}},100))}function o(){document.querySelectorAll("#mediaurl, .media-url-input").forEach(e=>{e._btfwUrlBound||(e._btfwUrlBound=!0,e.addEventListener("paste",()=>{setTimeout(()=>n(e),50)}),e.addEventListener("input",()=>{setTimeout(()=>n(e),50)}))})}function i(){setTimeout(()=>{e()},100),setTimeout(t,500),setTimeout(t,1e3),setTimeout(t,2e3)}function r(){if(e(),o(),function(){if(document.getElementById("btfw-video-enhancements-style"))return;const e=document.createElement("style");e.id="btfw-video-enhancements-style",e.textContent="\n      .vjs-fullscreen-control {\n        display: none !important;\n      }\n    ",document.head.appendChild(e)}(),t(),setTimeout(t,500),setTimeout(t,1e3),setTimeout(t,2e3),window.socket)try{socket.on("changeMedia",i)}catch(e){console.warn("[video-enhancements] Failed to bind changeMedia:",e)}new MutationObserver(()=>{o()}).observe(document.body,{childList:!0,subtree:!0})}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",r):r(),{name:"feature:videoEnhancements",updateTitleLength:e}}),BTFW.define("feature:ambient",[],async()=>{const e=(e,t=document)=>t.querySelector(e);function t(){const e=(function(){try{return window.PLAYER?.mediaType||null}catch(e){return null}}()||"").toLowerCase();return"fi"===e||"gd"===e}let n=!1,o=null,i=null,r=null,a=null,s=null,l=null,c=!1,d=null;function u(t=null){const i=t||e("#videowrap");return i?(o&&o!==i&&(o.classList.remove("btfw-ambient-ready"),o=null),o=i,n&&o.classList.add("btfw-ambient-ready"),o):null}function f(){return e("#ytapiplayer video")||e("#videowrap video")||document.querySelector("video")}function m(){const e=document.querySelector(".btfw-ambient-glow-bg");e&&e.parentNode&&e.parentNode.removeChild(e),s=null,a=null}function p(){if(m(),!o)return;f()&&(s=document.createElement("div"),s.className="btfw-ambient-glow-bg",s.setAttribute("aria-hidden","true"),a=document.createElement("video"),a.muted=!0,a.playsInline=!0,a.loop=!0,a.preload="auto",a.setAttribute("aria-hidden","true"),a.controls=!1,a.disablePictureInPicture=!0,s.appendChild(a),document.body.appendChild(s),b(),n&&s.classList.add("btfw-ambient-active"))}function b(){if(!s||!o)return;const e=o.getBoundingClientRect(),t=100;s.style.top=e.top-t+"px",s.style.left=e.left-t+"px",s.style.width=`${e.width+200}px`,s.style.height=`${e.height+200}px`}function h(){if(r&&a)try{const e=r.src||r.currentSrc;e&&a.src!==e&&(a.src=e);Math.abs(r.currentTime-a.currentTime)>.3&&(a.currentTime=r.currentTime),!r.paused&&a.paused?a.play().catch(()=>{}):r.paused&&!a.paused&&a.pause()}catch(e){}}function y(){if(!r||!d)return;["loadeddata","play","pause","seeked","timeupdate","ended","emptied"].forEach(e=>{try{r.removeEventListener(e,d)}catch(e){}}),d=null,r=null}function v(e){if(r===e)return;if(y(),r=e&&"VIDEO"===e.tagName?e:null,!r)return;s||p(),d=()=>h();["loadeddata","play","pause","seeked","timeupdate"].forEach(e=>{try{r.addEventListener(e,d)}catch(e){}}),h()}function w(){if(i)return;i=window.setInterval(()=>{if(!n)return;const t=e("#videowrap");t?t===o&&o&&o.classList.contains("btfw-ambient-ready")||u(t):o&&!o.isConnected&&(o.classList.remove("btfw-ambient-ready"),o=null);const i=f();i!==r&&v(i),b()},500);const a=()=>{n&&b()};window.addEventListener("scroll",a,{passive:!0}),window.addEventListener("resize",a,{passive:!0}),function(){if(c)return;try{window.socket&&"function"==typeof socket.on&&(c=!0,socket.on("changeMedia",()=>{n&&setTimeout(()=>{n&&(t()?(u(),v(f())):x())},400)}))}catch(e){}}()}async function g(){if(n)return!0;if(!t())return console.warn("[ambient] Ambient mode requires direct media (fi/gd)."),!1;!function(){if(document.getElementById("btfw-ambient-css"))return;const e=document.createElement("style");e.id="btfw-ambient-css",e.textContent="\n      /* Only apply styles when ambient is actually active */\n      \n      /* Ambient glow background layer - behind everything in videowrap */\n      .btfw-ambient-glow-bg {\n        position: fixed;\n        pointer-events: none;\n        z-index: -1;\n        opacity: 0;\n        transition: opacity 0.6s ease;\n        will-change: opacity;\n        mix-blend-mode: screen;\n      }\n\n      .btfw-ambient-glow-bg.btfw-ambient-active {\n        opacity: 1;\n      }\n\n      /* Cloned video for glow effect */\n      .btfw-ambient-glow-bg video {\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%) scale(1.3);\n        width: 100%;\n        height: 100%;\n        object-fit: cover;\n        filter: blur(clamp(60px, 8vw, 90px)) saturate(280%) brightness(1.8) contrast(1.3);\n        opacity: 1;\n      }\n\n      /* Make sure content stays above the glow */\n      body.btfw-ambient-active #main,\n      body.btfw-ambient-active #videowrap,\n      body.btfw-ambient-active #chatwrap {\n        position: relative;\n        z-index: 2;\n      }\n\n      /* Reduce background opacity when ambient is active to let glow shine through */\n      body.btfw-ambient-active,\n      html[data-btfw-theme] body.btfw-ambient-active {\n        background-color: color-mix(in srgb, var(--btfw-theme-bg, #13030c) 40%, transparent) !important;\n      }\n\n      body.btfw-ambient-active #main,\n      body.btfw-ambient-active #chatwrap,\n      body.btfw-ambient-active #videowrap,\n      body.btfw-ambient-active .panel,\n      body.btfw-ambient-active #userlist,\n      body.btfw-ambient-active #messagebuffer,\n      body.btfw-ambient-active #chatline {\n        background-color: color-mix(in srgb, var(--btfw-theme-bg) 40%, transparent) !important;\n      }\n\n      body.btfw-ambient-active #chatwrap,\n      body.btfw-ambient-active #userlist {\n        background-color: color-mix(in srgb, var(--btfw-theme-surface) 40%, transparent) !important;\n      }\n\n      body.btfw-ambient-active .panel-heading,\n      body.btfw-ambient-active .panel-body {\n        background-color: color-mix(in srgb, var(--btfw-theme-panel) 40%, transparent) !important;\n      }\n\n      /* Isolation only when ready */\n      #videowrap.btfw-ambient-ready {\n        isolation: isolate;\n      }\n\n      /* Mobile optimizations */\n      @media (max-width: 768px) {\n        .btfw-ambient-glow-bg video {\n          transform: translate(-50%, -50%) scale(1.2);\n          filter: blur(clamp(50px, 10vw, 70px)) saturate(260%) brightness(1.7) contrast(1.25);\n          opacity: 0.95;\n        }\n      }\n    ",document.head.appendChild(e)}();const o=e("#videowrap")||await function(t=5e3){if(l)return l;const n=e("#videowrap");return n?Promise.resolve(n):(l=new Promise(n=>{if(!document.body)return void n(null);const o=Date.now()+t,i=new MutationObserver(()=>{const t=e("#videowrap");t?(i.disconnect(),l=null,n(t)):Date.now()>o&&(i.disconnect(),l=null,n(null))});i.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{i.disconnect(),l=null,n(e("#videowrap"))},t)}),l)}();if(!o)return console.warn("[ambient] Unable to locate #videowrap for ambient mode."),!1;n=!0,u(o),document.body.classList.add("btfw-ambient-active");const i=f();return i&&(p(),v(i)),w(),E(),!0}async function x(){return!n||(n=!1,document.body.classList.remove("btfw-ambient-active"),o&&o.classList.remove("btfw-ambient-ready"),s&&(s.classList.remove("btfw-ambient-active"),setTimeout(()=>{m()},600)),i&&(clearInterval(i),i=null),window.removeEventListener("scroll",b),window.removeEventListener("resize",b),y(),E(),!0)}function E(){document.dispatchEvent(new CustomEvent("btfw:ambient:state",{detail:{active:!!n}}))}function k(){E()}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",k):k(),{name:"feature:ambient",enable:g,disable:x,toggle:async function(){return await(n?x():g())&&n},refresh:function(){n&&(u(),p(),v(f()))},isActive:function(){return!!n},isSupported:function(){return!0}}}),BTFW.define("feature:pip",["feature:layout"],async({})=>{const e="btfw:pip";function t(){try{return"1"===localStorage.getItem(e)}catch(e){return!!window.BTFW_PIP}}function n(t){try{localStorage.setItem(e,t?"1":"0")}catch(e){}window.BTFW_PIP=!!t,document.dispatchEvent(new CustomEvent("btfw:pip:refresh"))}let o=null,i=null,r=null;function a(){const e=document.getElementById("videowrap");if(!e)return;const t=function(){const e=document.getElementById("btfw-chatcol");if(!e)return null;let t=document.getElementById("btfw-pip-dock");return t||(t=document.createElement("div"),t.id="btfw-pip-dock",e.prepend(t)),t}();t&&(t.contains(e)||(i=e.parentNode,r=e.nextSibling,t.appendChild(e),e.classList.add("btfw-pip")))}function s(){const e=document.getElementById("videowrap");e&&(i&&!i.contains(e)&&(r?i.insertBefore(e,r):i.appendChild(e)),e.classList.remove("btfw-pip"))}function l(){c();const e=document.getElementById("videowrap");e&&(o=new IntersectionObserver(e=>{const t=e[0];t&&(t.intersectionRatio<.1?a():s())},{threshold:[0,.1,.5,1]}),o.observe(e))}function c(){o&&(o.disconnect(),o=null),s()}return document.addEventListener("btfw:pip:refresh",function(){t()?l():c()}),t()&&l(),window.BTFW_setPiP=n,{name:"feature:pip",set:n}}),BTFW.define("feature:resize",[],async()=>({name:"feature:resize"})),function(){"use strict";const e=["cytube.billtube.workers.dev","billtube.workers.dev"];function t(){return Date.now()}window.BTFW_AUDIO={audioContext:null,sourceNode:null,compressorNode:null,gainNode:null,player:null,originalSrc:null,proxiedSrc:null,isProxied:!1,boostEnabled:!1,normalizationEnabled:!1,CORS_PROXY:"https://vidprox.billtube.workers.dev/?url=",BOOST_MULTIPLIER:2.5,currentNormPreset:"youtube",_watchdogInterval:null,_mutationObserver:null,_lastKnownSrc:null,_lastInternalSrcSetAt:0,_lastAutoReapplyAt:0,NORM_PRESETS:{gentle:{threshold:-12,knee:20,ratio:6,attack:.01,release:.5,label:"Gentle"},youtube:{threshold:-24,knee:30,ratio:12,attack:.003,release:.25,label:"YouTube"},aggressive:{threshold:-50,knee:40,ratio:12,attack:.001,release:.25,label:"Aggressive"}},_isTrusted(t){try{const n=new URL(t);return e.some(e=>n.hostname===e)}catch{return!1}},_markInternalSrcSet(){this._lastInternalSrcSetAt=t()},_isInsideInternalWindow(){return t()-this._lastInternalSrcSetAt<=2e3},_shouldForceProxy(){return this.boostEnabled||this.normalizationEnabled},_same:(e,t)=>String(e||"")===String(t||""),disconnectChain(){if(this.sourceNode)try{this.sourceNode.disconnect()}catch(e){}if(this.compressorNode){try{this.compressorNode.disconnect()}catch(e){}this.compressorNode=null}if(this.gainNode){try{this.gainNode.disconnect()}catch(e){}this.gainNode=null}},cleanup(){this.disconnectChain(),this.audioContext&&"closed"!==this.audioContext.state&&(this.audioContext.close().catch(()=>{}),this.audioContext=null),this.sourceNode=null,this.player&&this.player.tech_&&this.player.tech_.el_&&(this.player.tech_.el_.disableRemotePlayback=!1),this.stopWatchdog()},startWatchdog(){if(!this.player)return;this.stopWatchdog();const e=this.player.tech_?.el?.()||this.player.tech_?.el_||document.querySelector("#ytapiplayer video");if(e&&"undefined"!=typeof MutationObserver){this._mutationObserver=new MutationObserver(()=>{this._checkAndReapply("mutation")}),this._mutationObserver.observe(e,{attributes:!0,attributeFilter:["src","crossorigin"]});const t=new MutationObserver(()=>{this._checkAndReapply("sources")});t.observe(e,{childList:!0,subtree:!0}),this._mutationObserver._sourceObserver=t}try{this.player.on("sourceset",()=>this._checkAndReapply("sourceset")),this.player.on("loadstart",()=>this._checkAndReapply("loadstart")),this.player.on("loadedmetadata",()=>this._checkAndReapply("loadedmetadata")),this.player.on("stalled",()=>this._checkAndReapply("stalled")),this.player.on("error",()=>this._checkAndReapply("error"))}catch{}this._watchdogInterval=setInterval(()=>this._checkAndReapply("interval"),800),this._lastKnownSrc=this.player.currentSrc()},stopWatchdog(){if(this._watchdogInterval&&(clearInterval(this._watchdogInterval),this._watchdogInterval=null),this._mutationObserver){try{this._mutationObserver.disconnect()}catch{}try{this._mutationObserver._sourceObserver?.disconnect()}catch{}this._mutationObserver=null}},_checkAndReapply(e){if(!this.player)return;const n=this.player.currentSrc();if(!n)return;if(this._lastKnownSrc=n,this._isInsideInternalWindow())return;if(n.includes(this.CORS_PROXY))return this.isProxied=!0,void(this.proxiedSrc=n);if(this._isTrusted(n)){if(this._shouldForceProxy())try{this.player.crossOrigin("anonymous")}catch{}return this.isProxied=!1,void(this.originalSrc=n)}if(this._shouldForceProxy()){if(t()-this._lastAutoReapplyAt<800)return;this._lastAutoReapplyAt=t(),this._forceProxyPreservingState(n)}},async _forceProxyPreservingState(e){if(!this.player)return;const t=this.player.currentTime(),n=!this.player.paused();this.originalSrc=e,this.proxiedSrc=this.CORS_PROXY+encodeURIComponent(e);try{this.player.pause()}catch{}try{this.player.crossOrigin("anonymous")}catch{}this._markInternalSrcSet(),this.player.src({src:this.proxiedSrc,type:"video/mp4"});try{this.player.load()}catch{}const o=()=>{try{this.player.currentTime(t)}catch{}this.isProxied=!0,n&&this.player.play().catch(()=>{})};"function"==typeof this.player.ready?this.player.ready(o):setTimeout(o,300)},async ensureProxy(){if(!this.player)return!1;const e=this.player.currentSrc();if(!e)return!1;if(e.includes(this.CORS_PROXY))return this.isProxied=!0,this.proxiedSrc=e,!0;try{new URL(e);if(this._isTrusted(e)){const t=this.player.currentTime(),n=!this.player.paused();this.originalSrc=e;try{this.player.pause()}catch{}try{this.player.crossOrigin("anonymous")}catch{}this._markInternalSrcSet(),this.player.src({src:e,type:"video/mp4"});try{this.player.load()}catch{}return new Promise(e=>{this.player.ready(()=>{try{this.player.currentTime(t)}catch{}this.isProxied=!1,n&&this.player.play().catch(()=>{}),e(!0)})})}}catch(e){console.warn("[BTFW_AUDIO] Invalid URL:",e)}return this._forceProxyPreservingState(e),!0},async rebuildAudioChain(){if(!this.player||!this.player.tech_||!this.player.tech_.el_)return console.error("[BTFW_AUDIO] Player not ready"),!1;if(this.boostEnabled||this.normalizationEnabled)if(this.isProxied||this._isTrusted(this.player.currentSrc()))try{this.player.crossOrigin("anonymous")}catch{}else await this.ensureProxy();this.disconnectChain();try{this.audioContext&&"closed"!==this.audioContext.state||(this.audioContext=new(window.AudioContext||window.webkitAudioContext));const e=this.player.tech().el();this.player.tech_&&this.player.tech_.el_&&(this.player.tech_.el_.disableRemotePlayback=!0),this.sourceNode||(this.sourceNode=this.audioContext.createMediaElementSource(e));let t=this.sourceNode;if(this.normalizationEnabled){this.compressorNode=this.audioContext.createDynamicsCompressor();const e=this.NORM_PRESETS[this.currentNormPreset];this.compressorNode.threshold.setValueAtTime(e.threshold,this.audioContext.currentTime),this.compressorNode.knee.setValueAtTime(e.knee,this.audioContext.currentTime),this.compressorNode.ratio.setValueAtTime(e.ratio,this.audioContext.currentTime),this.compressorNode.attack.setValueAtTime(e.attack,this.audioContext.currentTime),this.compressorNode.release.setValueAtTime(e.release,this.audioContext.currentTime),t.connect(this.compressorNode),t=this.compressorNode}return this.boostEnabled&&(this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=this.BOOST_MULTIPLIER,t.connect(this.gainNode),t=this.gainNode),t.connect(this.audioContext.destination),this.startWatchdog(),console.log("[BTFW_AUDIO] Chain rebuilt:",{normalization:this.normalizationEnabled,boost:this.boostEnabled,proxied:this.isProxied}),!0}catch(e){return console.error("[BTFW_AUDIO] Error building audio chain:",e),this.cleanup(),!1}},async enableBoost(){this.boostEnabled=!0;const e=await this.rebuildAudioChain();return e&&this.startWatchdog(),e},async disableBoost(){if(this.boostEnabled=!1,this.normalizationEnabled){const e=await this.rebuildAudioChain();return this._shouldForceProxy()||this.stopWatchdog(),e}if(this.cleanup(),this.originalSrc&&this.isProxied){const e=this.player.currentTime(),t=!this.player.paused();try{this.player.pause()}catch{}try{this.player.crossOrigin(null)}catch{}this._markInternalSrcSet(),this.player.src({src:this.originalSrc,type:"video/mp4"});try{this.player.load()}catch{}this.player.ready(()=>{try{this.player.currentTime(e)}catch{}this.isProxied=!1,t&&this.player.play().catch(()=>{})})}return!0},async enableNormalization(){this.normalizationEnabled=!0;const e=await this.rebuildAudioChain();return e&&this.startWatchdog(),e},async setNormPreset(e){return!!this.NORM_PRESETS[e]&&(this.currentNormPreset=e,!this.normalizationEnabled||await this.rebuildAudioChain())},async setBoostMultiplier(e){return this.BOOST_MULTIPLIER=e,!this.boostEnabled||await this.rebuildAudioChain()},async disableNormalization(){if(this.normalizationEnabled=!1,this.boostEnabled){const e=await this.rebuildAudioChain();return this._shouldForceProxy()||this.stopWatchdog(),e}if(this.cleanup(),this.originalSrc&&this.isProxied){const e=this.player.currentTime(),t=!this.player.paused();try{this.player.pause()}catch{}try{this.player.crossOrigin(null)}catch{}this._markInternalSrcSet(),this.player.src({src:this.originalSrc,type:"video/mp4"});try{this.player.load()}catch{}this.player.ready(()=>{try{this.player.currentTime(e)}catch{}this.isProxied=!1,t&&this.player.play().catch(()=>{})})}return!0}}}(),function(){"use strict";!function e(t){window.BTFW&&"function"==typeof BTFW.define?t():setTimeout(()=>e(t),100)}(function(){BTFW.define("feature:audioboost",[],async()=>{const e=(e,t=document)=>t.querySelector(e),t=window.BTFW_AUDIO;let n=null,o=!1,i=null;const r=[{multiplier:1.5,label:"150%"},{multiplier:2.5,label:"250%"},{multiplier:3.5,label:"350%"}];function a(e){n&&(e?(n.classList.add("active"),n.style.background="rgba(46, 213, 115, 0.3)",n.style.borderColor="#2ed573",n.style.color="#2ed573",n.style.boxShadow="0 0 12px rgba(46, 213, 115, 0.6)"):(n.classList.remove("active"),n.style.background="",n.style.borderColor="",n.style.color="",n.style.boxShadow=""))}function s(t,n="info"){let o=e("#btfw-audioboost-toast");o||(o=document.createElement("div"),o.id="btfw-audioboost-toast",o.style.cssText=`\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            background: ${"success"===n?"rgba(46, 213, 115, 0.9)":"rgba(235, 77, 75, 0.9)"};\n            color: white;\n            padding: 12px 20px;\n            border-radius: 8px;\n            font-size: 14px;\n            font-family: system-ui, -apple-system, sans-serif;\n            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n            z-index: 10000;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n            pointer-events: none;\n          `,document.body.appendChild(o)),o.textContent=t,o.style.background="success"===n?"rgba(46, 213, 115, 0.9)":"rgba(235, 77, 75, 0.9)",o.style.opacity="1",setTimeout(()=>{o.style.opacity="0"},2e3)}async function l(){if(await t.enableBoost()){o=!0;s(`Boosted by ${Math.round(100*t.BOOST_MULTIPLIER)}%`,"success"),a(!0)}else s("Failed to activate boost","error")}async function c(){await t.disableBoost(),o=!1,a(!1)}function d(){const e=document.createElement("button");e.id="btfw-vo-audioboost",e.className="btn btn-sm btn-default btfw-vo-adopted";const o=Math.round(100*t.BOOST_MULTIPLIER);return e.title=`Toggle Audio Boost (${o}%)`,e.setAttribute("data-btfw-overlay","1"),e.innerHTML='<i class="fa-solid fa-megaphone"></i>',e.addEventListener("click",()=>{t.boostEnabled?c():l()}),e.addEventListener("mouseenter",()=>function(){if(!n)return;const e=function(){if(i)return i;const e=document.createElement("div");return e.id="btfw-boost-context-menu",e.style.cssText="\n          position: absolute;\n          background: rgba(20, 31, 54, 0.95);\n          backdrop-filter: blur(10px);\n          border: 1px solid rgba(109, 77, 246, 0.3);\n          border-radius: 8px;\n          padding: 6px;\n          display: none;\n          z-index: 10000;\n          min-width: 100px;\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);\n        ",r.forEach(o=>{const a=document.createElement("button");a.className="btfw-context-item",a.textContent=o.label,a.style.cssText="\n            display: block;\n            width: 100%;\n            padding: 6px 12px;\n            background: transparent;\n            border: none;\n            color: #e0e0e0;\n            text-align: left;\n            cursor: pointer;\n            border-radius: 4px;\n            font-size: 13px;\n            transition: all 0.2s ease;\n          ",t.BOOST_MULTIPLIER===o.multiplier&&(a.style.background="rgba(46, 213, 115, 0.2)",a.style.color="#2ed573"),a.addEventListener("mouseenter",()=>{t.BOOST_MULTIPLIER!==o.multiplier&&(a.style.background="rgba(109, 77, 246, 0.2)")}),a.addEventListener("mouseleave",()=>{t.BOOST_MULTIPLIER!==o.multiplier&&(a.style.background="transparent")}),a.addEventListener("click",async()=>{if(await t.setBoostMultiplier(o.multiplier),function(){if(!i)return;i.querySelectorAll(".btfw-context-item").forEach((e,n)=>{const o=r[n];t.BOOST_MULTIPLIER===o.multiplier?(e.style.background="rgba(46, 213, 115, 0.2)",e.style.color="#2ed573"):(e.style.background="transparent",e.style.color="#e0e0e0")})}(),n){const e=Math.round(100*o.multiplier);n.title=`Toggle Audio Boost (${e}%)`}t.boostEnabled&&s(`Boost set to ${o.label}`,"success")}),e.appendChild(a)}),e.addEventListener("mouseleave",()=>{setTimeout(()=>{n?.matches(":hover")||u()},100)}),document.body.appendChild(e),i=e,e}(),o=n.getBoundingClientRect();e.style.left=o.left+"px",e.style.top=o.bottom+5+"px",e.style.display="block"}()),e.addEventListener("mouseleave",()=>{setTimeout(()=>{i?.matches(":hover")||e.matches(":hover")||u()},100)}),e}function u(){i&&(i.style.display="none")}function f(t,o=20){let i=0;const r=setInterval(()=>{i++,!function(){const t=e("#btfw-vo-left");if(!t)return!1;const o=e("#btfw-vo-audioboost");return o&&o.remove(),n=d(),t.appendChild(n),!0}()?i>=o&&clearInterval(r):(clearInterval(r),t())},500)}function m(){if("undefined"==typeof videojs)return void setTimeout(m,500);e("#ytapiplayer")?(t.player=videojs("ytapiplayer"),t.originalSrc=t.player.currentSrc(),t.startWatchdog()):setTimeout(m,500)}function p(){setTimeout(()=>{t.cleanup(),t.isProxied=!1,a(!1),m(),o&&setTimeout(()=>{l()},1200)},600)}function b(){f(()=>{m()}),"undefined"!=typeof socket&&socket.on&&(socket.on("disconnect",()=>{}),socket.on("connect",()=>{setTimeout(()=>t._checkAndReapply("socket-connect"),500)}),socket.on("reconnect",()=>{setTimeout(()=>t._checkAndReapply("socket-reconnect"),500)}),socket.on("changeMedia",p))}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",b):b(),{name:"feature:audioboost",activate:l,deactivate:c,isActive:()=>t.boostEnabled}}),window.BTFW&&"function"==typeof BTFW.init&&BTFW.init("feature:audioboost").catch(()=>{})})}(),function(){"use strict";!function e(t){window.BTFW&&"function"==typeof BTFW.define?t():setTimeout(()=>e(t),100)}(function(){BTFW.define("feature:audionorm",[],async()=>{const e=(e,t=document)=>t.querySelector(e),t=window.BTFW_AUDIO;let n=null,o=!1,i=null;function r(e){n&&(e?(n.classList.add("active"),n.style.background="rgba(52, 152, 219, 0.3)",n.style.borderColor="#3498db",n.style.color="#3498db",n.style.boxShadow="0 0 12px rgba(52, 152, 219, 0.6)"):(n.classList.remove("active"),n.style.background="",n.style.borderColor="",n.style.color="",n.style.boxShadow=""))}function a(t,n="info"){let o=e("#btfw-audionorm-toast");o||(o=document.createElement("div"),o.id="btfw-audionorm-toast",o.style.cssText=`\n            position: fixed;\n            top: 70px;\n            right: 20px;\n            background: ${"success"===n?"rgba(52, 152, 219, 0.9)":"rgba(235, 77, 75, 0.9)"};\n            color: white;\n            padding: 12px 20px;\n            border-radius: 8px;\n            font-size: 14px;\n            font-family: system-ui, -apple-system, sans-serif;\n            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n            z-index: 10000;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n            pointer-events: none;\n          `,document.body.appendChild(o)),o.textContent=t,o.style.background="success"===n?"rgba(52, 152, 219, 0.9)":"rgba(235, 77, 75, 0.9)",o.style.opacity="1",setTimeout(()=>{o.style.opacity="0"},2e3)}async function s(){await t.enableNormalization()?(o=!0,a("Normalization enabled","success"),r(!0)):a("Failed to activate","error")}async function l(){await t.disableNormalization(),o=!1,r(!1)}function c(){const e=document.createElement("button");e.id="btfw-vo-audionorm",e.className="btn btn-sm btn-default btfw-vo-adopted";const o=t.NORM_PRESETS[t.currentNormPreset].label;return e.title=`Toggle Audio Normalization (${o})`,e.setAttribute("data-btfw-overlay","1"),e.innerHTML='<i class="fa-solid fa-waveform-lines"></i>',e.addEventListener("click",()=>{t.normalizationEnabled?l():s()}),e.addEventListener("mouseenter",()=>function(){if(!n)return;const e=function(){if(i)return i;const e=document.createElement("div");return e.id="btfw-norm-context-menu",e.style.cssText="\n          position: absolute;\n          background: rgba(20, 31, 54, 0.95);\n          backdrop-filter: blur(10px);\n          border: 1px solid rgba(52, 152, 219, 0.3);\n          border-radius: 8px;\n          padding: 6px;\n          display: none;\n          z-index: 10000;\n          min-width: 110px;\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);\n        ",Object.keys(t.NORM_PRESETS).forEach(o=>{const r=t.NORM_PRESETS[o],s=document.createElement("button");s.className="btfw-context-item",s.textContent=r.label,s.style.cssText="\n            display: block;\n            width: 100%;\n            padding: 6px 12px;\n            background: transparent;\n            border: none;\n            color: #e0e0e0;\n            text-align: left;\n            cursor: pointer;\n            border-radius: 4px;\n            font-size: 13px;\n            transition: all 0.2s ease;\n          ",t.currentNormPreset===o&&(s.style.background="rgba(52, 152, 219, 0.2)",s.style.color="#3498db"),s.addEventListener("mouseenter",()=>{t.currentNormPreset!==o&&(s.style.background="rgba(109, 77, 246, 0.2)")}),s.addEventListener("mouseleave",()=>{t.currentNormPreset!==o&&(s.style.background="transparent")}),s.addEventListener("click",async()=>{await t.setNormPreset(o),function(){if(!i)return;const e=i.querySelectorAll(".btfw-context-item");Object.keys(t.NORM_PRESETS).forEach((n,o)=>{const i=e[o];t.currentNormPreset===n?(i.style.background="rgba(52, 152, 219, 0.2)",i.style.color="#3498db"):(i.style.background="transparent",i.style.color="#e0e0e0")})}(),n&&(n.title=`Toggle Audio Normalization (${r.label})`),t.normalizationEnabled&&a(`Preset: ${r.label}`,"success")}),e.appendChild(s)}),e.addEventListener("mouseleave",()=>{setTimeout(()=>{n?.matches(":hover")||d()},100)}),document.body.appendChild(e),i=e,e}(),o=n.getBoundingClientRect();e.style.left=o.left+"px",e.style.top=o.bottom+5+"px",e.style.display="block"}()),e.addEventListener("mouseleave",()=>{setTimeout(()=>{i?.matches(":hover")||e.matches(":hover")||d()},100)}),e}function d(){i&&(i.style.display="none")}function u(t,o=20){let i=0;const r=setInterval(()=>{i++,!function(){const t=e("#btfw-vo-left");if(!t)return!1;const o=e("#btfw-vo-audionorm");return o&&o.remove(),n=c(),t.appendChild(n),!0}()?i>=o&&clearInterval(r):(clearInterval(r),t())},500)}function f(){if("undefined"==typeof videojs)return void setTimeout(f,500);e("#ytapiplayer")?(t.player||(t.player=videojs("ytapiplayer"),t.originalSrc=t.player.currentSrc()),t.startWatchdog()):setTimeout(f,500)}function m(){setTimeout(()=>{t.cleanup(),t.isProxied=!1,r(!1),f(),o&&setTimeout(()=>{s()},1200)},600)}function p(){u(()=>{f()}),"undefined"!=typeof socket&&socket.on&&(socket.on("disconnect",()=>{}),socket.on("connect",()=>setTimeout(()=>t._checkAndReapply("socket-connect"),500)),socket.on("reconnect",()=>setTimeout(()=>t._checkAndReapply("socket-reconnect"),500)),socket.on("changeMedia",m))}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",p):p(),{name:"feature:audionorm",activate:s,deactivate:l,isActive:()=>t.normalizationEnabled}}),window.BTFW&&"function"==typeof BTFW.init&&BTFW.init("feature:audionorm").catch(()=>{})})}(),BTFW.define("ext:autosubs",[],async()=>{const e=(e,t=document)=>t.querySelector(e),t="https://api.themoviedb.org/3";let n="",o=null,i=new Map,r=[],a=null,s=null,l=null,c=!1,d=null;function u(){const e=window.PLAYER?.mediaType;return"fi"===e||"gd"===e}function f(){if(s&&"function"==typeof s.addRemoteTextTrack)return s;const t=e("#videowrap");if(!t)return null;const n=t.querySelector("video");if(!n)return null;if("function"==typeof videojs)try{return s=videojs(n),s}catch(e){}return null}function m(){return l||(window.socket&&"function"==typeof window.socket.on?(l=window.socket,l):null)}function p(e){return e.toLowerCase().replace(/[^\w\s]/g," ").replace(/\s+/g," ").trim()}function b(e,t,n=null,o=null){const i=p(e),r=p(t);return!(i!==r&&r!==i&&r.replace(/^(the|a|an)\s+/,"")!==i.replace(/^(the|a|an)\s+/,""))&&(!n||!o||Math.abs(n-o)<=1)}function h(){const e=f();if(e){r.forEach(t=>{try{if(t&&t.track){const n=t.track.src;n&&n.startsWith("blob:")&&URL.revokeObjectURL(n),e.removeRemoteTextTrack(t.track)}}catch(e){}}),r=[];try{const t=e.remoteTextTracks(),n=[];for(let e=0;e<t.length;e++){const o=t[e];o.src&&o.src.startsWith("blob:")&&n.push(o)}n.forEach(t=>{try{URL.revokeObjectURL(t.src),e.removeRemoteTextTrack(t)}catch(e){}})}catch(e){}}}async function y(e){if(!e.url)return null;try{const t=await fetch(e.url);if(!t.ok)return null;const n=function(e){let t="WEBVTT\n\n";return t+=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/(\d{2}):(\d{2}):(\d{2}),(\d{3})/g,"$1:$2:$3.$4").replace(/^\d+\n/gm,"").trim(),t}(await t.text()),o=new Blob([n],{type:"text/vtt"});return{url:URL.createObjectURL(o),lang:"en"}}catch(e){return null}}function v(e){const t=f();if(!t||!Array.isArray(e)||0===e.length)return!1;if("function"!=typeof t.addRemoteTextTrack)return!1;const n=t.remoteTextTracks();if(n&&Array.from(n).some(e=>e.src&&e.src.startsWith("blob:")))return!1;h();const o=[];return e.forEach((e,n)=>{if(!e.url)return;const i=`Sub ${n+1}`;try{const n=t.addRemoteTextTrack({kind:"subtitles",src:e.url,srclang:"en",label:i},!1);n&&o.push(n)}catch(e){}}),r=o,a=e,o.length>0}function w(){d||(d=setInterval(()=>{if(!u())return g(),void h();const e=f();if(!e||!a||0===a.length)return;const t=e.remoteTextTracks();!(t&&Array.from(t).some(e=>e.src&&e.src.startsWith("blob:")))&&r.length>0&&(r=[],setTimeout(()=>{v(a)},100))},1e3))}function g(){d&&(clearInterval(d),d=null)}async function x(){const r=function(){const t=e("#currenttitle");return t?t.textContent.trim():""}();if(r&&!c&&r!==n){if(!u())return n=r,h(),void g();n=r,c=!0;try{const e=f();if(!e||"function"!=typeof e.addRemoteTextTrack)return;if(i.has(r)){const e=i.get(r);if(e){v(e)&&w()}return}let n=null,a=null,s=null;const l=r.match(/S(\d+)E(\d+)/i);l&&(a=parseInt(l[1],10),s=parseInt(l[2],10));const{title:c,year:d}=function(e){const t=e.match(/^(.+?)\s*\((\d{4})\)\s*$/);if(t)return{title:t[1].trim(),year:parseInt(t[2]),originalTitle:e};const n=e.match(/^(.+?)\s+(\d{4})\s*$/);return n?{title:n[1].trim(),year:parseInt(n[2]),originalTitle:e}:{title:e.trim(),year:null,originalTitle:e}}(r),u=function(e){let t=e;return["Extended","Director's Cut","Directors Cut","Unrated","Theatrical Cut","Remastered"].forEach(e=>{const n=new RegExp(`\\b${e}\\b`,"gi");t=t.replace(n,"")}),t.replace(/\s{2,}/g," ").trim()}(c);if(n=await async function(e,n){if(!o)return null;let i=`${t}/search/movie?api_key=${o}&query=${encodeURIComponent(e)}`;n&&(i+=`&primary_release_year=${n}`);try{const r=await fetch(i),a=await r.json();if(a.results&&a.results.length>0){for(const i of a.results){const r=i.release_date?parseInt(i.release_date.substring(0,4)):null;if(b(e,i.title,n,r)){const e=await fetch(`${t}/movie/${i.id}/external_ids?api_key=${o}`);return(await e.json()).imdb_id||null}}if(n)for(const e of a.results)if((e.release_date?parseInt(e.release_date.substring(0,4)):null)===n){const n=await fetch(`${t}/movie/${e.id}/external_ids?api_key=${o}`);return(await n.json()).imdb_id||null}}}catch(e){}if(n){const n=`${t}/search/movie?api_key=${o}&query=${encodeURIComponent(e)}`;try{const e=await fetch(n),i=await e.json();if(i.results&&i.results.length>0){const e=i.results[0],n=await fetch(`${t}/movie/${e.id}/external_ids?api_key=${o}`);return(await n.json()).imdb_id||null}}catch(e){}}return null}(u,d),!n)return void i.set(r,null);const m=await async function(e,t,n){const o=["opensubtitles","subdl","all"];for(const i of o){const o=new URLSearchParams({id:e});null!==t&&null!==n&&(o.append("season",t),o.append("episode",n)),o.append("language","en"),o.append("format","srt"),o.append("source",i);const r=`https://sub.wyzie.ru/search?${o}`;try{const e=await fetch(r);if(!e.ok)continue;const t=await e.json();if(Array.isArray(t)&&t.length>0){const e=(await Promise.all(t.slice(0,10).map(e=>y(e)))).filter(Boolean);if(e.length>0)return e}}catch(e){continue}}return null}(n,a,s);if(m&&m.length>0){i.set(r,m);v(m)&&w()}else i.set(r,null)}catch(e){}finally{c=!1}}}function E(){if(o=function(){try{const e=window.BTFW_CONFIG&&"object"==typeof window.BTFW_CONFIG?window.BTFW_CONFIG:{},t=e.tmdb&&"object"==typeof e.tmdb?e.tmdb:{},n=e.integrations&&"object"==typeof e.integrations?e.integrations:{},o=n.tmdb&&"object"==typeof n.tmdb?n.tmdb:{},i="string"==typeof t.apiKey?t.apiKey.trim():"",r="string"==typeof o.apiKey?o.apiKey.trim():"",a="string"==typeof e.tmdbKey?e.tmdbKey.trim():"";let s="";try{s=(localStorage.getItem("btfw:tmdb:key")||"").trim()}catch(e){}const l=e=>(null==e?"":String(e)).trim(),c=l(window.TMDB_API_KEY)||l(window.BTFW_TMDB_KEY)||l(window.tmdb_key)||l(window.moviedbkey),d=(document.body?.dataset?.tmdbKey||"").trim();return r||i||a||s||c||d||null}catch(e){return null}}(),!o)return void console.error("[autosubs] TMDB API key not configured in Theme Settings Ã¢â€ â€™ Integrations");let e=0;const t=setInterval(()=>{e++;const o=f(),i=m();o&&i&&(clearInterval(t),h(),function(){const e=m();!!e&&e.on("changeMedia",e=>{s=null,n="",a=null,g(),setTimeout(()=>{s=f(),s&&x()},1e3)})}(),u()&&(w(),setTimeout(x,1e3))),e>=20&&clearInterval(t)},500)}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",E):setTimeout(E,100),{name:"ext:autosubs",clearCache:()=>i.clear(),refresh:()=>{n="",x()},stopWatcher:g}}),function(){function e(){window.BTFW&&"function"==typeof BTFW.init?BTFW.init("ext:autosubs").catch(()=>{}):setTimeout(e,100)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("btfw:ready",e),setTimeout(e,500)}):(document.addEventListener("btfw:ready",e),setTimeout(e,500))}(),function(){"use strict";const e="btfw-movie-header",t="#currenttitle",n=".btfw-chat-topbar",o=!0,i=!0,r=!0;let a,s=!1,l=null,c="";function d(){if(!s)try{if(!document.querySelector(n))return void setTimeout(d,500);!function(){const t=document.querySelector(n);if(!t)throw new Error("Chat topbar not found");const o=document.getElementById(e);o&&o.remove();l=document.createElement("div"),l.id=e,l.className="btfw-movie-header hide",t.insertAdjacentElement("afterend",l)}(),function(){if(window.socket&&"function"==typeof window.socket.on)window.socket.on("changeMedia",p);else{let e=0;const t=()=>{e++,window.socket&&"function"==typeof window.socket.on?window.socket.on("changeMedia",p):e<10&&setTimeout(t,1e3)};setTimeout(t,2e3)}(function(){const e=document.querySelector(t);if(e)e.addEventListener("mouseenter",u),e.addEventListener("mouseleave",f);else{const e=new MutationObserver(()=>{const n=document.querySelector(t);n&&(n.addEventListener("mouseenter",u),n.addEventListener("mouseleave",f),e.disconnect())});e.observe(document.body,{childList:!0,subtree:!0})}l&&(l.addEventListener("mouseenter",m),l.addEventListener("mouseleave",f))})(),window.addEventListener("resize",function(e,t){let n;return function(...o){const i=()=>{clearTimeout(n),e(...o)};clearTimeout(n),n=setTimeout(i,t)}}(h,250))}(),function(){const e=`\n        /* Movie Info Module Styles */\n        .btfw-movie-header {\n            position: absolute;\n            top: 44px;\n            right: 0;\n            height: auto;\n            width: 100%;\n            max-width: 90vw;\n            background: rgba(20, 20, 20, 0.95);\n            border-radius: 0 0 12px 12px;\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            backdrop-filter: blur(10px);\n            z-index: 1000;\n            overflow: hidden;\n            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);\n            opacity: 0;\n            transform: translateY(-20px) scale(0.95);\n            pointer-events: none;\n        }\n\n        .btfw-movie-header.show {\n            opacity: 1;\n            transform: translateY(0) scale(1);\n            pointer-events: auto;\n            animation: slideInDown 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;\n        }\n\n        .btfw-movie-header.hide {\n            animation: slideOutUp 0.3s cubic-bezier(0.55, 0.055, 0.675, 0.19) forwards;\n        }\n\n        @keyframes slideInDown {\n            0% {\n                opacity: 0;\n                transform: translateY(-30px) scale(0.9);\n            }\n            60% {\n                opacity: 0.8;\n                transform: translateY(5px) scale(1.02);\n            }\n            100% {\n                opacity: 1;\n                transform: translateY(0) scale(1);\n            }\n        }\n\n        @keyframes slideOutUp {\n            0% {\n                opacity: 1;\n                transform: translateY(0) scale(1);\n            }\n            100% {\n                opacity: 0;\n                transform: translateY(-25px) scale(0.95);\n            }\n        }\n\n        .btfw-movie-overlay {\n            position: absolute;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background: linear-gradient(\n                135deg, \n                rgba(0, 0, 0, 0.7) 0%, \n                rgba(0, 0, 0, 0.5) 50%, \n                rgba(0, 0, 0, 0.8) 100%\n            );\n            z-index: 1;\n        }\n\n        .btfw-movie-content {\n            position: relative;\n            z-index: 2;\n            padding: 10px;\n            display: flex;\n            gap: 15px;\n            min-height: 160px;\n        }\n\n        .btfw-movie-poster {\n            width: 100px;\n            height: auto;\n            border-radius: 8px;\n            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);\n            flex-shrink: 0;\n        }\n\n        .btfw-movie-details {\n            flex: 1;\n            display: flex;\n            flex-direction: column;\n            gap: 12px;\n        }\n\n        .btfw-movie-title {\n            color: #fff;\n            font-size: 1.2em;\n            font-weight: 600;\n            margin: 0;\n            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);\n            line-height: 1.3;\n        }\n\n        .btfw-movie-summary {\n            color: #e0e0e0;\n            font-size: 0.85em;\n            line-height: 1.5;\n            margin: 0;\n            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);\n            display: -webkit-box;\n            -webkit-line-clamp: 4;\n            -webkit-box-orient: vertical;\n            overflow: hidden;\n        }\n\n        .btfw-movie-rating {\n            position: sticky;\n            bottom: 16px;\n            right: 16px;\n            display: flex;\n            flex-direction: column;\n            align-items: stretch;\n            gap: 4px;\n            justify-content: flex-end;\n        }\n\n        .btfw-movie-votes {\n            color: #ccc;\n            font-size: 0.7em;\n            text-align: center;\n            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);\n        }\n\n        .btfw-movie-loading,\n        .btfw-movie-error {\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            justify-content: center;\n            gap: 12px;\n            color: #ccc;\n            text-align: center;\n            min-height: 120px;\n        }\n\n        .btfw-movie-loading i,\n        .btfw-movie-error i {\n            font-size: 2em;\n            opacity: 0.7;\n        }\n\n        .btfw-movie-error i {\n            color: #ff6b6b;\n        }\n\n        .btfw-movie-error small {\n            font-size: 0.8em;\n            color: #aaa;\n        }\n\n        /* Mobile adjustments */\n        @media (max-width: 768px) {\n            .btfw-movie-header {\n                width: 100%;\n                right: 0;\n                left: 0;\n                border-radius: 0;\n            }\n\n            .btfw-movie-content {\n                padding: 16px;\n                flex-direction: column;\n                min-height: auto;\n            }\n\n            .btfw-movie-poster {\n                width: 80px;\n                align-self: center;\n            }\n\n            .btfw-movie-rating {\n                position: static;\n                align-self: center;\n                margin-top: 12px;\n            }\n\n            .btfw-movie-summary {\n                -webkit-line-clamp: 3;\n            }\n        }\n\n        /* Hover effect for current title */\n        ${t}:hover {\n            color: #4fc3f7 !important;\n            transition: color 0.2s ease;\n        }\n        `,n=document.createElement("style");n.textContent=e,document.head.appendChild(n)}(),s=!0,setTimeout(p,100)}catch(e){setTimeout(d,1e3)}}function u(){a&&(clearTimeout(a),a=null),l&&(l.classList.remove("hide"),l.classList.add("show"))}function f(){a=setTimeout(()=>{l&&(l.classList.remove("show"),l.classList.add("hide"),setTimeout(()=>{l&&l.classList.contains("hide")&&l.classList.remove("hide")},300))},300)}function m(){a&&(clearTimeout(a),a=null)}async function p(){const e=document.querySelector(t);if(!e||!l)return;const n=e.textContent?.trim()||"";if(n!==c)if(c=n,n)try{!function(){if(!l)return;b(),l.innerHTML='\n            <div class="btfw-movie-content">\n                <div class="btfw-movie-loading">\n                    <i class="fa fa-spinner fa-spin"></i>\n                    <p>Loading movie information...</p>\n                </div>\n            </div>\n        '}();!function(e){if(!l)return;l.innerHTML="",o&&e.backdrop?(l.style.backgroundImage=`url(${e.backdrop})`,l.style.backgroundSize="cover",l.style.backgroundPosition="center"):b();const t=document.createElement("div");t.className="btfw-movie-overlay",l.appendChild(t);const n=document.createElement("div");if(n.className="btfw-movie-content",l.appendChild(n),e.poster){const t=document.createElement("img");t.src=e.poster,t.alt=`${e.title} Poster`,t.className="btfw-movie-poster",n.appendChild(t)}const a=document.createElement("div");a.className="btfw-movie-details",n.appendChild(a);const s=document.createElement("h2");if(s.textContent=e.title,s.className="btfw-movie-title",a.appendChild(s),r&&e.summary){const t=document.createElement("p");t.textContent=e.summary,t.className="btfw-movie-summary",a.appendChild(t)}if(i&&e.rating>0){const t=function(e,t){const n=document.createElement("div");n.className="btfw-movie-rating";const o=Math.round(10*e),i=function(e){const t=Math.max(0,Math.min(e,100));return t>=70?"#4caf50":t>=50?"#ff9800":"#f44336"}(o),r="http://www.w3.org/2000/svg",a=document.createElementNS(r,"svg");a.setAttribute("width","60"),a.setAttribute("height","60"),a.setAttribute("viewBox","0 0 60 60");const s=25,l=2*Math.PI*s,c=l-e/10*l,d=document.createElementNS(r,"circle");d.setAttribute("cx","30"),d.setAttribute("cy","30"),d.setAttribute("r",s.toString()),d.setAttribute("stroke","#2a2a2a"),d.setAttribute("stroke-width","4"),d.setAttribute("fill","#1a1a1a"),a.appendChild(d);const u=document.createElementNS(r,"circle");u.setAttribute("cx","30"),u.setAttribute("cy","30"),u.setAttribute("r",s.toString()),u.setAttribute("stroke",i),u.setAttribute("stroke-width","3"),u.setAttribute("fill","none"),u.setAttribute("stroke-dasharray",l.toString()),u.setAttribute("stroke-dashoffset",c.toString()),u.setAttribute("transform","rotate(-90 30 30)"),u.setAttribute("stroke-linecap","round"),a.appendChild(u);const f=document.createElementNS(r,"text");if(f.setAttribute("x","50%"),f.setAttribute("y","50%"),f.setAttribute("text-anchor","middle"),f.setAttribute("dominant-baseline","central"),f.setAttribute("fill","#fff"),f.setAttribute("font-size","10"),f.setAttribute("font-weight","bold"),f.textContent=`${o}%`,a.appendChild(f),n.appendChild(a),t>0){const e=document.createElement("div");e.className="btfw-movie-votes",e.textContent=`${t.toLocaleString()} votes`,n.appendChild(e)}return n}(e.rating,e.voteCount);n.appendChild(t)}}(await async function(e){const t=function(){try{const e=window.BTFW_CONFIG&&"object"==typeof window.BTFW_CONFIG?window.BTFW_CONFIG:{},t=e.tmdb&&"object"==typeof e.tmdb?e.tmdb:{},n="string"==typeof t.apiKey?t.apiKey.trim():"",o="string"==typeof e.tmdbKey?e.tmdbKey.trim():"";let i="";try{i=(localStorage.getItem("btfw:tmdb:key")||"").trim()}catch(e){}const r=e=>(null==e?"":String(e)).trim(),a=r(window.TMDB_API_KEY)||r(window.BTFW_TMDB_KEY)||r(window.tmdb_key),s=(document.body?.dataset?.tmdbKey||"").trim();return n||o||i||a||s||null}catch(e){return null}}();if(!t)throw new Error("TMDB API key not configured. Please set it in Theme Settings Ã¢â€ â€™ Integrations");let n=e.match(/(.+)\s*\((\d{4})\)/),o=n?n[1].trim():e,i=n?n[2]:"";i||(n=e.match(/(.+?)\s+(\d{4})\s*$/),n&&(o=n[1].trim(),i=n[2]));const r=function(e){let t=e;return["Extended","Director's Cut","Directors Cut","Unrated","Theatrical Cut"].forEach(e=>{const n=new RegExp(`\\b${e}\\b`,"gi");t=t.replace(n,"")}),t.replace(/\s{2,}/g," ").trim()}(o),a=`https://api.themoviedb.org/3/search/movie?api_key=${t}&query=${encodeURIComponent(r)}&year=${i}`;try{const t=await fetch(a);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const n=await t.json();if(n?.results?.length>0){const t=n.results[0];return{title:e,backdrop:t.backdrop_path?`https://image.tmdb.org/t/p/w1280${t.backdrop_path}`:null,poster:t.poster_path?`https://image.tmdb.org/t/p/w500${t.poster_path}`:null,summary:t.overview||"",rating:t.vote_average||0,releaseDate:t.release_date||"",voteCount:t.vote_count||0}}}catch(e){throw e}return{title:e,backdrop:null,poster:null,summary:"",rating:0,releaseDate:"",voteCount:0}}(n))}catch(e){!function(){if(!l)return;b(),l.innerHTML='\n            <div class="btfw-movie-content">\n                <div class="btfw-movie-error">\n                    <i class="fa fa-exclamation-triangle"></i>\n                    <p>Unable to fetch movie information</p>\n                    <small>Check TMDB API key in Theme Settings</small>\n                </div>\n            </div>\n        '}()}else!function(){if(!l)return;b(),l.innerHTML='\n            <div class="btfw-movie-content">\n                <p>No movie information available</p>\n            </div>\n        '}()}function b(){l&&(l.style.backgroundImage="",l.style.backgroundColor="")}function h(){if(l){const e=window.innerWidth<=768;l.classList.toggle("btfw-mobile",e)}}document.addEventListener("btfw:ready",()=>{setTimeout(d,500)}),function e(){"loading"!==document.readyState?setTimeout(d,2e3):document.addEventListener("DOMContentLoaded",e)}(),window.MovieInfoModule={init:d,cleanup:function(){l&&(l.remove(),l=null),window.socket&&"function"==typeof window.socket.off&&window.socket.off("changeMedia",p),a&&(clearTimeout(a),a=null),s=!1},isInitialized:()=>s,moduleInfo:{id:"movie-info",name:"Movie Info",version:"2.0.0"}}}(),BTFW.define("ext:movie-suggestion",[],async()=>{const e=(e,t=document)=>t.querySelector(e);let t=null,n=null,o=null;function i(){try{const e=window.BTFW_CONFIG&&"object"==typeof window.BTFW_CONFIG?window.BTFW_CONFIG:{},t=e.tmdb&&"object"==typeof e.tmdb?e.tmdb:{},n="string"==typeof t.apiKey?t.apiKey.trim():"",o="string"==typeof e.tmdbKey?e.tmdbKey.trim():"";let i="";try{i=(localStorage.getItem("btfw:tmdb:key")||"").trim()}catch(e){}const r=e=>(null==e?"":String(e)).trim(),a=r(window.TMDB_API_KEY)||r(window.BTFW_TMDB_KEY)||r(window.tmdb_key)||r(window.moviedbkey),s=(document.body?.dataset?.tmdbKey||"").trim();return n||o||i||a||s||null}catch(e){return null}}const r=CLIENT?.rank||0;function a(){if(e("#btfw-movie-suggest-btn"))return!0;const t=function(){const t=e("a[href*='donate'], #donate-btn, .donate-btn");if(t){const e=t.closest("ul");if(e)return{ul:e,insertAfter:t.parentElement}}const n=e("#btfw-theme-btn-nav");if(n){const e=n.closest("ul");if(e)return{ul:e,insertAfter:null}}return{ul:e(".navbar .nav.navbar-nav")||e(".navbar-nav")||e(".btfw-navbar ul")||e(".navbar ul"),insertAfter:null}}();if(!t.ul)return!1;const n=document.createElement("li"),o=document.createElement("a");return o.href="javascript:void(0)",o.className="btfw-nav-pill",o.id="btfw-movie-suggest-btn",o.innerHTML='\n      <span class="btfw-nav-pill__icon" aria-hidden="true"><i class="fa fa-film"></i></span>\n      <span class="btfw-nav-pill__label">Request</span>\n    ',n.appendChild(o),t.insertAfter?t.insertAfter.after(n):t.ul.insertBefore(n,t.ul.firstChild),o.addEventListener("click",l),!0}function s(){if(e("#btfw-movie-suggest-modal"))return;const a=document.createElement("div");a.id="btfw-movie-suggest-modal",a.className="modal",a.innerHTML=`\n      <div class="modal-background"></div>\n      <div class="modal-card btfw-modal">\n        <header class="modal-card-head">\n          <p class="modal-card-title">Suggest a movie for the playlist</p>\n          <button class="delete" aria-label="close"></button>\n        </header>\n        <section class="modal-card-body">\n          <div class="field">\n            <div class="control">\n              <input type="text" id="btfw-movie-search" class="input" \n                     placeholder="${0===r?"Please register to search and suggest movies":"Search for a movie..."}"\n                     ${0===r?"disabled":""}>\n            </div>\n          </div>\n          <div class="btfw-movie-results"></div>\n          <div style="margin-top:24px;">\n            <h6 style="font-weight:600;margin-bottom:12px;">Recent Suggestions:</h6>\n            <div id="btfw-recent-suggestions"></div>\n          </div>\n        </section>\n      </div>\n    `,document.body.appendChild(a);const s=e(".modal-background",a),l=e(".delete",a);if(s.addEventListener("click",c),l.addEventListener("click",c),0===r){const t=e("#btfw-movie-search",a);t.addEventListener("focus",()=>{alert("You need to be registered to search and suggest movies."),t.blur()})}else{let r;const s=e("#btfw-movie-search",a);s.addEventListener("input",()=>{clearTimeout(r);const l=s.value.trim();l.length>2?r=setTimeout(()=>function(r){const a=i();if(!a)return void console.error("[movie-suggestion] TMDB API key not available");const s=`https://api.themoviedb.org/3/search/movie?api_key=${a}&query=${encodeURIComponent(r)}`;fetch(s).then(e=>e.json()).then(i=>function(i){const r=e("#btfw-movie-suggest-modal");if(!r)return;const a=e(".btfw-movie-results",r);a.innerHTML=i.map(e=>`\n      <div class="movie-result" data-id="${e.id}" data-title="${e.title}" data-poster="${e.poster_path}">\n        <img src="https://image.tmdb.org/t/p/w154${e.poster_path}" alt="${e.title}" \n             onerror="this.src='https://via.placeholder.com/154x231?text=No+Image'">\n        <div class="movie-result__info">\n          <div class="movie-result__title">${e.title}</div>\n          <small style="opacity:0.7;">${e.release_date?e.release_date.split("-")[0]:"N/A"}</small>\n        </div>\n      </div>\n    `).join(""),((e,t=document)=>Array.from(t.querySelectorAll(e)))(".movie-result",a).forEach(i=>{i.addEventListener("click",()=>{t=i.dataset.id,n=i.dataset.title,o=i.dataset.poster;const r=e("#btfw-movie-confirm-modal");r&&(e("#btfw-confirm-movie-title",r).textContent=n,r.classList.add("is-active"))})})}(i.results.slice(0,5))).catch(e=>console.error("[movie-suggestion] Error fetching movies:",e))}(l),500):e(".btfw-movie-results",a).innerHTML=""})}}function l(){const t=e("#btfw-movie-suggest-modal");if(!t)return;t.classList.add("is-active");const n=e("#btfw-recent-suggestions",t);n&&(n.innerHTML=""),u()}function c(){const i=e("#btfw-movie-suggest-modal");i&&(i.classList.remove("is-active"),e("#btfw-movie-search",i).value="",e(".btfw-movie-results",i).innerHTML="",e("#btfw-recent-suggestions",i).innerHTML="",t=null,n=null,o=null)}async function d(){if(!t||!n)return;const i=e("#btfw-movie-confirm-modal");i&&i.classList.remove("is-active"),await function(e,t,n){const o=CLIENT?.name||"Anonymous";return console.log(`[movie-suggestion] Suggesting: ${t} (ID: ${e}) by ${o}`),function(e,t,n,o){const i={movieId:e,movieTitle:t,username:n,posterPath:o,timestamp:(new Date).toISOString()};return fetch("https://movie-suggestions-worker.billtube.workers.dev",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then(e=>e.json()).then(e=>(console.log("[movie-suggestion] Saved:",e),e)).catch(e=>{throw console.error("[movie-suggestion] Save failed:",e),e})}(e,t,o,n)}(t,n,o),await new Promise(e=>setTimeout(e,400)),u(),await new Promise(e=>setTimeout(e,1200)),c()}function u(){const t=e("#btfw-recent-suggestions");t&&(t.innerHTML="",fetch("https://movie-suggestions-worker.billtube.workers.dev").then(e=>e.json()).then(async t=>{(await Promise.all(t.map(e=>function(e){const t=i();if(!t)return console.error("[movie-suggestion] TMDB API key not available"),Promise.reject("No API key");return fetch(`https://api.themoviedb.org/3/movie/${e}?api_key=${t}`).then(e=>e.json()).catch(e=>(console.error("[movie-suggestion] Fetch details failed:",e),{poster_path:null}))}(e.movieId).then(t=>({movieId:e.movieId,movieTitle:e.movieTitle,username:e.username,posterPath:t.poster_path}))))).reverse().forEach(t=>{!function(t,n,o,i){const r=e("#btfw-recent-suggestions");if(!r)return;const a=document.createElement("div");a.className="recent-suggestion",a.innerHTML=`\n      <img src="https://image.tmdb.org/t/p/w92${i}" alt="${n}"\n           onerror="this.src='https://via.placeholder.com/92x138?text=No+Image'">\n      <div>\n        <div class="recent-suggestion__title">${n}</div>\n        <small class="recent-suggestion__user">Suggested by: ${o}</small>\n      </div>\n    `,r.appendChild(a)}(t.movieId,t.movieTitle,t.username,t.posterPath)})}).catch(e=>console.error("[movie-suggestion] Load failed:",e)))}function f(){if(!i())return void console.warn("[movie-suggestion] TMDB API key not configured. Add it in Theme Settings Ã¢â€ â€™ Integrations.");console.log("[movie-suggestion] Initializing with TMDB API key"),function(){if(document.getElementById("btfw-movie-suggest-styles"))return;const e=document.createElement("style");e.id="btfw-movie-suggest-styles",e.textContent="\n      /* Movie Suggestion Modal Styles */\n      #btfw-movie-suggest-modal .btfw-movie-results {\n        display: flex;\n        gap: 12px;\n        overflow-x: auto;\n        margin-top: 16px;\n      }\n\n      #btfw-movie-suggest-modal .movie-result {\n        min-width: 150px;\n        cursor: pointer;\n        border: 1px solid rgba(255,255,255,0.1);\n        border-radius: 8px;\n        overflow: hidden;\n        transition: all 0.2s ease;\n      }\n\n      #btfw-movie-suggest-modal .movie-result:hover {\n        border-color: var(--btfw-color-accent, #6d4df6);\n        transform: translateY(-2px);\n      }\n\n      #btfw-movie-suggest-modal .movie-result img {\n        width: 100%;\n        display: block;\n      }\n\n      #btfw-movie-suggest-modal .movie-result__info {\n        padding: 8px;\n      }\n\n      #btfw-movie-suggest-modal .movie-result__title {\n        font-weight: 600;\n        font-size: 0.85rem;\n      }\n\n      #btfw-movie-suggest-modal .recent-suggestion {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        margin-bottom: 12px;\n        padding: 8px;\n        border-radius: 8px;\n        background: rgba(255,255,255,0.03);\n      }\n\n      #btfw-movie-suggest-modal .recent-suggestion img {\n        width: 46px;\n        height: 69px;\n        border-radius: 4px;\n        object-fit: cover;\n      }\n\n      #btfw-movie-suggest-modal .recent-suggestion__title {\n        font-weight: 600;\n      }\n\n      #btfw-movie-suggest-modal .recent-suggestion__user {\n        opacity: 0.7;\n        font-size: 0.85rem;\n      }\n\n      .button.btfw-nav-pill#btfw-movie-suggest-btn:hover {\n        background-color: var(--btfw-color-accent, #6d4df6);\n      }\n    ",document.head.appendChild(e)}(),s(),function(){if(e("#btfw-movie-confirm-modal"))return;const t=document.createElement("div");t.id="btfw-movie-confirm-modal",t.className="modal",t.innerHTML='\n      <div class="modal-background"></div>\n      <div class="modal-card btfw-modal">\n        <header class="modal-card-head">\n          <p class="modal-card-title">Confirm Suggestion</p>\n          <button class="delete" aria-label="close"></button>\n        </header>\n        <section class="modal-card-body">\n          <p>Are you sure you want to suggest <strong id="btfw-confirm-movie-title"></strong>?</p>\n        </section>\n        <footer class="modal-card-foot">\n          <button class="button" id="btfw-movie-cancel">Cancel</button>\n          <button class="button is-link" id="btfw-movie-confirm">Confirm</button>\n        </footer>\n      </div>\n    ',document.body.appendChild(t);const n=e(".modal-background",t),o=e(".delete",t),i=e("#btfw-movie-cancel",t),r=e("#btfw-movie-confirm",t),a=()=>t.classList.remove("is-active");n.addEventListener("click",a),o.addEventListener("click",a),i.addEventListener("click",a),r.addEventListener("click",d)}();let t=0;const n=()=>{a()?console.log("[movie-suggestion] Button added successfully"):(t++,t<50?setTimeout(n,100):console.warn("[movie-suggestion] Failed to add button after retries"))};n()}return document.addEventListener("btfw:layoutReady",()=>{setTimeout(f,100)}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{setTimeout(f,200)}):setTimeout(f,200),{name:"ext:movie-suggestion",open:l,close:c}}),function(){function e(){window.BTFW&&"function"==typeof BTFW.init?BTFW.init("ext:movie-suggestion").catch(e=>{console.error("[movie-suggestion] Init failed:",e)}):setTimeout(e,100)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("btfw:ready",e),setTimeout(e,500)}):(document.addEventListener("btfw:ready",e),setTimeout(e,500))}();