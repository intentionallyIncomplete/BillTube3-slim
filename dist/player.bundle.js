BTFW.define("feature:player",["feature:layout"],async ({}) =>{const PLAYER_SELECTOR = "#videowrap .video-js";const DEFAULT_SKIN_CLASS = "vjs-default-skin";const CITY_THEME_CLASS = "vjs-theme-city";const BIG_PLAY_CLASS = "vjs-big-play-centered";const INLINE_VIDEO_SELECTORS = [ "#videowrap video","#ytapiplayer video","#videowrap .video-js video","#videowrap .video-js .vjs-tech" ].join(",");const INLINE_VIDEO_ATTRIBUTES ={playsinline:"","webkit-playsinline":"","x5-video-player-type":"h5","x5-video-player-fullscreen":"false","x5-video-orientation":"portrait"};const BASE_STYLES_LINK_ID = "btfw-videojs-base-css";const CITY_STYLES_LINK_ID = "btfw-videojs-city-css";const BASE_STYLES_URLS = ["https://vjs.zencdn.net/7.20.3/video-js.css"];const CITY_STYLES_URLS = [ "https://cdn.jsdelivr.net/npm/@videojs/themes@1/dist/city/index.css","https://unpkg.com/@videojs/themes@1/dist/city/index.css" ];function ensureStylesheet(id,urls){const doc = document;if (!doc || !doc.head) return;if (doc.getElementById(id)) return;const link = doc.createElement("link");link.id = id;link.rel = "stylesheet";const sources = Array.isArray(urls) ? urls.slice():[urls];const tryNext = () =>{if (!sources.length) return false;const href = sources.shift();if (!href) return tryNext();link.href = href;return true;};link.addEventListener("error",() =>{if (tryNext()) return;link.remove();});if (tryNext()){doc.head.appendChild(link);}}function baseStylesActive(){if (typeof window === "undefined" || !document.body) return false;const probe = document.createElement("div");probe.className = `video-js ${DEFAULT_SKIN_CLASS}`;probe.style.position = "absolute";probe.style.opacity = "0";probe.style.pointerEvents = "none";probe.style.width = "1px";probe.style.height = "1px";document.body.appendChild(probe);const fontSize = window.getComputedStyle(probe).fontSize;probe.remove();return fontSize && Math.abs(parseFloat(fontSize) - 10) < 0.2;}function ensureBaseStylesheet(){if (baseStylesActive()) return;const existing = document.querySelector( 'link[href*="video-js"],link[href*="videojs"],style[data-vjs-styles]' );if (existing) return;ensureStylesheet(BASE_STYLES_LINK_ID,BASE_STYLES_URLS);}function ensureCityStylesheet(){const existing = document.querySelector( 'link[href*="videojs" i][href*="city" i],link[href*="@videojs/themes" i][href*="city" i]' );if (existing) return;ensureStylesheet(CITY_STYLES_LINK_ID,CITY_STYLES_URLS);}function applyCityTheme(){ensureBaseStylesheet();ensureCityStylesheet();document.querySelectorAll(PLAYER_SELECTOR).forEach((player) =>{if (player.classList.contains(DEFAULT_SKIN_CLASS)){player.classList.remove(DEFAULT_SKIN_CLASS);}Array.from(player.classList).forEach((cls) =>{if (cls.startsWith("vjs-theme-") && cls !== CITY_THEME_CLASS){player.classList.remove(cls);}});if (!player.classList.contains(CITY_THEME_CLASS)){player.classList.add(CITY_THEME_CLASS);}if (!player.classList.contains(BIG_PLAY_CLASS)){player.classList.add(BIG_PLAY_CLASS);}});}function ensureInlinePlayback(){const nodes = document.querySelectorAll(INLINE_VIDEO_SELECTORS);nodes.forEach((node) =>{if (!(node instanceof HTMLVideoElement)) return;if (typeof node.playsInline === "boolean"){node.playsInline = true;}Object.entries(INLINE_VIDEO_ATTRIBUTES).forEach(([attr,value]) =>{try{node.setAttribute(attr,value);}catch (_){}});});}function patchVideojsTextContent(){if (typeof window === "undefined") return false;const vjs = window.videojs;if (!vjs) return false;const dom = vjs.dom || vjs;if (!dom || typeof dom.textContent !== "function") return false;if (dom.textContent && dom.textContent._btfwOptimized) return true;const original = dom.textContent.bind(dom);const patched = function patchedTextContent(el,text){if (!el) return el;let currentValue;try{if (typeof el.textContent !== "undefined"){currentValue = el.textContent;}else if (typeof el.innerText !== "undefined"){currentValue = el.innerText;}}catch (_){currentValue = undefined;}if (currentValue !== undefined){const nextValue = text === null || text === undefined ? "":String(text);if (currentValue === nextValue){return el;}}return original(el,text);};patched._btfwOptimized = true;patched._btfwOriginal = original;dom.textContent = patched;return true;}function ensureTextContentPatch(){if (patchVideojsTextContent()){ensureTextContentPatch._tries = 0;return;}if (ensureTextContentPatch._tries > 20) return;ensureTextContentPatch._tries = (ensureTextContentPatch._tries || 0) + 1;setTimeout(ensureTextContentPatch,250);}const GUARD_MARK = "_btfwGuarded";function shouldAllowClick(target){if (!target) return false;const allowSelectors = [ ".vjs-control-bar",".vjs-control",".vjs-menu",".vjs-menu-content",".vjs-slider",".vjs-volume-panel",".vjs-text-track-settings",".vjs-tech .alert",".vjs-tech [role=\"alert\"]",".vjs-tech [role=\"dialog\"]",".vjs-tech .modal",".vjs-tech .modal-dialog" ].join(",");if (target.closest(allowSelectors)){return true;}return false;}function attachGuardsTo(el){if (!el || el[GUARD_MARK]) return;el[GUARD_MARK] = true;const block = (e) =>{if (shouldAllowClick(e.target)) return;if (e.type === "click" && e.button !== 0) return;e.preventDefault();e.stopImmediatePropagation();};el.addEventListener("click",block,true);el.addEventListener("pointerdown",(e) =>{if (!shouldAllowClick(e.target) && e.button === 0) e.preventDefault();},true);el.addEventListener("touchstart",block,true);}function attachGuards(){const candidates = [ ...document.querySelectorAll("#ytapiplayer"),...document.querySelectorAll(".video-js"),...document.querySelectorAll(".video-js .vjs-tech"),...document.querySelectorAll(".video-js .vjs-poster"),...document.querySelectorAll(".video-js .vjs-loading-spinner") ];candidates.forEach(attachGuardsTo);}function watchPlayerMount(){const target = document.getElementById("videowrap") || document.body;if (!target) return;if (watchPlayerMount._mo){try{watchPlayerMount._mo.disconnect();}catch (_){}}const mo = new MutationObserver((mutations) =>{// âœ… FIX:Only react to significant changes,not Video.js time updates let shouldReact = false;for (const mutation of mutations){// Ignore textContent changes (Video.js time displays) if (mutation.type === 'characterData'){continue;}// Only care about added/removed elements that are significant if (mutation.type === 'childList'){for (const node of mutation.addedNodes){// React to new video players,but not internal Video.js elements if (node.nodeType === 1 && (node.classList?.contains('video-js') || node.classList?.contains('embed-responsive') || node.tagName === 'VIDEO' || node.tagName === 'IFRAME')){shouldReact = true;break;}}for (const node of mutation.removedNodes){// React to removed video players if (node.nodeType === 1 && (node.classList?.contains('video-js') || node.tagName === 'VIDEO' || node.tagName === 'IFRAME')){shouldReact = true;break;}}}if (shouldReact) break;}if (shouldReact){applyCityTheme();attachGuards();ensureInlinePlayback();}});mo.observe(target,{childList:true,subtree:true,characterData:false // âœ… Don't watch text changes});watchPlayerMount._mo = mo;}function boot(){applyCityTheme();attachGuards();ensureInlinePlayback();ensureTextContentPatch();watchPlayerMount();if (typeof window !== "undefined" && window.socket && typeof socket.on === "function"){try{if (typeof socket.off === "function"){socket.off("changeMedia",ensureInlinePlayback);}socket.on("changeMedia",() => setTimeout(ensureInlinePlayback,0));}catch (err){console.warn("[feature:player] Unable to bind changeMedia inline handler",err);}}}if (document.readyState === "loading"){document.addEventListener("DOMContentLoaded",boot);}else{boot();}document.addEventListener("btfw:layoutReady",() => setTimeout(boot,0));return{name:"feature:player",applyCityTheme,attachGuards,ensureInlinePlayback};});BTFW.define("feature:stack",["feature:layout"],async ({}) =>{const SKEY="btfw-stack-order";const PLAYLIST_VISIBILITY_KEY = "btfw-stack-playlist-open";let compactSpacing = true;// Define what should be grouped together const GROUPS = [{id:"motd-group",title:"Message of the Day",selectors:["#motdwrap","#motdrow","#motd","#announcements"],priority:1},{id:"playlist-group",title:"Playlist",selectors:["#playlistrow","#playlistwrap","#queuecontainer","#queue"],priority:2},{id:"channels-group",title:"Featured Channels",selectors:["#btfw-channels"],priority:3},{id:"poll-group",title:"Polls & Voting",selectors:["#pollwrap","#btfw-poll-parking","#btfw-poll-history"],priority:4}];// Skip these - they're either empty or handled elsewhere const SKIP_SELECTORS = ["#main","#mainpage","#mainpane"];const ADD_MEDIA_SECTIONS = [{id:"addfromurl",title:"From URL",default:true},{id:"searchcontrol",title:"Library & YouTube"},{id:"customembed",title:"Custom embed"}];function ensureAddMediaUI(mainContainer,controlsBar,actionsCluster){if (!mainContainer || !controlsBar || !actionsCluster) return null;const available = ADD_MEDIA_SECTIONS.map(cfg =>{const el = document.getElementById(cfg.id);if (!el) return null;return{...cfg,el};}).filter(Boolean);if (!available.length){const existingPanel = document.getElementById("btfw-addmedia-panel");if (existingPanel) existingPanel.remove();return null;}let panel = document.getElementById("btfw-addmedia-panel");if (!panel){panel = document.createElement("section");panel.id = "btfw-addmedia-panel";panel.className = "btfw-addmedia-panel";panel.dataset.open = "false";panel.setAttribute("role","region");panel.setAttribute("aria-label","Add media controls");panel.setAttribute("aria-hidden","true");panel.setAttribute("hidden","hidden");panel.innerHTML = ` <div class="btfw-addmedia-panel__inner"> <header class="btfw-addmedia-panel__header"> <nav class="btfw-addmedia-tabs" role="tablist"></nav> <button type="button" class="btfw-addmedia-close" aria-label="Close add media"> <span aria-hidden="true">&times;</span> </button> </header> <div class="btfw-addmedia-panel__body"> <div class="btfw-addmedia-views"></div> <p class="btfw-addmedia-help">Queue media by URL,browse your library,or embed custom players without leaving the playlist.</p> </div> </div> `;}if (panel.parentElement !== mainContainer){const anchor = controlsBar.parentElement === mainContainer ? controlsBar.nextSibling:null;mainContainer.insertBefore(panel,anchor);}const tabs = panel.querySelector(".btfw-addmedia-tabs");const viewsHost = panel.querySelector(".btfw-addmedia-views");const closeBtn = panel.querySelector(".btfw-addmedia-close");if (!tabs || !viewsHost) return null;while (tabs.firstChild) tabs.removeChild(tabs.firstChild);while (viewsHost.firstChild) viewsHost.removeChild(viewsHost.firstChild);available.forEach(({id,title,el}) =>{el.classList.remove("collapse","in","plcontrol-collapse");el.style.removeProperty("display");el.style.removeProperty("height");el.removeAttribute("aria-expanded");el.setAttribute("role","tabpanel");el.setAttribute("data-btfw-addmedia","panel");const tab = document.createElement("button");tab.type = "button";tab.className = "btfw-addmedia-tab";tab.dataset.target = id;tab.textContent = title;tab.setAttribute("role","tab");tabs.appendChild(tab);const view = document.createElement("div");view.className = "btfw-addmedia-view";view.dataset.target = id;view.setAttribute("role","tabpanel");view.setAttribute("aria-hidden","true");view.appendChild(el);viewsHost.appendChild(view);});const defaultSection = available.find(sec => sec.default) || available[0];const setActive = (targetId) =>{const activeId = targetId || panel.dataset.active || defaultSection.id;panel.dataset.active = activeId;tabs.querySelectorAll(".btfw-addmedia-tab").forEach(tab =>{const match = tab.dataset.target === activeId;tab.classList.toggle("is-active",match);tab.setAttribute("aria-selected",match ? "true":"false");tab.setAttribute("tabindex",match ? "0":"-1");});viewsHost.querySelectorAll(".btfw-addmedia-view").forEach(view =>{const match = view.dataset.target === activeId;view.classList.toggle("is-active",match);view.setAttribute("aria-hidden",match ? "false":"true");});};const toggle = (force) =>{const open = force != null ? !!force:panel.dataset.open !== "true";panel.dataset.open = open ? "true":"false";panel.classList.toggle("is-open",open);panel.setAttribute("aria-hidden",open ? "false":"true");if (open){panel.removeAttribute("hidden");setActive(panel.dataset.active || defaultSection.id);}else{panel.setAttribute("hidden","hidden");}panel.dispatchEvent(new CustomEvent("btfw:addmedia:state",{detail:{open}}));return open;};if (!panel._btfwWired){tabs.addEventListener("click",(ev) =>{const btn = ev.target.closest(".btfw-addmedia-tab");if (!btn) return;ev.preventDefault();setActive(btn.dataset.target);});if (closeBtn){closeBtn.addEventListener("click",() => toggle(false));}panel._btfwWired = true;}setActive(panel.dataset.active || defaultSection.id);panel._btfwToggle = toggle;panel._btfwSetActive = setActive;const wireLegacyTriggers = () =>{const triggers = [{id:"showsearch",target:"searchcontrol"},{id:"showcustomembed",target:"customembed"}];triggers.forEach(({id,target}) =>{const btn = document.getElementById(id);if (!btn) return;if (btn.dataset.btfwAddmedia === target) return;btn.dataset.btfwAddmedia = target;btn.setAttribute("aria-controls","btfw-addmedia-panel");btn.addEventListener("click",(ev) =>{ev.preventDefault();ev.stopPropagation();setActive(target);toggle(true);btn.blur();});});};wireLegacyTriggers();return{panel,toggle,setActive};}function applyCompactSpacing(enabled){const stack = document.getElementById("btfw-stack");if (!stack) return;const want = !!enabled;stack.classList.toggle("btfw-stack--compact",want);stack.querySelectorAll(".btfw-stack-list").forEach(list =>{list.classList.toggle("btfw-stack-list--compact",want);});}function ensureStack(){const left=document.getElementById("btfw-leftpad");if(!left) return null;let stack=document.getElementById("btfw-stack");if(!stack){stack=document.createElement("div");stack.id="btfw-stack";stack.className="btfw-stack";const v=document.getElementById("videowrap");if(v&&v.nextSibling) v.parentNode.insertBefore(stack,v.nextSibling);else left.appendChild(stack);// Just create the list - no header with "Page Modules" const list=document.createElement("div");list.className="btfw-stack-list";stack.appendChild(list);const footer=document.createElement("div");footer.id="btfw-stack-footer";footer.className="btfw-stack-footer";stack.appendChild(footer);}applyCompactSpacing(compactSpacing);return{list:stack.querySelector(".btfw-stack-list"),footer:stack.querySelector("#btfw-stack-footer")};}// function normalizeId(el){// if(!el) return null;// if(!el.id) el.id="stackitem-"+Math.random().toString(36).slice(2,7);// return el.id;//}// function titleOf(el){// return el.getAttribute("data-title")||el.getAttribute("title")||el.id;//}function mergeMotdElements(){const motdwrap = document.getElementById("motdwrap");const motdrow = document.getElementById("motdrow");const motd = document.getElementById("motd");if (!motdwrap && !motdrow) return;// Use motdwrap as the main container,or create it let container = motdwrap;if (!container && motdrow){container = motdrow;container.id = "motdwrap";}// Merge motd content into container (avoid circular reference) if (motd && container && !container.contains(motd) && !motd.contains(container)){// Move motd's content directly into container while (motd.firstChild){container.appendChild(motd.firstChild);}motd.remove();}// Ensure the merged container still exposes an element with id="motd" if (container && !container.querySelector("#motd")){const host = document.createElement("div");host.id = "motd";while (container.firstChild){host.appendChild(container.firstChild);}container.appendChild(host);}// Remove duplicate motdrow if we're using motdwrap (avoid circular reference) if (motdwrap && motdrow && motdrow !== motdwrap && !motdwrap.contains(motdrow) && !motdrow.contains(motdwrap)){while (motdrow.firstChild){motdwrap.appendChild(motdrow.firstChild);}motdrow.remove();}}function mergePlaylistControls(){const controlsRow = document.getElementById("controlsrow");const rightControls = document.getElementById("rightcontrols");const plBar = document.getElementById("btfw-plbar");const playlistWrap = document.getElementById("playlistwrap");const queueContainer = document.getElementById("queuecontainer");const playlistRow = document.getElementById("playlistrow");const stackPlaylist = document.querySelector('#btfw-stack .btfw-stack-item[data-bind="playlist-group"] .btfw-stack-item__body');// Find any floating controls row (legacy CyTube layout) const controlsRows = document.querySelectorAll(".btfw-controls-row");// Find the main playlist container let mainContainer = playlistRow || playlistWrap || queueContainer || stackPlaylist;if (!mainContainer) return;// Create or enhance the playlist bar let controlsBar = plBar;if (!controlsBar){controlsBar = document.createElement("div");controlsBar.id = "btfw-plbar";controlsBar.className = "btfw-plbar";}else{controlsBar.classList.add("btfw-plbar");}// Build a modern layout scaffold once let layout = controlsBar.querySelector(".btfw-plbar__layout");let primary;// search + playlist tools let aside;// playlist actions from rightcontrols if (!layout){layout = document.createElement("div");layout.className = "btfw-plbar__layout";primary = document.createElement("div");primary.className = "btfw-plbar__primary";aside = document.createElement("div");aside.className = "btfw-plbar__aside";layout.append(primary,aside);while (controlsBar.firstChild){primary.appendChild(controlsBar.firstChild);}controlsBar.appendChild(layout);const searchBlock = primary.querySelector(".field.has-addons");if (searchBlock) searchBlock.classList.add("btfw-plbar__search");const countBadge = primary.querySelector("#btfw-pl-count");if (countBadge){countBadge.classList.add("btfw-plbar__count");aside.appendChild(countBadge);}}else{primary = layout.querySelector(".btfw-plbar__primary") || layout;aside = layout.querySelector(".btfw-plbar__aside") || layout;}// Drop legacy controls that conflict with the modern bar controlsBar.querySelectorAll("#showmediaurl,#btfw-pl-poll").forEach(btn => btn.remove());// Ensure we have an actions cluster for playlist controls let actionsCluster = controlsBar.querySelector(".btfw-plbar__actions");if (!actionsCluster){actionsCluster = document.createElement("div");actionsCluster.className = "btfw-plbar__actions";(aside || controlsBar).appendChild(actionsCluster);}let addMediaBtn = document.getElementById("btfw-addmedia-btn");const styleActionButton = (btn) =>{if (!btn) return;btn.classList.add("btfw-plbar__action-btn");if (btn.tagName === "BUTTON" || btn.tagName === "A"){btn.classList.add("button","is-dark","is-small");}else if (btn.tagName === "INPUT"){const type = (btn.type || "").toLowerCase();if (type === "button" || type === "submit" || type === "reset"){btn.classList.add("button","is-dark","is-small");}else{btn.classList.remove("button","is-dark","is-small");}}};if (controlsBar.parentElement !== mainContainer){mainContainer.insertBefore(controlsBar,mainContainer.firstChild);}const addMedia = ensureAddMediaUI(mainContainer,controlsBar,actionsCluster);if (addMedia){if (!addMediaBtn || !document.body.contains(addMediaBtn)){addMediaBtn = document.createElement("button");addMediaBtn.id = "btfw-addmedia-btn";addMediaBtn.type = "button";addMediaBtn.className = "button is-small";addMediaBtn.innerHTML = `<i class="fa fa-plus"></i><span>Add media</span>`;actionsCluster.prepend(addMediaBtn);}else if (!actionsCluster.contains(addMediaBtn)){actionsCluster.prepend(addMediaBtn);}}else if (addMediaBtn){if (addMediaBtn.parentElement) addMediaBtn.parentElement.removeChild(addMediaBtn);addMediaBtn = null;}const moveControls = (root) =>{if (!root) return;const elements = Array.from(root.children || []);elements.forEach(el =>{if (!el) return;el.classList.add("btfw-plbar__control");actionsCluster.appendChild(el);});};// Move rightcontrols buttons into the enhanced bar if (rightControls){moveControls(rightControls);rightControls.remove();}// Move any remaining legacy controls into the bar if (controlsRow){moveControls(controlsRow);controlsRow.remove();}actionsCluster.querySelectorAll("button,a.btn,input[type=button],input[type=submit],input[type=reset],select").forEach(styleActionButton);if (addMedia && addMediaBtn){addMediaBtn.classList.remove("is-dark");addMediaBtn.classList.add("is-primary");if (!addMediaBtn.dataset.iconified){addMediaBtn.innerHTML = `<i class="fa fa-plus"></i><span>Add media</span>`;addMediaBtn.dataset.iconified = "1";}addMediaBtn.setAttribute("aria-controls","btfw-addmedia-panel");const syncState = (open) =>{addMediaBtn.setAttribute("aria-expanded",open ? "true":"false");};if (!addMediaBtn.dataset.btfwBound){addMediaBtn.dataset.btfwBound = "1";addMediaBtn.addEventListener("click",(ev) =>{ev.preventDefault();const panel = document.getElementById("btfw-addmedia-panel");const toggleFn = panel && panel._btfwToggle;const open = typeof toggleFn === "function" ? toggleFn():false;syncState(open);});}const panel = addMedia.panel || document.getElementById("btfw-addmedia-panel");if (panel){syncState(panel.dataset.open === "true");if (!panel._btfwButtonSync){panel.addEventListener("btfw:addmedia:state",(ev) =>{syncState(!!(ev.detail && ev.detail.open));});panel._btfwButtonSync = true;}}}// Move any floating controls rows into the playlist container controlsRows.forEach(row =>{if (row && !mainContainer.contains(row)){row.style.cssText += ` margin-top:8px;position:relative !important;bottom:auto !important;left:auto !important;right:auto !important;width:auto !important;`;row.remove();mainContainer.appendChild(row);console.log('[stack] Moved floating controls row into playlist container');}});// Hide the legacy controls row if it no longer contains useful content // Ensure the bar is at the top of the playlist container if (!mainContainer.contains(controlsBar)){mainContainer.insertBefore(controlsBar,mainContainer.firstChild);}}function createGroupItem(group,elements){// Special handling for MOTD group if (group.id === "motd-group"){mergeMotdElements();// Re-get the element after merging elements = [document.getElementById("motdwrap")].filter(Boolean);}// Special handling for playlist group if (group.id === "playlist-group"){mergePlaylistControls();// Re-get elements after merging elements = elements.filter(el => el && el.id !== "rightcontrols");// rightcontrols is now merged}// âœ… FIX:Allow channels-group to be created even with zero elements (slider will be added later) if (group.id !== "channels-group" && elements.length === 0) return null;// Filter out any elements that are already in the stack to avoid circular references const stackList = document.querySelector("#btfw-stack .btfw-stack-list");if (stackList){elements = elements.filter(el => el && !stackList.contains(el) && !el.contains(stackList));}// Continue creating the wrapper even if elements is empty (for channels-group) const wrapper = document.createElement("section");wrapper.className = "btfw-stack-item btfw-group-item";wrapper.dataset.bind = group.id;wrapper.dataset.group = "true";const header = document.createElement("header");header.className = "btfw-stack-item__header";header.innerHTML = ` <span class="btfw-stack-item__title">${group.title}</span> <span class="btfw-stack-arrows"> <button class="btfw-arrow btfw-up">â†‘</button> <button class="btfw-arrow btfw-down">â†“</button> </span> `;const body = document.createElement("div");body.className = "btfw-stack-item__body btfw-group-body";// Add all elements to this group with safety checks elements.forEach(el =>{if (el && el.parentElement !== body && !body.contains(el) && !el.contains(body)){try{body.appendChild(el);}catch (error){console.warn('[stack] Failed to move element:',el.id || el.className,error);}}});wrapper.appendChild(header);wrapper.appendChild(body);if (group.id === "playlist-group"){const storedVisibility = getStoredPlaylistVisibility();if (!wrapper.hasAttribute("data-open")){const shouldOpen = storedVisibility !== null ? storedVisibility:true;wrapper.dataset.open = shouldOpen ? "true":"false";}wrapper.classList.toggle("is-open",wrapper.dataset.open !== "false");const arrows = header.querySelector(".btfw-stack-arrows");if (arrows && !arrows.querySelector(".btfw-playlist-toggle")){const toggleBtn = document.createElement("button");toggleBtn.type = "button";toggleBtn.className = "btfw-arrow btfw-playlist-toggle";toggleBtn.setAttribute("aria-label","Toggle playlist visibility");toggleBtn.style.display = "flex";toggleBtn.style.alignItems = "center";toggleBtn.style.justifyContent = "center";const updateToggle = () =>{const isOpen = wrapper.dataset.open !== "false";toggleBtn.textContent = isOpen ? "ðŸ‘ï¸":"ðŸ‘ï¸â€ðŸ—¨ï¸";toggleBtn.title = isOpen ? "Hide playlist (improves performance)":"Show playlist";toggleBtn.setAttribute("aria-expanded",isOpen ? "true":"false");wrapper.classList.toggle("is-open",isOpen);};const setOpenState = (open,options ={}) =>{const isOpen = !!open;wrapper.dataset.open = isOpen ? "true":"false";updateToggle();if (options.persist !== false){storePlaylistVisibility(isOpen);}};toggleBtn.addEventListener("click",(ev) =>{ev.preventDefault();ev.stopPropagation();const currentlyOpen = wrapper.dataset.open !== "false";setOpenState(!currentlyOpen);console.log("[Playlist Toggle]",currentlyOpen ? "Collapsed":"Expanded");});if (storedVisibility !== null){setOpenState(storedVisibility,{persist:false});}else{updateToggle();}const observer = new MutationObserver((mutations) =>{for (const mutation of mutations){if (mutation.type === "attributes"){updateToggle();storePlaylistVisibility(wrapper.dataset.open !== "false");}}});observer.observe(wrapper,{attributes:true,attributeFilter:["data-open"]});arrows.appendChild(toggleBtn);}}// Wire up/down buttons wrapper.querySelector(".btfw-up").onclick = function(){const p = wrapper.parentElement;const prev = wrapper.previousElementSibling;if(prev) p.insertBefore(wrapper,prev);save(p);};wrapper.querySelector(".btfw-down").onclick = function(){const p = wrapper.parentElement;const next = wrapper.nextElementSibling;if(next) p.insertBefore(next,wrapper);else p.appendChild(wrapper);save(p);};return wrapper;}function save(list){try{const items = Array.from(list.children).map(n => ({id:n.dataset.bind,isGroup:n.dataset.group === "true"}));localStorage.setItem(SKEY,JSON.stringify(items));}catch(e){}}function load(){try{return JSON.parse(localStorage.getItem(SKEY)||"[]");}catch(e){return [];}}function getStoredPlaylistVisibility(){try{const stored = localStorage.getItem(PLAYLIST_VISIBILITY_KEY);if (stored === null) return null;return stored === "true";}catch(e){return null;}}function storePlaylistVisibility(isOpen){try{localStorage.setItem(PLAYLIST_VISIBILITY_KEY,isOpen ? "true":"false");}catch(e){}}function attachFooter(footer){if (!footer) return;if (footer.querySelector("#btfw-footer")) return;const themed = document.getElementById("btfw-footer");if (themed && themed !== footer && !footer.contains(themed)){footer.innerHTML = "";footer.appendChild(themed);return;}const real=document.getElementById("footer")||document.querySelector("footer");if(real && !footer.contains(real)){real.classList.add("btfw-footer");footer.innerHTML="";footer.appendChild(real);}}function movePollButton(){// Move poll button from leftcontrols to pollwrap const leftControls = document.getElementById("leftcontrols");const pollWrap = document.getElementById("pollwrap");if (leftControls && pollWrap){// Find poll-related buttons const pollButtons = leftControls.querySelectorAll('button[onclick*="poll"],button[title*="poll"],.poll-btn,#newpollbtn');pollButtons.forEach(btn =>{// Create a container if pollwrap doesn't have one let btnContainer = pollWrap.querySelector('.poll-controls');if (!btnContainer){btnContainer = document.createElement('div');btnContainer.className = 'poll-controls';btnContainer.style.cssText = 'margin-bottom:8px;padding:4px;display:flex;gap:6px;';pollWrap.insertBefore(btnContainer,pollWrap.firstChild);}// Style the button to match the theme btn.classList.add('button','is-small','is-link');btnContainer.appendChild(btn);});// Remove leftcontrols if it's empty if (leftControls.children.length === 0){leftControls.remove();}}}function populate(refs){const list = refs.list;const footer = refs.footer;// Move poll button first movePollButton();// Group elements const groupedElements = new Map();// Process groups with better safety checks GROUPS.forEach(group =>{const elements = [];group.selectors.forEach(sel =>{const el = document.querySelector(sel);if (!el) return;if (list.contains(el) || el.contains(list)) return;if (SKIP_SELECTORS.includes(sel)) return;if (sel === "#pollwrap"){const overlayState = el.dataset && el.dataset.btfwPollOverlay;const attrState = el.getAttribute && el.getAttribute("data-btfw-poll-overlay");if (overlayState === "video" || attrState === "video"){return;}}elements.push(el);});// âœ… FIX:Always create channels-group if slider is enabled,even if #btfw-channels doesn't exist yet if (group.id === "channels-group" && elements.length === 0){// Check if channel slider is enabled via multiple possible sources const btfw = window.BTFW ||{};// Check modern config paths let sliderEnabled = btfw.channelSliderEnabled || (btfw.channelSlider && btfw.channelSlider.enabled) || (btfw.channelTheme && btfw.channelTheme.slider && btfw.channelTheme.slider.enabled);// Also check legacy global variables (for backwards compatibility) if (typeof sliderEnabled === 'undefined' && typeof window.UI_ChannelList !== 'undefined'){sliderEnabled = window.UI_ChannelList === '1' || window.UI_ChannelList === 1;}// If we found a URL but no explicit enabled flag,assume enabled if (!sliderEnabled){const hasUrl = btfw.channelSliderJSON || (btfw.channelSlider && btfw.channelSlider.feedUrl) || (btfw.channelTheme && btfw.channelTheme.slider && btfw.channelTheme.slider.feedUrl) || window.Channel_JSON;if (hasUrl) sliderEnabled = true;}if (sliderEnabled){// Don't skip this group - allow it to be created with zero elements // The channel slider will be added to it later via placeSliderInStack() groupedElements.set(group.id,{group,elements:[]});return;// Continue to next group}}if (elements.length > 0){groupedElements.set(group.id,{group,elements});}});// Create items by priority/order const savedOrder = load();const itemsToAdd = [];// Add groups groupedElements.forEach(({group,elements},groupId) =>{const existingItem = Array.from(list.children).find(n => n.dataset.bind === groupId);if (!existingItem){try{const groupItem = createGroupItem(group,elements);if (groupItem){itemsToAdd.push({item:groupItem,id:groupId,priority:group.priority,isGroup:true});}}catch (error){console.warn('[stack] Failed to create group item:',groupId,error);}}});// Sort by saved order,then by priority if (savedOrder.length > 0){itemsToAdd.sort((a,b) =>{const aIndex = savedOrder.findIndex(s => s.id === a.id);const bIndex = savedOrder.findIndex(s => s.id === b.id);if (aIndex >= 0 && bIndex >= 0) return aIndex - bIndex;if (aIndex >= 0) return -1;if (bIndex >= 0) return 1;return a.priority - b.priority;});}else{itemsToAdd.sort((a,b) => a.priority - b.priority);}// Add items to list with safety checks itemsToAdd.forEach(({item}) =>{try{if (item && !list.contains(item) && !item.contains(list)){list.appendChild(item);}}catch (error){console.warn('[stack] Failed to add item to list:',error);}});applyCompactSpacing(compactSpacing);save(list);attachFooter(footer);}function setCompactSpacing(enabled){compactSpacing = !!enabled;applyCompactSpacing(compactSpacing);}function getCompactSpacing(){return compactSpacing;}function boot(){const refs=ensureStack();if(!refs) return;populate(refs);const observer=new MutationObserver(()=>populate(refs));const leftpad = document.getElementById('btfw-leftpad');const main = document.getElementById('main');if (leftpad){observer.observe(leftpad,{childList:true,subtree:false});}if (main){observer.observe(main,{childList:true,subtree:false});}setTimeout(() =>{const playlistGroup = document.querySelector('.btfw-stack-item[data-bind="playlist-group"]');if (!playlistGroup) return;const storedVisibility = getStoredPlaylistVisibility();const shouldBeOpen = storedVisibility !== null ? storedVisibility:true;playlistGroup.dataset.open = shouldBeOpen ? 'true':'false';playlistGroup.classList.toggle('is-open',shouldBeOpen);},1000);let n=0;const iv=setInterval(()=>{populate(refs);if(++n>8) clearInterval(iv);},700);}document.addEventListener("btfw:layoutReady",boot);setTimeout(boot,1200);document.addEventListener("btfw:channelThemeTint",() =>{const refs = ensureStack();if (refs){setTimeout(() => populate(refs),100);}});document.addEventListener("btfw:layout:orientation",() =>{requestAnimationFrame(() => applyCompactSpacing(compactSpacing));});document.addEventListener("btfw:stack:compactChanged",(ev) =>{if (ev && ev.detail && "enabled" in ev.detail){setCompactSpacing(!!ev.detail.enabled);}else{applyCompactSpacing(compactSpacing);}});return{name:"feature:stack",setCompactSpacing,getCompactSpacing};});BTFW.define("feature:videoOverlay",["feature:ambient"],async () =>{const $ = (selector,root = document) => root.querySelector(selector);const CONTROL_SELECTORS = [ "#mediarefresh","#voteskip","#fullscreenbtn" ];const LS ={localSubs:"btfw:video:localsubs"};const localSubsEnabled = () =>{try{return localStorage.getItem(LS.localSubs) !== "0";}catch (_){return true;}};const setLocalSubs = (value) =>{try{localStorage.setItem(LS.localSubs,value ? "1":"0");}catch (_){}document.dispatchEvent( new CustomEvent("btfw:video:localsubs:changed",{detail:{enabled:!!value}}) );};let refreshClickCount = 0;let refreshCooldownUntil = 0;let lastRefreshTimestamp = 0;const USER_REFRESH_INTERVAL = 2000;const AUTO_REFRESH_BASE_INTERVAL = 8000;const AUTO_REFRESH_MAX_INTERVAL = 45000;const AUTO_IDLE_RESET_INTERVAL = 120000;let autoRefreshInterval = AUTO_REFRESH_BASE_INTERVAL;let ambientModulePromise = null;let airplayListenerAttached = false;let trackedAirplayVideo = null;function ensureCSS(){if ($("#btfw-vo-css")) return;const st = document.createElement("style");st.id = "btfw-vo-css";st.textContent = ` #btfw-video-overlay{position:absolute;inset:0;pointer-events:none;z-index:1000;opacity:0;transition:opacity 0.3s ease;background:linear-gradient( to bottom,rgba(0,0,0,0.45) 0%,rgba(0,0,0,0.35) 12%,rgba(0,0,0,0.18) 32%,rgba(0,0,0,0.08) 55%,transparent 75% );}#btfw-video-overlay.btfw-vo-visible{opacity:1;}#btfw-video-overlay .btfw-vo-bar{position:absolute;right:12px;top:12px;left:12px;display:flex;gap:8px;pointer-events:auto;background:transparent;}#btfw-video-overlay .btfw-vo-section{display:flex;align-items:center;gap:8px;pointer-events:auto;}#btfw-video-overlay .btfw-vo-section--right{margin-left:auto;}#btfw-video-overlay .btfw-vo-btn,#btfw-video-overlay .btfw-vo-adopted{all:unset;box-sizing:border-box;display:inline-grid;place-items:center;min-width:44px;height:44px;padding:0;border-radius:22px;border:0;background:rgba(0,0,0,0.42);color:#fff;cursor:pointer;font:600 14px/1.05 "Inter","Segoe UI",system-ui,-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,sans-serif;letter-spacing:0.01em;backdrop-filter:blur(12px) saturate(120%);box-shadow:0 2px 8px rgba(0,0,0,0.18);transition:all 0.2s cubic-bezier(0.4,0,0.2,1);text-decoration:none;}#btfw-video-overlay .btfw-vo-btn i,#btfw-video-overlay .btfw-vo-adopted i{transition:transform 0.2s ease;font-size:16px;}#btfw-video-overlay .btfw-vo-btn:hover,#btfw-video-overlay .btfw-vo-adopted:hover{background:rgba(109,77,246,0.82);transform:translateY(-1px);box-shadow:0 4px 16px rgba(109,77,246,0.36);}#btfw-video-overlay .btfw-vo-btn:hover i,#btfw-video-overlay .btfw-vo-adopted:hover i{transform:scale(1.08);}#btfw-video-overlay .btfw-vo-btn:active,#btfw-video-overlay .btfw-vo-adopted:active{transform:translateY(0);}#btfw-video-overlay .btfw-vo-btn:focus-visible,#btfw-video-overlay .btfw-vo-adopted:focus-visible{outline:2px solid rgba(109,77,246,0.95);outline-offset:2px;}#btfw-ambient.active{background:rgba(109,77,246,0.8);}.btfw-notification{position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:12px;color:#ffffff;font-size:14px;font-weight:500;z-index:10000;transform:translateX(100%);opacity:0;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);backdrop-filter:blur(12px) saturate(120%);box-shadow:0 4px 20px rgba(0,0,0,0.2);max-width:300px;}.btfw-notification--show{transform:translateX(0);opacity:1;}.btfw-notification--success{background:rgba(34,197,94,0.9);border:1px solid rgba(34,197,94,0.3);}.btfw-notification--error{background:rgba(239,68,68,0.9);border:1px solid rgba(239,68,68,0.3);}.btfw-notification--warning{background:rgba(245,158,11,0.9);border:1px solid rgba(245,158,11,0.3);}.btfw-notification--info{background:rgba(59,130,246,0.9);border:1px solid rgba(59,130,246,0.3);}#btfw-mini-toast{position:fixed;right:12px;bottom:12px;background:#111a;color:#fff;padding:8px 12px;border-radius:8px;font:12px/1.2 system-ui,Segoe UI,Arial;z-index:99999;pointer-events:none;opacity:0;transition:opacity .2s}@media (max-width:768px){#btfw-video-overlay .btfw-vo-bar{top:8px;right:8px;left:8px;gap:6px;}#btfw-video-overlay .btfw-vo-section{gap:6px;flex-wrap:wrap;}#btfw-video-overlay .btfw-vo-btn,#btfw-video-overlay .btfw-vo-adopted{min-width:40px;height:40px;border-radius:20px;font-size:12px;}}`;document.head.appendChild(st);}function ensureOverlay(){const wrap = $("#videowrap");if (!wrap) return null;let overlay = $("#btfw-video-overlay");if (!overlay){overlay = document.createElement("div");overlay.id = "btfw-video-overlay";}overlay.classList.add("btfw-video-overlay");if (overlay.parentElement !== wrap) wrap.appendChild(overlay);let bar = overlay.querySelector("#btfw-vo-bar");if (!bar){bar = document.createElement("div");bar.className = "btfw-vo-bar";bar.id = "btfw-vo-bar";overlay.appendChild(bar);}const sections = ensureOverlaySections(overlay,bar);setupHoverEffects(wrap,overlay);ensureLocalSubsButton(sections.left);ensureCustomButtons(sections);adoptNativeControls(sections);restyleOverlayButtons(overlay);return overlay;}function restyleOverlayButtons(overlay){if (!overlay) return;overlay .querySelectorAll("button") .forEach((btn) =>{if (!btn.classList.contains("btfw-vo-btn")){btn.classList.add("btfw-vo-btn");}});}function ensureOverlaySections(overlay,bar){const leftId = "btfw-vo-left";const rightId = "btfw-vo-right";let left = bar.querySelector(`#${leftId}`);if (!left){left = document.createElement("div");left.id = leftId;left.className = "btfw-vo-section btfw-vo-section--left";bar.insertBefore(left,bar.firstChild);}let right = bar.querySelector(`#${rightId}`);if (!right){right = document.createElement("div");right.id = rightId;right.className = "btfw-vo-section btfw-vo-section--right";bar.appendChild(right);}Array.from(bar.children).forEach((child) =>{if (child === left || child === right) return;right.appendChild(child);});overlay.dataset.leftSection = `#${leftId}`;overlay.dataset.rightSection = `#${rightId}`;bar.dataset.leftSection = `#${leftId}`;bar.dataset.rightSection = `#${rightId}`;return{left,right};}function ensureAmbientModule(){if (ambientModulePromise) return ambientModulePromise;if (!window.BTFW || typeof BTFW.init !== "function"){return Promise.reject(new Error("Ambient module unavailable"));}ambientModulePromise = BTFW.init("feature:ambient").catch((err) =>{ambientModulePromise = null;throw err;});return ambientModulePromise;}function updateAmbientButton(active){const btn = $("#btfw-ambient");if (!btn) return;btn.classList.toggle("active",!!active);}function syncAmbientButton(){const btn = $("#btfw-ambient");if (!btn) return;ensureAmbientModule() .then((ambient) =>{updateAmbientButton(ambient.isActive());}) .catch(() =>{});}document.addEventListener("btfw:ambient:state",(event) =>{updateAmbientButton(event?.detail?.active);});function getAirplayCandidate(){return document.querySelector("#ytapiplayer video,video");}function hasAirplaySupport(video = getAirplayCandidate()){if (!video) return false;return ( typeof window.WebKitPlaybackTargetAvailabilityEvent !== "undefined" || typeof video.webkitShowPlaybackTargetPicker === "function" );}function unbindAirplayAvailability(){if (!trackedAirplayVideo) return;const handler = trackedAirplayVideo._btfwAirplayHandler;if (handler){try{trackedAirplayVideo.removeEventListener("webkitplaybacktargetavailabilitychanged",handler);}catch (_){}delete trackedAirplayVideo._btfwAirplayHandler;}trackedAirplayVideo = null;}function bindAirplayAvailability(video){if (!video || typeof video.addEventListener !== "function"){unbindAirplayAvailability();return;}if (trackedAirplayVideo === video) return;unbindAirplayAvailability();const handler = (event) =>{const available = !event || event.availability === "available";const btn = $("#btfw-airplay");if (!btn) return;btn.style.display = available ? "":"none";};try{video.addEventListener("webkitplaybacktargetavailabilitychanged",handler);video._btfwAirplayHandler = handler;trackedAirplayVideo = video;}catch (_){}}function updateAirplayButtonVisibility(){const btn = $("#btfw-airplay");if (!btn) return;const video = getAirplayCandidate();const supported = hasAirplaySupport(video);if (!supported){btn.style.display = "none";unbindAirplayAvailability();return;}btn.style.display = "";bindAirplayAvailability(video);}function setupHoverEffects(videowrap,overlay){if (overlay._hoverSetup) return;overlay._hoverSetup = true;let hideTimer = null;function showOverlay(){clearTimeout(hideTimer);overlay.classList.add("btfw-vo-visible");overlay.style.pointerEvents = "none";}function hideOverlay(){overlay.classList.remove("btfw-vo-visible");}function scheduleHide(){clearTimeout(hideTimer);hideTimer = setTimeout(hideOverlay,3000);}videowrap.addEventListener("mouseenter",showOverlay);videowrap.addEventListener("mousemove",() =>{showOverlay();scheduleHide();});videowrap.addEventListener("mouseleave",hideOverlay);overlay.addEventListener("mouseenter",() =>{clearTimeout(hideTimer);showOverlay();});overlay.addEventListener("mouseleave",scheduleHide);}function ensureCustomButtons(sections){if (!sections?.right || !sections?.left) return;const customButtons = [];if (!document.querySelector("#fullscreenbtn")){customButtons.push({id:"btfw-fullscreen",icon:"fas fa-expand",tooltip:"Fullscreen",action:toggleFullscreen,section:"right"});}customButtons.push({id:"btfw-ambient",icon:"fas fa-sun",tooltip:"Ambient Mode",action:toggleAmbient,section:"left"},{id:"btfw-airplay",icon:"fas fa-cast",tooltip:"AirPlay",action:enableAirplay,section:"right"});customButtons.forEach((btnConfig) =>{let btn = document.querySelector(`#${btnConfig.id}`);const target = btnConfig.section === "left" ? sections.left:sections.right;if (!btn){btn = document.createElement("button");btn.id = btnConfig.id;btn.className = "btfw-vo-btn";btn.innerHTML = `<i class="${btnConfig.icon}"></i>`;btn.title = btnConfig.tooltip;btn.addEventListener("click",btnConfig.action);(target || sections.right).appendChild(btn);}else if (target && btn.parentElement !== target){target.appendChild(btn);}});syncAmbientButton();updateAirplayButtonVisibility();}function adoptNativeControls(sections){const targetSection = sections?.right;if (!targetSection) return;CONTROL_SELECTORS.forEach((selector) =>{const el = document.querySelector(selector);if (!el) return;if (el.dataset.btfwOverlay === "1"){if (el.parentElement !== targetSection) targetSection.appendChild(el);return;}const placeholder = document.createElement("span");placeholder.hidden = true;placeholder.setAttribute("data-btfw-ph",selector);try{el.insertAdjacentElement("afterend",placeholder);}catch (_){}el.classList.add("btfw-vo-adopted");el.dataset.btfwOverlay = "1";if (el.id === "mediarefresh"){const original = el.onclick;el.onclick = (event) =>{event.preventDefault();const isUserAction = !!(event && event.isTrusted);handleMediaRefresh(() =>{if (typeof original === "function"){try{original.call(el,event);return true;}catch (err){console.warn("[video-overlay] native refresh handler failed:",err);}}return false;},{isUserAction});};}targetSection.appendChild(el);});}function emitNativeRefresh(){try{if (window.socket){socket.emit("playerReady");return true;}}catch (e){console.warn("[video-overlay] Media refresh failed:",e);}return false;}function handleMediaRefresh(triggerOriginal,options ={}){const{isUserAction = false}= options;const now = Date.now();if (lastRefreshTimestamp && now - lastRefreshTimestamp > AUTO_IDLE_RESET_INTERVAL){autoRefreshInterval = AUTO_REFRESH_BASE_INTERVAL;refreshClickCount = 0;}if (now < refreshCooldownUntil){const remainingSeconds = Math.ceil((refreshCooldownUntil - now) / 1000);showNotification( isUserAction ? `Refresh available in ${remainingSeconds}s`:`Auto refresh paused. Next attempt in ${remainingSeconds}s`,"warning" );return false;}const minInterval = isUserAction ? USER_REFRESH_INTERVAL:autoRefreshInterval;if (lastRefreshTimestamp && now - lastRefreshTimestamp < minInterval){const waitMs = minInterval - (now - lastRefreshTimestamp);const waitSeconds = Math.ceil(waitMs / 1000);refreshCooldownUntil = now + waitMs;showNotification( isUserAction ? `Refresh available in ${waitSeconds}s`:`Auto refresh paused. Next attempt in ${waitSeconds}s`,"warning" );return false;}refreshClickCount++;if (refreshClickCount >= 10){refreshCooldownUntil = now + 30000;refreshClickCount = 0;showNotification("Refresh limit reached. 30s cooldown active.","error");return false;}const decayMs = isUserAction ? 6000:Math.max(12000,autoRefreshInterval + 2000);setTimeout(() =>{if (refreshClickCount > 0) refreshClickCount--;},decayMs);let handled = false;if (typeof triggerOriginal === "function"){try{handled = triggerOriginal() === true;}catch (err){console.warn("[video-overlay] Refresh handler error:",err);}}if (!handled){handled = emitNativeRefresh();}lastRefreshTimestamp = Date.now();if (isUserAction){autoRefreshInterval = AUTO_REFRESH_BASE_INTERVAL;}else{const multiplier = handled ? 1.25:1.5;autoRefreshInterval = Math.min( AUTO_REFRESH_MAX_INTERVAL,Math.max(AUTO_REFRESH_BASE_INTERVAL,Math.round(autoRefreshInterval * multiplier)) );}const nextWindow = isUserAction ? USER_REFRESH_INTERVAL:autoRefreshInterval;refreshCooldownUntil = Math.max(refreshCooldownUntil,lastRefreshTimestamp + nextWindow);if (!isUserAction && handled){showNotification( `Auto refresh sent. Next attempt in ${Math.ceil(autoRefreshInterval / 1000)}s`,"info" );}else{showNotification( handled ? "Media refreshed":"Unable to refresh media",handled ? "success":"error" );}return handled;}function toggleFullscreen(){const videowrap = $("#videowrap");if (!videowrap) return;if (!document.fullscreenElement){if (videowrap.requestFullscreen){videowrap.requestFullscreen();}else if (videowrap.webkitRequestFullscreen){videowrap.webkitRequestFullscreen();}else if (videowrap.mozRequestFullScreen){videowrap.mozRequestFullScreen();}}else{if (document.exitFullscreen){document.exitFullscreen();}else if (document.webkitExitFullscreen){document.webkitExitFullscreen();}else if (document.mozCancelFullScreen){document.mozCancelFullScreen();}}}async function toggleAmbient(){try{const ambient = await ensureAmbientModule();const enabling = !ambient.isActive();const active = await ambient.toggle();if (active){try{ambient.refresh();}catch (_){}}updateAmbientButton(active);if (active){showNotification("Ambient mode enabled","info");}else if (enabling){showNotification("Unable to enable ambient mode","error");}else{showNotification("Ambient mode disabled","info");}}catch (e){console.warn("[video-overlay] Ambient toggle failed:",e);showNotification("Failed to toggle ambient mode","error");}}function applyAirplayAttributes(video,showPicker = true){if (!video || !hasAirplaySupport(video)) return false;video.setAttribute("airplay","allow");video.setAttribute("x-webkit-airplay","allow");if (showPicker && typeof video.webkitShowPlaybackTargetPicker === "function"){try{video.webkitShowPlaybackTargetPicker();}catch (err){console.warn("[video-overlay] AirPlay picker failed:",err);}}updateAirplayButtonVisibility();return true;}function attachAirplayListener(){if (airplayListenerAttached || !window.socket) return;airplayListenerAttached = true;try{socket.on("changeMedia",() =>{setTimeout(() =>{const video = getAirplayCandidate();if (video){applyAirplayAttributes(video,false);bindAirplayAvailability(video);}updateAirplayButtonVisibility();},1000);});}catch (err){console.warn("[video-overlay] Failed to attach AirPlay listener:",err);}}function enableAirplay(){const video = getAirplayCandidate();if (!hasAirplaySupport(video)){updateAirplayButtonVisibility();showNotification("AirPlay not available","warning");return false;}if (applyAirplayAttributes(video)){showNotification("AirPlay enabled","success");attachAirplayListener();return true;}showNotification("AirPlay not available","warning");return false;}function showNotification(message,type = "info"){let notification = document.getElementById("btfw-notification");if (!notification){notification = document.createElement("div");notification.id = "btfw-notification";notification.className = "btfw-notification";document.body.appendChild(notification);}notification.textContent = message;notification.className = `btfw-notification btfw-notification--${type}btfw-notification--show`;clearTimeout(notification._hideTimer);notification._hideTimer = setTimeout(() =>{notification.classList.remove("btfw-notification--show");},3000);}function getHTML5Video(){return $("video");}function srtToVtt(text){let s = (text || "").replace(/\r\n/g,"\n").trim() + "\n";s = s.replace(/^\d+\s*$\n/gm,"");s = s.replace(/(\d{2}:\d{2}:\d{2}),(\d{3})/g,"$1.$2");s = s.replace(/(\d{2}:\d{2}:\d{2}\.\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2}\.\d{3})/g,"$1 --> $2");return "WEBVTT\n\n" + s;}async function pickLocalSubs(){const video = getHTML5Video();if (!video){toast("Local subs only for HTML5 sources.");return;}const inp = document.createElement("input");inp.type = "file";inp.accept = ".vtt,.srt,text/vtt,text/plain";inp.style.display = "none";document.body.appendChild(inp);const done = new Promise((resolve) =>{inp.addEventListener( "change",async () =>{const f = inp.files && inp.files[0];document.body.removeChild(inp);if (!f) return resolve(false);try{const txt = await f.text();const ext = (f.name.split(".").pop() || "").toLowerCase();const vtt = ext === "srt" ? srtToVtt(txt):txt.startsWith("WEBVTT") ? txt:"WEBVTT\n\n" + txt;const url = URL.createObjectURL(new Blob([vtt],{type:"text/vtt"}));attachTrack(video,url,f.name.replace(/\.[^.]+$/,"") || "Local");toast("Subtitles loaded.");resolve(true);}catch (e){console.error(e);toast("Failed to load subtitles.");resolve(false);}},{once:true});});inp.click();await done;}function attachTrack(video,url,label){$("track[data-btfw=\"1\"]",video)?.remove();const tr = document.createElement("track");tr.kind = "subtitles";tr.label = label || "Local";tr.srclang = "en";tr.src = url;tr.default = true;tr.setAttribute("data-btfw","1");video.appendChild(tr);try{for (const t of video.textTracks) t.mode = t.label === tr.label ? "showing":"disabled";}catch (_){}}function toast(msg){let t = $("#btfw-mini-toast");if (!t){t = document.createElement("div");t.id = "btfw-mini-toast";document.body.appendChild(t);}t.textContent = msg;t.style.opacity = "1";clearTimeout(t._hid);t._hid = setTimeout(() => (t.style.opacity = "0"),1400);}function ensureLocalSubsButton(section){if (!section) return;let btn = document.querySelector("#btfw-vo-subs");if (!btn){btn = document.createElement("button");btn.id = "btfw-vo-subs";btn.className = "btfw-vo-btn";btn.title = "Load local subtitles (.vtt/.srt)";btn.innerHTML = `<i class="fa fa-closed-captioning"></i>`;btn.addEventListener("click",(e) =>{e.preventDefault();pickLocalSubs();});section.insertBefore(btn,section.firstChild || null);}btn.style.display = localSubsEnabled() ? "":"none";}function boot(){ensureCSS();ensureOverlay();const targets = [ $("#videowrap"),$("#rightcontrols"),$("#leftcontrols"),document.body ].filter(Boolean);const mo = new MutationObserver(() => ensureOverlay());targets.forEach((target) => mo.observe(target,{childList:true,subtree:true}));document.addEventListener("btfw:video:localsubs:changed",() => ensureOverlay());}if (document.readyState === "loading") document.addEventListener("DOMContentLoaded",boot);else boot();return{name:"feature:videoOverlay",setLocalSubsEnabled:setLocalSubs,toggleFullscreen,toggleAmbient,enableAirplay};});BTFW.define("feature:videoEnhancements",[],async () =>{// Title length CSS variable handling function updateTitleLength(){const titleElements = document.querySelectorAll("#currenttitle,.current-title");titleElements.forEach(el =>{const text = (el.textContent || el.innerText || "").trim();el.style.setProperty("--length",text.length);});}// Remove the fullscreen button if present function removeVjsFullscreenButton(){const fullscreenBtn = document.querySelector(".vjs-fullscreen-control");if (fullscreenBtn){fullscreenBtn.remove();}}// Hide the quality button when there are no real options function handleQualityButton(){const qualityBtn = document.querySelector(".vjs-resolution-button");if (!qualityBtn) return;const qualityMenu = qualityBtn.querySelector(".vjs-menu");if (!qualityMenu){qualityBtn.style.display = "none";return;}const menuItems = qualityMenu.querySelectorAll(".vjs-menu-item");if (menuItems.length <= 1){qualityBtn.style.display = "none";}}// Ensure the fullscreen button is hidden via CSS as a fallback function ensureFullscreenCss(){if (document.getElementById("btfw-video-enhancements-style")) return;const style = document.createElement("style");style.id = "btfw-video-enhancements-style";style.textContent = ` .vjs-fullscreen-control{display:none !important;}`;document.head.appendChild(style);}// Try to remove fullscreen controls and hide unused quality options function tryHideQuality(){removeVjsFullscreenButton();handleQualityButton();}// Media URL processing and title extraction function processMediaUrl(urlInput){if (!urlInput || !urlInput.value) return;let url = urlInput.value.trim();if (!url) return;// Dropbox URL transformation url = url.replace("//www.dropbox.com/s/","//dl.dropbox.com/s/") .replace("?dl=0","") .replace("?a=view","");urlInput.value = url;// Auto-title extraction setTimeout(() =>{const titleInput = document.querySelector("#addfromurl-title-val,#mediaurl-title,.media-title-input");if (titleInput && !titleInput.value.trim()){try{const decodedUrl = decodeURI(url);const pathParts = decodedUrl.split("/");const filename = pathParts[pathParts.length - 1];const nameParts = filename.split("?")[0].split(".");// Build title from filename parts (exclude extension) let title = "";for (let i = 0;i < nameParts.length - 1;i++){title += nameParts[i] + (i < nameParts.length - 2 ? ".":"");}// Clean up title title = title.replace(/[._-]/g," ") .replace(/\s+/g," ") .trim();if (title){titleInput.value = title;}}catch (err){console.warn("[video-enhancements] Title extraction failed:",err);}}},100);}// Setup media URL processing function bindMediaUrlProcessing(){const urlInputs = document.querySelectorAll("#mediaurl,.media-url-input");urlInputs.forEach(input =>{if (input._btfwUrlBound) return;input._btfwUrlBound = true;input.addEventListener("paste",() =>{setTimeout(() => processMediaUrl(input),50);});input.addEventListener("input",() =>{setTimeout(() => processMediaUrl(input),50);});});}// changeMedia event handler function handleChangeMedia(){setTimeout(() =>{updateTitleLength();},100);setTimeout(tryHideQuality,500);setTimeout(tryHideQuality,1000);setTimeout(tryHideQuality,2000);}// Initialize function boot(){// Initial setup updateTitleLength();bindMediaUrlProcessing();ensureFullscreenCss();tryHideQuality();setTimeout(tryHideQuality,500);setTimeout(tryHideQuality,1000);setTimeout(tryHideQuality,2000);// Bind to changeMedia event if (window.socket){try{socket.on("changeMedia",handleChangeMedia);}catch (err){console.warn("[video-enhancements] Failed to bind changeMedia:",err);}}// Watch for DOM changes to rebind URL processing const observer = new MutationObserver(() =>{bindMediaUrlProcessing();});observer.observe(document.body,{childList:true,subtree:true});}if (document.readyState === "loading"){document.addEventListener("DOMContentLoaded",boot);}else{boot();}return{name:"feature:videoEnhancements",updateTitleLength:updateTitleLength};});BTFW.define("feature:ambient",[],async () =>{// const STORAGE_KEY = "btfw:ambient:enabled";const $ = (selector,root = document) => root.querySelector(selector);let active = false;let wrap = null;let monitorTimer = null;let currentVideo = null;let glowVideo = null;let glowContainer = null;let waitForWrapPromise = null;let socketListenerAttached = false;let syncHandler = null;function ensureCSS(){if (document.getElementById("btfw-ambient-css")) return;const st = document.createElement("style");st.id = "btfw-ambient-css";st.textContent = ` .btfw-ambient-glow-bg{position:fixed;pointer-events:none;z-index:-1;opacity:0;transition:opacity 0.6s ease;will-change:opacity;mix-blend-mode:screen;}.btfw-ambient-glow-bg.btfw-ambient-active{opacity:1;}.btfw-ambient-glow-bg video{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(1.3);width:100%;height:100%;object-fit:cover;filter:blur(clamp(60px,8vw,90px)) saturate(280%) brightness(1.8) contrast(1.3);opacity:1;}body.btfw-ambient-active #main,body.btfw-ambient-active #videowrap,body.btfw-ambient-active #chatwrap{position:relative;z-index:2;}body.btfw-ambient-active,html[data-btfw-theme] body.btfw-ambient-active{background-color:color-mix(in srgb,var(--btfw-theme-bg,#13030c) 40%,transparent) !important;}body.btfw-ambient-active #main,body.btfw-ambient-active #chatwrap,body.btfw-ambient-active #videowrap,body.btfw-ambient-active .panel,body.btfw-ambient-active #userlist,body.btfw-ambient-active #messagebuffer,body.btfw-ambient-active #chatline{background-color:color-mix(in srgb,var(--btfw-theme-bg) 40%,transparent) !important;}body.btfw-ambient-active #chatwrap,body.btfw-ambient-active #userlist{background-color:color-mix(in srgb,var(--btfw-theme-surface) 40%,transparent) !important;}body.btfw-ambient-active .panel-heading,body.btfw-ambient-active .panel-body{background-color:color-mix(in srgb,var(--btfw-theme-panel) 40%,transparent) !important;}#videowrap.btfw-ambient-ready{isolation:isolate;}@media (max-width:768px){.btfw-ambient-glow-bg video{transform:translate(-50%,-50%) scale(1.2);filter:blur(clamp(50px,10vw,70px)) saturate(260%) brightness(1.7) contrast(1.25);opacity:0.95;}}`;document.head.appendChild(st);}// function removeCSS(){// const st = document.getElementById("btfw-ambient-css");// if (st && st.parentNode){// st.parentNode.removeChild(st);//}//}function waitForWrap(timeout = 5000){if (waitForWrapPromise) return waitForWrapPromise;const immediate = $("#videowrap");if (immediate) return Promise.resolve(immediate);waitForWrapPromise = new Promise((resolve) =>{if (!document.body){resolve(null);return;}const deadline = Date.now() + timeout;const observer = new MutationObserver(() =>{const found = $("#videowrap");if (found){observer.disconnect();waitForWrapPromise = null;resolve(found);}else if (Date.now() > deadline){observer.disconnect();waitForWrapPromise = null;resolve(null);}});observer.observe(document.body,{childList:true,subtree:true});setTimeout(() =>{observer.disconnect();waitForWrapPromise = null;resolve($("#videowrap"));},timeout);});return waitForWrapPromise;}function ensureAmbientRoot(preferredWrap = null){const nextWrap = preferredWrap || $("#videowrap");if (!nextWrap) return null;if (wrap && wrap !== nextWrap){wrap.classList.remove("btfw-ambient-ready");wrap = null;}wrap = nextWrap;// Add ready class when enabling if (active){wrap.classList.add("btfw-ambient-ready");}return wrap;}// function getStoredPreference(){// // Always return false - don't remember state between sessions // return false;//}// function setStoredPreference(value){// // Don't store preference - always start disabled // return;//}function findVideoElement(){return $("#ytapiplayer video") || $("#videowrap video") || document.querySelector("video");}function cleanupGlowElements(){// Remove from DOM completely const existingGlow = document.querySelector(".btfw-ambient-glow-bg");if (existingGlow && existingGlow.parentNode){existingGlow.parentNode.removeChild(existingGlow);}glowContainer = null;glowVideo = null;}function createGlowElements(){// Always clean up first to prevent duplicates cleanupGlowElements();if (!wrap) return;const videoElement = findVideoElement();if (!videoElement) return;// Create glow container on body for full page glow glowContainer = document.createElement("div");glowContainer.className = "btfw-ambient-glow-bg";glowContainer.setAttribute("aria-hidden","true");// Create cloned video for glow effect glowVideo = document.createElement("video");glowVideo.muted = true;glowVideo.playsInline = true;glowVideo.loop = true;glowVideo.preload = "auto";glowVideo.setAttribute("aria-hidden","true");glowVideo.controls = false;glowVideo.disablePictureInPicture = true;glowContainer.appendChild(glowVideo);document.body.appendChild(glowContainer);// Position and activate updateGlowPosition();if (active){glowContainer.classList.add("btfw-ambient-active");}}function updateGlowPosition(){if (!glowContainer || !wrap) return;const rect = wrap.getBoundingClientRect();const padding = 100;glowContainer.style.top = `${rect.top - padding}px`;glowContainer.style.left = `${rect.left - padding}px`;glowContainer.style.width = `${rect.width + padding * 2}px`;glowContainer.style.height = `${rect.height + padding * 2}px`;}function syncVideos(){if (!currentVideo || !glowVideo) return;try{const src = currentVideo.src || currentVideo.currentSrc;if (src && glowVideo.src !== src){glowVideo.src = src;}const timeDiff = Math.abs(currentVideo.currentTime - glowVideo.currentTime);if (timeDiff > 0.3){glowVideo.currentTime = currentVideo.currentTime;}if (!currentVideo.paused && glowVideo.paused){glowVideo.play().catch(() =>{});}else if (currentVideo.paused && !glowVideo.paused){glowVideo.pause();}}catch (_){}}function detachVideoListeners(){if (!currentVideo || !syncHandler) return;const events = ["loadeddata","play","pause","seeked","timeupdate","ended","emptied"];events.forEach((evt) =>{try{currentVideo.removeEventListener(evt,syncHandler);}catch (_){}});syncHandler = null;currentVideo = null;}function attachVideo(video){if (currentVideo === video) return;detachVideoListeners();currentVideo = video && video.tagName === "VIDEO" ? video:null;if (!currentVideo){return;}// Create glow elements if they don't exist if (!glowContainer){createGlowElements();}syncHandler = () => syncVideos();const events = ["loadeddata","play","pause","seeked","timeupdate"];events.forEach((evt) =>{try{currentVideo.addEventListener(evt,syncHandler);}catch (_){}});syncVideos();}function startMonitoring(){if (monitorTimer) return;monitorTimer = window.setInterval(() =>{if (!active) return;const wrapNow = $("#videowrap");if (!wrapNow){if (wrap && !wrap.isConnected){wrap.classList.remove("btfw-ambient-ready");wrap = null;}}else if (wrapNow !== wrap || !wrap || !wrap.classList.contains("btfw-ambient-ready")){ensureAmbientRoot(wrapNow);}const videoEl = findVideoElement();if (videoEl !== currentVideo){attachVideo(videoEl);}// Update glow position updateGlowPosition();},500);// Update position on scroll and resize const throttledUpdate = () =>{if (active) updateGlowPosition();};window.addEventListener('scroll',throttledUpdate,{passive:true});window.addEventListener('resize',throttledUpdate,{passive:true});wireSocketListener();}function stopMonitoring(){if (monitorTimer){clearInterval(monitorTimer);monitorTimer = null;}window.removeEventListener('scroll',updateGlowPosition);window.removeEventListener('resize',updateGlowPosition);detachVideoListeners();}function wireSocketListener(){if (socketListenerAttached) return;try{if (window.socket && typeof socket.on === "function"){socketListenerAttached = true;socket.on("changeMedia",() =>{if (!active) return;setTimeout(() =>{ensureAmbientRoot();attachVideo(findVideoElement());},400);});}}catch (_){}}async function enable(){if (active) return true;ensureCSS();const wrapEl = $("#videowrap") || (await waitForWrap());if (!wrapEl){console.warn("[ambient] Unable to locate #videowrap for ambient mode.");return false;}active = true;ensureAmbientRoot(wrapEl);// Add ambient class to body for background transparency document.body.classList.add("btfw-ambient-active");// Create glow and activate it const videoEl = findVideoElement();if (videoEl){createGlowElements();attachVideo(videoEl);}startMonitoring();dispatchState();return true;}async function disable(){if (!active) return true;active = false;// Remove ambient class from body document.body.classList.remove("btfw-ambient-active");if (wrap){wrap.classList.remove("btfw-ambient-ready");}// Remove glow with fade out if (glowContainer){glowContainer.classList.remove("btfw-ambient-active");setTimeout(() =>{cleanupGlowElements();},600);}stopMonitoring();dispatchState();return true;}async function toggle(){return (await (active ? disable():enable())) && active;}function refresh(){if (!active) return;ensureAmbientRoot();createGlowElements();attachVideo(findVideoElement());}function isActive(){return !!active;}function isSupported(){return true;}function dispatchState(){document.dispatchEvent( new CustomEvent("btfw:ambient:state",{detail:{active:!!active}}) );}function boot(){// Always start disabled - no memory of previous state // Feature will dispatch initial state as disabled dispatchState();}if (document.readyState === "loading"){document.addEventListener("DOMContentLoaded",boot);}else{boot();}return{name:"feature:ambient",enable,disable,toggle,refresh,isActive,isSupported};});BTFW.define("feature:pip",["feature:layout"],async ({}) =>{const KEY = "btfw:pip";function pref(){try{return localStorage.getItem(KEY)==="1";}catch(e){return !!window.BTFW_PIP;}}function setPref(v){try{localStorage.setItem(KEY,v ? "1":"0");}catch(e){}window.BTFW_PIP = !!v;document.dispatchEvent(new CustomEvent("btfw:pip:refresh"));}let io=null,originalParent=null,beforeNode=null;function ensureDock(){const chatcol=document.getElementById("btfw-chatcol");if(!chatcol) return null;let dock=document.getElementById("btfw-pip-dock");if(!dock){dock=document.createElement("div");dock.id="btfw-pip-dock";chatcol.prepend(dock);}return dock;}function toDock(){const video=document.getElementById("videowrap");if(!video) return;const dock=ensureDock();if(!dock) return;if(dock.contains(video)) return;originalParent=video.parentNode;beforeNode=video.nextSibling;dock.appendChild(video);video.classList.add("btfw-pip");}function toOriginal(){const video=document.getElementById("videowrap");if(!video) return;if(originalParent && !originalParent.contains(video)){if(beforeNode) originalParent.insertBefore(video,beforeNode);else originalParent.appendChild(video);}video.classList.remove("btfw-pip");}function start(){stop();const video=document.getElementById("videowrap");if(!video) return;io = new IntersectionObserver(entries =>{const e=entries[0];if(!e) return;if(e.intersectionRatio < 0.1) toDock();else toOriginal();},{threshold:[0,0.1,0.5,1]});io.observe(video);}function stop(){if(io){io.disconnect();io=null;}toOriginal();}document.addEventListener("btfw:pip:refresh",function(){if (pref()) start();else stop();});if (pref()) start();window.BTFW_setPiP = setPref;return{name:"feature:pip",set:setPref};});BTFW.define('feature:resize',[],async () => ({name:'feature:resize'}));