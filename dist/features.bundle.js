BTFW.define("feature:channels",[],async()=>{function t(){try{const t=window.BTFW||{},e=t.channelTheme||{},n=e.slider||{};let o=n.enabled,a=n.feedUrl||n.url||n.json||"";return void 0===o&&void 0!==e.sliderEnabled&&(o=e.sliderEnabled),a||(a=e.sliderJson||e.sliderJSON||""),void 0===o&&t.channelSlider&&(o=t.channelSlider.enabled,a||(a=t.channelSlider.feedUrl||"")),void 0===o&&void 0!==t.channelSliderEnabled&&(o=t.channelSliderEnabled),!a&&t.channelSliderJSON&&(a=t.channelSliderJSON),void 0===o&&void 0!==window.UI_ChannelList&&(o="1"===window.UI_ChannelList||1===window.UI_ChannelList),a||void 0===window.Channel_JSON||(a=window.Channel_JSON||""),void 0===o&&a&&(o=!0),{enabled:Boolean(o),url:a||""}}catch(t){return{enabled:!1,url:""}}}function e(){return t().enabled}function n(){if(document.getElementById("btfw-channels-css"))return;const t=document.createElement("style");t.id="btfw-channels-css",t.textContent="\n      .btfw-channels {\n        position: relative;\n        margin-top: 10px;\n        border-radius: 16px;\n        border: 1px solid rgba(109, 77, 246, 0.22);\n        border: 1px solid color-mix(in srgb, var(--btfw-theme-accent, #6d4df6) 28%, transparent 72%);\n        background: rgba(12, 18, 34, 0.92);\n        background: linear-gradient(135deg,\n          color-mix(in srgb, var(--btfw-theme-surface, #0b111d) 94%, transparent 6%),\n          color-mix(in srgb, var(--btfw-theme-panel, #141f36) 86%, black 14%));\n        padding: 10px 30px;\n        display: flex;\n        align-items: center;\n        gap: 14px;\n        width: 100%;\n        color: var(--btfw-theme-text, #e8ecfb);\n      }\n\n      .btfw-channels__viewport {\n        flex: 1 1 auto;\n        overflow: hidden;\n        touch-action: pan-y;\n      }\n\n      .btfw-channels__track {\n        display: flex;\n        gap: 16px;\n        transition: transform 0.3s ease;\n        will-change: transform;\n      }\n\n      .btfw-channels__item {\n        flex: 0 0 clamp(160px, 18vw, 220px);\n        max-width: clamp(160px, 18vw, 220px);\n      }\n\n      .btfw-channels__link {\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n        text-decoration: none;\n        color: color-mix(in srgb, var(--btfw-theme-text, #e8ecfb) 96%, transparent 4%);\n        background: var(--btfw-theme-surface, #0b111d);\n        background: color-mix(in srgb, var(--btfw-theme-surface, #0b111d) 88%, transparent 12%);\n        border-radius: 12px;\n        border: 1px solid color-mix(in srgb, var(--btfw-theme-accent, #6d4df6) 22%, transparent 78%);\n        overflow: hidden;\n        box-shadow: 0 14px 30px color-mix(in srgb, var(--btfw-theme-panel, #141f36) 28%, transparent 72%);\n        transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease, background 0.18s ease;\n        cursor: grab;\n        user-select: none;\n      }\n\n      .btfw-channels__link:hover,\n      .btfw-channels__link:focus {\n        transform: translateY(-4px);\n        border-color: color-mix(in srgb, var(--btfw-theme-accent, #6d4df6) 70%, white 30%);\n        background: color-mix(in srgb, var(--btfw-theme-panel, #141f36) 82%, var(--btfw-theme-accent, #6d4df6) 18%);\n        box-shadow: 0 18px 36px color-mix(in srgb, var(--btfw-theme-accent, #6d4df6) 35%, transparent 65%);\n      }\n\n      .btfw-channels__media {\n        position: relative;\n        width: 100%;\n        aspect-ratio: 16 / 6;\n        overflow: hidden;\n        background: var(--btfw-theme-panel, #141f36);\n        background: color-mix(in srgb, var(--btfw-theme-panel, #141f36) 88%, black 12%);\n      }\n\n      .btfw-channels__thumb {\n        width: 100%;\n        height: 100%;\n        object-fit: cover;\n        display: block;\n        transition: transform 0.2s ease;\n      }\n\n      .btfw-channels__thumb.is-missing {\n        opacity: 0.45;\n        object-fit: contain;\n      }\n\n      .btfw-channels__link:hover .btfw-channels__thumb {\n        transform: scale(1.05);\n      }\n\n      .btfw-channels__label {\n        padding: 10px 12px 14px;\n        font-weight: 600;\n        letter-spacing: 0.01em;\n        font-size: 14px;\n        color: color-mix(in srgb, var(--btfw-theme-text, #e6edf3) 92%, transparent 8%);\n        text-overflow: ellipsis;\n        overflow: hidden;\n        white-space: nowrap;\n      }\n\n      .btfw-channels__arrow {\n        width: 38px;\n        height: 38px;\n        border-radius: 50%;\n        border: 0;\n        display: inline-flex;\n        align-items: center;\n        justify-content: center;\n        background: color-mix(in srgb, var(--btfw-theme-accent, #6d4df6) 18%, rgba(255,255,255,0.08) 82%);\n        color: color-mix(in srgb, var(--btfw-theme-text, #e6edf3) 98%, transparent 2%);\n        font-size: 20px;\n        cursor: pointer;\n        transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;\n      }\n\n      .btfw-channels__arrow:hover:not([disabled]) {\n        background: color-mix(in srgb, var(--btfw-theme-accent, #6d4df6) 65%, white 35%);\n        box-shadow: 0 12px 24px color-mix(in srgb, var(--btfw-theme-accent, #6d4df6) 30%, transparent 70%);\n        transform: translateY(-2px);\n      }\n\n      .btfw-channels__arrow[disabled] {\n        opacity: 0.4;\n        cursor: default;\n        pointer-events: none;\n      }\n\n      .btfw-channels--dragging .btfw-channels__link {\n        cursor: grabbing;\n      }\n\n      .btfw-channels__empty {\n        padding: 24px;\n        color: color-mix(in srgb, var(--btfw-theme-text, #e6edf3) 80%, transparent 20%);\n        font-size: 15px;\n        width: 100%;\n        text-align: center;\n      }\n\n      .btfw-channels--no-scroll .btfw-channels__arrow {\n        display: none;\n      }\n\n      @media (max-width: 960px) {\n        .btfw-channels {\n          padding: 16px 44px;\n        }\n        .btfw-channels__item {\n          flex-basis: 190px;\n        }\n      }\n\n      @media (max-width: 768px) {\n        .btfw-channels {\n          padding: 14px 38px;\n          gap: 10px;\n        }\n        .btfw-channels__item {\n          flex-basis: 170px;\n        }\n        .btfw-channels__label {\n          font-size: 13px;\n        }\n        .btfw-channels__arrow {\n          width: 34px;\n          height: 34px;\n          font-size: 18px;\n        }\n      }\n\n      @media (max-width: 600px) {\n        .btfw-channels {\n          padding: 12px 32px;\n        }\n        .btfw-channels__item {\n          flex-basis: 150px;\n        }\n      }\n    ",document.head.appendChild(t)}function o(t){const e=document.querySelector('#btfw-stack .btfw-stack-item[data-bind="channels-group"] .btfw-stack-item__body');return!!e&&(t.parentElement!==e&&e.appendChild(t),t._btfwRecalc&&t._btfwRecalc(),!0)}function a(){document.querySelectorAll("#btfw-channels").forEach(t=>{if("function"==typeof t._btfwCleanup)try{t._btfwCleanup()}catch(t){}try{t.remove()}catch(t){}})}function r(t){a();const e=function(t){const e=document.createElement("section");e.className="btfw-channels",e.id="btfw-channels",e.dataset.title="Featured Channels";const n=document.createElement("button");n.type="button",n.className="btfw-channels__arrow btfw-channels__arrow--prev",n.setAttribute("aria-label","Scroll featured channels left"),n.innerHTML='<span aria-hidden="true">‚Äπ</span>';const o=document.createElement("button");o.type="button",o.className="btfw-channels__arrow btfw-channels__arrow--next",o.setAttribute("aria-label","Scroll featured channels right"),o.innerHTML='<span aria-hidden="true">‚Ä∫</span>';const a=document.createElement("div");a.className="btfw-channels__viewport",a.id="btfw-carousel";const r=document.createElement("div");if(r.className="btfw-channels__track",a.appendChild(r),0===t.length){const t=document.createElement("div");t.className="btfw-channels__empty",t.textContent="No channels available",r.appendChild(t)}else t.forEach((t,e)=>{const n=document.createElement("article");n.className="btfw-channels__item",n.dataset.index=String(e);const o=document.createElement("a");o.href=t.channel_url||"#",o.target="_blank",o.rel="noopener noreferrer",o.className="btfw-channels__link",o.title=t.title||t.channel_url;const a=document.createElement("div");a.className="btfw-channels__media";const i=document.createElement("img");i.className="btfw-channels__thumb",i.src=t.image_url,i.alt=t.title||"Channel thumbnail",i.loading="lazy",i.onerror=function(){this.classList.add("is-missing")},a.appendChild(i);const s=document.createElement("span");s.className="btfw-channels__label",s.textContent=t.title||t.channel_url||"Channel",o.appendChild(a),o.appendChild(s),n.appendChild(o),r.appendChild(n)});return e.appendChild(n),e.appendChild(a),e.appendChild(o),e}(t),n=document.getElementById("videowrap"),r=document.getElementById("btfw-leftpad");let i=!1;o(e)?i=!0:n&&r&&r.contains(n)?(r.insertBefore(e,n.nextSibling),i=!0):r&&(r.appendChild(e),i=!0),i||document.body.appendChild(e),function(t){if(o(t))return;let e=0;const n=setInterval(()=>{e+=1,(o(t)||e>10)&&clearInterval(n)},400)}(e),setTimeout(()=>{!function(t,e){if(!t||t._btfwCarouselWired)return;if(!e||0===e.length)return void t.classList.add("btfw-channels--no-scroll");t._btfwCarouselWired=!0;const n=t.querySelector(".btfw-channels__viewport"),o=t.querySelector(".btfw-channels__track"),a=t.querySelector(".btfw-channels__arrow--prev"),r=t.querySelector(".btfw-channels__arrow--next");if(!n||!o)return;const i=Array.from(o.children);if(!i.length)return void t.classList.add("btfw-channels--no-scroll");let s=0,l=0,c=0,d=null;const u=()=>{d&&(clearInterval(d),d=null)},f=()=>{u(),e.length<=1||(d=setInterval(()=>{const t=b();t<=0||(s=s>=t?0:s+1,w(s))},48e3))};function m(){const t=i.find(t=>t.getBoundingClientRect().width>0);if(!t)return l=0,void(c=0);const e=t.getBoundingClientRect();l=e.width;const n=window.getComputedStyle(o),a=parseFloat(n.columnGap||n.gap||"0");c=Number.isFinite(a)?a:0,p()}function b(){if(!l)return 0;const t=Math.max(1,Math.floor((n.clientWidth+c)/(l+c)));return Math.max(0,i.length-t)}function p(){const e=b();a&&(a.disabled=s<=0),r&&(r.disabled=s>=e),t.classList.toggle("btfw-channels--no-scroll",e<=0)}function w(t,e="smooth"){const o=b();s=Math.min(Math.max(t,0),o),n.scrollTo({left:(l+c)*s,behavior:e}),p()}a&&a.addEventListener("click",()=>{u(),w(s-1),f()}),r&&r.addEventListener("click",()=>{u(),w(s+1),f()}),n.addEventListener("scroll",()=>{if(!l)return;const t=Math.round(n.scrollLeft/(l+c));Number.isNaN(t)||(s=t,p())}),t.addEventListener("mouseenter",u),t.addEventListener("mouseleave",f),window.addEventListener("resize",m),m(),requestAnimationFrame(m),f(),t._btfwRecalc=()=>{m(),p()},t._btfwCleanup&&t._btfwCleanup(),t._btfwCleanup=()=>{d&&clearInterval(d),window.removeEventListener("resize",m)}}(e,t),e._btfwRecalc&&e._btfwRecalc()},150)}async function i(){if(a(),!e())return;const o=t().url||"";if(!o)return;const i=await async function(t){try{const e=await fetch(t);if(!e.ok)throw new Error(`HTTP ${e.status}`);const n=await e.json();return n.list&&n.list.channels&&Array.isArray(n.list.channels)?n.list.channels:n.channels&&Array.isArray(n.channels)?n.channels:Array.isArray(n)?n:[]}catch(t){return[]}}(o);if(0===i.length)return n(),void r([]);n(),r(i)}function s(){setTimeout(i,500),setTimeout(i,1500),setTimeout(i,3e3),document.addEventListener("btfw:layoutReady",()=>{setTimeout(i,300)});let t=null;document.addEventListener("btfw:channelThemeTint",()=>{t&&clearTimeout(t),t=setTimeout(()=>{t=null,i()},120)})}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",s):s(),{name:"feature:channels",initialize:i,isEnabled:e}}),BTFW.define("feature:footer",[],async()=>{const t=(t,e=document)=>e.querySelector(t);let e=!1;function n(){const e=function(){const e=document.getElementById("btfw-stack-footer");if(e){const t=document.getElementById("btfw-footer"),n=[];if(t&&t!==e&&!e.contains(t)){for(;t.firstChild;)n.push(t.firstChild);t.remove()}let o=e.querySelector("#btfw-footer")||e.querySelector(".btfw-footer");return o?(o.id="btfw-footer",o.classList.add("btfw-footer")):(o=document.createElement("div"),o.id="btfw-footer",o.className="btfw-footer",e.appendChild(o)),n.forEach(t=>o.appendChild(t)),e.querySelectorAll("#btfw-footer ~ .btfw-footer, #btfw-footer ~ #btfw-footer").forEach(t=>{if(t!==o){for(;t.firstChild;)o.appendChild(t.firstChild);t.remove()}}),o.classList.remove("btfw-footer--standalone"),o}let n=t("#btfw-footer")||t(".btfw-footer");n||(n=document.createElement("div"),n.id="btfw-footer",n.className="btfw-footer",(t("#btfw-content-stack")||t("#mainpage")||t("#main")||document.body).appendChild(n));return n}();if(!e)return null;let n=e.querySelector(".btfw-footer__inner");return n||(n=document.createElement("div"),n.className="btfw-footer__inner",e.appendChild(n)),n}function o(){const t=function(){const t=n();if(!t)return null;let e=t.querySelector(".btfw-footer__auth");return e||(e=document.createElement("div"),e.className="btfw-footer__auth",t.prepend(e)),e}();t&&["#logoutform","#loginform"].forEach(e=>{((t,e=document)=>Array.from(e.querySelectorAll(t)))(e).forEach(e=>{t.contains(e)||(e.classList.remove("navbar-text","pull-right"),e.classList.add("btfw-footer__form"),e.style.margin="0",e.style.display="inline-flex",t.appendChild(e))})})}function a(){!function(){const t=n();if(!t)return null;let e=t.querySelector(".btfw-footer-branding");e||(e=document.createElement("div"),e.className="btfw-footer-branding",e.innerHTML='\n    <div class="btfw-footer-branding__content">\n      <div class="btfw-footer-branding__disclaimer">\n        <p>\n          The author is not responsible for any contents linked or referred to from these pages.\n          All CyTu.be does is link or embed content that was uploaded to popular Online Video hosting sites like Youtube.com /\n          Google Drive. All Google users signed a contract with the sites when they set up their accounts which forces them not\n          to upload illegal content. (<a href="https://www.lumendatabase.org/topics/14" target="_blank" rel="noopener">DMCA Safe Harbor</a>)\n        </p>\n      </div>\n      <div class="btfw-footer-branding__credit">\n        <h4>\n          <span>BillTube Framework</span>\n          <a href="http://discord.gg/fwadWd9" target="_blank" rel="noopener">Available Now</a>\n        </h4>\n      </div>\n    </div>\n  ',t.appendChild(e))}()}function r(){document.querySelectorAll("footer#footer").forEach(t=>{t&&t.isConnected&&t.remove()})}function i(){!function(){if(e)return;e=!0;const t=document.createElement("style");t.id="btfw-footer-styles",t.textContent="\n      #btfw-footer, .btfw-footer {\n        width: 100%;\n      }\n\n      .btfw-footer__inner {\n        display: flex;\n        flex-direction: column;\n        gap: 2rem;\n        padding: 1.5rem 1rem 3rem;\n        color: rgba(255, 255, 255, 0.85);\n      }\n\n      .btfw-footer__auth {\n        display: flex;\n        flex-wrap: wrap;\n        gap: 0.75rem;\n        align-items: center;\n        justify-content: center;\n      }\n\n      .btfw-footer__form {\n        display: inline-flex !important;\n        gap: 0.35rem;\n        align-items: center;\n      }\n\n      .btfw-footer-branding {\n        border-top: 1px solid rgba(255, 255, 255, 0.12);\n        padding-top: 1.25rem;\n        font-size: 0.85rem;\n        background: rgba(5, 6, 13, 0.35);\n        border-radius: 12px;\n      }\n\n      .btfw-footer-branding__disclaimer {\n        margin-bottom: 1rem;\n        opacity: 0.8;\n      }\n\n      .btfw-footer-branding__disclaimer p {\n        margin: 0;\n        text-align: center;\n        line-height: 1.5;\n      }\n\n      .btfw-footer-branding__disclaimer a,\n      .btfw-footer-branding__credit a {\n        color: var(--btfw-color-accent, #6d4df6);\n        text-decoration: none;\n        font-weight: 600;\n      }\n\n      .btfw-footer-branding__disclaimer a:hover,\n      .btfw-footer-branding__credit a:hover {\n        text-decoration: underline;\n      }\n\n      .btfw-footer-branding__credit {\n        text-align: center;\n      }\n\n      .btfw-footer-branding__credit h4 {\n        margin: 0;\n        font-size: 1rem;\n        font-weight: 600;\n        display: flex;\n        flex-direction: column;\n        gap: 0.35rem;\n      }\n\n      @media (min-width: 640px) {\n        .btfw-footer__auth {\n          justify-content: flex-end;\n        }\n        .btfw-footer__inner {\n          padding-inline: 2.5rem;\n        }\n      }\n\n      @media (max-width: 640px) {\n        .btfw-footer-branding {\n          font-size: 0.8rem;\n        }\n      }\n    ",document.head.appendChild(t)}(),o(),a(),r()}function s(){if(i(),!document._btfwFooterObserver){const t=new MutationObserver(()=>i());t.observe(document.body,{childList:!0,subtree:!0}),document._btfwFooterObserver=t}}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",s):s(),document.addEventListener("btfw:ready",()=>r(),{once:!0}),{name:"feature:footer",moveForms:o,insertBranding:a,removeLegacyFooter:r}}),BTFW.define("feature:navbar",[],async()=>{let t=!1,e=!1,n={open:null,mobile:null};function o(t){try{const e=function(t){if(!t)return null;const e=document.querySelector(`#userlist li[data-name="${CSS.escape(t)}"]`);if(e)return e;const n=document.querySelectorAll("#userlist li, #userlist .userlist_item, #userlist .user");for(const e of n){const n=(e.textContent||"").trim();if(n&&n.replace(/\s+/g,"").toLowerCase().startsWith(t.toLowerCase()))return e}return null}(t);if(!e||!window.jQuery)return"";const n=window.jQuery(e),o=n.data&&n.data("profile");return o&&o.image||""}catch(t){return""}}function a(){const t=document.getElementById("btfw-theme-btn-nav");if(t){const e=t.closest("ul");if(e)return e}return document.querySelector(".navbar .nav.navbar-nav")||document.querySelector(".navbar-nav")||document.querySelector(".navbar .navbar-end ul")||document.querySelector(".btfw-navbar ul")||document.querySelector(".navbar ul")}function r(t){t&&(t.id="btfw-theme-btn-nav",t.classList.add("btfw-nav-pill"),t.classList.remove("button","is-dark","is-small","btn","btn-default","is-primary"),"BUTTON"!==t.tagName||t.hasAttribute("type")||(t.type="button"),t.getAttribute("aria-label")||t.setAttribute("aria-label","Theme settings"))}function i(){const t=document.getElementById("btfw-theme-btn-nav");if(t)return void r(t);const e=a();if(!e)return;let n=e.querySelector(".fa-sliders, .fa-sliders-h, .fa-sliders-simple, .fa-sliders-h::before");if(n){const t=n.closest("a,button");if(t)return void r(t)}const o=document.createElement("li"),i=document.createElement("a");i.innerHTML='\n      <span class="btfw-nav-pill__icon" aria-hidden="true"><i class="fa fa-sliders"></i></span>\n      <span class="btfw-nav-pill__label">Theme</span>\n    ',i.href="javascript:void(0)",r(i),o.appendChild(i),e.appendChild(o)}function s(t){let e=t&&(o(t)||function(){try{return window.USEROPTS&&USEROPTS.avatar?USEROPTS.avatar:""}catch(t){return""}}())||"";e||(e=function(t,e){const n=["#1abc9c","#16a085","#f1c40f","#f39c12","#2ecc71","#27ae60","#e67e22","#d35400","#3498db","#2980b9","#e74c3c","#c0392b","#9b59b6","#8e44ad","#0080a5","#34495e","#2c3e50"],o=n[((t||"?").codePointAt(0)||63)%n.length],a=(t||"?").trim().slice(0,2).toUpperCase()||"?",r=e||28,i=`<svg xmlns="http://www.w3.org/2000/svg" width="${r}" height="${r}">\n      <rect width="100%" height="100%" rx="${Math.round(.2*r)}" fill="${o}"/>\n      <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"\n            fill="#fff" font-family="Inter,Arial,sans-serif" font-weight="600"\n            font-size="${Math.round(.5*r)}">${a}</text>\n    </svg>`;return"data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(i)))}(t||"Guest",28));const n=document.createElement("a");n.href=t?"/account/profile":"/login",n.target="_blank",n.className="btfw-nav-avatar-link",n.title=t||"Sign in";const a=document.createElement("img");return a.id="btfw-useravatar",a.className="btfw-nav-avatar",a.src=e,a.alt=t||"guest",a.width=28,a.height=28,n.appendChild(a),n}function l(){const t=a();if(!t)return;let e=document.getElementById("btfw-nav-avatar-item");e?e.innerHTML="":(e=document.createElement("li"),e.id="btfw-nav-avatar-item",e.className="btfw-nav-avatar-item",t.appendChild(e)),e.appendChild(s(function(){try{return window.CLIENT&&CLIENT.name?CLIENT.name:""}catch(t){return""}}()))}function c(){const t=a();t&&Array.from(t.querySelectorAll("li")).forEach(t=>{const e=t.querySelector("a");if(!e)return;const n=(e.textContent||"").trim().toLowerCase(),o=(e.getAttribute("href")||"").trim(),a="home"===n||"/"===o,r="layout"===n||/layout/i.test(e.dataset?.target||"");(a||r)&&t.remove()})}function d(){c(),l(),b()}function u(){const t=document.getElementById("btfw-navhost");return!!t&&"true"===t.getAttribute("data-mobile-open")}function f(t){const e=document.getElementById("btfw-navhost");if(!e)return;const o=t?"true":"false";e.getAttribute("data-mobile-open")!==o&&e.setAttribute("data-mobile-open",o);const a=e.classList.contains("btfw-navhost--mobile");document.body&&(a&&t?document.body.classList.add("btfw-mobile-nav-open"):document.body.classList.remove("btfw-mobile-nav-open")),function(t){const e=document.getElementById("btfw-navhost"),o=e?.classList.contains("btfw-navhost--mobile")||!1;n.open===t&&n.mobile===o||(n={open:t,mobile:o},document.dispatchEvent(new CustomEvent("btfw:navbar:mobileState",{detail:{open:t,mobile:o}})))}(t)}function m(){const e=document.getElementById("btfw-navhost");if(!e)return;const n=e.classList.contains("btfw-navhost--mobile"),o=window.innerWidth<=768;e.classList.toggle("btfw-navhost--mobile",o),o?t&&n?f(u()):(t=!0,f(!1)):(t=!1,f(!0))}function b(){const t=document.getElementById("btfw-navhost");t&&(!function(){const t=document.getElementById("btfw-navhost");if(!t)return;const e=t.querySelector(":is(nav.navbar, .navbar, #navbar, .navbar-fixed-top)");if(!e)return;let n=document.getElementById("btfw-mobile-nav-close");n&&n.closest(":is(nav.navbar, .navbar, #navbar, .navbar-fixed-top)")!==e&&(n.remove(),n=null),n||(n=document.createElement("button"),n.type="button",n.id="btfw-mobile-nav-close",n.className="btfw-mobile-nav-close",n.setAttribute("aria-label","Close navigation menu"),n.innerHTML='<span aria-hidden="true">&times;</span>',n.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),f(!1)}),e.insertBefore(n,e.firstChild))}(),m(),e||(e=!0,window.addEventListener("resize",()=>m()),t.addEventListener("click",t=>{if(window.innerWidth>768)return;const e=t.target.closest?.("#btfw-navhost a, #btfw-navhost button");e&&f(!1)},!0)))}function p(){i(),c(),l(),b();const t=((t,e=document)=>e.querySelector(t))("#userlist");if(t&&!t._btfwNavMO){const e=new MutationObserver(()=>d());e.observe(t,{childList:!0,subtree:!0}),t._btfwNavMO=e}try{window.socket&&socket.on&&(socket.on("login",d),socket.on("logout",d),socket.on("setProfile",d),socket.on("userlist",d))}catch(t){}let e=0;const n=setInterval(()=>{e++;const t=a();t&&(i(),c(),l(),b()),(e>10||t)&&clearInterval(n)},300)}return document._btfw_nav_setMobileOpen=f,document._btfw_nav_toggleMobile=function(){const t=document.getElementById("btfw-navhost");t&&(t.classList.contains("btfw-navhost--mobile")?f(!u()):f(!0))},document._btfw_nav_isMobileOpen=u,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",p):p(),{name:"feature:navbar",refresh:d}}),BTFW.define("feature:modal-skin",[],async()=>{function t(t){const e=[["btn-primary","is-link"],["btn-danger","is-danger"],["btn-warning","is-warning"],["btn-success","is-success"],["btn-info","is-info"],["btn-default","is-dark"]];t.querySelectorAll(".btn").forEach(t=>{t.classList.add("button","is-small"),t.classList.remove("btn","btn-lg","btn-sm","btn-xs");let n=!1;for(const[o,a]of e)t.classList.contains(o)&&(t.classList.remove(o),t.classList.add(a),n=!0);n||t.classList.add("is-dark"),t.classList.contains("pull-right")&&(t.classList.remove("pull-right"),t.classList.add("is-pulled-right")),t.classList.contains("pull-left")&&(t.classList.remove("pull-left"),t.classList.add("is-pulled-left"))})}function e(e){if(e&&!e.classList.contains("btfw-modal")&&!e.classList.contains("btfw-bulma-skin")){e.classList.add("btfw-bulma-skin"),e.querySelectorAll(".modal-content").forEach(t=>t.classList.add("btfw-card")),e.querySelectorAll(".modal-header").forEach(t=>t.classList.add("btfw-card-head")),e.querySelectorAll(".modal-body").forEach(t=>t.classList.add("btfw-card-body")),e.querySelectorAll(".modal-footer").forEach(t=>t.classList.add("btfw-card-foot")),function(t){const e=t.querySelector(".modal-header");if(!e)return;if(e.querySelector(".delete"))return;const n=document.createElement("button");n.className="delete",n.setAttribute("aria-label","close"),n.addEventListener("click",e=>{e.preventDefault();try{window.jQuery&&window.jQuery(t).modal("hide")}catch(t){}t.classList.remove("is-active")}),e.appendChild(n)}(e),t(e);try{window.jQuery&&window.jQuery(e).on("shown.bs.modal",function(){t(e)})}catch(t){}}}function n(){((t,e=document)=>Array.from(e.querySelectorAll(t)))(".modal").forEach(t=>e(t))}function o(){n();const t=t=>{const n=t?.target&&t.target.classList?.contains("modal")?t.target:t?.target?.closest?.(".modal");n&&e(n)};document.addEventListener("show.bs.modal",t,!0),document.addEventListener("shown.bs.modal",t,!0)}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",o):o(),{name:"feature:modal-skin",reskin:n}}),BTFW.define("feature:emotes",[],async()=>{const t=(t,e=document)=>e.querySelector(t),e=await BTFW.init("util:motion");function n(t,e){t.focus();const n=t.selectionStart??t.value.length,o=t.selectionEnd??t.value.length,a=t.value.slice(0,n),r=t.value.slice(o);t.value=a+e+r;const i=a.length+e.length;t.selectionStart=t.selectionEnd=i,t.dispatchEvent(new Event("input",{bubbles:!0}))}const o=`btfw:recent:emotes:${window.CHANNEL&&window.CHANNEL.name||"default"}`;let a={tab:"emotes",list:{emotes:[],emoji:[],recent:[]},filtered:[],highlight:0,emojiReady:!1,search:"",renderEpoch:0};function r(t){const e="emoji"===t.kind?t.char:t.name;a.list.recent=a.list.recent.filter(t=>("emoji"===t.kind?t.char:t.name)!==e),a.list.recent.unshift(t),a.list.recent=a.list.recent.slice(0,24);try{localStorage.setItem(o,JSON.stringify(a.list.recent))}catch(t){}}function i(){let e=t("#btfw-emotes-pop");if(e)return e;!function(){const e=t("#chatwrap");e&&"static"===getComputedStyle(e).position&&(e.style.position="relative")}(),e=document.createElement("div"),e.id="btfw-emotes-pop",e.className="btfw-popover btfw-emotes-pop",e.dataset.btfwPopoverState="closed",e.setAttribute("hidden",""),e.setAttribute("aria-hidden","true"),e.innerHTML='\n      <div class="btfw-emotes-head">\n        <div class="btfw-emotes-tabs">\n          <button class="btfw-tab is-active" data-tab="emotes">Channel</button>\n          <button class="btfw-tab" data-tab="emoji">Emoji</button>\n          <button class="btfw-tab" data-tab="recent">Recent</button>\n        </div>\n        <div class="btfw-emotes-search">\n          <input id="btfw-emotes-search" type="search" placeholder="Search‚Ä¶" autocomplete="off" />\n          <button id="btfw-emotes-clear" class="btfw-emotes-clear" type="button" title="Clear search" aria-label="Clear search" aria-hidden="true" tabindex="-1">√ó</button>\n        </div>\n        <button class="btfw-emotes-close" title="Close">√ó</button>\n      </div>\n      <div id="btfw-emotes-grid" class="btfw-emotes-grid" tabindex="0" aria-label="Emote grid"></div>\n    ';(t("#chatwrap")||document.body).appendChild(e);const n=e.querySelector("#btfw-emotes-grid");n&&(n.setAttribute("data-twemoji-skip","true"),n.classList.add("btfw-emoji-grid--native"));const o=()=>{const n=t("#btfw-emotes-search",e),o=t("#btfw-emotes-clear",e);if(!n||!o)return;const a=n.value.length>0;o.classList.toggle("is-visible",a),o.setAttribute("aria-hidden",a?"false":"true"),o.tabIndex=a?0:-1};return e.querySelector(".btfw-emotes-tabs").addEventListener("click",n=>{const r=n.target.closest(".btfw-tab");r&&(e.querySelectorAll(".btfw-tab").forEach(t=>t.classList.toggle("is-active",t===r)),a.tab=r.getAttribute("data-tab"),a.search="",t("#btfw-emotes-search").value="",o(),"emoji"!==a.tab||a.emojiReady||async function(){try{const t=localStorage.getItem("btfw:emoji:cache");if(t)return a.list.emoji=JSON.parse(t),a.emojiReady=!0,void d(!0)}catch(t){}try{const t=await fetch("https://cdn.jsdelivr.net/npm/emoji.json@13.1.0/emoji.json",{cache:"force-cache"}),e=await t.json();a.list.emoji=e.map(t=>({char:t.char,name:(t.name||"").toLowerCase(),keywords:(t.keywords||"").toLowerCase()})),localStorage.setItem("btfw:emoji:cache",JSON.stringify(a.list.emoji))}catch(t){a.list.emoji=[{char:"üòÄ",name:"grinning face",keywords:"smile happy"},{char:"üòÇ",name:"face with tears of joy",keywords:"laugh cry"},{char:"üòç",name:"smiling face with heart-eyes",keywords:"love"},{char:"üëç",name:"thumbs up",keywords:"like ok yes"},{char:"üî•",name:"fire",keywords:"lit hot"},{char:"üéâ",name:"party popper",keywords:"celebrate confetti"}]}a.emojiReady=!0,d(!0)}(),d(!0),s())}),function(){let n=0;t("#btfw-emotes-search",e).addEventListener("input",t=>{a.search=t.target.value.trim(),o(),clearTimeout(n),n=setTimeout(()=>d(!0),120)})}(),t("#btfw-emotes-clear",e).addEventListener("click",()=>{a.search="",t("#btfw-emotes-search").value="",o(),d(!0),s()}),t(".btfw-emotes-close",e).addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),p()}),t("#btfw-emotes-grid",e).addEventListener("keydown",e=>{const n=t("#btfw-emotes-grid"),o=n.querySelectorAll(".btfw-emote-tile").length;if(!o)return;const r=function(t){const e=t.clientWidth||520;return Math.max(3,Math.floor(e/72))}(n);switch(e.key){case"ArrowRight":a.highlight=Math.min(o-1,a.highlight+1);break;case"ArrowLeft":a.highlight=Math.max(0,a.highlight-1);break;case"ArrowDown":a.highlight=Math.min(o-1,a.highlight+r);break;case"ArrowUp":a.highlight=Math.max(0,a.highlight-r);break;case"Enter":{const t=n.querySelector(`.btfw-emote-tile[data-index="${a.highlight}"]`);return t&&t.click(),void e.preventDefault()}case"Escape":return void p();default:return}e.preventDefault(),u(),function(){const e=t("#btfw-emotes-grid"),n=e&&e.querySelector(`.btfw-emote-tile[data-index="${a.highlight}"]`);if(!e||!n)return;const o=n.getBoundingClientRect(),r=e.getBoundingClientRect();o.top<r.top?e.scrollTop-=r.top-o.top+8:o.bottom>r.bottom&&(e.scrollTop+=o.bottom-r.bottom+8)}()}),document.addEventListener("click",t=>{if("open"!==e.dataset.btfwPopoverState)return;t.target.closest("#btfw-emotes-pop")||t.target.closest("#btfw-btn-emotes")||p()},!0),l(),o(),e._btfwSyncSearchClear=o,e}function s(t=!0){const e=document.getElementById("btfw-emotes-grid");if(e&&"function"==typeof e.focus){if(t)try{return void e.focus({preventScroll:!0})}catch(t){}try{e.focus()}catch(t){}}}function l(){const t=document.getElementById("btfw-emotes-pop");t&&window.BTFW_positionPopoverAboveChatBar&&window.BTFW_positionPopoverAboveChatBar(t,{widthPx:530,widthVw:92,maxHpx:480,maxHvh:70})}function c(){const t=document.getElementById("chatwrap")||document.body,e=document.getElementById("btfw-chat-bottombar")||document.getElementById("chatcontrols")||document.getElementById("chatline")||t;if(t._btfwEmoteWatch)return;t._btfwEmoteWatch=!0;const n=()=>l();if(window.addEventListener("resize",n),window.addEventListener("scroll",n,!0),window.ResizeObserver){const o=new ResizeObserver(n);o.observe(t),e&&e!==t&&o.observe(e),t._btfwEmoteRO=o}else{const o=new MutationObserver(n);o.observe(t,{attributes:!0,childList:!0,subtree:!0}),e&&e!==t&&o.observe(e,{attributes:!0,childList:!0,subtree:!0}),t._btfwEmoteMO=o}}function d(e){const o=t("#btfw-emotes-grid");if(!o)return;const i=(a.search||"").toLowerCase();"emotes"===a.tab?a.filtered=i?a.list.emotes.filter(t=>t.name.toLowerCase().includes(i)):a.list.emotes:"emoji"===a.tab?a.filtered=i?a.list.emoji.filter(t=>t.name.includes(i)||t.keywords.includes(i)):a.list.emoji:a.filtered=i?a.list.recent.filter(t=>"emoji"===t.kind?(t.char+(t.name||"")+(t.keywords||"")).toLowerCase().includes(i):(t.name||"").toLowerCase().includes(i)):a.list.recent,e&&(o.scrollTop=0,a.highlight=0);const s=++a.renderEpoch;o.innerHTML="";const l=a.filtered.length;let c=0;function d(e,o){const i=document.createElement("div");if(i.className="btfw-emote-tile",i.setAttribute("data-index",String(o)),"emoji"===a.tab||"emoji"===e.kind){i.classList.add("btfw-emote-tile--emoji"),i.dataset.kind="emoji",i.setAttribute("aria-label",e.name||e.char||"Emoji"),i.dataset.emoji=e.char;const t=document.createElement("span");t.className="btfw-emoji",t.textContent=e.char,t.setAttribute("aria-hidden","true"),i.title=e.name||"",i.appendChild(t)}else{i.classList.add("btfw-emote-tile--emote"),i.dataset.kind="emote";const t=document.createElement("img");t.className="btfw-emote-img",t.src=e.image||"",t.alt=e.name,t.loading="lazy",t.decoding="async",t.onerror=()=>{t.style.display="none",i.textContent=e.name},i.title=e.name,i.setAttribute("aria-label",e.name||"Emote"),i.appendChild(t)}return i.addEventListener("click",()=>{const o=t("#chatline");var i;o&&("emoji"===a.tab||"emoji"===e.kind?(n(o,(i=e.char,(/\uFE0F/.test(i)?i:1===Array.from(i).length?i+"Ô∏è":i)+" ")),r({kind:"emoji",char:e.char,name:e.name,keywords:e.keywords})):(n(o," "+e.name+" "),r({kind:"emote",name:e.name,image:e.image})),p())}),i}!function t(){if(s!==a.renderEpoch)return;const e=document.createDocumentFragment(),n=Math.min(l,c+200);for(;c<n;c++)e.appendChild(d(a.filtered[c],c));o.appendChild(e),document.dispatchEvent(new CustomEvent("btfw:emotes:rendered",{detail:{container:o}})),c<l?"requestIdleCallback"in window?requestIdleCallback(t,{timeout:50}):setTimeout(t,0):u()}()}function u(){const e=t("#btfw-emotes-grid");if(!e)return;e.querySelectorAll(".btfw-emote-tile.is-active").forEach(t=>t.classList.remove("is-active"));const n=e.querySelector(`.btfw-emote-tile[data-index="${a.highlight}"]`);n&&n.classList.add("is-active")}function f(){["#emotelistbtn","#emotelist","#emote-list","#emote-btn",'button[title*="Emote"]','button[onclick*="emote"]'].forEach(t=>((t,e=document)=>Array.from(e.querySelectorAll(t)))(t).forEach(t=>t.remove()))}function m(){if(t("#btfw-btn-emotes"))return;const e=document.getElementById("btfw-chat-bottombar")||document.querySelector("#chatcontrols .input-group-btn")||document.getElementById("chatcontrols")||document.getElementById("chatwrap");if(!e)return;const n=document.createElement("button");n.id="btfw-btn-emotes",n.type="button",n.className="button is-dark is-small btfw-chatbtn btfw-btn-emotes",n.innerHTML=window.FontAwesome||document.querySelector(".fa")?'<i class="fa fa-smile" aria-hidden="true"></i>':'<span aria-hidden="true">üôÇ</span>',n.title="Emotes / Emoji";const o=e.querySelector("#btfw-btn-gif, .btfw-btn-gif");o&&o.parentNode?o.parentNode.insertBefore(n,o):e.appendChild(n),n.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();const e=document.getElementById("btfw-emotes-pop");e&&"open"===e.dataset.btfwPopoverState?p():b()},{capture:!0})}function b(){const n=i();!function(){const t=Array.isArray(window.CHANNEL?.emotes)?window.CHANNEL.emotes:[];a.list.emotes=t.filter(t=>t&&t.name).map(t=>({name:t.name,image:t.image||""}))}(),function(){try{a.list.recent=JSON.parse(localStorage.getItem(o)||"[]")}catch(t){a.list.recent=[]}}(),a.tab="emotes",a.search="",a.highlight=0,t("#btfw-emotes-search").value="",n?._btfwSyncSearchClear?.(),n.querySelectorAll(".btfw-tab").forEach(t=>t.classList.toggle("is-active","emotes"===t.getAttribute("data-tab"))),e.openPopover(n),l(),d(!0),s()}function p(){const n=t("#btfw-emotes-pop");n&&e.closePopover(n)}function w(){f(),m(),["#btfw-btn-emotes",".btfw-btn-emotes"].forEach(t=>{document.querySelectorAll(t).forEach(t=>{if(t.removeAttribute("onclick"),window.jQuery)try{jQuery(t).off("click")}catch(t){}const e=t.cloneNode(!0);t.parentNode.replaceChild(e,t),e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();const e=document.getElementById("btfw-emotes-pop");e&&"open"===e.dataset.btfwPopoverState?p():b()},{capture:!0})})}),c()}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",w):w(),{name:"feature:emotes",open:b,close:p,render:d,positionPopover:l}}),BTFW.define("feature:emoji-compat",[],async()=>{const t="btfw:emoji:twemoji",e="14.0.2",n=`https://cdn.jsdelivr.net/npm/twemoji@${e}/dist/twemoji.min.js`,o=`https://cdn.jsdelivr.net/npm/twemoji@${e}/assets/`,a="[data-twemoji-skip='true']";let r=!1,i=null;function s(){try{return"1"===localStorage.getItem(t)}catch(t){return!1}}function l(e){r=!!e;try{localStorage.setItem(t,e?"1":"0")}catch(t){}r?new Promise((t,e)=>{if(window.twemoji)return t();const o=document.createElement("script");o.async=!0,o.defer=!0,o.src=n+"?v="+Date.now(),o.onload=()=>t(),o.onerror=()=>e(new Error("Failed to load Twemoji")),document.head.appendChild(o)}).then(()=>{!function(){const t=document.getElementById("btfw-emotes-grid");t&&d(t)}(),function(){const t=document.getElementById("messagebuffer");if(!t)return;u(),i=new MutationObserver(t=>{for(const e of t)e.addedNodes&&e.addedNodes.forEach(t=>{1===t.nodeType&&d(t)})}),i.observe(t,{childList:!0,subtree:!0}),d(t)}()}):u()}function c(t){if(!t)return!1;if(1===t.nodeType){if(t.matches?.(a))return!0;if(t.closest?.(a))return!0}return 11===t.nodeType&&Array.from(t.childNodes||[]).every(t=>c(t))}function d(t){var e;window.twemoji&&r&&t&&(c(t)||(window.twemoji.parse(t,{base:o,folder:"svg",ext:".svg",className:"twemoji",attributes:()=>({loading:"lazy",decoding:"async"})}),(e=t)&&e.querySelectorAll("img.twemoji").forEach(t=>{t.setAttribute("loading","lazy"),t.setAttribute("decoding","async"),t.complete&&t.naturalWidth>0?t.classList.add("is-ready"):t.addEventListener("load",()=>t.classList.add("is-ready"),{once:!0});try{("Ô∏è"===t.alt||/\/fe0f(?:\.svg|\.png)$/.test(t.src))&&t.remove()}catch(t){}t.addEventListener("error",()=>t.remove(),{once:!0})})))}function u(){if(i){try{i.disconnect()}catch(t){}i=null}}function f(){l(s())}return document.addEventListener("btfw:emotes:rendered",t=>{const e=t.detail?.container||null;r&&e&&!c(e)&&d(e)}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",f):f(),{name:"feature:emoji-compat",getEnabled:s,setEnabled:l}}),BTFW.define("feature:emoji-loader",[],async()=>{const t=(t,e=document)=>Array.from(e.querySelectorAll(t));function e(t){if(!t||t._btfwReady)return;t._btfwReady=!0;const e=t.querySelector(".btfw-emoji-img");e&&(t.classList.add("loading"),e.addEventListener("load",()=>{t.classList.remove("loading"),t.classList.add("ready")},{once:!0}),e.addEventListener("error",()=>{t.classList.remove("loading"),e.style.display="none"},{once:!0}),e.complete&&e.naturalWidth>0&&(t.classList.remove("loading"),t.classList.add("ready")))}const n="function"==typeof requestAnimationFrame?requestAnimationFrame:t=>setTimeout(t,16),o="function"==typeof IntersectionObserver,a=o?new IntersectionObserver(t=>{t.forEach(t=>{if(!t.isIntersecting)return;const n=t.target;o&&a.unobserve(n),e(n)})}):null;let r,i;function s(){r||(r=n(()=>{if(!o)return t(".btfw-emoji-grid .btfw-emoji-cell").forEach(e),void(r=null);t(".btfw-emoji-grid .btfw-emoji-cell:not([data-observed])").forEach(t=>{t.dataset.observed="true",a.observe(t)}),r=null}))}return new MutationObserver(()=>{clearTimeout(i),i=setTimeout(s,50)}).observe(document.body,{childList:!0,subtree:!0}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",s):s(),{name:"feature:emoji-loader"}}),BTFW.define("feature:gifs",[],async()=>{const t=(t,e=document)=>e.querySelector(t),e=12,n=await BTFW.init("util:motion"),o={giphy:"btfw:giphy:key",tenor:"btfw:tenor:key"};function a(t,e){const n=function(t){try{return(localStorage.getItem(o[t])||"").trim()}catch(t){return""}}(t);return n||e}const r={provider:"giphy",query:"",page:1,total:0,items:[],loading:!1};let i=[],s=!1;const l="btfw:gifs:favorites";let c=function(){try{const t=localStorage.getItem(l);if(!t)return[];const e=JSON.parse(t);if(Array.isArray(e))return e.filter(t=>t&&"object"==typeof t&&t.urlClassic).map(t=>({provider:t.provider||"giphy",id:t.id||"",thumb:t.thumb||t.urlClassic,urlClassic:t.urlClassic}))}catch(t){}return[]}(),d=function(t){const e=new Map;return t.forEach(t=>{const n=C(t);n&&e.set(n,t)}),e}(c);function u(){if(["#btfw-btn-gif",".btfw-btn-gif","#giphybtn","#gifbtn"].forEach(t=>{((t,e=document)=>Array.from(e.querySelectorAll(t)))(t).forEach(t=>{t.removeAttribute("onclick");const e=t.cloneNode(!0);t.parentNode.replaceChild(e,t),e.addEventListener("click",t=>{t.preventDefault(),E()},{capture:!0})})}),!t("#btfw-btn-gif")){const t=document.getElementById("btfw-chat-bottombar")||document.querySelector("#chatcontrols .input-group-btn")||document.getElementById("chatcontrols")||document.getElementById("chatwrap");if(t){const e=document.createElement("button");e.id="btfw-btn-gif",e.type="button",e.className="button is-dark is-small btfw-chatbtn btfw-btn-gif",e.innerHTML=document.querySelector(".fa")?'<i class="fa fa-file-video-o"></i>':"GIF",e.title="GIFs",t.appendChild(e),e.addEventListener("click",t=>{t.preventDefault(),E()},{capture:!0})}}}let f=null;function m(){return f||(f=document.createElement("div"),f.id="btfw-gif-modal",f.className="modal",f.dataset.btfwModalState="closed",f.setAttribute("hidden",""),f.setAttribute("aria-hidden","true"),f.innerHTML='\n      <div class="modal-background"></div>\n      <div class="modal-card btfw-modal">\n        <header class="modal-card-head">\n          <p class="modal-card-title">GIFs</p>\n          <button class="delete" aria-label="close"></button>\n        </header>\n        <section class="modal-card-body">\n          <div class="btfw-gif-toolbar">\n            <div class="tabs is-boxed is-small btfw-gif-tabs">\n              <ul>\n                <li class="is-active" data-p="giphy"><a>Giphy</a></li>\n                <li data-p="tenor"><a>Tenor</a></li>\n                <li data-p="favorites"><a>Favorites</a></li>\n              </ul>\n            </div>\n            <div class="btfw-gif-search">\n              <input id="btfw-gif-q" class="input is-small" type="text" placeholder="Search GIFs‚Ä¶">\n              <button id="btfw-gif-go" class="button is-link is-small">Search</button>\n              <button id="btfw-gif-trending" class="button is-dark is-small">Trending</button>\n            </div>\n          </div>\n\n          <div id="btfw-gif-notice" class="btfw-gif-notice is-hidden"></div>\n          <div id="btfw-gif-grid" class="btfw-gif-grid"></div>\n\n          <nav class="pagination is-centered btfw-gif-pager" role="navigation" aria-label="pagination">\n            <button id="btfw-gif-prev" class="button is-dark is-small">Prev</button>\n            <span id="btfw-gif-pages" class="btfw-gif-pages">1 / 1</span>\n            <button id="btfw-gif-next" class="button is-dark is-small">Next</button>\n          </nav>\n        </section>\n        <footer class="modal-card-foot">\n          <button class="button is-link" id="btfw-gif-close">Close</button>\n        </footer>\n      </div>\n    ',document.body.appendChild(f),f.querySelector(".modal-background").addEventListener("click",k),f.querySelector(".delete").addEventListener("click",k),t("#btfw-gif-close",f).addEventListener("click",k),f.querySelector(".btfw-gif-tabs ul").addEventListener("click",t=>{const e=t.target.closest("li[data-p]");e&&(f.querySelectorAll(".btfw-gif-tabs li").forEach(t=>t.classList.toggle("is-active",t===e)),r.provider=e.getAttribute("data-p"),r.page=1,x(),"favorites"===r.provider?(L(),g()):(w(),p()))}),t("#btfw-gif-go",f).addEventListener("click",()=>{r.page=1,p()}),t("#btfw-gif-q",f).addEventListener("keydown",t=>{"Enter"===t.key&&(r.page=1,p())}),t("#btfw-gif-trending",f).addEventListener("click",()=>{t("#btfw-gif-q").value="",r.page=1,p()}),t("#btfw-gif-prev",f).addEventListener("click",()=>{r.page>1&&(r.page--,_())}),t("#btfw-gif-next",f).addEventListener("click",()=>{const t=Math.max(1,Math.ceil(r.total/e));r.page<t&&(r.page++,_())}),f)}function b(e){const n=t("#btfw-gif-notice",f);n.textContent=e||"",n.classList.toggle("is-hidden",!e)}async function p(){const e=(t("#btfw-gif-q",m()).value||"").trim();if(r.query=e,r.page=1,"favorites"===r.provider)return r.loading=!1,L(),void g();r.loading=!0,w();try{const{items:t,total:n}="giphy"===r.provider?await async function(t){const e=a("giphy","bb2006d9d3454578be1a99cfad65913d"),n=new URL(t?"https://api.giphy.com/v1/gifs/search":"https://api.giphy.com/v1/gifs/trending");n.searchParams.set("api_key",e),t&&n.searchParams.set("q",t),n.searchParams.set("limit","50"),n.searchParams.set("rating","pg-13");const o=await fetch(n.toString());if(!o.ok)throw new Error(`GIPHY_${o.status}`);const r=((await o.json()).data||[]).map(t=>{const e=t.id||"",n=t.images&&(t.images.fixed_width_small?.url||t.images.fixed_width?.url||t.images.downsized_still?.url)||"",o=e?function(t){return`https://media1.giphy.com/media/${t}/giphy.gif`}(e):"";return{id:e,provider:"giphy",thumb:n,urlClassic:o}});return{items:r,total:r.length}}(e):await async function(t){const e=a("tenor","5WPAZ4EXST2V"),n=new URL(t?"https://api.tenor.com/v1/search":"https://api.tenor.com/v1/trending");n.searchParams.set("key",e),t&&n.searchParams.set("q",t),n.searchParams.set("limit","50");const o=await fetch(n.toString());if(!o.ok)throw new Error(`TENOR_${o.status}`);const r=((await o.json()).results||[]).map(t=>{const e=t.media?.[0]?.gif?.url||t.media?.[0]?.mediumgif?.url||t.media?.[0]?.tinygif?.url||"",n=t.media?.[0]?.nanogif?.url||t.media?.[0]?.tinygif?.url||e;return{id:t.id,provider:"tenor",thumb:n,urlClassic:(o=e,function(t){return(t||"").split("?")[0].split("#")[0]}(o))};var o});return{items:r,total:r.length}}(e);r.items=t,r.total=n,r.loading=!1,b(n?"":"No results. Try a different search."),g()}catch(t){r.items=[],r.total=0,r.loading=!1,b("Failed to load GIFs (key limit or network). Try again, or set your own keys in localStorage."),g()}}function w(){if("favorites"===r.provider)return;const n=t("#btfw-gif-grid",m());i=[];if(n.querySelectorAll(".is-skeleton").length===e)return;n.innerHTML="";const o=document.createDocumentFragment();for(let t=0;t<e;t++){const t=document.createElement("div");t.className="btfw-gif-cell is-skeleton";const e=document.createElement("div");e.className="btfw-gif-thumb",t.appendChild(e),o.appendChild(t)}n.appendChild(o),t("#btfw-gif-pages").textContent="‚Ä¶ / ‚Ä¶"}function g(){const n=t("#btfw-gif-grid",m());!function(t){if(s)return;t.addEventListener("click",t=>{const e=t.target.closest(".btfw-gif-fav-toggle");if(e&&N(e))return t.preventDefault(),void t.stopPropagation();const n=t.target.closest(".btfw-gif-cell");if(!n||n.classList.contains("is-skeleton"))return;const o=n.dataset.url;if(!o)return;const a=document.getElementById("chatline");a&&(!function(t,e){t.focus();const n=t.selectionStart??t.value.length,o=t.selectionEnd??t.value.length,a=t.value.slice(0,n),r=t.value.slice(o);t.value=a+e+r;const i=a.length+e.length;t.selectionStart=t.selectionEnd=i,t.dispatchEvent(new Event("input",{bubbles:!0}))}(a," "+o+" "),k())}),t.addEventListener("keydown",t=>{if("Enter"!==t.key&&" "!==t.key&&"Spacebar"!==t.key)return;const e=t.target.closest(".btfw-gif-fav-toggle");e&&N(e)&&(t.preventDefault(),t.stopPropagation())}),s=!0}(n),x();const o=Math.max(1,Math.ceil(r.total/e)),a=Math.max(1,Math.min(o,r.page));a!==r.page&&(r.page=a);const l=(r.page-1)*e,c=r.items.slice(l,l+e),d=function(t,e){const n=e.querySelectorAll(".btfw-gif-cell:not(.is-skeleton)");return n.length===t.length&&0!==i.length}(c,n),u="favorites"===r.provider;d?function(t,e,n={}){const{showRemove:o=!1}=n,a=t.querySelectorAll(".btfw-gif-cell");e.forEach((t,e)=>{const n=a[e];n&&function(t,e,n={}){const{showRemove:o=!1}=n;t.dataset.url=e.urlClassic||"",t.dataset.id=e.id||"",t.dataset.thumb=e.thumb||"",t.dataset.provider=e.provider||r.provider||"",t.dataset.favKey=C(e);const a=t.querySelector("img");a&&a.src!==e.thumb?(a.src=e.thumb,a.alt="gif",v(t,a)):a&&v(t,a);t.classList.remove("is-skeleton"),h(t,o)}(n,t,{showRemove:o})})}(n,c,{showRemove:u}):function(t,e,n={}){const{showRemove:o=!1}=n,a=document.createDocumentFragment();e.forEach(t=>{const e=function(t,e={}){const{showRemove:n=!1}=e,o=document.createElement("button");o.className="btfw-gif-cell",o.type="button",o.dataset.url=t.urlClassic||"",o.dataset.id=t.id||"",o.dataset.thumb=t.thumb||"",o.dataset.provider=t.provider||r.provider||"",o.dataset.favKey=C(t);const a=document.createElement("div");a.className="btfw-gif-thumb";const i=document.createElement("img");i.src=t.thumb,i.alt="gif",i.loading="lazy",i.decoding="async",v(o,i),a.appendChild(i),o.appendChild(a);const s=document.createElement("span");return s.className="btfw-gif-fav-toggle"+(n?" is-remove":""),s.dataset.action=n?"remove-favorite":"toggle-favorite",s.setAttribute("role","button"),s.tabIndex=0,o.appendChild(s),h(o,n),o}(t,{showRemove:o});a.appendChild(e)}),t.replaceChildren(a)}(n,c,{showRemove:u}),i=c.map(t=>({id:t.id,provider:t.provider,thumb:t.thumb,urlClassic:t.urlClassic})),t("#btfw-gif-pages").textContent=`${r.page} / ${o}`,t("#btfw-gif-prev").disabled=r.page<=1,t("#btfw-gif-next").disabled=r.page>=o}function h(t,e){const n=t.dataset.favKey,o=d.has(n||"");t.classList.toggle("is-favorited",o);const a=t.querySelector(".btfw-gif-fav-toggle");if(!a)return;if(e)return a.textContent="√ó",a.title="Remove from favorites",a.setAttribute("aria-label","Remove from favorites"),void a.setAttribute("aria-pressed","true");a.textContent=o?"‚òÖ":"‚òÜ";const r=o?"Remove from favorites":"Add to favorites";a.title=r,a.setAttribute("aria-label",r),a.setAttribute("aria-pressed",o?"true":"false")}function v(t,e){const n=()=>{t.classList.remove("is-loading"),t.classList.remove("is-broken")},o=()=>{t.classList.add("is-broken"),t.classList.remove("is-loading")};t.classList.add("is-loading"),e.onload=n,e.onerror=o,e.complete&&(e.naturalWidth&&e.naturalHeight?n():o())}let y=null;function _(){y&&clearTimeout(y),y=setTimeout(()=>{g(),y=null},16)}function E(){m(),b(""),r.page=1,r.provider=f.querySelector(".btfw-gif-tabs li.is-active")?.getAttribute("data-p")||"giphy","favorites"!==r.provider&&w(),setTimeout(p,0),n.openModal(f);const e=t("#btfw-gif-q",f);e&&"favorites"!==r.provider&&requestAnimationFrame(()=>{e.focus(),e.select()})}function k(){f&&n.closeModal(f)}function x(){const e=t(".btfw-gif-search",f||document);if(!e)return;const n="favorites"===r.provider;e.classList.toggle("is-hidden",n)}function C(t){const e=t.provider||r.provider||"",n=t.id||"",o=t.urlClassic||"";return e+"::"+(n||o||"")}function S(){try{localStorage.setItem(l,JSON.stringify(c))}catch(t){}}function L(){r.loading=!1,r.items=c.slice(),r.total=c.length,b(c.length?"":"Favorite GIFs will appear here once you star them.")}function T(t){const e=t.favKey||C(t),n=c.findIndex(t=>C(t)===e);-1!==n&&(c.splice(n,1),d.delete(e),S(),"favorites"===r.provider&&L(),g())}function N(t){const e=t.closest(".btfw-gif-cell");if(!e||e.classList.contains("is-skeleton"))return!1;const n=function(t){if(!t)return null;const e={provider:t.dataset.provider||r.provider||"",id:t.dataset.id||"",thumb:t.dataset.thumb||"",urlClassic:t.dataset.url||""};return e.favKey=t.dataset.favKey||C(e),e}(e);if(!n)return!1;return"remove-favorite"===(t.dataset.action||"")?T(n):function(t){const e=t.favKey||C(t);t.urlClassic&&(d.has(e)?T(t):(c.push({provider:t.provider,id:t.id,thumb:t.thumb||t.urlClassic,urlClassic:t.urlClassic}),d.set(e,c[c.length-1]),S(),"favorites"===r.provider&&L(),g()))}(n),!0}function A(){u()}return document.addEventListener("btfw:openGifs",()=>{try{openGifModal()}catch(t){}}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",A):A(),{name:"feature:gifs",open:E,close:k}}),BTFW.define("feature:poll-overlay",[],async()=>{"use strict";const t="btfw-poll-overlay-styles";let e=null,n=null,o=!1,a=new Set,r=null,i=null;const s=document.createElement("textarea");function l(t){return"string"!=typeof t?null==t?"":String(t):0===t.length?"":(s.innerHTML=t,s.value)}function c(){return document.querySelectorAll("#pollwrap .well.active .option button")}function d(){r&&(r.disconnect(),r=null,i=null)}function u(){if(d(),!e||!e.classList.contains("btfw-poll-active"))return;const t=document.querySelector("#pollwrap .well.active");t?(i=t,r=new MutationObserver(()=>{if(i&&!document.contains(i))return d(),void setTimeout(()=>{r||u()},120);f()}),r.observe(t,{childList:!0,subtree:!0,characterData:!0,attributes:!0}),f()):setTimeout(()=>{r||u()},150)}function f(){if(!e)return;const t=e.querySelectorAll(".btfw-poll-option-btn"),o=c();if(!t.length||t.length!==o.length)return;const r=[];if(t.forEach((t,e)=>{const n=o[e],i=parseInt(n?.textContent)||0;t.textContent=i.toString(),n?.classList.contains("active")?(t.classList.add("active"),a.add(e)):(t.classList.remove("active"),a.delete(e)),r.push(i)}),r.length){const t=e.querySelector(".btfw-poll-votes");if(t){const e=r.reduce((t,e)=>t+e,0);t.textContent=`${e} vote${1!==e?"s":""}`}n&&(n.votes=r)}}function m(t,e=0){const o=c();if(o&&o[t])return o[t].click(),void setTimeout(()=>{f()},120);e>=4?function(t){if(!window.socket||"function"!=typeof window.socket.emit)return!1;const e=n&&(n.id??n.pollId??n.pollID??n.poll_id),o=[],a=[t,{option:t}];null!=e&&(a.push({poll:e,option:t}),a.push({id:e,option:t}));["vote","votePoll"].forEach(t=>{a.forEach(e=>{o.push({event:t,payload:e})})}),o.forEach(({event:t,payload:e},n)=>{setTimeout(()=>{try{window.socket.emit(t,e)}catch(t){n===o.length-1&&console.warn("[poll-overlay] Failed to emit vote via socket",t)}},25*n)}),setTimeout(()=>{f()},25*o.length+150),o.length}(t):setTimeout(()=>{m(t,e+1)},100)}function b(t){const o=function(){if(e)return e;const t=document.getElementById("videowrap");if(!t)return null;const n=document.createElement("div");return n.id="btfw-poll-video-overlay",n.innerHTML='\n      <div class="btfw-poll-video-content">\n        <div class="btfw-poll-video-header">\n          <h3 class="btfw-poll-video-title">Poll Title</h3>\n          <button class="btfw-poll-video-close" type="button">&times;</button>\n        </div>\n        <div class="btfw-poll-options-grid">\n          \x3c!-- Options populated by JS --\x3e\n        </div>\n        <div class="btfw-poll-footer">\n          <div class="btfw-poll-info">\n            <span class="btfw-poll-votes">0 votes</span>\n          </div>\n          <button class="btfw-poll-end-btn" style="display: none;">End Poll</button>\n        </div>\n      </div>\n    ',t.appendChild(n),e=n,n.querySelector(".btfw-poll-video-close").addEventListener("click",p),n.querySelector(".btfw-poll-end-btn").addEventListener("click",()=>{if(window.socket&&window.socket.emit)try{window.socket.emit("closePoll")}catch(t){console.error("Failed to end poll:",t)}}),n}();if(!o||!t)return;const r=function(t){const e=l(t);if("string"==typeof e){const t=e.trim();if(t.length)return t}return"Poll"}(t.title);n={...t,title:r,votes:t.votes?[...t.votes]:new Array(t.options?.length||0).fill(0)},a.clear();const i=o.querySelector(".btfw-poll-video-title"),s=o.querySelector(".btfw-poll-options-grid"),c=o.querySelector(".btfw-poll-end-btn");i&&(i.textContent=r),c&&(c.style.display=window.CLIENT&&window.CLIENT.rank>=2?"block":"none"),s&&t.options&&(s.innerHTML="",t.options.forEach((e,o)=>{const r=document.createElement("div");r.className="btfw-poll-option-row";const i=document.createElement("button");i.className="btfw-poll-option-btn",i.dataset.optionIndex=o;const c=document.createElement("span");c.className="btfw-poll-option-text",c.textContent=l(e);const d=n.votes[o]||0;i.textContent=d.toString(),i.addEventListener("click",()=>{try{m(o)}catch(t){console.error("Failed to trigger poll vote:",t)}t.multi?a.has(o)?(a.delete(o),i.classList.remove("active")):(a.add(o),i.classList.add("active")):(a.clear(),s.querySelectorAll(".btfw-poll-option-btn").forEach(t=>{t.classList.remove("active")}),a.add(o),i.classList.add("active"))}),r.appendChild(i),r.appendChild(c),s.appendChild(r)})),w(n),o.classList.add("btfw-poll-active"),setTimeout(()=>{f(),u()},200)}function p(){e&&(e.classList.remove("btfw-poll-active"),n=null,a.clear(),d())}function w(t){if(!e||!t)return;n&&t.votes&&(n.votes=[...t.votes]);const o=e.querySelector(".btfw-poll-votes"),i=e.querySelector(".btfw-poll-options-grid");if(i&&t.votes){const e=i.querySelectorAll(".btfw-poll-option-btn"),n=c();let o=!1;e.forEach((e,n)=>{const o=t.votes[n]||0;e.textContent=o.toString(),e.classList.remove("active")}),n.length===e.length&&e.forEach((t,e)=>{const r=n[e];r&&r.classList.contains("active")?(t.classList.add("active"),a.add(e),o=!0):a.delete(e)}),!o&&a.size&&a.forEach(t=>{const n=e[t];n&&n.classList.add("active")})}if(o&&t.votes){const e=t.votes.reduce((t,e)=>t+(e||0),0);o.textContent=`${e} vote${1!==e?"s":""}`}!r&&e&&e.classList.contains("btfw-poll-active")&&u()}function g(){if(!o&&window.socket)try{window.socket.on("newPoll",t=>{t&&b(t)}),window.socket.on("updatePoll",t=>{t&&n&&w(t)}),window.socket.on("closePoll",()=>{p()}),window.socket.on("connect",()=>{console.log("[poll-overlay] Socket reconnected, re-wiring events"),o=!1,setTimeout(()=>{g()},500)}),o=!0}catch(t){console.warn("[poll-overlay] Socket event wiring failed:",t)}}async function h(){try{!function(){if(document.getElementById(t))return;const e=document.createElement("style");e.id=t,e.textContent="\n    /* Poll Display Overlay on Video */\n    #btfw-poll-video-overlay {\n      position: absolute;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      z-index: 1500;\n      pointer-events: none;\n      display: none;\n    }\n\n    :root.btfw-poll-overlay-disabled #btfw-poll-video-overlay {\n      display: none !important;\n    }\n\n    #btfw-poll-video-overlay.btfw-poll-active {\n      display: block;\n    }\n\n    .btfw-poll-video-content {\n      position: absolute;\n      top: 30px;\n      left: 20px;\n      right: 20px;\n      pointer-events: auto;\n      background: var(--btfw-overlay-bg);\n      backdrop-filter: saturate(130%) blur(2px);\n      border: 1px solid var(--btfw-overlay-border);\n      border-radius: calc(var(--btfw-radius) + 6px);\n      padding: 20px;\n      box-shadow: var(--btfw-overlay-shadow);\n      color: var(--btfw-color-text);\n      max-width: 800px;\n      margin: 0 auto;\n    }\n\n    .btfw-poll-video-header {\n      display: flex;\n      justify-content: space-between;\n      align-items: flex-start;\n      margin-bottom: 16px;\n    }\n\n    .btfw-poll-video-title {\n      font-size: 1.2rem;\n      font-weight: 700;\n      color: var(--btfw-color-text);\n      margin: 0;\n      flex: 1;\n    }\n\n    .btfw-poll-video-close {\n      background: none;\n      border: none;\n      font-size: 1.2rem;\n      color: var(--btfw-color-text);\n      cursor: pointer;\n      padding: 4px;\n      opacity: 0.7;\n      margin-left: 12px;\n    }\n\n    .btfw-poll-video-close:hover {\n      opacity: 1;\n    }\n\n    .btfw-poll-options-grid {\n    display: flex !important;\n    flex-direction: row !important;\n    gap: 1rem !important;\n    align-items: stretch;\n    margin: 20px 0 !important;\n    justify-content: center;\n    flex-wrap: nowrap;\n    overflow-x: auto;\n    overflow-y: hidden;\n    }\n\n    .btfw-poll-option-row {\n      display: flex;\n      align-items: center;\n      gap: 8px;\n    }\n\n    .btfw-poll-option-btn {\n      background: color-mix(in srgb, var(--btfw-color-panel) 86%, transparent 14%);\n      border: 2px solid var(--btfw-border);\n      border-radius: 6px;\n      padding: 6px 12px;\n      color: var(--btfw-color-text);\n      cursor: pointer;\n      transition: all 0.2s;\n      font-weight: 500;\n      min-width: 60px;\n      text-align: center;\n      font-size: 0.9rem;\n    }\n\n    .btfw-poll-option-btn:hover {\n      background: color-mix(in srgb, var(--btfw-color-accent) 20%, transparent 80%);\n      border-color: var(--btfw-color-accent);\n    }\n\n    .btfw-poll-option-btn.active {\n      background: color-mix(in srgb, var(--btfw-color-accent) 32%, transparent 68%);\n      border-color: var(--btfw-color-accent);\n      color: var(--btfw-color-on-accent);\n    }\n\n    .btfw-poll-option-text {\n      flex: 1;\n      color: var(--btfw-color-text);\n      font-weight: 500;\n    }\n\n    .btfw-poll-footer {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      margin-top: 16px;\n      padding-top: 12px;\n      border-top: 1px solid color-mix(in srgb, var(--btfw-border) 60%, transparent 40%);\n    }\n\n    .btfw-poll-info {\n      font-size: 0.85rem;\n      color: color-mix(in srgb, var(--btfw-color-text) 70%, transparent 30%);\n    }\n\n    .btfw-poll-end-btn {\n      background: var(--btfw-color-error, #e74c3c);\n      color: white;\n      border: none;\n      border-radius: 6px;\n      padding: 6px 12px;\n      cursor: pointer;\n      font-size: 0.85rem;\n      font-weight: 600;\n    }\n\n    .btfw-poll-end-btn:hover {\n      opacity: 0.9;\n    }\n\n    @media (max-width: 768px) {\n      .btfw-poll-video-content {\n        left: 12px;\n        right: 12px;\n        top: 20px;\n        padding: 16px;\n      }\n    }\n  ",document.head.appendChild(e)}(),await new Promise(t=>{if(window.socket&&window.socket.on)return void t();let e=0;const n=()=>{e++,window.socket&&window.socket.on?t():e<50?setTimeout(n,100):(console.warn("[poll-overlay] Socket not available after 5 seconds"),t())};setTimeout(n,100)}),g(),setTimeout(()=>{!function(){const t=document.querySelector("#pollwrap .well.active");if(t){console.log("Found existing active poll, extracting data...");const e=t.querySelector("h3"),n=t.querySelectorAll(".option");if(e&&n.length>0){const t={title:e.textContent.trim(),options:[],votes:[],multi:!1};return n.forEach((e,n)=>{const o=e.querySelector("button"),a=e.textContent.replace(o?o.textContent:"","").trim(),r=o&&parseInt(o.textContent)||0;t.options.push(a),t.votes.push(r)}),console.log("Extracted poll data:",t),b(t),!0}}}()},500)}catch(t){console.error("[poll-overlay] Boot failed:",t)}}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",h):setTimeout(h,0),document.addEventListener("btfw:layoutReady",()=>{setTimeout(h,200)}),{name:"feature:poll-overlay",showOverlay:b,hideOverlay:p}}),BTFW.define("feature:notify",[],async()=>{const t=(t,e=document)=>e.querySelector(t),e=document.createElement("textarea");function n(t){return"string"!=typeof t?null==t?"":String(t):""===t?"":(e.innerHTML=t,e.value)}const o="btfw:notify:enabled";let a=!0;try{const t=localStorage.getItem(o);null!==t&&(a="1"===t)}catch(t){}let r=!0;try{const t=localStorage.getItem("btfw:chat:joinNotices");null!==t&&(r="1"===t)}catch(t){}function i(){const e=t("#messagebuffer");if(!e)return null;const n=t("#chatwrap"),o=n?.querySelector(".btfw-chat-topbar");let a=t("#btfw-notify-stack");a||(a=document.createElement("div"),a.id="btfw-notify-stack",a.setAttribute("role","region"),a.setAttribute("aria-live","polite"),a.setAttribute("aria-relevant","additions"));const r=!!o;if(a.classList.toggle("btfw-notify-stack--topbar",r),a.classList.toggle("btfw-notify-stack--buffer",!r),r)"static"===getComputedStyle(o).position&&(o.style.position="relative"),a.parentElement!==o&&o.appendChild(a);else{"static"===getComputedStyle(e).position&&(e.style.position="relative"),a.parentElement!==e&&e.appendChild(a);const t=e.firstElementChild;t&&t!==a&&e.insertBefore(a,t)}return a}document.addEventListener("btfw:chat:joinNoticesChanged",t=>{t&&t.detail&&(r=!!t.detail.enabled)}),document.addEventListener("btfw:themeSettings:apply",t=>{const e=t?.detail?.values?.joinNotices;null!=e&&(r=!!e)});const s=[],l=[];function c(t){if(!a)return null;const e=Object.assign({id:"n_"+Math.random().toString(36).slice(2),title:"",html:"",icon:"",kind:"info",timeout:6e3,onClick:null,actions:[]},t||{});return e.el=function(t){const e=document.createElement("div");e.className=`btfw-notice btfw-notice--${t.kind}`,e.setAttribute("role","status"),e.setAttribute("aria-live","polite");const n=document.createElement("div");n.className="btfw-notice-shell";const o=document.createElement("div");if(o.className="btfw-notice-iconwrap",t.icon){const e=document.createElement("span");e.className="btfw-notice-icon",e.innerHTML=t.icon,o.appendChild(e)}else o.classList.add("is-empty");n.appendChild(o);const a=document.createElement("div");a.className="btfw-notice-content";const r=document.createElement("div");r.className="btfw-notice-header";const i=document.createElement("strong");i.className="btfw-notice-title",i.textContent=t.title||"";const s=document.createElement("button");s.className="btfw-notice-close",s.type="button",s.setAttribute("aria-label","Close"),s.innerHTML="&times;",r.appendChild(i),r.appendChild(s),a.appendChild(r);const l=document.createElement("div");l.className="btfw-notice-body",t.html&&(l.innerHTML=t.html);if(a.appendChild(l),t.actions&&t.actions.length){const e=document.createElement("div");e.className="btfw-notice-actions",t.actions.forEach(t=>{const n=document.createElement("button");n.className="btfw-notice-cta",n.type="button",n.textContent=t.label||"Action",n.addEventListener("click",e=>{e.stopPropagation(),t.onclick&&t.onclick(e)}),e.appendChild(n)}),a.appendChild(e)}if(t.timeout>0){const t=document.createElement("p");t.className="btfw-notice-timer";const e=document.createElement("span");e.className="btfw-notice-timer-label",e.innerHTML='This message will close in <span class="btfw-notice-timer-remaining"></span> seconds.';const n=document.createElement("button");n.type="button",n.className="btfw-notice-stop",n.textContent="Click to stop.",t.appendChild(e),t.appendChild(n),a.appendChild(t)}n.appendChild(a),e.appendChild(n);const c=document.createElement("div");c.className="btfw-notice-progress";const d=document.createElement("div");return c.appendChild(d),e.appendChild(c),e.addEventListener("click",e=>{if(e.target.closest(".btfw-notice-close"))return e.preventDefault(),e.stopPropagation(),void u(t);"function"==typeof t.onClick&&t.onClick(e)}),e.addEventListener("mouseenter",()=>function(t){const e=t._state;e&&(e.paused=!0,e.lastTick=Date.now())}(t)),e.addEventListener("mouseleave",()=>function(t){const e=t._state;e&&!e.manual&&(e.paused=!1,e.lastTick=Date.now())}(t)),e}(e),s.length>=3?l.push(e):d(e),e}function d(t){const e=i();if(e)if(s.push(t),e.appendChild(t.el),t.timeout>0)t.el.classList.add("btfw-notice--timed"),function(t){const e=t.el.querySelector(".btfw-notice-progress > div"),n=t.el.querySelector(".btfw-notice-timer"),o=t.el.querySelector(".btfw-notice-timer-label"),a=t.el.querySelector(".btfw-notice-timer-remaining"),r=t.el.querySelector(".btfw-notice-stop"),i={total:Math.max(0,t.timeout),remaining:Math.max(0,t.timeout),paused:!1,manual:!1,lastTick:Date.now(),lastDisplayedSecs:-1,intervalId:0,bar:e,label:o,timer:n,remainingNode:a};function s(){if(i.bar){const t=i.total>0?Math.max(0,Math.min(1,i.remaining/i.total)):0;i.bar.style.transform=`scaleX(${t})`}if(i.remainingNode){const t=i.total>0?Math.max(0,Math.ceil(i.remaining/1e3)):0;t!==i.lastDisplayedSecs&&(i.remainingNode.textContent=String(t),i.lastDisplayedSecs=t)}}s(),i.intervalId=window.setInterval(()=>{if(i.manual||i.paused)return void(i.lastTick=Date.now());const e=Date.now(),n=e-i.lastTick;i.lastTick=e,i.remaining=Math.max(0,i.remaining-n),s(),i.remaining<=0&&(clearInterval(i.intervalId),i.intervalId=0,u(t))},140),t._state=i,r&&r.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),i.manual||(i.manual=!0,i.paused=!0,i.intervalId&&(clearInterval(i.intervalId),i.intervalId=0),t.el.classList.add("btfw-notice--pinned"),i.timer&&i.timer.classList.add("is-stopped"),i.label&&(i.label.textContent="Timer stopped."),i.remainingNode&&(i.remainingNode.textContent="0"),r.remove())},{once:!0})}(t);else{t.el.classList.remove("btfw-notice--timed");const e=t.el.querySelector(".btfw-notice-timer");e&&e.remove();const n=t.el.querySelector(".btfw-notice-progress");n&&n.remove()}else l.push(t)}function u(t){if(t._closed)return;t._closed=!0,t._state?.intervalId&&clearInterval(t._state.intervalId),t._state=null,t.el&&t.el.parentNode&&(t.el.classList.add("btfw-notice--leaving"),setTimeout(()=>{try{t.el.remove()}catch(t){}},160));const e=s.indexOf(t);e>=0&&s.splice(e,1),l.length&&s.length<3&&d(l.shift())}function f(){s.slice().forEach(u),l.length=0}const m={notify:c,info:t=>c(Object.assign({kind:"info"},t||{})),success:t=>c(Object.assign({kind:"success"},t||{})),warn:t=>c(Object.assign({kind:"warn"},t||{})),error:t=>c(Object.assign({kind:"error"},t||{})),closeAll:f,setEnabled(t){a=!!t;try{localStorage.setItem(o,a?"1":"0")}catch(t){}a||f()},isEnabled:()=>!!a},b=new Map;function p(t,e,n){const o=Date.now();(b.get(t)||0)>o||(b.set(t,o+(e||1500)),n())}let w=!1;function g(){if(!w&&window.socket&&"function"==typeof window.socket.on){w=!0;try{const e=e=>{const n=function(t){if(!t)return"";const e=[t.title,t.currenttitle,t.currentTitle,t.media?.title,t.current?.media?.title,t.queue?.media?.title,t.queue?.current?.media?.title,t.queue?.item?.title,t.item?.media?.title,t.item?.title];for(const t of e)if(null!=t&&String(t).trim())return h(t);return""}(e);if(n)return v(n);const o=(e,n=200)=>{e<=0||setTimeout(()=>{const a=function(){const e=t("#currenttitle");return e&&e.textContent?h(e.textContent):"New media"}();a&&"New media"!==a?v(a):o(e-1,n)},n)};o(3)};socket.on("changeMedia",e),socket.on("setCurrent",e)}catch(t){}try{socket.on("newPoll",t=>{const e=t&&t.title?String(t.title):"A new poll started";p("poll:"+e,2e3,()=>{const o=Array.isArray(t?.options)?t.options.slice(0,4).map(t=>`<li>${y(n(String(t)))}</li>`).join(""):"";m.info({title:"Poll started",html:`<div class="poll-title">${y(n(e))}</div>${o?`<ul class="poll-opts">${o}</ul>`:""}`,icon:"üìä"})})})}catch(t){}try{socket.on("addUser",t=>{const e=t&&(t.name||t.un)?t.name||t.un:"Someone";r&&p("join:"+e,6e4,()=>{m.success({title:"Joined",html:`<b>${y(n(e))}</b> entered the channel`,icon:"üëã",timeout:3500})})})}catch(t){}}}function h(t){return String(t||"").replace(/^\s*(?:currently|now)\s*playing\s*[:\-]\s*/i,"").trim()}function v(t){const e=h(n(t||""))||"New media";p(`np:${function(t){const e=(null==t?"":String(t)).trim();return e?e.toLowerCase():"__unknown__"}(e)}`,1500,()=>{m.info({title:"Now playing",html:`<div class="np-title">${y(e)}</div>`,icon:"‚ñ∂Ô∏è"})})}function y(t){return t.replace(/[&<>"]/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[t]))}function _(){i(),function(){const e=t("#chatwrap");e&&!e._btfw_notify_obs&&(e._btfw_notify_obs=!0,new MutationObserver(()=>i()).observe(e,{childList:!0,subtree:!0}))}(),g()}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",_):_(),document.addEventListener("btfw:layoutReady",()=>setTimeout(_,50)),window.BTFW_notify=m,Object.assign({name:"feature:notify"},m)}),BTFW.define("feature:notification-sounds",[],async()=>{const t="btfw:notify:sounds:v2",e=[{id:"soft-chime",name:"Soft chime",duration:.8,steps:[{type:"sine",frequency:660,duration:.28,attack:.012,release:.16,level:.9},{type:"triangle",frequency:880,duration:.26,delay:.05,attack:.01,release:.14,level:.75}]},{id:"bright-ping",name:"Bright ping",duration:.7,steps:[{type:"square",frequency:1250,frequencyEnd:1320,duration:.2,attack:.006,release:.12,level:.85},{type:"sine",frequency:980,frequencyEnd:880,delay:.18,duration:.22,attack:.01,release:.16,level:.6}]},{id:"digital-pop",name:"Digital pop",duration:.65,steps:[{type:"square",frequency:420,frequencyEnd:260,duration:.22,attack:.008,release:.16,level:.9},{type:"sawtooth",frequency:640,frequencyEnd:520,delay:.16,duration:.18,attack:.012,release:.12,level:.7}]},{id:"harmony-rise",name:"Harmony rise",duration:1,steps:[{type:"sine",frequency:540,frequencyEnd:620,duration:.32,attack:.014,release:.18,level:.85},{type:"sine",frequency:720,frequencyEnd:680,delay:.18,duration:.34,attack:.012,release:.2,level:.75},{type:"triangle",frequency:430,frequencyEnd:360,delay:.32,duration:.42,attack:.018,release:.24,level:.65}]},{id:"airy-bell",name:"Airy bell",duration:.9,steps:[{type:"sine",frequency:780,duration:.28,attack:.012,release:.2,level:.75},{type:"triangle",frequency:520,frequencyEnd:470,delay:.22,duration:.34,attack:.018,release:.22,level:.7},{type:"sine",frequency:1040,delay:.1,duration:.2,attack:.008,release:.14,level:.6}]}],n="https://raw.githubusercontent.com/BillTube/BillTube2/master/sounds/",o=[{id:"boop",name:"boop",url:n+"146717_2437358-lq.mp3",duration:1},{id:"blip",name:"blip",url:n+"146718_2437358-lq.mp3",duration:1},{id:"dingding",name:"dingding",url:n+"264447_4322723-lq.mp3",duration:2},{id:"nyan",name:"nyan",url:n+"336012_5953264-lq.mp3",duration:2},{id:"knocks",name:"knocks",url:n+"383757_7146007-lq.mp3",duration:5},{id:"scary",name:"scary",url:n+"419673_1904290-lq.mp3",duration:1},{id:"ping",name:"ping",url:n+"506052_10991815-lq.mp3",duration:1}];e.push(...o);const a=new Map(e.map(t=>[t.id,t])),r=[{key:"join",title:"Someone joins",description:"Play a sound when a new viewer enters the channel.",muteLabel:"Mute join sound"},{key:"mention",title:"You are mentioned",description:"Alert me when my username appears in chat.",muteLabel:"Mute mention sound"},{key:"poll",title:"Poll starts",description:"Play an audible cue whenever a new poll opens.",muteLabel:"Mute poll sound"},{key:"video",title:"New video",description:"Notify me when playback switches to a new video.",muteLabel:"Mute video sound"}],i={join:{muted:!0,volume:.6,sound:"soft-chime"},mention:{muted:!1,volume:.75,sound:"blip"},poll:{muted:!1,volume:.85,sound:"knocks"},video:{muted:!0,volume:.65,sound:"airy-bell"}},s=document.createElement("div"),l=new Map,c=new Map;let d=function(){try{const e=localStorage.getItem(t);if(!e)return h(i);return h(JSON.parse(e))}catch(t){return h(i)}}(),u=h(d),f=null;const m=new Map;function b(){return window.AudioContext||window.webkitAudioContext||null}function p(){if(f)return f;const t=b();if(!t)return null;try{f=new t}catch(t){f=null}return f}function w(){const t=p();return t?("suspended"===t.state&&t.resume().catch(()=>{}),t):null}function g(t){const e=Number(t);return Number.isFinite(e)?Math.min(Math.max(e,0),1):0}function h(t){const e={};return r.forEach(n=>{const o=t&&t[n.key];e[n.key]=function(t,e){const n=i[t],o=e&&"object"==typeof e?e:{},r=a.has(o.sound)?o.sound:n.sound,s=g(null!=o.volume?o.volume:n.volume);return{muted:null!=o.muted?!!o.muted:!!n.muted,volume:s,sound:r}}(n.key,o)}),e}async function v(t,n){const o=a.get(t)||e[0];if(!o)return;if(o.url){const t=await async function(t){if(m.has(t))return m.get(t);const e=p();if(!e)return null;try{const n=await fetch(t);if(!n.ok)throw new Error(`HTTP ${n.status}`);const o=await n.arrayBuffer(),a=await e.decodeAudioData(o);return m.set(t,a),a}catch(e){return console.error(`Failed to load sound from ${t}:`,e),null}}(o.url);return void(t&&function(t,e){const n=w();if(!n||!t)return;const o=n.createBufferSource();o.buffer=t;const a=n.createGain();a.gain.value=g(e),o.connect(a),a.connect(n.destination),o.start(0),setTimeout(()=>{try{a.disconnect()}catch(t){}},1e3*(t.duration+.1))}(t,n))}const r=w();if(!r)return;const i=r.createGain();i.gain.value=g(n),i.connect(r.destination);const s=r.currentTime+.02;let l=s;o.steps.forEach(t=>{l=Math.max(l,function(t,e,n,o,a){const r=n+Math.max(0,Number(o.delay)||0),i=Math.max(.08,Number(o.duration)||.2),s=Math.max(.004,Math.min(null!=o.attack?o.attack:.01,.6*i)),l=Math.max(.04,Math.min(null!=o.release?o.release:.12,i)),c=Math.max(0,i-s-l),d=g(a)*g(null!=o.level?o.level:1),u=t.createOscillator();u.type=o.type||"sine";const f=Number(o.frequency)||440;u.frequency.setValueAtTime(f,r),"number"==typeof o.frequencyEnd&&o.frequencyEnd!==f&&u.frequency.linearRampToValueAtTime(o.frequencyEnd,r+i);const m=t.createGain();m.gain.setValueAtTime(1e-4,r),m.gain.linearRampToValueAtTime(d,r+s),c>0&&m.gain.setValueAtTime(d,r+s+c),m.gain.linearRampToValueAtTime(1e-4,r+i),u.connect(m),m.connect(e);const b=r+i+(null!=o.tail?o.tail:.08);u.start(r),u.stop(b);const p=Math.max(0,1e3*(b-t.currentTime+.25));return setTimeout(()=>{try{m.disconnect()}catch(t){}try{u.disconnect()}catch(t){}},p),b}(r,i,s,t,i.gain.value))});const c=Math.max(0,1e3*(l-r.currentTime+.35));setTimeout(()=>{try{i.disconnect()}catch(t){}},c)}function y(t,e){const n=Date.now();return(l.get(t)||0)>n||(l.set(t,n+(e||1e3)),!1)}function _(){try{if(window.CLIENT&&"string"==typeof CLIENT.name)return CLIENT.name}catch(t){}return""}function E(t){const e=d[t];return!!e&&(!e.muted&&(e.volume>0&&!!a.has(e.sound)))}function k(t){if(!E(t))return;const e=d[t];v(e.sound,e.volume)}function x(t){if(!t)return;const e=(t.name||t.un||"").trim();e&&e!==_()&&(y("join:"+e.toLowerCase(),6e4)||k("join"))}function C(t){if(!E("mention"))return;const e=_();if(!e)return;if(t&&(t.username===e||t.name===e))return;const n=function(t){if(!t)return"";s.innerHTML=String(t);const e=s.textContent||s.innerText||"";return s.textContent="",e}(t&&t.msg);(function(t,e){if(!t||!e)return!1;const n=t.toLowerCase(),o=e.toLowerCase();if(!n.includes(o))return!1;let a=n.indexOf(o);for(;-1!==a;){const t=0===a?" ":n[a-1],e=a+o.length,r=e>=n.length?" ":n[e],i=!/[a-z0-9_]/i.test(t),s=!/[a-z0-9_]/i.test(r);if(i&&s)return!0;a=n.indexOf(o,a+o.length)}return!1})(n,e)&&(y("mention:"+n.slice(0,40),1200)||k("mention"))}function S(t){const e=function(t){if(!t||"object"!=typeof t)return"poll:?";const e=t.id??t.pollId??t.pollID??t.poll_id??t.uid;return null!=e?"poll:"+String(e):t.title?"poll:"+String(t.title):"poll:?"}(t);y(e,2500)||k("poll")}function L(t){if(!E("video"))return;const e=function(t){if(!t||"object"!=typeof t)return"media:?";const e=t.id??t.uid??t.guid??t.media?.id??t.media?.uid??t.media?.vid;return null!=e?"media:"+String(e):t.media&&t.media.title?"media:"+String(t.media.title):t.title?"media:"+String(t.title):"media:?"}(t);y(e,2e3)||k("video")}const T={wired:!1,socketRef:null,teardown:null,retryTimer:null};function N(){const t=window.socket;if(T.socketRef&&T.socketRef!==t&&function(){if("function"==typeof T.teardown)try{T.teardown()}catch(t){}T.teardown=null,T.wired=!1,T.socketRef=null}(),T.wired)return;if(!t||"function"!=typeof t.on)return void(T.retryTimer||(T.retryTimer=setTimeout(()=>{T.retryTimer=null,N()},1e3)));const e=new Map([["addUser",x],["chatMsg",C],["newPoll",S],["changeMedia",L]]);try{e.forEach((e,n)=>{t.on(n,e)})}catch(t){return void(T.retryTimer||(T.retryTimer=setTimeout(()=>{T.retryTimer=null,N()},1e3)))}T.retryTimer&&(clearTimeout(T.retryTimer),T.retryTimer=null),T.wired=!0,T.socketRef=t,T.teardown=()=>{e.forEach((e,n)=>{if("function"==typeof t.off)try{t.off(n,e)}catch(t){}else if("function"==typeof t.removeListener)try{t.removeListener(n,e)}catch(t){}})}}function A(){const t=((t,e=document)=>e.querySelector(t))("#btfw-notify-sounds-body");if(!t||t._btfwNotifySounds)return;t._btfwNotifySounds=!0;const n=!!b(),o=document.createElement("div");if(o.className="btfw-notify-sound-list",r.forEach(t=>{const n=function(t){const n=document.createElement("div");n.className="btfw-notify-sound",n.dataset.notifyKey=t.key;const o=document.createElement("div");o.className="btfw-notify-sound__meta";const r=document.createElement("h4");r.textContent=t.title;const s=document.createElement("p");s.textContent=t.description,o.appendChild(r),o.appendChild(s),n.appendChild(o);const l=document.createElement("div");l.className="btfw-notify-sound__controls";const d=document.createElement("div");d.className="btfw-ts-control";const f=document.createElement("label");f.className="btfw-input__label";const m=`btfw-notify-${t.key}-sound`;f.setAttribute("for",m),f.textContent="Sound";const b=document.createElement("div");b.className="select is-small";const p=document.createElement("select");p.id=m,e.forEach(t=>{const e=document.createElement("option");e.value=t.id,e.textContent=t.name,p.appendChild(e)}),b.appendChild(p),d.appendChild(f),d.appendChild(b),l.appendChild(d);const w=document.createElement("div");w.className="btfw-notify-volume";const h=document.createElement("span");h.className="btfw-input__label",h.textContent="Volume";const y=document.createElement("div");y.className="btfw-notify-volume-range";const _=document.createElement("input");_.type="range",_.min="0",_.max="100",_.step="5",_.id=`btfw-notify-${t.key}-volume`;const E=document.createElement("span");E.className="btfw-notify-volume-value",E.textContent="100%",y.appendChild(_),y.appendChild(E),w.appendChild(h),w.appendChild(y),l.appendChild(w);const k=document.createElement("label");k.className="checkbox btfw-checkbox";const x=document.createElement("input");x.type="checkbox",x.id=`btfw-notify-${t.key}-mute`;const C=document.createElement("span");C.textContent=t.muteLabel,k.appendChild(x),k.appendChild(C),l.appendChild(k);const S=document.createElement("button");return S.type="button",S.className="button is-small is-link btfw-notify-preview",S.textContent="Preview",l.appendChild(S),n.appendChild(l),c.set(t.key,{row:n,soundSelect:p,volumeInput:_,volumeValue:E,muteInput:x,previewBtn:S}),p.addEventListener("change",()=>{const e=u[t.key];e&&(e.sound=a.has(p.value)?p.value:e.sound)}),_.addEventListener("input",()=>{const e=u[t.key];if(!e)return;const n=g(Number(_.value)/100);e.volume=n,E.textContent=`${Math.round(100*n)}%`}),x.addEventListener("change",()=>{const e=u[t.key];e&&(e.muted=!!x.checked,n.classList.toggle("is-muted",e.muted))}),S.addEventListener("click",e=>{e.preventDefault();const n=u[t.key];if(!n)return;v(a.has(n.sound)?n.sound:i[t.key].sound,g(null!=n.volume?n.volume:i[t.key].volume)||.5)}),n}(t);o.appendChild(n)}),t.appendChild(o),!n){const e=document.createElement("p");e.className="btfw-help",e.textContent="Your browser does not support the Web Audio API, so notification sounds cannot play.",t.appendChild(e)}}function q(){r.forEach(t=>{const e=u[t.key],n=c.get(t.key);if(!e||!n)return;n.soundSelect.value=a.has(e.sound)?e.sound:i[t.key].sound;const o=g(null!=e.volume?e.volume:i[t.key].volume);n.volumeInput.value=String(Math.round(100*o)),n.volumeValue.textContent=`${Math.round(100*o)}%`,n.muteInput.checked=!!e.muted,n.row.classList.toggle("is-muted",!!e.muted)})}return document.addEventListener("btfw:themeSettings:open",function(){A(),u=h(d),q(),w()}),document.addEventListener("btfw:themeSettings:apply",function(){d=h(u),function(e){try{localStorage.setItem(t,JSON.stringify(e))}catch(t){}}(d),u=h(d),q(),document.dispatchEvent(new CustomEvent("btfw:notificationSounds:changed",{detail:{settings:h(d)}}))}),document.addEventListener("click",w,{once:!0}),document.addEventListener("keydown",w,{once:!0}),N(),document.addEventListener("btfw:ready",()=>setTimeout(N,0)),{getSettings:()=>h(d),preview(t){const e=d[t];e&&v(e.sound,e.volume)}}}),BTFW.define("feature:syncGuard",[],async()=>({name:"feature:syncGuard",disabled:!0})),BTFW.define("feature:local-subs",[],async()=>{const t=(t,e=document)=>e.querySelector(t);function e(){const t=(function(){try{return window.PLAYER?.mediaType||null}catch(t){return null}}()||"").toLowerCase();return"fi"===t||"gd"===t}function n(t){try{t.querySelectorAll("track[kind='subtitles'], track[kind='captions']").forEach(t=>t.remove())}catch(t){}}function o(){try{return window.videojs&&videojs("ytapiplayer")||null}catch(t){return null}}function a(t){try{const e=t.remoteTextTracks();for(let n=e.length-1;n>=0;n--)t.removeRemoteTextTrack(e[n])}catch(t){}}function r(){return t("#ytapiplayer video")||t("video")||null}function i(){let e=t("#btfw-localsubs-input");e||(e=document.createElement("input"),e.type="file",e.accept=".vtt,.srt",e.id="btfw-localsubs-input",e.style.display="none",document.body.appendChild(e),e.addEventListener("change",async t=>{const e=t.target.files&&t.target.files[0];if(!e)return;const i=new FileReader;i.onload=function(t){let i=String(t.target.result||"");e.name.toLowerCase().endsWith(".srt")&&(i="WEBVTT\n\n"+String(i).replace(/\r+/g,"").replace(/^\d+\s+|\n\d+\s+/g,"").replace(/(\d{2}):(\d{2}):(\d{2}),(\d{3})/g,"$1:$2:$3.$4"));const s=function(t){const e=new Blob([t],{type:"text/vtt"});return URL.createObjectURL(e)}(i),l=o();if(l)a(l),function(t,e,n="Subtitles"){try{t.addRemoteTextTrack({kind:"subtitles",src:e,default:!0,label:n},!1)}catch(t){}}(l,s,e.name);else{const t=r();t?(n(t),function(t,e,n="Subtitles"){const o=document.createElement("track");o.kind="subtitles",o.src=e,o.label=n,o.default=!0,t.appendChild(o)}(t,s,e.name)):console.warn("[local-subs] No compatible video element found.")}},i.readAsText(e),t.target.value=""})),e.click()}function s(){const n=t("#btfw-btn-localsubs");n&&(n.style.display=e()?"":"none")}function l(){const e=t("#VideoOverlay");if(!e)return;let n=t("#btfw-btn-localsubs");n||(n=document.createElement("button"),n.id="btfw-btn-localsubs",n.className="button is-dark is-small btfw-vo-btn",n.title="Local Subtitles (VTT/SRT)",n.innerHTML='<i class="fa fa-closed-captioning"></i>',n.addEventListener("click",i),e.querySelector(".btfw-vo-buttons")?.appendChild(n)||e.appendChild(n)),s()}function c(){!function(){try{window.socket&&socket.on&&!window._btfw_localsubs_wired&&(window._btfw_localsubs_wired=!0,socket.on("changeMedia",()=>{const t=o();t&&a(t);const e=r();e&&n(e),setTimeout(s,0)}))}catch(t){}}(),l(),s();new MutationObserver(()=>{l(),s()}).observe(document.body,{childList:!0,subtree:!0})}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",c):c(),{name:"feature:local-subs"}}),BTFW.define("feature:billcast",[],async()=>{const t="btfw:billcast:enabled",e=(window.BTFW&&BTFW.BASE?BTFW.BASE.replace(/\/+$/,""):"")+"/modules/feature-billcaster.js";function n(){const t=(function(){try{return window.PLAYER?.mediaType||null}catch(t){return null}}()||"").toLowerCase();return"fi"===t||"gd"===t}async function o(){if(window.__BTFW_BILLCAST_LOADED)return!0;try{return await new Promise((t,n)=>{if(window.__BTFW_BILLCAST_LOADED)return t(!0);const o=document.createElement("script");o.src=e,o.async=!0,o.defer=!0,o.onload=()=>{window.__BTFW_BILLCAST_LOADED=!0,t(!0)},o.onerror=()=>n(new Error("Failed to load "+e)),document.head.appendChild(o)}),console.log("[billcast] loaded"),!0}catch(t){return console.warn("[billcast] load failed:",t&&t.message||t),!1}}function a(){const t=document.getElementById("castButton"),e=document.getElementById("fallbackButton");t&&t.remove(),e&&e.remove(),console.log("[billcast] disabled (UI hidden; script not reloaded again)")}function r(e){const n=e&&e.detail&&e.detail.values||{};"boolean"==typeof n.billcastEnabled&&(!function(e){try{localStorage.setItem(t,e?"1":"0")}catch(t){}}(n.billcastEnabled),i())}function i(){!function(){try{const e=localStorage.getItem(t);return null===e||"1"===e}catch(t){return!0}}()?a():n()?o():a()}function s(){document.addEventListener("btfw:themeSettings:apply",r),i();try{window.socket&&"function"==typeof socket.on&&socket.on("changeMedia",()=>{setTimeout(()=>i(),0)})}catch(t){}}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",s):s(),{name:"feature:billcast",enable:o,disable:a}}),$(document).ready(function(){var t=null,e=null,n=null,o=!1,a=null;function r(){var t=function(){try{return window.PLAYER&&window.PLAYER.mediaType||null}catch(t){return null}}();if("string"==typeof t){if("fi"===(t=t.toLowerCase())||"gd"===t)return!0;if(t)return!1}var e=m();if("string"==typeof e&&e.length){var n=e.toLowerCase();return-1===n.indexOf("youtube.com")&&-1===n.indexOf("youtu.be")&&/(\.mp4|\.webm|\.ogg|\.ogv|\.mov)([#?]|$)/.test(n)}return!1}function i(){var t=$("#btfw-vo-bar");if(t.length)return t;var e=function(){var t=$("#btfw-video-overlay");if(t.length)return t;if((t=$("#VideoOverlay")).length)return t;var e=$("#videowrap");return e.length?t=$('<div id="btfw-video-overlay" class="btfw-video-overlay"></div>').css({position:"absolute",inset:0,"pointer-events":"none"}).appendTo(e):$()}();return e.length?t=$('<div id="btfw-vo-bar" class="btfw-vo-bar"></div>').css({position:"absolute",top:"8px",right:"8px",left:"8px",display:"flex","justify-content":"space-between",gap:"6px","pointer-events":"none","z-index":1e3}).appendTo(e):$()}function s(t){if(i().length)return t();var e=new MutationObserver(function(){i().length&&(e.disconnect(),t())});e.observe(document.body,{childList:!0,subtree:!0})}function l(){$("#ytapiplayer").length?(n=videojs("ytapiplayer"),function(){if(!n)return;n.on("play",function(){t&&e&&e.playerState!==chrome.cast.media.PlayerState.PLAYING&&e.play(function(){console.log("Cast player resumed")},function(t){console.error("Error playing cast player:",t)})}),n.on("pause",function(){t&&e&&e.playerState!==chrome.cast.media.PlayerState.PAUSED&&e.pause(function(t){console.error("Error pausing cast player:",t)})}),n.on("seeked",function(){if(t&&e){var o=n.currentTime();if(e&&e.sessionId===t.getSessionId()){var a=new chrome.cast.media.SeekRequest;a.currentTime=o,e.seek(a,function(){console.log("Cast player synced after seek")},function(t){console.error("Error syncing cast player after seek:",t)})}else console.error("Cannot seek: Invalid cast player session.")}}),n.on("loadstart",function(){w()}),n.on("loadeddata",function(){p(),t&&b(0),d()})}(),d()):setTimeout(l,500)}function c(){var t=function(t){var e="left"===t?"btfw-vo-left":"btfw-vo-right",n="btfw-vo-section btfw-vo-section--"+t,o=$("#"+e);if(o.length)return o;var a=i();return a.length?(o=$("<div></div>").attr("id",e).addClass(n).css({display:"flex","pointer-events":"auto",gap:"6px","flex-wrap":"wrap"}),"left"===t?a.prepend(o):a.append(o),a.attr("data-left-section","#btfw-vo-left"),a.attr("data-right-section","#btfw-vo-right"),o):$()}("left");if(t.length){$("#btfw-vo-cast, #btfw-vo-cast-fallback").remove();var e=o?function(){if($("#btfw-vo-cast").length)return $("#btfw-vo-cast");var t=$('<button id="btfw-vo-cast" class="btn btn-sm btn-default btfw-vo-adopted" title="Cast to device" data-btfw-overlay="1"><i class="fa-brands fa-chromecast"></i></button>');return t.on("click",function(){try{cast.framework.CastContext.getInstance().requestSession()}catch(t){alert("Cast framework not ready.")}}),t}():function(){if($("#btfw-vo-cast-fallback").length)return $("#btfw-vo-cast-fallback");var t=$('<button id="btfw-vo-cast-fallback" class="btn btn-sm btn-default btfw-vo-adopted" title="Casting not available" data-btfw-overlay="1"><i class="fa-solid fa-circle-info"></i></button>');return t.on("click",function(){alert("Casting is not available in this browser. Please use Google Chrome for casting.")}),t}();e&&e.length&&(t.append(e),d())}else s(c)}function d(){if(!r())return $("#btfw-vo-cast, #btfw-vo-cast-fallback").hide(),void(t&&w());o?($("#btfw-vo-cast").show(),$("#btfw-vo-cast-fallback").hide(),t&&!a&&p()):($("#btfw-vo-cast").hide(),$("#btfw-vo-cast-fallback").show())}function u(o){switch(o.sessionState){case cast.framework.SessionState.SESSION_STARTED:case cast.framework.SessionState.SESSION_RESUMED:(t=cast.framework.CastContext.getInstance().getCurrentSession())&&(e=t.getMediaSession()),f(function(){b(n&&"function"==typeof n.currentTime?n.currentTime():0)}),p();break;case cast.framework.SessionState.SESSION_ENDED:t=null,e=null,w()}}function f(t){n?t():setTimeout(function(){f(t)},500)}function m(){var t=$("#ytapiplayer video"),e=$("#ytapiplayer iframe"),n=null;return t.length>0&&((n=t.attr("src"))||t.find("source").each(function(){var t=$(this).attr("src");if(t)return n=t,!1}),n||(n=t.attr("data-src"))),!n&&e.length>0&&(n=e.attr("src")),n}function b(n){if(t){var o=m();if(o){if(r()){var a=function(t){switch(t.split(".").pop().split(/#|\?/)[0].toLowerCase()){case"mp4":return"video/mp4";case"webm":return"video/webm";case"ogg":case"ogv":return"video/ogg";case"mov":return"video/quicktime";default:return console.warn("Unknown extension; defaulting to video/mp4"),"video/mp4"}}(o),i=new chrome.cast.media.MediaInfo(o,a),s="BillTube Cast: "+($("#currenttitle").text()||"Unknown Title"),l=new chrome.cast.media.GenericMediaMetadata;l.title=s,i.metadata=l;var c=new chrome.cast.media.LoadRequest(i);c.currentTime=n||0,c.autoplay=!0,t.loadMedia(c).then(function(){e=t.getMediaSession(),d()},function(t){console.error("Error loading media:",t)})}}else console.error("Cannot cast: no video src")}}function p(){a||(a=setInterval(g,12e4))}function w(){a&&(clearInterval(a),a=null)}function g(){if(t&&e&&n&&"function"==typeof n.currentTime){var o=n.currentTime(),a=Date.now();e.getStatus(null,function(n){var r=(Date.now()-a)/2e3,i=n.currentTime+r;if(Math.abs(o-i)>20)if(e&&e.sessionId===t.getSessionId()){var s=new chrome.cast.media.SeekRequest;s.currentTime=o,e.seek(s,function(){console.log("Cast synced to local")},function(t){console.error("Cast sync error:",t)})}else console.error("Invalid cast session; stopping sync."),w()})}else w()}function h(t){$("#ytapiplayer").length>0?t():setTimeout(function(){h(t)},500)}window.socket&&"function"==typeof window.socket.on&&socket.on("changeMedia",function(){h(function(){l(),n&&"function"==typeof n.ready&&n.ready(function(){t&&b(0),d()})})});var v=document.createElement("script");v.src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1",document.head.appendChild(v),window.__onGCastApiAvailable=function(t){t?function(){o=!0;var t=cast.framework.CastContext.getInstance();t.setOptions({receiverApplicationId:chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,autoJoinPolicy:chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED}),t.addEventListener(cast.framework.CastContextEventType.SESSION_STATE_CHANGED,u),s(c)}():(o=!1,s(c))},$(window).on("beforeunload",function(){t&&t.endSession(!0)}),l(),s(c)}),BTFW.define("feature:overlays",["core"],async function(){function t(){if(!document.getElementById("btfw-overlay-root")){var t=document.createElement("div");t.id="btfw-overlay-root",document.body.appendChild(t)}}function e(e){t();var n=document.getElementById("btfw-overlay-root"),o=document.createElement("div");o.className="btfw-overlay",o.innerHTML="<div class='btfw-backdrop'></div><div class='btfw-modal'><button class='btfw-close' aria-label='Close'>&times;</button><div class='btfw-modal-body'></div></div>";var a=o.querySelector(".btfw-modal-body");function r(){o.remove()}return e&&e.content&&("string"==typeof e.content?a.innerHTML=e.content:a.appendChild(e.content)),o.querySelector(".btfw-backdrop").addEventListener("click",r),o.querySelector(".btfw-close").addEventListener("click",r),document.addEventListener("keydown",function t(e){"Escape"===e.key&&(r(),document.removeEventListener("keydown",t))}),n.appendChild(o),{close:r,el:o,body:a}}function n(e){t();var n=e&&e.side||"right",o=document.getElementById("btfw-overlay-root"),a=document.createElement("div");a.className="btfw-overlay btfw-drawer btfw-"+n,a.innerHTML="<div class='btfw-backdrop'></div><div class='btfw-panel'><div class='btfw-drawer-header'><span class='title'></span><button class='btfw-close'>&times;</button></div><div class='btfw-drawer-body'></div></div>",a.querySelector(".title").textContent=e&&e.title||"";var r=a.querySelector(".btfw-drawer-body");function i(){a.remove()}return e&&e.content&&("string"==typeof e.content?r.innerHTML=e.content:r.appendChild(e.content)),a.querySelector(".btfw-backdrop").addEventListener("click",i),a.querySelector(".btfw-close").addEventListener("click",i),o.appendChild(a),{close:i,el:a,body:r}}return window.BTFW_overlays={openModal:e,openDrawer:n},{openModal:e,openDrawer:n}}),BTFW.define("feature:userlistOverlay",["core","bridge"],async function(){var{ids:t}=BTFW.require("bridge"),e=!1,n=null,o=null;function a(){var a=t(),r=function(){if(n&&n.parentNode)return n;var t=document.getElementById("btfw-chatcol")||document.body;return(n=document.createElement("div")).className="btfw-chat-overlay",n.style.display="none",n.innerHTML="<div class='btfw-chat-overlay-head'><span>Connected Users</span><button class='btfw-close'>&times;</button></div><div class='btfw-chat-overlay-body'></div>",n.querySelector(".btfw-close").addEventListener("click",i),t.appendChild(n),n}(),s=r.querySelector(".btfw-chat-overlay-body");a.userList?(a.userList.style.display="",o=a.userList.parentNode,s.appendChild(a.userList)):s.textContent="No user list found.",r.style.display="block",e=!0}function r(){var a=t();a.userList&&o&&(o.appendChild(a.userList),a.userList.style.display="none",o=null),n&&(n.style.display="none"),e=!1}function i(){e?r():a()}var s=t().userList;return s&&(s.style.display="none"),window.BTFW_userlist={open:a,close:r,toggle:i},{open:a,close:r,toggle:i}}),BTFW.define("feature:ratings",[],async()=>{const t=[(()=>{try{return window.BTFW_THEME_ADMIN?.integrations?.ratings?.endpoint||""}catch(t){return""}})(),(()=>{try{return window.BTFW_CONFIG?.ratings?.endpoint||""}catch(t){return""}})(),(()=>{try{return document?.body?.dataset?.btfwRatingsEndpoint||""}catch(t){return""}})(),(()=>{try{return window.BTFW_RATINGS_ENDPOINT||""}catch(t){return""}})()].map(t=>"string"==typeof t?t.trim():"").find(Boolean)||"";if(!(t.length>0)){try{window.BTFW_CONFIG=window.BTFW_CONFIG||{},window.BTFW_CONFIG.shouldLoadRatings=!1}catch(t){}return{name:"feature:ratings",disabled:!0}}try{window.BTFW_CONFIG=window.BTFW_CONFIG||{},"object"!=typeof window.BTFW_CONFIG.ratings&&(window.BTFW_CONFIG.ratings={}),window.BTFW_CONFIG.ratings.endpoint||(window.BTFW_CONFIG.ratings.endpoint=t),window.BTFW_CONFIG.shouldLoadRatings=!0}catch(t){}const e=await BTFW.init("util:motion"),n=[1,2,3,4,5],o="btfw:ratings:anonid",a="btfw:ratings:self:",r={enabled:!1,container:null,stars:[],statusNode:null,selfNode:null,errorNode:null,announcedStart:!1,lookup:null,currentMedia:null,currentKey:"",stats:null,lastVote:null,isSubmitting:!1,lastStatsRequest:0,statsTimer:null,playbackTimer:null,endpoint:t||null,channel:null,playback:{currentTime:0,duration:0,lastUpdate:0}},i={modal:null,scrollEl:null,listEl:null,loadingEl:null,errorEl:null,loading:!1,items:[],abortController:null,tmdbKey:null,tmdbCache:new Map};function s(t,e=document){return e.querySelector(t)}function l(){try{return window.CLIENT||window.client||null}catch{return null}}function c(t){if("function"==typeof t)try{return t()}catch(t){return}return t}function d(t){let e=0;for(const n of t){const t=c(n),o=Number(t);Number.isFinite(o)&&o>e&&(e=o)}return e>0?e:NaN}function u(t){for(const e of t){const t=c(e),n=Number(t);if(Number.isFinite(n)&&n>=0)return n}return NaN}const f=["Extended","Director's Cut","Directors Cut","Unrated","Theatrical Cut"];function m(t){if(!t)return"";let e=String(t);for(const t of f){const n=new RegExp(`\\b${t}\\b`,"gi");e=e.replace(n,"")}return e.replace(/\s{2,}/g," ").trim()}function b(){const t=function(){try{return window.PLAYER||window.player||window.Player||null}catch(t){return null}}(),e=r.currentMedia;let n=!1;const o=d([()=>t?.getDuration?.(),()=>t?.getLength?.(),()=>t?.mediaLength,()=>t?.media?.seconds,()=>t?.media?.duration,()=>t?.player?.getDuration?.(),()=>"function"==typeof t?.player?.duration?t.player.duration():t?.player?.duration,()=>t?.player?.currentMedia?.duration,()=>t?.videojs?.duration?.(),()=>"function"==typeof t?.duration?t.duration():t?.duration,()=>e?.duration,()=>r.lookup?.duration,()=>r.lookup?.seconds,()=>r.playback.duration]);Number.isFinite(o)&&o>0&&((!Number.isFinite(r.playback.duration)||Math.abs(r.playback.duration-o)>.5)&&(n=!0),r.playback.duration=o,e&&(e.duration=o));const a=u([()=>t?.getTime?.(),()=>t?.getCurrentTime?.(),()=>"function"==typeof t?.currentTime?t.currentTime():t?.currentTime,()=>t?.media?.currentTime,()=>t?.player?.getCurrentTime?.(),()=>"function"==typeof t?.player?.currentTime?t.player.currentTime():t?.player?.currentTime,()=>t?.videojs?.currentTime?.(),()=>e?.currentTime,()=>r.playback.currentTime]);return Number.isFinite(a)&&a>=0&&((!Number.isFinite(r.playback.currentTime)||Math.abs(r.playback.currentTime-a)>.3)&&(n=!0),r.playback.currentTime=a,r.playback.lastUpdate=Date.now(),e&&(e.currentTime=a)),n}function p(){r.playbackTimer&&(clearTimeout(r.playbackTimer),r.playbackTimer=null)}function w(){if(r.channel)return r.channel;const t=function(){try{return window.CHANNEL||window.channel||null}catch{return null}}(),e=window.BTFW_CONFIG?.channelName,n=document.body?.dataset?.channel||"",o=(t?.name||e||n||window.CHANNELNAME||"").toString().trim();return r.channel=o||"default",r.channel}function g(){const t=function(){const t=[Number(window.BTFW_CONFIG?.ratings?.minRank),Number(document.body?.dataset?.btfwRatingsMinRank)].filter(t=>Number.isFinite(t)&&t>=0);return t.length?Math.max(1,...t):1}(),e=function(){const t=l(),e=Number(t?.rank);return Number.isFinite(e)?e:NaN}();if(Number.isFinite(e)&&e>=t)return!0;try{if("function"==typeof window.hasPermission&&(window.hasPermission("chanadmin")||window.hasPermission("owner")))return!0}catch{}try{const t=l();if(t?.hasPermission&&(t.hasPermission("chanadmin")||t.hasPermission("owner")))return!0}catch{}return!1}function h(){if(!r.enabled&&!r.container)return g()?(r.enabled=!0,void X()):void setTimeout(h,1200)}function v(){if(r.endpoint)return r.endpoint;const t=window.BTFW_CONFIG?.ratings||{},e=[document.body?.dataset?.btfwRatingsEndpoint,t.endpoint,window.BTFW_RATINGS_ENDPOINT,window.BTFW_CONFIG?.ratingsEndpoint,window.BTFW_RATINGS_API,(()=>{try{return localStorage.getItem("btfw:ratings:endpoint")||null}catch{return null}})()].find(t=>"string"==typeof t&&t.trim().length>0);return e?(r.endpoint=e.trim().replace(/\/$/,""),r.endpoint):null}function y(t){return String(t??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function _(t){const e=String(t??"").trim();return e?/^https?:/i.test(e)||/^data:image\//i.test(e)||/^blob:/i.test(e)?e:e.startsWith("//")?`https:${e}`:"":""}function E(t){for(const e of t){const t=c(e);if(null==t)continue;const n=String(t).trim();if(n)return n}return""}function k(t){for(const e of t){const t=c(e),n=Number(t);if(Number.isFinite(n))return n}return NaN}function x(){if(i.modal?.isConnected)return i.modal;const t=document.createElement("div");return t.id="btfw-ratings-modal",t.className="modal",t.dataset.btfwModalState="closed",t.setAttribute("hidden",""),t.setAttribute("aria-hidden","true"),t.innerHTML='\n      <div class="modal-background"></div>\n      <div class="modal-card btfw-modal" role="dialog" aria-modal="true" aria-labelledby="btfw-ratings-modal-title">\n        <header class="modal-card-head">\n          <p class="modal-card-title" id="btfw-ratings-modal-title">Community Ratings</p>\n          <button class="delete" type="button" aria-label="Close"></button>\n        </header>\n        <section class="modal-card-body">\n          <div class="btfw-ratings-modal__scroll">\n            <div class="btfw-ratings-modal__loading">Loading ratings‚Ä¶</div>\n            <div class="btfw-ratings-modal__error" hidden></div>\n            <div class="btfw-ratings-modal__list" hidden aria-live="polite"></div>\n          </div>\n        </section>\n        <footer class="modal-card-foot">\n          <button type="button" class="button is-link btfw-ratings-modal__close">Close</button>\n        </footer>\n      </div>\n    ',document.body.appendChild(t),t.querySelector(".modal-background")?.addEventListener("click",F),t.querySelector(".delete")?.addEventListener("click",F),t.querySelector(".btfw-ratings-modal__close")?.addEventListener("click",F),t.addEventListener("keydown",t=>{"Escape"===t.key&&F()}),i.modal=t,i.scrollEl=t.querySelector(".btfw-ratings-modal__scroll"),i.listEl=t.querySelector(".btfw-ratings-modal__list"),i.loadingEl=t.querySelector(".btfw-ratings-modal__loading"),i.errorEl=t.querySelector(".btfw-ratings-modal__error"),t}function C(t){i.loading=!!t,i.loadingEl&&(i.loadingEl.hidden=!t),t&&i.listEl&&i.listEl.setAttribute("hidden","")}function S(t){i.errorEl&&(t?(i.errorEl.hidden=!1,i.errorEl.textContent=t):(i.errorEl.hidden=!0,i.errorEl.textContent=""))}function L(t){if(!t)return[];if(Array.isArray(t))return t;const e=["items","results","list","entries","data","movies","records","leaderboard","ratings"];for(const n of e){const e=t[n];if(Array.isArray(e))return e}if("object"==typeof t){const e=Object.values(t);if(e.length&&e.every(t=>t&&"object"==typeof t))return e}return[]}function T(t){if(!t||"object"!=typeof t)return null;const e=E([t.title,t.name,t.mediaTitle,t.displayTitle,t.media?.title,t.lookup?.title]);if(!e)return null;const n=function(t){const e=String(t||"").trim();if(!e)return{title:"",year:""};let n=e,o="",a=e.match(/(.+)\s*\((\d{4})\)/);return a&&(n=a[1].trim(),o=a[2]),o||(a=n.match(/(.+?)\s+(\d{4})\s*$/),a&&(n=a[1].trim(),o=a[2])),{title:m(n),year:o}}(e),o=Math.min(5,Math.max(0,k([t.avg,t.average,t.score,t.rating,t.mean,t.averageScore])||0)),a=Math.max(0,Math.round(k([t.votes,t.voteCount,t.count,t.totalVotes,t.ratingCount,t.total])||0)),r=E([t.posterPath,t.poster_path,t.poster,t.artwork,t.image,t.media?.poster,t.media?.posterPath,t.tmdb?.poster_path]);let i=E([t.posterUrl,t.posterURL,t.imageUrl,t.imageURL,t.art]);!i&&r&&(/^https?:/i.test(r)?i=r:r.startsWith("//")?i=`https:${r}`:r.startsWith("/")&&(i=`https://image.tmdb.org/t/p/w342${r}`));const s=_(i),l=E([t.tmdbId,t.tmdb_id,t.tmdb?.id]),c=E([t.tmdbType,t.tmdb_type,t.type,t.mediaType,t.media_type,t.tmdb?.media_type]);let d=function(t){const e=E([t?.year,t?.releaseYear,t?.release_year,t?.releaseDate,t?.release_date,t?.firstAirDate,t?.first_air_date,t?.date,t?.media?.year,t?.media?.releaseDate,t?.media?.released,t?.tmdb?.release_date,t?.tmdb?.first_air_date]);if(!e)return"";const n=e.match(/(19|20)\d{2}/);return n?n[0]:""}(t);d||(d=n.year);return{id:E([t.mediaKey,t.key,t.id,t.media?.id,t.media?.key])||e,title:e,avg:Number.isFinite(o)?o:0,votes:Number.isFinite(a)?a:0,posterUrl:s,tmdbId:l||"",tmdbType:c||"",year:d,searchTitle:n.title||m(e),searchYear:n.year||d||""}}function N(t){return t.sort((t,e)=>e.avg!==t.avg?e.avg-t.avg:e.votes!==t.votes?e.votes-t.votes:t.title.localeCompare(e.title,void 0,{sensitivity:"base"}))}function A(t,e){const n=y(t.title),o=Number(t.avg)||0,a=o?o.toFixed(2):"0.00",r=function(t){const e=Number(t),n=Number.isFinite(e)&&e>=0?e:0;let o=String(n);try{o=n.toLocaleString()}catch(t){}return`${o} vote${1===n?"":"s"}`}(t.votes),i=t.posterUrl?y(t.posterUrl):"",s=y((t.title||"?").trim().charAt(0)||"?"),l=t.year?`<span class="btfw-ratings-modal__year">(${y(t.year)})</span>`:"";return`\n      <article class="btfw-ratings-modal__item" data-index="${e}">\n        <div class="btfw-ratings-modal__poster" data-has-poster="${t.posterUrl?"true":"false"}">\n          <img src="${i}" alt="Poster for ${n}" loading="lazy" ${t.posterUrl?"":"hidden"}>\n          <div class="btfw-ratings-modal__poster-fallback"${t.posterUrl?" hidden":""} aria-hidden="true">${s}</div>\n        </div>\n        <div class="btfw-ratings-modal__details">\n          <div class="btfw-ratings-modal__title">\n            <span class="btfw-ratings-modal__rank">#${e+1}</span>\n            <span class="btfw-ratings-modal__name">${n}</span>\n            ${l}\n          </div>\n          <div class="btfw-ratings-modal__scoreline">\n            ${function(t){return`\n      <span class="btfw-ratings-modal__stars" aria-hidden="true">\n        <span class="btfw-ratings-modal__stars-base">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>\n        <span class="btfw-ratings-modal__stars-fill" style="width:${Math.min(5,Math.max(0,Number(t)||0))/5*100}%">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>\n      </span>\n    `}(o)}\n            <span class="btfw-ratings-modal__avg">${a}‚òÖ</span>\n          </div>\n          <div class="btfw-ratings-modal__votes">${y(r)}</div>\n        </div>\n      </article>\n    `}function q(t,e){if(!i.modal)return;const n=i.modal.querySelector(`.btfw-ratings-modal__item[data-index="${t}"]`);if(!n)return;const o=n.querySelector(".btfw-ratings-modal__poster");if(!o)return;const a=o.querySelector("img"),r=o.querySelector(".btfw-ratings-modal__poster-fallback");if(e){if(a){a.src=e,a.removeAttribute("hidden");const t=n.querySelector(".btfw-ratings-modal__name")?.textContent?.trim()||"movie";a.alt=`Poster for ${t}`}r&&r.setAttribute("hidden",""),o.dataset.hasPoster="true"}else a&&(a.setAttribute("hidden",""),a.removeAttribute("src")),r&&r.removeAttribute("hidden"),o.dataset.hasPoster="false"}async function M(t){if(!t||!i.tmdbKey)return null;const e=t.searchTitle||m(t.title);if(!e)return null;const n=t.searchYear||t.year||"",o=[];t.tmdbId&&o.push(`id:${String(t.tmdbId).toLowerCase()}`),o.push(`t:${e.toLowerCase()}`),n&&o.push(`y:${n}`);const a=o.join("::");if(i.tmdbCache.has(a)){return i.tmdbCache.get(a)||null}const r=i.tmdbKey,s=String(t.tmdbType||"").toLowerCase(),l=String(t.tmdbId||"").trim();if(l&&("movie"===s||"tv"===s)){const t=await async function(t,e){if(!t||!e)return null;const n="tv"===e?`tv/${t}`:"movie"===e?`movie/${t}`:"";if(!n)return null;try{const t=new URL(`https://api.themoviedb.org/3/${n}`);t.searchParams.set("api_key",r);const e=await fetch(t.toString());if(!e.ok)return null;const o=await e.json(),a=o?.poster_path;if(a)return _(`https://image.tmdb.org/t/p/w342${a}`)}catch(t){console.warn("[ratings] tmdb lookup by id failed",t)}return null}(l,s);if(t)return i.tmdbCache.set(a,t),t}const c=[];"movie"===s?c.push({path:"search/movie",type:"movie"}):("tv"===s||c.push({path:"search/movie",type:"movie"}),c.push({path:"search/tv",type:"tv"})),c.push({path:"search/multi",type:"multi"});for(const t of c)try{const o=new URL(`https://api.themoviedb.org/3/${t.path}`);o.searchParams.set("api_key",r),o.searchParams.set("include_adult","false"),o.searchParams.set("query",e),n&&("movie"!==t.type&&"multi"!==t.type||(o.searchParams.set("year",n),o.searchParams.set("primary_release_year",n)),"tv"!==t.type&&"multi"!==t.type||o.searchParams.set("first_air_date_year",n));const c=await fetch(o.toString());if(!c.ok)throw new Error(`HTTP ${c.status}`);const d=await c.json(),u=Array.isArray(d?.results)?d.results:[];let f=null;for(const e of u){if(!e||!e.poster_path)continue;const n=null!=e.id?String(e.id):"";if(l&&n===l){f=e;break}if(f||(f=e),"movie"===t.type||"tv"===t.type)break;const o=String(e.media_type||"").toLowerCase();if(s&&o===s)break;if(!s&&("movie"===o||"tv"===o))break}if(f?.poster_path){const t=_(`https://image.tmdb.org/t/p/w342${f.poster_path}`);return i.tmdbCache.set(a,t),t}}catch(t){console.warn("[ratings] tmdb lookup failed",t)}return i.tmdbCache.set(a,""),null}async function I(){const t=x();if(!v())return C(!1),S("Ratings are disabled for this channel."),void(i.listEl&&(i.listEl.innerHTML="",i.listEl.setAttribute("hidden","")));i.abortController&&i.abortController.abort();const e=new AbortController;i.abortController=e;const n=function(){try{const t=window.BTFW_CONFIG&&"object"==typeof window.BTFW_CONFIG?window.BTFW_CONFIG:{},e=t.tmdb&&"object"==typeof t.tmdb?t.tmdb:{},n="string"==typeof e.apiKey?e.apiKey.trim():"",o="string"==typeof t.tmdbKey?t.tmdbKey.trim():"";let a="";try{a=(localStorage.getItem("btfw:tmdb:key")||"").trim()}catch(t){}const r=t=>(null==t?"":String(t)).trim(),i=r(window.TMDB_API_KEY)||r(window.BTFW_TMDB_KEY)||r(window.tmdb_key),s=r(document.body?.dataset?.tmdbKey);return n||o||a||i||s||null}catch(t){return null}}();n!==i.tmdbKey&&i.tmdbCache.clear(),i.tmdbKey=n,i.loadingEl&&(i.loadingEl.textContent="Loading ratings‚Ä¶"),S(""),C(!0),i.scrollEl&&(i.scrollEl.scrollTop=0);try{const t=await async function(t){const e=v();if(!e)return[];const n=w(),o=new URLSearchParams({channel:n});o.set("limit","200"),o.set("min","1");const a=e.replace(/\/$/,""),r=["leaderboard","top","list","history",""];let i=null;for(const e of r){const n=`${e?`${a}/${e}`:a}?${o.toString()}`;try{const e=await fetch(n,{signal:t,credentials:"omit"});if(404===e.status||405===e.status)continue;if(!e.ok){const t=await e.text().catch(()=>"");throw new Error(`HTTP ${e.status} ${t}`.trim())}return N(L(await e.json()).map(t=>T(t)).filter(Boolean).filter(t=>t.votes>0))}catch(t){if("AbortError"===t?.name)throw t;i=t}}if(i)throw i;return[]}(e.signal);i.items=t,function(){const t=i.listEl;if(!t)return;const e=Array.isArray(i.items)?i.items:[],n=!!i.tmdbKey||e.some(t=>t.posterUrl);if(t.dataset.layout=n?"grid":"list",!e.length)return t.innerHTML='<div class="btfw-ratings-modal__empty">No movies have been rated yet.</div>',void t.removeAttribute("hidden");t.innerHTML=e.map((t,e)=>A(t,e)).join(""),t.removeAttribute("hidden")}(),C(!1),await async function(t){if(!i.tmdbKey)return;const e=Math.min(t.length,60);for(let n=0;n<e;n+=1){const e=t[n];if(!e||e.posterUrl)continue;const o=await M(e);if(o&&(e.posterUrl=o,q(n,o)),!i.modal||"closed"===i.modal.dataset.btfwModalState)return}}(t)}catch(t){if("AbortError"===t?.name)return;console.warn("[ratings] leaderboard fetch failed",t),C(!1),S("Unable to load rated movies right now."),i.listEl&&(i.listEl.innerHTML="",i.listEl.setAttribute("hidden",""))}finally{i.abortController===e&&(i.abortController=null)}t&&requestAnimationFrame(()=>{const e=t.querySelector(".btfw-ratings-modal__close");if(e)try{e.focus({preventScroll:!0})}catch(t){try{e.focus()}catch(t){}}})}function F(){i.abortController&&(i.abortController.abort(),i.abortController=null),i.modal&&e.closeModal(i.modal)}function $(t){let e=2166136261;for(let n=0;n<t.length;n++)e^=t.charCodeAt(n),e=Math.imul(e,16777619);return(e>>>0).toString(16)}function j(t){return String(t||"").replace(/^\s*(?:currently|now)\s*playing\s*[:\-]\s*/i,"").replace(/[\s]+/g," ").trim()}function B(t,e){Number(t?.seconds??t?.duration??t?.length??0);const n=j(t?.title||e||"");if(!n)return"";const o=function(t){const e=String(t||"").match(/(?:\(|\b)(19|20)\d{2}(?:\)|\b)(?!.*(19|20)\d{2})/);return e?e[0].replace(/[()]/g,""):""}(n),a=function(t){let e=String(t||"").toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"");return e=e.replace(/[\[\](){}:;\.,!?'"`~_|\\/+-]+/g," "),e=e.replace(/\s+/g," ").trim(),e}(o?n.replace(new RegExp(`\\(?${o}\\)?`),""):n);if(!a)return"";return`title:${$(`t:${a}|y:${o||"na"}`)}`}function O(){if(r.container?.isConnected)return r.container;!function(){if(document.getElementById("btfw-ratings-style"))return;const t=document.createElement("style");t.id="btfw-ratings-style",t.textContent='\n      #btfw-ratings-wrapper { width: 100%; }\n      #btfw-ratings { display: flex; flex-direction: row-reverse; align-items: center; align-content: center; gap: 8px; width: 100%;\n        margin: 0; padding-top: 10px; font-size: 13px; font-family: inherit; color: var(--btfw-chat-dim, rgba(222, 229, 255, .72));\n        position: relative; border-top: 0px solid rgba(255, 255, 255, .08); }\n      #btfw-ratings[hidden] { display:none !important; }\n      #btfw-ratings .btfw-ratings__header { display:flex; align-items:center; gap:8px; width:100%; }\n      #btfw-ratings .btfw-ratings__label { font-size:12px; opacity:.78; letter-spacing:.02em; text-transform:uppercase; }\n      #btfw-ratings .btfw-ratings__actions { margin-left:auto; display:flex; align-items:center; gap:4px; }\n      #btfw-ratings .btfw-ratings__actions button { display:inline-flex; align-items:center; justify-content:center; min-width:0; }\n      #btfw-ratings .btfw-ratings__stars { display:flex; align-items:center; gap:3px; }\n      #btfw-ratings .btfw-ratings__stars button { appearance:none; border:none; background:none; color:rgba(255,255,255,.32);\n        cursor:pointer; padding:0 2px; font-size:18px; line-height:1; transition:color .15s ease; }\n      #btfw-ratings[data-loading="true"] .btfw-ratings__stars button,\n      #btfw-ratings[data-disabled="true"] .btfw-ratings__stars button { cursor:default; pointer-events:none; opacity:.55; }\n      #btfw-ratings .btfw-ratings__stars button[data-active="true"],\n      #btfw-ratings .btfw-ratings__stars button:hover,\n      #btfw-ratings .btfw-ratings__stars button:focus-visible { color: var(--btfw-rating-accent, #ffd166); }\n      #btfw-ratings .btfw-ratings__meta-group { display:flex; flex-wrap:wrap; align-items:center; gap:8px; font-size:12px; opacity:.8; }\n      #btfw-ratings .btfw-ratings__meta { white-space:nowrap; }\n      #btfw-ratings .btfw-ratings__self { font-size:12px; opacity:.9; color: var(--btfw-rating-accent, #ffd166); }\n      #btfw-ratings .btfw-ratings__error { font-size:11px; color:#ff879d; }\n      #btfw-ratings .btfw-ratings__refresh,\n      #btfw-ratings .btfw-ratings__list { appearance:none; border:none; background:none; color:rgba(255,255,255,.45);\n        cursor:pointer; padding:0 4px; font-size:14px; line-height:1; transition:color .15s ease; }\n      #btfw-ratings .btfw-ratings__list { font-size:13px; }\n      #btfw-ratings .btfw-ratings__refresh:hover,\n      #btfw-ratings .btfw-ratings__refresh:focus-visible,\n      #btfw-ratings .btfw-ratings__list:hover,\n      #btfw-ratings .btfw-ratings__list:focus-visible { color:rgba(255,255,255,.82); }\n      #btfw-ratings-modal .modal-card { width: min(92vw, 960px); max-height: 90vh; display:flex; flex-direction:column; }\n      #btfw-ratings-modal .modal-card-head,\n      #btfw-ratings-modal .modal-card-foot { background: rgba(12, 14, 22, .92); color:#fff; }\n      #btfw-ratings-modal .modal-card-head { border-bottom: 1px solid rgba(255,255,255,.08); }\n      #btfw-ratings-modal .modal-card-foot { border-top: 1px solid rgba(255,255,255,.08); justify-content:flex-end; }\n      #btfw-ratings-modal .modal-card-title { font-size:1.125rem; }\n      #btfw-ratings-modal .modal-card-body { background: rgba(12, 14, 22, .88); padding: 18px; color: #f4f6ff; }\n      #btfw-ratings-modal .btfw-ratings-modal__scroll { max-height: min(70vh, 640px); overflow-y: auto; padding-right: 6px; }\n      #btfw-ratings-modal .btfw-ratings-modal__loading,\n      #btfw-ratings-modal .btfw-ratings-modal__error { font-size: 0.95rem; text-align: center; padding: 24px 12px; }\n      #btfw-ratings-modal .btfw-ratings-modal__error { color: #ff879d; }\n      #btfw-ratings-modal .btfw-ratings-modal__list { display:flex; flex-direction:column; gap:12px; }\n      #btfw-ratings-modal .btfw-ratings-modal__list[data-layout="grid"] { display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:16px; }\n      #btfw-ratings-modal .btfw-ratings-modal__item { display:flex; gap:12px; background: rgba(255,255,255,0.04); border-radius: 10px; padding:12px; color:inherit; text-decoration:none; min-height:120px; }\n      #btfw-ratings-modal .btfw-ratings-modal__list[data-layout="grid"] .btfw-ratings-modal__item { flex-direction:column; min-height:0; }\n      #btfw-ratings-modal .btfw-ratings-modal__poster { position:relative; flex:0 0 auto; width:84px; aspect-ratio:2 / 3; border-radius:8px; overflow:hidden; background: rgba(255,255,255,0.07);\n        display:flex; align-items:center; justify-content:center; font-weight:600; font-size:1.25rem; color:rgba(255,255,255,0.64); text-transform:uppercase; }\n      #btfw-ratings-modal .btfw-ratings-modal__poster img { width:100%; height:100%; object-fit:cover; display:block; }\n      #btfw-ratings-modal .btfw-ratings-modal__poster img[hidden] { display:none !important; }\n      #btfw-ratings-modal .btfw-ratings-modal__poster[data-has-poster="true"] .btfw-ratings-modal__poster-fallback { display:none !important; }\n      #btfw-ratings-modal .btfw-ratings-modal__list[data-layout="grid"] .btfw-ratings-modal__poster { width:100%; }\n      #btfw-ratings-modal .btfw-ratings-modal__details { display:flex; flex-direction:column; gap:6px; flex:1 1 auto; }\n      #btfw-ratings-modal .btfw-ratings-modal__title { font-size:1rem; font-weight:600; display:flex; align-items:center; flex-wrap:wrap; gap:6px; }\n      #btfw-ratings-modal .btfw-ratings-modal__rank { display:inline-flex; align-items:center; justify-content:center; background: rgba(255,255,255,0.12); color: var(--btfw-rating-accent, #ffd166);\n        border-radius:999px; font-size:0.75rem; padding:2px 8px; letter-spacing:0.04em; text-transform:uppercase; }\n      #btfw-ratings-modal .btfw-ratings-modal__name { flex:1 1 auto; }\n      #btfw-ratings-modal .btfw-ratings-modal__year { opacity:0.7; font-size:0.9rem; }\n      #btfw-ratings-modal .btfw-ratings-modal__scoreline { display:flex; align-items:center; gap:8px; font-size:0.95rem; }\n      #btfw-ratings-modal .btfw-ratings-modal__avg { font-weight:600; color: var(--btfw-rating-accent, #ffd166); }\n      #btfw-ratings-modal .btfw-ratings-modal__votes { font-size:0.85rem; opacity:0.85; }\n      #btfw-ratings-modal .btfw-ratings-modal__stars { position:relative; display:inline-block; font-size:0.9rem; line-height:1; letter-spacing:2px; min-width:5ch; }\n      #btfw-ratings-modal .btfw-ratings-modal__stars-base { color:rgba(255,255,255,0.18); }\n      #btfw-ratings-modal .btfw-ratings-modal__stars-fill { color:var(--btfw-rating-accent, #ffd166); position:absolute; inset:0; overflow:hidden; white-space:nowrap; }\n      #btfw-ratings-modal .btfw-ratings-modal__empty { padding:36px 12px; text-align:center; opacity:0.85; font-size:0.95rem; }\n      @media (max-width: 720px) {\n        #btfw-ratings { padding-top:6px; font-size:12px; }\n        #btfw-ratings .btfw-ratings__label { letter-spacing:0.01em; }\n        #btfw-ratings .btfw-ratings__header { flex-wrap:wrap; }\n        #btfw-ratings .btfw-ratings__actions { width:100%; justify-content:flex-start; margin-left:0; }\n        #btfw-ratings .btfw-ratings__actions button { padding:0 2px; }\n        #btfw-ratings-modal .modal-card { width:94vw; }\n      }\n    ',document.head.appendChild(t)}();const t=s("#chatwrap .btfw-chat-topbar .btfw-chat-topbar-left"),o=s("#btfw-nowplaying-slot"),i=t||o||s("#chatwrap .btfw-chat-topbar")||s("#chatwrap")||document.body;let l=i.querySelector("#btfw-ratings-wrapper");l||(l=document.createElement("div"),l.id="btfw-ratings-wrapper",l.className="btfw-ratings-wrapper",t&&o&&o.parentElement===t?o.insertAdjacentElement("afterend",l):i.appendChild(l));const c=document.createElement("div");return c.id="btfw-ratings",c.hidden=!0,c.innerHTML=`\n      <div class="btfw-ratings__header">\n        <span class="btfw-ratings__label">Rate</span>\n        <div class="btfw-ratings__actions">\n          <button type="button" class="btfw-ratings__list" title="Show rated movies" aria-label="Show rated movies">‚â£</button>\n          <button type="button" class="btfw-ratings__refresh" title="Refresh rating" aria-label="Refresh rating">‚ü≥</button>\n        </div>\n      </div>\n      <div class="btfw-ratings__stars" role="group" aria-label="Rate current media">\n        ${n.map(t=>`<button type="button" data-score="${t}" aria-label="Rate ${t} star${1===t?"":"s"}">‚òÖ</button>`).join("")}\n      </div>\n      <div class="btfw-ratings__meta-group">\n        <span class="btfw-ratings__meta" aria-live="polite"></span>\n        <span class="btfw-ratings__self" hidden></span>\n      </div>\n      <span class="btfw-ratings__error" hidden></span>\n    `,l.appendChild(c),r.container=c,r.stars=Array.from(c.querySelectorAll("button[data-score]")),r.statusNode=c.querySelector(".btfw-ratings__meta"),r.selfNode=c.querySelector(".btfw-ratings__self"),r.errorNode=c.querySelector(".btfw-ratings__error"),c.addEventListener("click",t=>{const e=t.target?.closest?.("button[data-score]");if(!e)return;const n=Number(e.dataset.score);Number.isFinite(n)&&async function(t){if(!r.currentKey||r.isSubmitting)return;const e=v();if(!e)return void U();const n=w(),o=r.currentMedia;if(!o)return;z(!0),W("");const i={channel:n,mediaKey:r.currentKey,title:o.title||r.lookup?.canonical||r.lookup?.original||"",duration:o.duration||0,userKey:V(),score:t};try{const n=await fetch(`${e}/rate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i),credentials:"omit"});if(!n.ok){const t=await n.text().catch(()=>"");throw new Error(`HTTP ${n.status}: ${t}`)}r.lastVote=t;try{localStorage.setItem(a+r.currentKey,String(t))}catch{}P(t),D(`Your rating: ${t}‚òÖ`),await J(!0)}catch(t){console.warn("[ratings] vote failed",t),W("Vote failed, try again")}finally{z(!1)}}(n)}),c.addEventListener("mousemove",t=>{const e=t.target?.closest?.("button[data-score]");if(!e)return;const n=Number(e.dataset.score);Number.isFinite(n)&&P(n)}),c.addEventListener("mouseleave",()=>P(r.lastVote||0)),c.querySelector(".btfw-ratings__list")?.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),function(){const t=x();e.openModal(t),I()}()}),c.querySelector(".btfw-ratings__refresh")?.addEventListener("click",()=>J(!0)),c}function P(t){r.stars.forEach(e=>{const n=Number(e.dataset.score);e.dataset.active=n<=t?"true":"false"})}function R(t){r.statusNode&&(r.statusNode.textContent=t||"")}function D(t){r.selfNode&&(t?(r.selfNode.hidden=!1,r.selfNode.textContent=t):(r.selfNode.hidden=!0,r.selfNode.textContent=""))}function W(t){r.errorNode&&(t?(r.errorNode.hidden=!1,r.errorNode.textContent=t):(r.errorNode.hidden=!0,r.errorNode.textContent=""))}function z(t){r.container&&(r.isSubmitting=!!t,r.container.dataset.loading=t?"true":"false")}function H(){r.container&&(r.container.hidden=!0,r.container.dataset.disabled="true")}function U(){if(!r.container)return;if(!v()||!r.currentKey||!r.currentMedia)return void H();b();const t=function(){const t=d([r.playback.duration,r.currentMedia?.duration,r.lookup?.duration,r.lookup?.seconds]);return Number.isFinite(t)&&t>0?t:NaN}(),e=function(t){const e=u([r.playback.currentTime,r.currentMedia?.currentTime]);return!Number.isFinite(e)||e<0?NaN:Number.isFinite(t)&&t>0?Math.min(e,t):e}(t);!function(t,e){return!(!Number.isFinite(t)||!Number.isFinite(e))&&(!(t<3600)&&t-e<=901)}(t,e)?H():function(){if(r.container){if(r.container.hidden=!1,r.container.dataset.disabled="false",r.stats&&"number"==typeof r.stats.avg){const t=r.stats.avg,e=r.stats.votes||0;R(e>0?`${t.toFixed(2)}‚òÖ (${e} vote${1===e?"":"s"})`:"No ratings yet")}else R("No ratings yet");r.lastVote?(D(`Your rating: ${r.lastVote}‚òÖ`),P(r.lastVote)):(D(""),P(0))}}()}function G(t){if(t?.detail){if(r.lookup={...t.detail},!r.currentMedia&&r.lookup?.original){const t=j(r.lookup.original),e=B({title:t,seconds:0},t);r.currentMedia={key:e,title:t,duration:0,provider:"",id:""},r.currentKey=r.currentMedia.key}U()}}function K(){return function(){try{return l()?.name||""}catch{return""}}()||function(){try{let t=localStorage.getItem(o);if(t&&t.length>=8)return t;const e=new Uint8Array(12);return(window.crypto||window.msCrypto).getRandomValues(e),t=Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join(""),localStorage.setItem(o,t),t}catch{return"anon"+Math.random().toString(36).slice(2,8)}}()}function V(){return`u_${$(`${w()}::${K()}`)}`}async function J(t){if(!r.currentKey)return;const e=v();if(!e)return void U();const n=Date.now();if(!t&&n-r.lastStatsRequest<400)return;r.lastStatsRequest=n;const o=w(),i=new URLSearchParams({channel:o,mediaKey:r.currentKey});try{i.set("userKey",V())}catch{}const s=`${e}/stats?${i.toString()}`;try{const t=await fetch(s,{credentials:"omit"});if(!t.ok)throw new Error(`HTTP ${t.status}`);const e=await t.json(),n=Number(e?.userScore);if(r.stats={avg:Number(e?.avg)||0,votes:Number(e?.votes)||0,user:Number.isFinite(n)?n:null},r.stats.user){r.lastVote=r.stats.user;try{localStorage.setItem(a+r.currentKey,String(r.lastVote))}catch{}}else try{const t=Number(localStorage.getItem(a+r.currentKey));Number.isFinite(t)&&t>=1&&t<=5&&(r.lastVote=t)}catch{}W("")}catch(t){console.warn("[ratings] stats fetch failed",t),W("Stats unavailable");try{const t=Number(localStorage.getItem(a+r.currentKey));Number.isFinite(t)&&t>=1&&t<=5&&(r.lastVote=t)}catch{}}U(),r.statsTimer&&(clearTimeout(r.statsTimer),r.statsTimer=null),r.statsTimer=setTimeout(()=>J(!1),2e4)}function Y(t){p(),r.statsTimer&&(clearTimeout(r.statsTimer),r.statsTimer=null);const e=function(t){if(!t||"object"!=typeof t)return null;const e=r.lookup?.canonical||r.lookup?.query||r.lookup?.original||"",n=j(t.title||e||""),o=Number(t.seconds??t.duration??t.length??0)||0,a=Number(t.currentTime??t.time??t.position??0)||0,i=B(t,n||e);return i?{key:i,title:n,duration:o,currentTime:a,provider:(t.type||t.mediaType||t.provider||"").toString().trim(),id:(t.id||t.videoId||t.vid||t.uid||"").toString().trim()}:null}(t);if(!e)return r.currentMedia=null,r.currentKey="",r.stats=null,r.lastVote=null,r.playback.currentTime=0,r.playback.duration=0,D(""),P(0),void U();r.currentMedia=e,r.currentKey=e.key,r.stats=null,r.lastVote=null,r.playback.currentTime=Number(e.currentTime)||0,r.playback.duration=Number(e.duration)||0,r.playback.lastUpdate=Date.now(),D(""),P(0),b(),U(),J(!0),function(){if(p(),!r.currentMedia)return;const t=()=>{r.currentMedia?(U(),r.playbackTimer=setTimeout(t,5e3)):p()};r.playbackTimer=setTimeout(t,5e3)}()}function Q(t){if(!t)return;if(t.title&&r.currentMedia&&(r.currentMedia.title=j(t.title)),r.currentMedia){const e=d([Number(t.seconds),Number(t.duration),Number(t.length),r.currentMedia.duration,r.playback.duration]);Number.isFinite(e)&&e>0&&(r.currentMedia.duration=e,r.playback.duration=e)}const e=u([Number(t.currentTime),Number(t.time),Number(t.position),r.playback.currentTime]);Number.isFinite(e)&&e>=0&&(r.playback.currentTime=e,r.playback.lastUpdate=Date.now(),r.currentMedia&&(r.currentMedia.currentTime=e)),U()}function X(){if(!O())return void setTimeout(X,800);!function(){if(!r.announcedStart){r.announcedStart=!0;try{const t=window.BTFW_notify;t&&"function"==typeof t.info?t.info({title:"Movie rating has started"}):t&&"function"==typeof t.notify&&t.notify({title:"Movie rating has started",kind:"info"})}catch(t){}}}(),U(),function(){const t=window.socket;if(t&&"function"==typeof t.on)try{t.on("changeMedia",Y),t.on("setCurrent",Y),t.on("mediaUpdate",Q)}catch(t){console.warn("[ratings] failed to bind socket handlers",t)}}(),function(){try{if(window.Callbacks&&"function"==typeof window.Callbacks.changeMedia){const t=window.Callbacks.changeMedia;window.Callbacks.changeMedia=function(e){try{Y(e)}catch{}return t.apply(this,arguments)}}}catch(t){console.warn("[ratings] unable to wrap Callbacks.changeMedia",t)}}(),document.addEventListener("btfw:nowplayingLookup",G,{passive:!0});const t=window.socket;if(t&&t.connected)try{t.emit("playerReady")}catch{}}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",h):h(),{name:"feature:ratings",refresh:()=>J(!0)}});