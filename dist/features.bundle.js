BTFW.define("feature:channels",[],async () =>{const $ = (s,r = document) => r.querySelector(s);function resolveSliderSettings(){try{const global = window.BTFW ||{};const theme = global.channelTheme ||{};const slider = theme.slider ||{};let enabled = slider.enabled;let url = slider.feedUrl || slider.url || slider.json || '';if (typeof enabled === 'undefined' && typeof theme.sliderEnabled !== 'undefined'){enabled = theme.sliderEnabled;}if (!url){url = theme.sliderJson || theme.sliderJSON || '';}if (typeof enabled === 'undefined' && global.channelSlider){enabled = global.channelSlider.enabled;if (!url) url = global.channelSlider.feedUrl || '';}if (typeof enabled === 'undefined' && typeof global.channelSliderEnabled !== 'undefined'){enabled = global.channelSliderEnabled;}if (!url && global.channelSliderJSON){url = global.channelSliderJSON;}if (typeof enabled === 'undefined' && typeof window.UI_ChannelList !== 'undefined'){enabled = window.UI_ChannelList === '1' || window.UI_ChannelList === 1;}if (!url && typeof window.Channel_JSON !== 'undefined'){url = window.Channel_JSON || '';}if (typeof enabled === 'undefined' && url){enabled = true;}return{enabled:Boolean(enabled),url:url || ''};}catch (_){return{enabled:false,url:''};}}function isChannelListEnabled(){return resolveSliderSettings().enabled;}function getChannelJSON(){return resolveSliderSettings().url || '';}function createChannelSlider(channels){const slider = document.createElement('section');slider.className = 'btfw-channels';slider.id = 'btfw-channels';slider.dataset.title = 'Featured Channels';const prev = document.createElement('button');prev.type = 'button';prev.className = 'btfw-channels__arrow btfw-channels__arrow--prev';prev.setAttribute('aria-label','Scroll featured channels left');prev.innerHTML = '<span aria-hidden="true">â€¹</span>';const next = document.createElement('button');next.type = 'button';next.className = 'btfw-channels__arrow btfw-channels__arrow--next';next.setAttribute('aria-label','Scroll featured channels right');next.innerHTML = '<span aria-hidden="true">â€º</span>';const viewport = document.createElement('div');viewport.className = 'btfw-channels__viewport';viewport.id = 'btfw-carousel';const track = document.createElement('div');track.className = 'btfw-channels__track';viewport.appendChild(track);if (channels.length === 0){const empty = document.createElement('div');empty.className = 'btfw-channels__empty';empty.textContent = 'No channels available';track.appendChild(empty);}else{channels.forEach((channel,index) =>{const item = document.createElement('article');item.className = 'btfw-channels__item';item.dataset.index = String(index);const link = document.createElement('a');link.href = channel.channel_url || '#';link.target = '_blank';link.rel = 'noopener noreferrer';link.className = 'btfw-channels__link';link.title = channel.title || channel.channel_url;const media = document.createElement('div');media.className = 'btfw-channels__media';const img = document.createElement('img');img.className = 'btfw-channels__thumb';img.src = channel.image_url;img.alt = channel.title || 'Channel thumbnail';img.loading = 'lazy';img.onerror = function(){this.classList.add('is-missing');};media.appendChild(img);const label = document.createElement('span');label.className = 'btfw-channels__label';label.textContent = channel.title || channel.channel_url || 'Channel';link.appendChild(media);link.appendChild(label);item.appendChild(link);track.appendChild(item);});}slider.appendChild(prev);slider.appendChild(viewport);slider.appendChild(next);return slider;}function injectChannelCSS(){if (document.getElementById('btfw-channels-css')) return;const style = document.createElement('style');style.id = 'btfw-channels-css';style.textContent = ` .btfw-channels{position:relative;margin-top:10px;border-radius:16px;border:1px solid rgba(109,77,246,0.22);border:1px solid color-mix(in srgb,var(--btfw-theme-accent,#6d4df6) 28%,transparent 72%);background:rgba(12,18,34,0.92);background:linear-gradient(135deg,color-mix(in srgb,var(--btfw-theme-surface,#0b111d) 94%,transparent 6%),color-mix(in srgb,var(--btfw-theme-panel,#141f36) 86%,black 14%));padding:10px 30px;display:flex;align-items:center;gap:14px;width:100%;color:var(--btfw-theme-text,#e8ecfb);}.btfw-channels__viewport{flex:1 1 auto;overflow:hidden;touch-action:pan-y;}.btfw-channels__track{display:flex;gap:16px;transition:transform 0.3s ease;will-change:transform;}.btfw-channels__item{flex:0 0 clamp(160px,18vw,220px);max-width:clamp(160px,18vw,220px);}.btfw-channels__link{display:flex;flex-direction:column;gap:8px;text-decoration:none;color:color-mix(in srgb,var(--btfw-theme-text,#e8ecfb) 96%,transparent 4%);background:var(--btfw-theme-surface,#0b111d);background:color-mix(in srgb,var(--btfw-theme-surface,#0b111d) 88%,transparent 12%);border-radius:12px;border:1px solid color-mix(in srgb,var(--btfw-theme-accent,#6d4df6) 22%,transparent 78%);overflow:hidden;box-shadow:0 14px 30px color-mix(in srgb,var(--btfw-theme-panel,#141f36) 28%,transparent 72%);transition:transform 0.18s ease,box-shadow 0.18s ease,border-color 0.18s ease,background 0.18s ease;cursor:grab;user-select:none;}.btfw-channels__link:hover,.btfw-channels__link:focus{transform:translateY(-4px);border-color:color-mix(in srgb,var(--btfw-theme-accent,#6d4df6) 70%,white 30%);background:color-mix(in srgb,var(--btfw-theme-panel,#141f36) 82%,var(--btfw-theme-accent,#6d4df6) 18%);box-shadow:0 18px 36px color-mix(in srgb,var(--btfw-theme-accent,#6d4df6) 35%,transparent 65%);}.btfw-channels__media{position:relative;width:100%;aspect-ratio:16 / 6;overflow:hidden;background:var(--btfw-theme-panel,#141f36);background:color-mix(in srgb,var(--btfw-theme-panel,#141f36) 88%,black 12%);}.btfw-channels__thumb{width:100%;height:100%;object-fit:cover;display:block;transition:transform 0.2s ease;}.btfw-channels__thumb.is-missing{opacity:0.45;object-fit:contain;}.btfw-channels__link:hover .btfw-channels__thumb{transform:scale(1.05);}.btfw-channels__label{padding:10px 12px 14px;font-weight:600;letter-spacing:0.01em;font-size:14px;color:color-mix(in srgb,var(--btfw-theme-text,#e6edf3) 92%,transparent 8%);text-overflow:ellipsis;overflow:hidden;white-space:nowrap;}.btfw-channels__arrow{width:38px;height:38px;border-radius:50%;border:0;display:inline-flex;align-items:center;justify-content:center;background:color-mix(in srgb,var(--btfw-theme-accent,#6d4df6) 18%,rgba(255,255,255,0.08) 82%);color:color-mix(in srgb,var(--btfw-theme-text,#e6edf3) 98%,transparent 2%);font-size:20px;cursor:pointer;transition:background 0.2s ease,transform 0.2s ease,box-shadow 0.2s ease;}.btfw-channels__arrow:hover:not([disabled]){background:color-mix(in srgb,var(--btfw-theme-accent,#6d4df6) 65%,white 35%);box-shadow:0 12px 24px color-mix(in srgb,var(--btfw-theme-accent,#6d4df6) 30%,transparent 70%);transform:translateY(-2px);}.btfw-channels__arrow[disabled]{opacity:0.4;cursor:default;pointer-events:none;}.btfw-channels--dragging .btfw-channels__link{cursor:grabbing;}.btfw-channels__empty{padding:24px;color:color-mix(in srgb,var(--btfw-theme-text,#e6edf3) 80%,transparent 20%);font-size:15px;width:100%;text-align:center;}.btfw-channels--no-scroll .btfw-channels__arrow{display:none;}@media (max-width:960px){.btfw-channels{padding:16px 44px;}.btfw-channels__item{flex-basis:190px;}}@media (max-width:768px){.btfw-channels{padding:14px 38px;gap:10px;}.btfw-channels__item{flex-basis:170px;}.btfw-channels__label{font-size:13px;}.btfw-channels__arrow{width:34px;height:34px;font-size:18px;}}@media (max-width:600px){.btfw-channels{padding:12px 32px;}.btfw-channels__item{flex-basis:150px;}}`;document.head.appendChild(style);}async function fetchChannelData(jsonUrl){try{const response = await fetch(jsonUrl);if (!response.ok) throw new Error(`HTTP ${response.status}`);const data = await response.json();if (data.list && data.list.channels && Array.isArray(data.list.channels)){return data.list.channels;}else if (data.channels && Array.isArray(data.channels)){return data.channels;}else if (Array.isArray(data)){return data;}return [];}catch (error){return [];}}function setupCarouselControls(slider,channels){if (!slider || slider._btfwCarouselWired) return;if (!channels || channels.length === 0){slider.classList.add('btfw-channels--no-scroll');return;}slider._btfwCarouselWired = true;const viewport = slider.querySelector('.btfw-channels__viewport');const track = slider.querySelector('.btfw-channels__track');const leftBtn = slider.querySelector('.btfw-channels__arrow--prev');const rightBtn = slider.querySelector('.btfw-channels__arrow--next');if (!viewport || !track) return;const items = Array.from(track.children);if (!items.length){slider.classList.add('btfw-channels--no-scroll');return;}let currentIndex = 0;let itemWidth = 0;let gap = 0;let autoTimer = null;const cleanup = () =>{if (slider._btfwCleanup) slider._btfwCleanup();slider._btfwCleanup = () =>{if (autoTimer) clearInterval(autoTimer);window.removeEventListener('resize',measure);};};const stopAuto = () =>{if (autoTimer){clearInterval(autoTimer);autoTimer = null;}};const startAuto = () =>{stopAuto();if (channels.length <= 1) return;autoTimer = setInterval(() =>{const max = getMaxIndex();if (max <= 0) return;currentIndex = currentIndex >= max ? 0:currentIndex + 1;scrollToIndex(currentIndex);},48000);};function measure(){const first = items.find(el => el.getBoundingClientRect().width > 0);if (!first){itemWidth = 0;gap = 0;return;}const rect = first.getBoundingClientRect();itemWidth = rect.width;const style = window.getComputedStyle(track);const parsedGap = parseFloat(style.columnGap || style.gap || '0');gap = Number.isFinite(parsedGap) ? parsedGap:0;updateArrows();}function getMaxIndex(){if (!itemWidth) return 0;const visible = Math.max(1,Math.floor((viewport.clientWidth + gap) / (itemWidth + gap)));return Math.max(0,items.length - visible);}function updateArrows(){const max = getMaxIndex();if (leftBtn) leftBtn.disabled = currentIndex <= 0;if (rightBtn) rightBtn.disabled = currentIndex >= max;slider.classList.toggle('btfw-channels--no-scroll',max <= 0);}function scrollToIndex(index,behavior = 'smooth'){const max = getMaxIndex();currentIndex = Math.min(Math.max(index,0),max);viewport.scrollTo({left:(itemWidth + gap) * currentIndex,behavior});updateArrows();}if (leftBtn){leftBtn.addEventListener('click',() =>{stopAuto();scrollToIndex(currentIndex - 1);startAuto();});}if (rightBtn){rightBtn.addEventListener('click',() =>{stopAuto();scrollToIndex(currentIndex + 1);startAuto();});}viewport.addEventListener('scroll',() =>{if (!itemWidth) return;const newIndex = Math.round(viewport.scrollLeft / (itemWidth + gap));if (!Number.isNaN(newIndex)){currentIndex = newIndex;updateArrows();}});slider.addEventListener('mouseenter',stopAuto);slider.addEventListener('mouseleave',startAuto);window.addEventListener('resize',measure);measure();requestAnimationFrame(measure);startAuto();slider._btfwRecalc = () =>{measure();updateArrows();};cleanup();}function placeSliderInStack(slider){const stackBody = document.querySelector('#btfw-stack .btfw-stack-item[data-bind="channels-group"] .btfw-stack-item__body');if (!stackBody) return false;if (slider.parentElement !== stackBody) stackBody.appendChild(slider);slider._btfwRecalc && slider._btfwRecalc();return true;}function scheduleStackPlacement(slider){if (placeSliderInStack(slider)) return;let attempts = 0;const iv = setInterval(() =>{attempts += 1;if (placeSliderInStack(slider) || attempts > 10) clearInterval(iv);},400);}function removeExistingSliders(){document.querySelectorAll('#btfw-channels').forEach(existing =>{if (typeof existing._btfwCleanup === 'function'){try{existing._btfwCleanup();}catch(_){}}try{existing.remove();}catch(_){}});}function injectChannelSlider(channels){removeExistingSliders();const slider = createChannelSlider(channels);const videowrap = document.getElementById('videowrap');const leftpad = document.getElementById('btfw-leftpad');let inserted = false;if (placeSliderInStack(slider)){inserted = true;}else if (videowrap && leftpad && leftpad.contains(videowrap)){leftpad.insertBefore(slider,videowrap.nextSibling);inserted = true;}else if (leftpad){leftpad.appendChild(slider);inserted = true;}if (!inserted){document.body.appendChild(slider);}scheduleStackPlacement(slider);setTimeout(() =>{setupCarouselControls(slider,channels);slider._btfwRecalc && slider._btfwRecalc();},150);}async function initializeChannels(){removeExistingSliders();if (!isChannelListEnabled()){return;}const jsonUrl = getChannelJSON();if (!jsonUrl){return;}const channels = await fetchChannelData(jsonUrl);if (channels.length === 0){injectChannelCSS();injectChannelSlider([]);return;}injectChannelCSS();injectChannelSlider(channels);}function boot(){setTimeout(initializeChannels,500);setTimeout(initializeChannels,1500);setTimeout(initializeChannels,3000);document.addEventListener('btfw:layoutReady',() =>{setTimeout(initializeChannels,300);});let themeTimer = null;const scheduleThemeSync = () =>{if (themeTimer) clearTimeout(themeTimer);themeTimer = setTimeout(() =>{themeTimer = null;initializeChannels();},120);};document.addEventListener('btfw:channelThemeTint',scheduleThemeSync);}if (document.readyState === 'loading'){document.addEventListener('DOMContentLoaded',boot);}else{boot();}return{name:'feature:channels',initialize:initializeChannels,isEnabled:isChannelListEnabled};});BTFW.define("feature:footer",[],async () =>{const $ = (selector,root = document) => root.querySelector(selector);const $$ = (selector,root = document) => Array.from(root.querySelectorAll(selector));const BRANDING_HTML = ` <div class="btfw-footer-branding__content"> <div class="btfw-footer-branding__disclaimer"> <p> The author is not responsible for any contents linked or referred to from these pages. All CyTu.be does is link or embed content that was uploaded to popular Online Video hosting sites like Youtube.com / Google Drive. All Google users signed a contract with the sites when they set up their accounts which forces them not to upload illegal content. (<a href="https://www.lumendatabase.org/topics/14" target="_blank" rel="noopener">DMCA Safe Harbor</a>) </p> </div> <div class="btfw-footer-branding__credit"> <h4> <span>BillTube Framework</span> <a href="http://discord.gg/fwadWd9" target="_blank" rel="noopener">Available Now</a> </h4> </div> </div> `;let styleInjected = false;function ensureStyles(){if (styleInjected) return;styleInjected = true;const style = document.createElement("style");style.id = "btfw-footer-styles";style.textContent = ` #btfw-footer,.btfw-footer{width:100%;}.btfw-footer__inner{display:flex;flex-direction:column;gap:2rem;padding:1.5rem 1rem 3rem;color:rgba(255,255,255,0.85);}.btfw-footer__auth{display:flex;flex-wrap:wrap;gap:0.75rem;align-items:center;justify-content:center;}.btfw-footer__form{display:inline-flex !important;gap:0.35rem;align-items:center;}.btfw-footer-branding{border-top:1px solid rgba(255,255,255,0.12);padding-top:1.25rem;font-size:0.85rem;background:rgba(5,6,13,0.35);border-radius:12px;}.btfw-footer-branding__disclaimer{margin-bottom:1rem;opacity:0.8;}.btfw-footer-branding__disclaimer p{margin:0;text-align:center;line-height:1.5;}.btfw-footer-branding__disclaimer a,.btfw-footer-branding__credit a{color:var(--btfw-color-accent,#6d4df6);text-decoration:none;font-weight:600;}.btfw-footer-branding__disclaimer a:hover,.btfw-footer-branding__credit a:hover{text-decoration:underline;}.btfw-footer-branding__credit{text-align:center;}.btfw-footer-branding__credit h4{margin:0;font-size:1rem;font-weight:600;display:flex;flex-direction:column;gap:0.35rem;}@media (min-width:640px){.btfw-footer__auth{justify-content:flex-end;}.btfw-footer__inner{padding-inline:2.5rem;}}@media (max-width:640px){.btfw-footer-branding{font-size:0.8rem;}}`;document.head.appendChild(style);}function ensureFooterSlot(){const stackContainer = document.getElementById("btfw-stack-footer");if (stackContainer){const stray = document.getElementById("btfw-footer");const strayChildren = [];if (stray && stray !== stackContainer && !stackContainer.contains(stray)){while (stray.firstChild){strayChildren.push(stray.firstChild);}stray.remove();}let host = stackContainer.querySelector("#btfw-footer") || stackContainer.querySelector(".btfw-footer");if (!host){host = document.createElement("div");host.id = "btfw-footer";host.className = "btfw-footer";stackContainer.appendChild(host);}else{host.id = "btfw-footer";host.classList.add("btfw-footer");}strayChildren.forEach(node => host.appendChild(node));stackContainer.querySelectorAll("#btfw-footer ~ .btfw-footer,#btfw-footer ~ #btfw-footer").forEach(extra =>{if (extra === host) return;while (extra.firstChild) host.appendChild(extra.firstChild);extra.remove();});host.classList.remove("btfw-footer--standalone");return host;}let host = $("#btfw-footer") || $(".btfw-footer");if (!host){host = document.createElement("div");host.id = "btfw-footer";host.className = "btfw-footer";const stack = $("#btfw-content-stack") || $("#mainpage") || $("#main") || document.body;stack.appendChild(host);}return host;}function ensureFooterInner(){const slot = ensureFooterSlot();if (!slot) return null;let inner = slot.querySelector(".btfw-footer__inner");if (!inner){inner = document.createElement("div");inner.className = "btfw-footer__inner";slot.appendChild(inner);}return inner;}function ensureAuthWrap(){const inner = ensureFooterInner();if (!inner) return null;let wrap = inner.querySelector(".btfw-footer__auth");if (!wrap){wrap = document.createElement("div");wrap.className = "btfw-footer__auth";inner.prepend(wrap);}return wrap;}function ensureBrandingBlock(){const inner = ensureFooterInner();if (!inner) return null;let block = inner.querySelector(".btfw-footer-branding");if (!block){block = document.createElement("div");block.className = "btfw-footer-branding";block.innerHTML = BRANDING_HTML;inner.appendChild(block);}return block;}function moveForms(){const wrap = ensureAuthWrap();if (!wrap) return;["#logoutform","#loginform"].forEach(selector =>{$$(selector).forEach(form =>{if (!wrap.contains(form)){form.classList.remove("navbar-text","pull-right");form.classList.add("btfw-footer__form");form.style.margin = "0";form.style.display = "inline-flex";wrap.appendChild(form);}});});}function insertBranding(){ensureBrandingBlock();}function removeLegacyFooter(){document.querySelectorAll("footer#footer").forEach(legacy =>{if (legacy && legacy.isConnected){legacy.remove();}});}function maintainFooter(){ensureStyles();moveForms();insertBranding();removeLegacyFooter();}function boot(){maintainFooter();if (!document._btfwFooterObserver){const observer = new MutationObserver(() => maintainFooter());observer.observe(document.body,{childList:true,subtree:true});document._btfwFooterObserver = observer;}}if (document.readyState === "loading"){document.addEventListener("DOMContentLoaded",boot);}else{boot();}document.addEventListener("btfw:ready",() => removeLegacyFooter(),{once:true});return{name:"feature:footer",moveForms,insertBranding,removeLegacyFooter};});BTFW.define("feature:navbar",[],async () =>{const $ = (s,r=document)=>r.querySelector(s);const MOBILE_BREAKPOINT = 768;let mobileNavActive = false;let mobileNavHandlersBound = false;let lastMobileDispatch ={open:null,mobile:null};function getUserName(){try{return (window.CLIENT && CLIENT.name) ? CLIENT.name:"";}catch(_){return "";}}function findUserlistItem(name){if (!name) return null;const byData = document.querySelector(`#userlist li[data-name="${CSS.escape(name)}"]`);if (byData) return byData;const items = document.querySelectorAll("#userlist li,#userlist .userlist_item,#userlist .user");for (const el of items){const t = (el.textContent || "").trim();if (t && t.replace(/\s+/g,"").toLowerCase().startsWith(name.toLowerCase())) return el;}return null;}function getProfileImgFromUserlist(name){try{const li = findUserlistItem(name);if (!li || !window.jQuery) return "";const $li = window.jQuery(li);const prof = $li.data && $li.data("profile");const img = prof && prof.image;return img || "";}catch(_){return "";}}function getCyTubeAvatar(){try{return (window.USEROPTS && USEROPTS.avatar) ? USEROPTS.avatar:"";}catch(_){return "";}}function initialsDataURL(name,sizePx){const colors = ["#1abc9c","#16a085","#f1c40f","#f39c12","#2ecc71","#27ae60","#e67e22","#d35400","#3498db","#2980b9","#e74c3c","#c0392b","#9b59b6","#8e44ad","#0080a5","#34495e","#2c3e50"];const seed = (name||"?").codePointAt(0) || 63;const bg = colors[seed % colors.length];const letters = (name||"?").trim().slice(0,2).toUpperCase() || "?";const sz = sizePx || 28;const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${sz}" height="${sz}"> <rect width="100%" height="100%" rx="${Math.round(sz*0.2)}" fill="${bg}"/> <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#fff" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="${Math.round(sz*0.5)}">${letters}</text> </svg>`;return "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svg)));}function findNavList(){const themeBtn = document.getElementById("btfw-theme-btn-nav");if (themeBtn){const ul = themeBtn.closest("ul");if (ul) return ul;}return document.querySelector(".navbar .nav.navbar-nav") || document.querySelector(".navbar-nav") || document.querySelector(".navbar .navbar-end ul") || document.querySelector(".btfw-navbar ul") || document.querySelector(".navbar ul");}function styleThemeButton(btn){if (!btn) return;btn.id = "btfw-theme-btn-nav";btn.classList.add("btfw-nav-pill");btn.classList.remove("button","is-dark","is-small","btn","btn-default","is-primary");if (btn.tagName === "BUTTON" && !btn.hasAttribute("type")){btn.type = "button";}if (!btn.getAttribute("aria-label")){btn.setAttribute("aria-label","Theme settings");}}function ensureThemeButtonHook(){const existing = document.getElementById("btfw-theme-btn-nav");if (existing){styleThemeButton(existing);return;}const navUL = findNavList();if (!navUL) return;let btn = navUL.querySelector(".fa-sliders,.fa-sliders-h,.fa-sliders-simple,.fa-sliders-h::before");if (btn){const a = btn.closest("a,button");if (a){styleThemeButton(a);return;}}const li = document.createElement("li");const a = document.createElement("a");a.innerHTML = ` <span class="btfw-nav-pill__icon" aria-hidden="true"><i class="fa fa-sliders"></i></span> <span class="btfw-nav-pill__label">Theme</span> `;a.href = "javascript:void(0)";styleThemeButton(a);li.appendChild(a);navUL.appendChild(li);}function buildAvatarElement(name){const size = 28;let src = name ? (getProfileImgFromUserlist(name) || getCyTubeAvatar() || ""):"";if (!src) src = initialsDataURL(name || "Guest",size);const a = document.createElement("a");a.href = name ? "/account/profile":"/login";a.target = "_blank";a.className = "btfw-nav-avatar-link";a.title = name ? name:"Sign in";const img = document.createElement("img");img.id = "btfw-useravatar";img.className = "btfw-nav-avatar";img.src = src;img.alt = name || "guest";img.width = size;img.height = size;a.appendChild(img);return a;}function renderAvatar(){const navUL = findNavList();if (!navUL) return;let li = document.getElementById("btfw-nav-avatar-item");if (!li){li = document.createElement("li");li.id = "btfw-nav-avatar-item";li.className = "btfw-nav-avatar-item";navUL.appendChild(li);}else{li.innerHTML = "";}li.appendChild(buildAvatarElement(getUserName()));}function pruneNavLinks(){const navUL = findNavList();if (!navUL) return;Array.from(navUL.querySelectorAll("li")).forEach(li =>{const link = li.querySelector("a");if (!link) return;const label = (link.textContent || "").trim().toLowerCase();const href = (link.getAttribute("href") || "").trim();const isHome = label === "home" || href === "/";const isLayout = label === "layout" || /layout/i.test(link.dataset?.target || "");if (isHome || isLayout){li.remove();}});}function refresh(){pruneNavLinks();renderAvatar();setupMobileNav();}function isMobileNavOpen(){const host = document.getElementById("btfw-navhost");if (!host) return false;return host.getAttribute("data-mobile-open") === "true";}function dispatchMobileState(open){const host = document.getElementById("btfw-navhost");const mobile = host?.classList.contains("btfw-navhost--mobile") || false;if (lastMobileDispatch.open === open && lastMobileDispatch.mobile === mobile) return;lastMobileDispatch ={open,mobile};document.dispatchEvent(new CustomEvent("btfw:navbar:mobileState",{detail:{open,mobile}}));}function setMobileNavOpen(open){const host = document.getElementById("btfw-navhost");if (!host) return;const value = open ? "true":"false";const prev = host.getAttribute("data-mobile-open");if (prev !== value){host.setAttribute("data-mobile-open",value);}const isMobile = host.classList.contains("btfw-navhost--mobile");if (document.body){if (isMobile && open) document.body.classList.add("btfw-mobile-nav-open");else document.body.classList.remove("btfw-mobile-nav-open");}dispatchMobileState(open);}function ensureMobileCloseButton(){const host = document.getElementById("btfw-navhost");if (!host) return;const nav = host.querySelector(":is(nav.navbar,.navbar,#navbar,.navbar-fixed-top)");if (!nav) return;let btn = document.getElementById("btfw-mobile-nav-close");if (btn && btn.closest(":is(nav.navbar,.navbar,#navbar,.navbar-fixed-top)") !== nav){btn.remove();btn = null;}if (!btn){btn = document.createElement("button");btn.type = "button";btn.id = "btfw-mobile-nav-close";btn.className = "btfw-mobile-nav-close";btn.setAttribute("aria-label","Close navigation menu");btn.innerHTML = "<span aria-hidden=\"true\">&times;</span>";btn.addEventListener("click",(ev) =>{ev.preventDefault();ev.stopPropagation();setMobileNavOpen(false);});nav.insertBefore(btn,nav.firstChild);}}function toggleMobileNav(){const host = document.getElementById("btfw-navhost");if (!host) return;if (!host.classList.contains("btfw-navhost--mobile")){setMobileNavOpen(true);return;}setMobileNavOpen(!isMobileNavOpen());}function updateMobileNavState(){const host = document.getElementById("btfw-navhost");if (!host) return;const wasMobile = host.classList.contains("btfw-navhost--mobile");const shouldEnable = window.innerWidth <= MOBILE_BREAKPOINT;host.classList.toggle("btfw-navhost--mobile",shouldEnable);if (shouldEnable){if (!mobileNavActive || !wasMobile){mobileNavActive = true;setMobileNavOpen(false);}else{setMobileNavOpen(isMobileNavOpen());}}else{mobileNavActive = false;setMobileNavOpen(true);}}function setupMobileNav(){const host = document.getElementById("btfw-navhost");if (!host) return;ensureMobileCloseButton();updateMobileNavState();if (mobileNavHandlersBound) return;mobileNavHandlersBound = true;window.addEventListener("resize",() => updateMobileNavState());host.addEventListener("click",(ev) =>{if (window.innerWidth > MOBILE_BREAKPOINT) return;const target = ev.target.closest?.('#btfw-navhost a,#btfw-navhost button');if (!target) return;setMobileNavOpen(false);},true);}document._btfw_nav_setMobileOpen = setMobileNavOpen;document._btfw_nav_toggleMobile = toggleMobileNav;document._btfw_nav_isMobileOpen = isMobileNavOpen;// ---------- Boot ---------- function boot(){ensureThemeButtonHook();pruneNavLinks();renderAvatar();setupMobileNav();const userlist = $("#userlist");if (userlist && !userlist._btfwNavMO){const mo = new MutationObserver(()=> refresh());mo.observe(userlist,{childList:true,subtree:true});userlist._btfwNavMO = mo;}try{if (window.socket && socket.on){socket.on("login",refresh);socket.on("logout",refresh);socket.on("setProfile",refresh);socket.on("userlist",refresh);}}catch(_){}let tries = 0;const t = setInterval(()=>{tries++;const navUL = findNavList();if (navUL){ensureThemeButtonHook();pruneNavLinks();renderAvatar();setupMobileNav();}if (tries > 10 || navUL) clearInterval(t);},300);}if (document.readyState === "loading") document.addEventListener("DOMContentLoaded",boot);else boot();return{name:"feature:navbar",refresh};});BTFW.define("feature:modal-skin",[],async () =>{const $ = (s,r=document)=>r.querySelector(s);const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));function restyleButtons(root){const map = [ ["btn-primary","is-link"],["btn-danger","is-danger"],["btn-warning","is-warning"],["btn-success","is-success"],["btn-info","is-info"],["btn-default","is-dark"] ];root.querySelectorAll(".btn").forEach(btn=>{btn.classList.add("button","is-small");btn.classList.remove("btn","btn-lg","btn-sm","btn-xs");let mapped=false;for (const [bs,bul] of map){if (btn.classList.contains(bs)){btn.classList.remove(bs);btn.classList.add(bul);mapped=true;}}if (!mapped) btn.classList.add("is-dark");if (btn.classList.contains("pull-right")){btn.classList.remove("pull-right");btn.classList.add("is-pulled-right");}if (btn.classList.contains("pull-left")){btn.classList.remove("pull-left");btn.classList.add("is-pulled-left");}});}function ensureDeleteButton(modal){const header = modal.querySelector(".modal-header");if (!header) return;if (header.querySelector(".delete")) return;const del = document.createElement("button");del.className = "delete";del.setAttribute("aria-label","close");del.addEventListener("click",(e)=>{e.preventDefault();try{if (window.jQuery) window.jQuery(modal).modal("hide");}catch(_){}modal.classList.remove("is-active");});header.appendChild(del);}function decorate(modal){if (!modal || modal.classList.contains("btfw-modal") || modal.classList.contains("btfw-bulma-skin")) return;modal.classList.add("btfw-bulma-skin");modal.querySelectorAll(".modal-content").forEach(c=>c.classList.add("btfw-card"));modal.querySelectorAll(".modal-header").forEach(h=>h.classList.add("btfw-card-head"));modal.querySelectorAll(".modal-body").forEach(b=>b.classList.add("btfw-card-body"));modal.querySelectorAll(".modal-footer").forEach(f=>f.classList.add("btfw-card-foot"));ensureDeleteButton(modal);restyleButtons(modal);try{if (window.jQuery){window.jQuery(modal).on("shown.bs.modal",function(){restyleButtons(modal);});}}catch(_){}}function skinAll(){$$(".modal").forEach(m => decorate(m));}function boot(){skinAll();const handleBootstrapModal = (event)=>{const modal = event?.target && event.target.classList?.contains("modal") ? event.target:event?.target?.closest?.(".modal");if (modal) decorate(modal);};document.addEventListener("show.bs.modal",handleBootstrapModal,true);document.addEventListener("shown.bs.modal",handleBootstrapModal,true);}if (document.readyState === "loading") document.addEventListener("DOMContentLoaded",boot);else boot();return{name:"feature:modal-skin",reskin:skinAll};});BTFW.define("feature:emotes",[],async () =>{const $ = (s,r=document) => r.querySelector(s);const $$ = (s,r=document) => Array.from(r.querySelectorAll(s));const motion = await BTFW.init("util:motion");function insertAtCursor(input,text){input.focus();const s = input.selectionStart ?? input.value.length;const e = input.selectionEnd ?? input.value.length;const before = input.value.slice(0,s);const after = input.value.slice(e);input.value = before + text + after;const pos = before.length + text.length;input.selectionStart = input.selectionEnd = pos;input.dispatchEvent(new Event("input",{bubbles:true}));}function normalizeEmojiForInsert(s){if (/\uFE0F/.test(s)) return s;const cps = Array.from(s);if (cps.length === 1) return s + "\uFE0F";return s;}function ensureChatwrapRelative(){const wrap = $("#chatwrap");if (wrap && getComputedStyle(wrap).position === "static"){wrap.style.position = "relative";}}const CHANNEL_NAME = (window.CHANNEL && window.CHANNEL.name) || "default";const RECENT_KEY = `btfw:recent:emotes:${CHANNEL_NAME}`;let state ={tab:"emotes",list:{emotes:[],emoji:[],recent:[]},filtered:[],highlight:0,emojiReady:false,search:"",renderEpoch:0};const TILE_APPROX = 72;function gridCols(grid){const w = grid.clientWidth || 520;return Math.max(3,Math.floor(w / TILE_APPROX));}function loadChannelEmotes(){const src = Array.isArray(window.CHANNEL?.emotes) ? window.CHANNEL.emotes:[];state.list.emotes = src .filter(x => x && x.name) .map(x => ({name:x.name,image:x.image || ""}));}async function loadEmoji(){try{const raw = localStorage.getItem("btfw:emoji:cache");if (raw){state.list.emoji = JSON.parse(raw);state.emojiReady = true;render(true);return;}}catch(_){}const url = "https://cdn.jsdelivr.net/npm/emoji.json@13.1.0/emoji.json";try{const res = await fetch(url,{cache:"force-cache"});const arr = await res.json();state.list.emoji = arr.map(e => ({char:e.char,name:(e.name || "").toLowerCase(),keywords:(e.keywords || "").toLowerCase()}));localStorage.setItem("btfw:emoji:cache",JSON.stringify(state.list.emoji));}catch(_){state.list.emoji = [{char:"ðŸ˜€",name:"grinning face",keywords:"smile happy"},{char:"ðŸ˜‚",name:"face with tears of joy",keywords:"laugh cry"},{char:"ðŸ˜",name:"smiling face with heart-eyes",keywords:"love"},{char:"ðŸ‘",name:"thumbs up",keywords:"like ok yes"},{char:"ðŸ”¥",name:"fire",keywords:"lit hot"},{char:"ðŸŽ‰",name:"party popper",keywords:"celebrate confetti"},];}state.emojiReady = true;render(true);}function loadRecent(){try{state.list.recent = JSON.parse(localStorage.getItem(RECENT_KEY) || "[]");}catch(_){state.list.recent = [];}}function pushRecent(item){const key = item.kind === "emoji" ? item.char:item.name;state.list.recent = state.list.recent.filter(x => (x.kind==="emoji" ? x.char:x.name) !== key);state.list.recent.unshift(item);state.list.recent = state.list.recent.slice(0,24);try{localStorage.setItem(RECENT_KEY,JSON.stringify(state.list.recent));}catch(_){}}function ensurePopover(){let pop = $("#btfw-emotes-pop");if (pop) return pop;ensureChatwrapRelative();pop = document.createElement("div");pop.id = "btfw-emotes-pop";pop.className = "btfw-popover btfw-emotes-pop";pop.dataset.btfwPopoverState = "closed";pop.setAttribute("hidden","");pop.setAttribute("aria-hidden","true");pop.innerHTML = ` <div class="btfw-emotes-head"> <div class="btfw-emotes-tabs"> <button class="btfw-tab is-active" data-tab="emotes">Channel</button> <button class="btfw-tab" data-tab="emoji">Emoji</button> <button class="btfw-tab" data-tab="recent">Recent</button> </div> <div class="btfw-emotes-search"> <input id="btfw-emotes-search" type="search" placeholder="Searchâ€¦" autocomplete="off" /> <button id="btfw-emotes-clear" class="btfw-emotes-clear" type="button" title="Clear search" aria-label="Clear search" aria-hidden="true" tabindex="-1">Ã—</button> </div> <button class="btfw-emotes-close" title="Close">Ã—</button> </div> <div id="btfw-emotes-grid" class="btfw-emotes-grid" tabindex="0" aria-label="Emote grid"></div> `;const wrap = $("#chatwrap") || document.body;wrap.appendChild(pop);const gridEl = pop.querySelector("#btfw-emotes-grid");if (gridEl){gridEl.setAttribute("data-twemoji-skip","true");gridEl.classList.add("btfw-emoji-grid--native");}// Tabs const syncSearchClear = ()=>{const input = $("#btfw-emotes-search",pop);const btn = $("#btfw-emotes-clear",pop);if (!input || !btn) return;const hasValue = input.value.length > 0;btn.classList.toggle("is-visible",hasValue);btn.setAttribute("aria-hidden",hasValue ? "false":"true");btn.tabIndex = hasValue ? 0:-1;};pop.querySelector(".btfw-emotes-tabs").addEventListener("click",ev=>{const btn = ev.target.closest(".btfw-tab");if (!btn) return;pop.querySelectorAll(".btfw-tab").forEach(x=>x.classList.toggle("is-active",x===btn));state.tab = btn.getAttribute("data-tab");state.search = "";$("#btfw-emotes-search").value = "";syncSearchClear();if (state.tab === "emoji" && !state.emojiReady) loadEmoji();render(true);focusGrid();});// Debounced search (function(){let t = 0;$("#btfw-emotes-search",pop).addEventListener("input",e=>{state.search = e.target.value.trim();syncSearchClear();clearTimeout(t);t = setTimeout(()=> render(true),120);});})();$("#btfw-emotes-clear",pop).addEventListener("click",()=>{state.search = "";$("#btfw-emotes-search").value = "";syncSearchClear();render(true);focusGrid();});// Close button $(".btfw-emotes-close",pop).addEventListener("click",(e)=>{e.preventDefault();e.stopPropagation();close();});$("#btfw-emotes-grid",pop).addEventListener("keydown",ev=>{const grid = $("#btfw-emotes-grid");const total = grid.querySelectorAll(".btfw-emote-tile").length;if (!total) return;const cols = gridCols(grid);switch(ev.key){case "ArrowRight":state.highlight = Math.min(total-1,state.highlight+1);break;case "ArrowLeft":state.highlight = Math.max(0,state.highlight-1);break;case "ArrowDown":state.highlight = Math.min(total-1,state.highlight + cols);break;case "ArrowUp":state.highlight = Math.max(0,state.highlight - cols);break;case "Enter":{const tile = grid.querySelector(`.btfw-emote-tile[data-index="${state.highlight}"]`);if (tile) tile.click();ev.preventDefault();return;}case "Escape":close();return;default:return;}ev.preventDefault();highlightActive();ensureVisible();});// Click-outside to close document.addEventListener("click",(e)=>{if (pop.dataset.btfwPopoverState !== "open") return;const within = e.target.closest("#btfw-emotes-pop") || e.target.closest("#btfw-btn-emotes");if (!within) close();},true);// First position & fixed height positionPopover(true);syncSearchClear();pop._btfwSyncSearchClear = syncSearchClear;return pop;}function focusGrid(preventScroll = true){const grid = document.getElementById("btfw-emotes-grid");if (!grid || typeof grid.focus !== "function") return;if (preventScroll){try{grid.focus({preventScroll:true});return;}catch(_){}}try{grid.focus();}catch(_){}}function findBottomBar(){return document.getElementById("btfw-chat-bottombar") || document.getElementById("chatcontrols") || document.getElementById("chatline");}function positionPopover(){const pop = document.getElementById("btfw-emotes-pop");if (!pop) return;if (window.BTFW_positionPopoverAboveChatBar){window.BTFW_positionPopoverAboveChatBar(pop,{widthPx:530,widthVw:92,maxHpx:480,maxHvh:70});}}function watchPosition(){const wrap = document.getElementById("chatwrap") || document.body;const anchor = findBottomBar() || wrap;if (wrap._btfwEmoteWatch) return;wrap._btfwEmoteWatch = true;const onReflow = () => positionPopover(false);window.addEventListener("resize",onReflow);window.addEventListener("scroll",onReflow,true);if (window.ResizeObserver){const ro = new ResizeObserver(onReflow);ro.observe(wrap);if (anchor && anchor !== wrap) ro.observe(anchor);wrap._btfwEmoteRO = ro;}else{const mo = new MutationObserver(onReflow);mo.observe(wrap,{attributes:true,childList:true,subtree:true});if (anchor && anchor !== wrap) mo.observe(anchor,{attributes:true,childList:true,subtree:true});wrap._btfwEmoteMO = mo;}}function render(fromSearch){const grid = $("#btfw-emotes-grid");if (!grid) return;const q = (state.search || "").toLowerCase();if (state.tab === "emotes"){state.filtered = q ? state.list.emotes.filter(x => x.name.toLowerCase().includes(q)):state.list.emotes;}else if (state.tab === "emoji"){state.filtered = q ? state.list.emoji.filter(x => x.name.includes(q) || x.keywords.includes(q)):state.list.emoji;}else{state.filtered = q ? state.list.recent.filter(x => x.kind==="emoji" ? (x.char+(x.name||"")+(x.keywords||"")).toLowerCase().includes(q):(x.name||"").toLowerCase().includes(q)):state.list.recent;}if (fromSearch){grid.scrollTop = 0;state.highlight = 0;}const epoch = ++state.renderEpoch;grid.innerHTML = "";const total = state.filtered.length;let i = 0;const CHUNK = 200;function makeTile(item,idxAbs){const tile = document.createElement("div");tile.className = "btfw-emote-tile";tile.setAttribute("data-index",String(idxAbs));if (state.tab==="emoji" || item.kind==="emoji"){tile.classList.add("btfw-emote-tile--emoji");tile.dataset.kind = "emoji";tile.setAttribute("aria-label",item.name || item.char || "Emoji");tile.dataset.emoji = item.char;const span = document.createElement("span");span.className = "btfw-emoji";span.textContent = item.char;span.setAttribute("aria-hidden","true");tile.title = item.name || "";tile.appendChild(span);}else{tile.classList.add("btfw-emote-tile--emote");tile.dataset.kind = "emote";const img = document.createElement("img");img.className = "btfw-emote-img";img.src = item.image || "";img.alt = item.name;img.loading = "lazy";img.decoding = "async";img.onerror = ()=>{img.style.display="none";tile.textContent = item.name;};tile.title = item.name;tile.setAttribute("aria-label",item.name || "Emote");tile.appendChild(img);}tile.addEventListener("click",()=>{const input = $("#chatline");if (!input) return;if (state.tab==="emoji" || item.kind==="emoji"){insertAtCursor(input,normalizeEmojiForInsert(item.char) + " ");pushRecent({kind:"emoji",char:item.char,name:item.name,keywords:item.keywords});}else{insertAtCursor(input," " + item.name + " ");pushRecent({kind:"emote",name:item.name,image:item.image});}close();});return tile;}function step(){if (epoch !== state.renderEpoch) return;// canceled const frag = document.createDocumentFragment();const end = Math.min(total,i + CHUNK);for (;i < end;i++){frag.appendChild(makeTile(state.filtered[i],i));}grid.appendChild(frag);document.dispatchEvent(new CustomEvent("btfw:emotes:rendered",{detail:{container:grid}}));if (i < total){if ('requestIdleCallback' in window){requestIdleCallback(step,{timeout:50});}else{setTimeout(step,0);}}else{highlightActive();}}step();}function highlightActive(){const grid = $("#btfw-emotes-grid");if (!grid) return;grid.querySelectorAll(".btfw-emote-tile.is-active").forEach(el => el.classList.remove("is-active"));const active = grid.querySelector(`.btfw-emote-tile[data-index="${state.highlight}"]`);if (active) active.classList.add("is-active");}function ensureVisible(){const grid = $("#btfw-emotes-grid");const active = grid && grid.querySelector(`.btfw-emote-tile[data-index="${state.highlight}"]`);if (!grid || !active) return;const r = active.getBoundingClientRect();const gr = grid.getBoundingClientRect();if (r.top < gr.top) grid.scrollTop -= (gr.top - r.top) + 8;else if (r.bottom > gr.bottom) grid.scrollTop += (r.bottom - gr.bottom) + 8;}function removeLegacyButtons(){const sels = [ "#emotelistbtn","#emotelist","#emote-list","#emote-btn",'button[title*="Emote"]','button[onclick*="emote"]' ];sels.forEach(sel => $$(sel).forEach(el => el.remove()));}function findBottomBarContainer(){return document.getElementById("btfw-chat-bottombar") || document.querySelector("#chatcontrols .input-group-btn") || document.getElementById("chatcontrols") || document.getElementById("chatwrap");}function ensureOurButton(){if ($("#btfw-btn-emotes")) return;const bar = findBottomBarContainer();if (!bar) return;const btn = document.createElement("button");btn.id = "btfw-btn-emotes";btn.type = "button";btn.className = "button is-dark is-small btfw-chatbtn btfw-btn-emotes";btn.innerHTML = (window.FontAwesome || document.querySelector('.fa')) ? '<i class="fa fa-smile" aria-hidden="true"></i>':'<span aria-hidden="true">ðŸ™‚</span>';btn.title = "Emotes / Emoji";const gifBtn = bar.querySelector("#btfw-btn-gif,.btfw-btn-gif");if (gifBtn && gifBtn.parentNode) gifBtn.parentNode.insertBefore(btn,gifBtn);else bar.appendChild(btn);btn.addEventListener("click",ev=>{ev.preventDefault();ev.stopPropagation();const pop = document.getElementById("btfw-emotes-pop");(pop && pop.dataset.btfwPopoverState === "open") ? close():open();},{capture:true});}function bindAnyExistingOpeners(){["#btfw-btn-emotes",".btfw-btn-emotes"].forEach(sel=>{document.querySelectorAll(sel).forEach(el=>{el.removeAttribute("onclick");if (window.jQuery){try{jQuery(el).off("click");}catch(_){}}const c = el.cloneNode(true);el.parentNode.replaceChild(c,el);c.addEventListener("click",ev=>{ev.preventDefault();ev.stopPropagation();const pop = document.getElementById("btfw-emotes-pop");(pop && pop.dataset.btfwPopoverState === "open") ? close():open();},{capture:true});});});}function open(){const pop = ensurePopover();loadChannelEmotes();loadRecent();state.tab="emotes";state.search="";state.highlight=0;$("#btfw-emotes-search").value = "";pop?._btfwSyncSearchClear?.();// activate correct tab styling pop.querySelectorAll(".btfw-tab").forEach(b=>b.classList.toggle("is-active",b.getAttribute("data-tab")==="emotes"));motion.openPopover(pop);positionPopover(true);// compute fixed height once per open render(true);focusGrid();}function close(){const pop = $("#btfw-emotes-pop");if (pop) motion.closePopover(pop);}function boot(){removeLegacyButtons();ensureOurButton();bindAnyExistingOpeners();watchPosition();}if (document.readyState === "loading") document.addEventListener("DOMContentLoaded",boot);else boot();return{name:"feature:emotes",open,close,render,positionPopover};});BTFW.define("feature:emoji-compat",[],async () =>{const LS = "btfw:emoji:twemoji";const TW_VER = "14.0.2";const TW_JS = `https://cdn.jsdelivr.net/npm/twemoji@${TW_VER}/dist/twemoji.min.js`;const TW_ASSETS_BASE = `https://cdn.jsdelivr.net/npm/twemoji@${TW_VER}/assets/`;const SKIP_SELECTOR = "[data-twemoji-skip='true']";let enabled = false;let mo = null;function getEnabled(){try{return localStorage.getItem(LS) === "1";}catch(_){return false;}}function setEnabled(v){enabled = !!v;try{localStorage.setItem(LS,v ? "1":"0");}catch(_){}if (enabled){ensureTwemoji().then(() =>{parsePicker();startChatObserver();});}else{stopChatObserver();}}function ensureTwemoji(){return new Promise((resolve,reject)=>{if (window.twemoji) return resolve();const s = document.createElement("script");s.async = true;s.defer = true;s.src = TW_JS + "?v=" + Date.now();s.onload = ()=> resolve();s.onerror = ()=> reject(new Error("Failed to load Twemoji"));document.head.appendChild(s);});}function prepImages(root){if (!root) return;root.querySelectorAll("img.twemoji").forEach(img =>{img.setAttribute("loading","lazy");img.setAttribute("decoding","async");if (img.complete && img.naturalWidth > 0) img.classList.add("is-ready");else{img.addEventListener("load",()=> img.classList.add("is-ready"),{once:true});}try{if (img.alt === "\uFE0F" || /\/fe0f(?:\.svg|\.png)$/.test(img.src)){img.remove();}}catch(_){}img.addEventListener("error",()=> img.remove(),{once:true});});}function shouldSkip(node){if (!node) return false;if (node.nodeType === 1){if (node.matches?.(SKIP_SELECTOR)) return true;if (node.closest?.(SKIP_SELECTOR)) return true;}if (node.nodeType === 11){return Array.from(node.childNodes || []).every(child => shouldSkip(child));}return false;}function parseNode(node){if (!window.twemoji || !enabled || !node) return;if (shouldSkip(node)) return;window.twemoji.parse(node,{base:TW_ASSETS_BASE,folder:"svg",ext:".svg",className:"twemoji",attributes:() => ({loading:"lazy",decoding:"async"})});prepImages(node);}function parsePicker(){const grid = document.getElementById("btfw-emotes-grid");if (grid) parseNode(grid);}function startChatObserver(){const buf = document.getElementById("messagebuffer");if (!buf) return;stopChatObserver();mo = new MutationObserver((muts)=>{for (const m of muts){m.addedNodes && m.addedNodes.forEach(n =>{if (n.nodeType === 1) parseNode(n);});}});mo.observe(buf,{childList:true,subtree:true});parseNode(buf);}function stopChatObserver(){if (mo){try{mo.disconnect();}catch(_){}mo = null;}}document.addEventListener("btfw:emotes:rendered",(e)=>{const container = e.detail?.container || null;if (enabled && container && !shouldSkip(container)){parseNode(container);}});function boot(){setEnabled(getEnabled());}if (document.readyState === "loading") document.addEventListener("DOMContentLoaded",boot);else boot();return{name:"feature:emoji-compat",getEnabled,setEnabled};});BTFW.define("feature:emoji-loader",[],async () =>{const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));function prepCell(cell){if (!cell || cell._btfwReady) return;cell._btfwReady = true;const img = cell.querySelector(".btfw-emoji-img");if (!img) return;cell.classList.add("loading");img.addEventListener("load",()=>{cell.classList.remove("loading");cell.classList.add("ready");},{once:true});img.addEventListener("error",()=>{cell.classList.remove("loading");img.style.display = "none";},{once:true});if (img.complete && img.naturalWidth > 0){cell.classList.remove("loading");cell.classList.add("ready");}}const scheduleFrame = typeof requestAnimationFrame === "function" ? requestAnimationFrame:(cb) => setTimeout(cb,16);const supportsIntersectionObserver = typeof IntersectionObserver === "function";const observer = supportsIntersectionObserver ? new IntersectionObserver((entries) =>{entries.forEach(entry =>{if (!entry.isIntersecting) return;const target = entry.target;if (supportsIntersectionObserver) observer.unobserve(target);prepCell(target);});}):null;let rafId;function scan(){if (rafId) return;rafId = scheduleFrame(() =>{if (!supportsIntersectionObserver){$$(".btfw-emoji-grid .btfw-emoji-cell").forEach(prepCell);rafId = null;return;}$$(".btfw-emoji-grid .btfw-emoji-cell:not([data-observed])").forEach(cell =>{cell.dataset.observed = "true";observer.observe(cell);});rafId = null;});}let scanTimeout;const mo = new MutationObserver(() =>{clearTimeout(scanTimeout);scanTimeout = setTimeout(scan,50);});mo.observe(document.body,{childList:true,subtree:true});if (document.readyState === "loading") document.addEventListener("DOMContentLoaded",scan);else scan();return{name:"feature:emoji-loader"};});BTFW.define("feature:gifs",[],async () =>{const $ = (s,r=document) => r.querySelector(s);const $$ = (s,r=document) => Array.from(r.querySelectorAll(s));const PER_PAGE = 12;const motion = await BTFW.init("util:motion");const K ={giphy:"btfw:giphy:key",tenor:"btfw:tenor:key"};const DEFAULT_GIPHY = "bb2006d9d3454578be1a99cfad65913d";const DEFAULT_TENOR = "5WPAZ4EXST2V";function getKey(which){try{return (localStorage.getItem(K[which]) || "").trim();}catch (_){return "";}}function effKey(which,fallback){const v = getKey(which);return v || fallback;}const state ={provider:"giphy",// "giphy" | "tenor" | "favorites" query:"",page:1,total:0,items:[],//{id,provider,thumb,urlClassic}loading:false};let renderedItems = [];let gridClickHandlerAttached = false;const FAVORITES_KEY = "btfw:gifs:favorites";let favorites = loadFavorites();let favoriteLookup = buildFavoriteLookup(favorites);function insertAtCursor(input,text){input.focus();const s = input.selectionStart ?? input.value.length;const e = input.selectionEnd ?? input.value.length;const before = input.value.slice(0,s);const after = input.value.slice(e);input.value = before + text + after;const pos = before.length + text.length;input.selectionStart = input.selectionEnd = pos;input.dispatchEvent(new Event("input",{bubbles:true}));}function stripQuery(u){return (u||"").split("?")[0].split("#")[0];}function buildGiphyClassic(id){return `https://media1.giphy.com/media/${id}/giphy.gif`;}function normTenor(u){return stripQuery(u);}function ensureOpeners(){["#btfw-btn-gif",".btfw-btn-gif","#giphybtn","#gifbtn"].forEach(sel=>{$$(sel).forEach(el=>{el.removeAttribute("onclick");const c = el.cloneNode(true);el.parentNode.replaceChild(c,el);c.addEventListener("click",e =>{e.preventDefault();open();},{capture:true});});});if (!$("#btfw-btn-gif")){const bar = document.getElementById("btfw-chat-bottombar") || document.querySelector("#chatcontrols .input-group-btn") || document.getElementById("chatcontrols") || document.getElementById("chatwrap");if (bar){const btn = document.createElement("button");btn.id = "btfw-btn-gif";btn.type = "button";btn.className = "button is-dark is-small btfw-chatbtn btfw-btn-gif";btn.innerHTML = (document.querySelector(".fa")) ? '<i class="fa fa-file-video-o"></i>':'GIF';btn.title = "GIFs";bar.appendChild(btn);btn.addEventListener("click",e =>{e.preventDefault();open();},{capture:true});}}}let modal = null;function ensureModal(){if (modal) return modal;modal = document.createElement("div");modal.id = "btfw-gif-modal";modal.className = "modal";modal.dataset.btfwModalState = "closed";modal.setAttribute("hidden","");modal.setAttribute("aria-hidden","true");modal.innerHTML = ` <div class="modal-background"></div> <div class="modal-card btfw-modal"> <header class="modal-card-head"> <p class="modal-card-title">GIFs</p> <button class="delete" aria-label="close"></button> </header> <section class="modal-card-body"> <div class="btfw-gif-toolbar"> <div class="tabs is-boxed is-small btfw-gif-tabs"> <ul> <li class="is-active" data-p="giphy"><a>Giphy</a></li> <li data-p="tenor"><a>Tenor</a></li> <li data-p="favorites"><a>Favorites</a></li> </ul> </div> <div class="btfw-gif-search"> <input id="btfw-gif-q" class="input is-small" type="text" placeholder="Search GIFsâ€¦"> <button id="btfw-gif-go" class="button is-link is-small">Search</button> <button id="btfw-gif-trending" class="button is-dark is-small">Trending</button> </div> </div> <div id="btfw-gif-notice" class="btfw-gif-notice is-hidden"></div> <div id="btfw-gif-grid" class="btfw-gif-grid"></div> <nav class="pagination is-centered btfw-gif-pager" role="navigation" aria-label="pagination"> <button id="btfw-gif-prev" class="button is-dark is-small">Prev</button> <span id="btfw-gif-pages" class="btfw-gif-pages">1 / 1</span> <button id="btfw-gif-next" class="button is-dark is-small">Next</button> </nav> </section> <footer class="modal-card-foot"> <button class="button is-link" id="btfw-gif-close">Close</button> </footer> </div> `;document.body.appendChild(modal);modal.querySelector(".modal-background").addEventListener("click",close);modal.querySelector(".delete").addEventListener("click",close);$("#btfw-gif-close",modal).addEventListener("click",close);modal.querySelector(".btfw-gif-tabs ul").addEventListener("click",e=>{const li = e.target.closest("li[data-p]");if (!li) return;modal.querySelectorAll(".btfw-gif-tabs li").forEach(x=>x.classList.toggle("is-active",x===li));state.provider = li.getAttribute("data-p");state.page = 1;handleProviderChange();});$("#btfw-gif-go",modal).addEventListener("click",()=>{state.page = 1;search();});$("#btfw-gif-q",modal).addEventListener("keydown",e=>{if (e.key === "Enter"){state.page = 1;search();}});$("#btfw-gif-trending",modal).addEventListener("click",()=>{$("#btfw-gif-q").value = "";state.page = 1;search();});$("#btfw-gif-prev",modal).addEventListener("click",()=>{if (state.page > 1){state.page--;debouncedRender();}});$("#btfw-gif-next",modal).addEventListener("click",()=>{const totalPages = Math.max(1,Math.ceil(state.total / PER_PAGE));if (state.page < totalPages){state.page++;debouncedRender();}});return modal;}function showNotice(msg){const n = $("#btfw-gif-notice",modal);n.textContent = msg || "";n.classList.toggle("is-hidden",!msg);}async function fetchGiphy(q){const key = effKey("giphy",DEFAULT_GIPHY);const endpoint = q ? "https://api.giphy.com/v1/gifs/search":"https://api.giphy.com/v1/gifs/trending";const url = new URL(endpoint);url.searchParams.set("api_key",key);if (q) url.searchParams.set("q",q);url.searchParams.set("limit","50");url.searchParams.set("rating","pg-13");const res = await fetch(url.toString());if (!res.ok) throw new Error(`GIPHY_${res.status}`);const json = await res.json();const list = (json.data || []).map(g =>{const id = g.id || "";// always present const thumb = (g.images && (g.images.fixed_width_small?.url || g.images.fixed_width?.url || g.images.downsized_still?.url)) || "";const urlClassic = id ? buildGiphyClassic(id):"";// <â€” classic format ONLY return{id,provider:"giphy",thumb,urlClassic};});return{items:list,total:list.length};}async function fetchTenor(q){const key = effKey("tenor",DEFAULT_TENOR);const endpoint = q ? "https://api.tenor.com/v1/search":"https://api.tenor.com/v1/trending";const url = new URL(endpoint);url.searchParams.set("key",key);if (q) url.searchParams.set("q",q);url.searchParams.set("limit","50");const res = await fetch(url.toString());if (!res.ok) throw new Error(`TENOR_${res.status}`);const json = await res.json();const list = (json.results || []).map(t =>{const gif = t.media?.[0]?.gif?.url || t.media?.[0]?.mediumgif?.url || t.media?.[0]?.tinygif?.url || "";const tiny = t.media?.[0]?.nanogif?.url || t.media?.[0]?.tinygif?.url || gif;return{id:t.id,provider:"tenor",thumb:tiny,urlClassic:normTenor(gif)};});return{items:list,total:list.length};}async function search(){const q = ($("#btfw-gif-q",ensureModal()).value || "").trim();state.query = q;state.page = 1;if (state.provider === "favorites"){state.loading = false;applyFavoritesToState();render();return;}state.loading = true;renderSkeleton();try{const{items,total}= (state.provider === "giphy") ? await fetchGiphy(q):await fetchTenor(q);state.items = items;state.total = total;state.loading = false;showNotice(total ? "":"No results. Try a different search.");render();}catch (e){state.items = [];state.total = 0;state.loading = false;showNotice("Failed to load GIFs (key limit or network). Try again,or set your own keys in localStorage.");render();}}function renderSkeleton(){if (state.provider === "favorites"){return;}const grid = $("#btfw-gif-grid",ensureModal());renderedItems = [];const existingSkeletons = grid.querySelectorAll('.is-skeleton');if (existingSkeletons.length === PER_PAGE){return;}grid.innerHTML = "";const frag = document.createDocumentFragment();for (let i = 0;i < PER_PAGE;i++){const sk = document.createElement("div");sk.className = "btfw-gif-cell is-skeleton";const frame = document.createElement("div");frame.className = "btfw-gif-thumb";sk.appendChild(frame);frag.appendChild(sk);}grid.appendChild(frag);$("#btfw-gif-pages").textContent = "â€¦ / â€¦";}function render(){const grid = $("#btfw-gif-grid",ensureModal());setupGridClickHandler(grid);updateToolbarForProvider();const totalPages = Math.max(1,Math.ceil(state.total / PER_PAGE));const clamped = Math.max(1,Math.min(totalPages,state.page));if (clamped !== state.page) state.page = clamped;const start = (state.page - 1) * PER_PAGE;const pageItems = state.items.slice(start,start + PER_PAGE);const canUpdateInPlace = shouldUpdateInPlace(pageItems,grid);const showRemove = state.provider === "favorites";if (canUpdateInPlace){// Fast path:update existing elements updateExistingCells(grid,pageItems,{showRemove});}else{// Full render needed fullRender(grid,pageItems,{showRemove});}renderedItems = pageItems.map(item => ({id:item.id,provider:item.provider,thumb:item.thumb,urlClassic:item.urlClassic}));$("#btfw-gif-pages").textContent = `${state.page}/ ${totalPages}`;$("#btfw-gif-prev").disabled = (state.page <= 1);$("#btfw-gif-next").disabled = (state.page >= totalPages);}function setupGridClickHandler(grid){if (gridClickHandlerAttached) return;grid.addEventListener("click",(e) =>{const toggle = e.target.closest(".btfw-gif-fav-toggle");if (toggle && handleFavoriteControl(toggle)){e.preventDefault();e.stopPropagation();return;}// Find the clicked cell (bubbling from img or button) const cell = e.target.closest(".btfw-gif-cell");if (!cell || cell.classList.contains("is-skeleton")) return;const url = cell.dataset.url;if (!url) return;const input = document.getElementById("chatline");if (!input) return;insertAtCursor(input," " + url + " ");close();});grid.addEventListener("keydown",(e) =>{if (e.key !== "Enter" && e.key !== " " && e.key !== "Spacebar") return;const toggle = e.target.closest(".btfw-gif-fav-toggle");if (toggle && handleFavoriteControl(toggle)){e.preventDefault();e.stopPropagation();}});gridClickHandlerAttached = true;}function shouldUpdateInPlace(newItems,grid){const existingCells = grid.querySelectorAll(".btfw-gif-cell:not(.is-skeleton)");if (existingCells.length !== newItems.length) return false;if (renderedItems.length === 0) return false;return true;}// Update existing cells efficiently function updateExistingCells(grid,newItems,opts ={}){const{showRemove = false}= opts;const cells = grid.querySelectorAll(".btfw-gif-cell");newItems.forEach((item,index) =>{const cell = cells[index];if (!cell) return;updateCell(cell,item,{showRemove});});}// Update a single cell's content function updateCell(cell,item,opts ={}){const{showRemove = false}= opts;// Update data attribute cell.dataset.url = item.urlClassic || "";cell.dataset.id = item.id || "";cell.dataset.thumb = item.thumb || "";cell.dataset.provider = item.provider || state.provider || "";cell.dataset.favKey = makeFavoriteKey(item);const img = cell.querySelector("img");if (img && img.src !== item.thumb){img.src = item.thumb;img.alt = "gif";prepareImageLoadingState(cell,img);}else if (img){prepareImageLoadingState(cell,img);}cell.classList.remove("is-skeleton");updateFavoriteVisualState(cell,showRemove);}// Full render when updating in place isn't possible function fullRender(grid,pageItems,opts ={}){const{showRemove = false}= opts;// Use replaceChildren for efficient bulk replacement (better than innerHTML = "") const frag = document.createDocumentFragment();pageItems.forEach(item =>{const cell = createGifCell(item,{showRemove});frag.appendChild(cell);});grid.replaceChildren(frag);}// Create a single GIF cell element function createGifCell(item,opts ={}){const{showRemove = false}= opts;const cell = document.createElement("button");cell.className = "btfw-gif-cell";cell.type = "button";cell.dataset.url = item.urlClassic || "";cell.dataset.id = item.id || "";cell.dataset.thumb = item.thumb || "";cell.dataset.provider = item.provider || state.provider || "";cell.dataset.favKey = makeFavoriteKey(item);const frame = document.createElement("div");frame.className = "btfw-gif-thumb";const img = document.createElement("img");img.src = item.thumb;img.alt = "gif";img.loading = "lazy";img.decoding = "async";prepareImageLoadingState(cell,img);frame.appendChild(img);cell.appendChild(frame);const toggle = document.createElement("span");toggle.className = "btfw-gif-fav-toggle" + (showRemove ? " is-remove":"");toggle.dataset.action = showRemove ? "remove-favorite":"toggle-favorite";toggle.setAttribute("role","button");toggle.tabIndex = 0;cell.appendChild(toggle);updateFavoriteVisualState(cell,showRemove);return cell;}function updateFavoriteVisualState(cell,showRemove){const favKey = cell.dataset.favKey;const isFav = favoriteLookup.has(favKey || "");cell.classList.toggle("is-favorited",isFav);const toggle = cell.querySelector(".btfw-gif-fav-toggle");if (!toggle) return;if (showRemove){toggle.textContent = "Ã—";toggle.title = "Remove from favorites";toggle.setAttribute("aria-label","Remove from favorites");toggle.setAttribute("aria-pressed","true");return;}toggle.textContent = isFav ? "â˜…":"â˜†";const label = isFav ? "Remove from favorites":"Add to favorites";toggle.title = label;toggle.setAttribute("aria-label",label);toggle.setAttribute("aria-pressed",isFav ? "true":"false");}function prepareImageLoadingState(cell,img){const handleLoad = () =>{cell.classList.remove("is-loading");cell.classList.remove("is-broken");};const handleError = () =>{cell.classList.add("is-broken");cell.classList.remove("is-loading");};cell.classList.add("is-loading");img.onload = handleLoad;img.onerror = handleError;if (img.complete){if (img.naturalWidth && img.naturalHeight){handleLoad();}else{handleError();}}}let renderTimeout = null;function debouncedRender(){if (renderTimeout){clearTimeout(renderTimeout);}renderTimeout = setTimeout(() =>{render();renderTimeout = null;},16);}document.addEventListener('btfw:openGifs',()=>{try{openGifModal();}catch(e){}});function open(){ensureModal();showNotice("");state.page = 1;state.provider = modal.querySelector(".btfw-gif-tabs li.is-active")?.getAttribute("data-p") || "giphy";if (state.provider !== "favorites"){renderSkeleton();}setTimeout(search,0);motion.openModal(modal);const input = $("#btfw-gif-q",modal);if (input && state.provider !== "favorites"){requestAnimationFrame(() =>{input.focus();input.select();});}}function close(){if (modal) motion.closeModal(modal);}function handleProviderChange(){updateToolbarForProvider();if (state.provider === "favorites"){applyFavoritesToState();render();}else{renderSkeleton();search();}}function updateToolbarForProvider(){const searchBar = $(".btfw-gif-search",modal || document);if (!searchBar) return;const shouldHide = state.provider === "favorites";searchBar.classList.toggle("is-hidden",shouldHide);}function makeFavoriteKey(item){const provider = item.provider || state.provider || "";const idPart = item.id || "";const urlPart = item.urlClassic || "";const fallback = idPart || urlPart;return provider + "::" + (fallback || "");}function loadFavorites(){try{const raw = localStorage.getItem(FAVORITES_KEY);if (!raw) return [];const parsed = JSON.parse(raw);if (Array.isArray(parsed)){return parsed .filter(item => item && typeof item === "object" && item.urlClassic) .map(item => ({provider:item.provider || "giphy",id:item.id || "",thumb:item.thumb || item.urlClassic,urlClassic:item.urlClassic}));}}catch (_){}return [];}function saveFavorites(){try{localStorage.setItem(FAVORITES_KEY,JSON.stringify(favorites));}catch (_){}}function buildFavoriteLookup(list){const map = new Map();list.forEach(item =>{const key = makeFavoriteKey(item);if (key) map.set(key,item);});return map;}function applyFavoritesToState(){state.loading = false;state.items = favorites.slice();state.total = favorites.length;showNotice(favorites.length ? "":"Favorite GIFs will appear here once you star them.");}function cellToItem(cell){if (!cell) return null;const provider = cell.dataset.provider || state.provider || "";const id = cell.dataset.id || "";const thumb = cell.dataset.thumb || "";const urlClassic = cell.dataset.url || "";const item ={provider,id,thumb,urlClassic};item.favKey = cell.dataset.favKey || makeFavoriteKey(item);return item;}function toggleFavorite(item){const key = item.favKey || makeFavoriteKey(item);if (!item.urlClassic) return;if (favoriteLookup.has(key)){removeFavorite(item);return;}favorites.push({provider:item.provider,id:item.id,thumb:item.thumb || item.urlClassic,urlClassic:item.urlClassic});favoriteLookup.set(key,favorites[favorites.length - 1]);saveFavorites();if (state.provider === "favorites"){applyFavoritesToState();}render();}function removeFavorite(item){const key = item.favKey || makeFavoriteKey(item);const idx = favorites.findIndex(f => makeFavoriteKey(f) === key);if (idx === -1) return;favorites.splice(idx,1);favoriteLookup.delete(key);saveFavorites();if (state.provider === "favorites"){applyFavoritesToState();}render();}function handleFavoriteControl(toggle){const cell = toggle.closest(".btfw-gif-cell");if (!cell || cell.classList.contains("is-skeleton")) return false;const item = cellToItem(cell);if (!item) return false;const action = toggle.dataset.action || "";if (action === "remove-favorite"){removeFavorite(item);}else{toggleFavorite(item);}return true;}function boot(){ensureOpeners();}if (document.readyState === "loading") document.addEventListener("DOMContentLoaded",boot);else boot();return{name:"feature:gifs",open,close};});BTFW.define("feature:poll-overlay",[],async () =>{"use strict";const CSS_ID = "btfw-poll-overlay-styles";const POLL_OVERLAY_CSS = ` #btfw-poll-video-overlay{position:absolute;top:0;left:0;right:0;bottom:0;z-index:1500;pointer-events:none;display:none;}:root.btfw-poll-overlay-disabled #btfw-poll-video-overlay{display:none !important;}#btfw-poll-video-overlay.btfw-poll-active{display:block;}.btfw-poll-video-content{position:absolute;top:30px;left:20px;right:20px;pointer-events:auto;background:var(--btfw-overlay-bg);backdrop-filter:saturate(130%) blur(2px);border:1px solid var(--btfw-overlay-border);border-radius:calc(var(--btfw-radius) + 6px);padding:20px;box-shadow:var(--btfw-overlay-shadow);color:var(--btfw-color-text);max-width:800px;margin:0 auto;}.btfw-poll-video-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;}.btfw-poll-video-title{font-size:1.2rem;font-weight:700;color:var(--btfw-color-text);margin:0;flex:1;}.btfw-poll-video-close{background:none;border:none;font-size:1.2rem;color:var(--btfw-color-text);cursor:pointer;padding:4px;opacity:0.7;margin-left:12px;}.btfw-poll-video-close:hover{opacity:1;}.btfw-poll-options-grid{display:flex !important;flex-direction:row !important;gap:1rem !important;align-items:stretch;margin:20px 0 !important;justify-content:center;flex-wrap:nowrap;overflow-x:auto;overflow-y:hidden;}.btfw-poll-option-row{display:flex;align-items:center;gap:8px;}.btfw-poll-option-btn{background:color-mix(in srgb,var(--btfw-color-panel) 86%,transparent 14%);border:2px solid var(--btfw-border);border-radius:6px;padding:6px 12px;color:var(--btfw-color-text);cursor:pointer;transition:all 0.2s;font-weight:500;min-width:60px;text-align:center;font-size:0.9rem;}.btfw-poll-option-btn:hover{background:color-mix(in srgb,var(--btfw-color-accent) 20%,transparent 80%);border-color:var(--btfw-color-accent);}.btfw-poll-option-btn.active{background:color-mix(in srgb,var(--btfw-color-accent) 32%,transparent 68%);border-color:var(--btfw-color-accent);color:var(--btfw-color-on-accent);}.btfw-poll-option-text{flex:1;color:var(--btfw-color-text);font-weight:500;}.btfw-poll-footer{display:flex;justify-content:space-between;align-items:center;margin-top:16px;padding-top:12px;border-top:1px solid color-mix(in srgb,var(--btfw-border) 60%,transparent 40%);}.btfw-poll-info{font-size:0.85rem;color:color-mix(in srgb,var(--btfw-color-text) 70%,transparent 30%);}.btfw-poll-end-btn{background:var(--btfw-color-error,#e74c3c);color:white;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-size:0.85rem;font-weight:600;}.btfw-poll-end-btn:hover{opacity:0.9;}@media (max-width:768px){.btfw-poll-video-content{left:12px;right:12px;top:20px;padding:16px;}}`;let videoOverlay = null;let currentPoll = null;let socketEventsWired = false;let userVotes = new Set();let pollDomObserver = null;let observedPollElement = null;const ENTITY_DECODER = document.createElement("textarea");function decodeHtmlEntities(value){if (typeof value !== "string"){if (value == null) return "";return String(value);}if (value.length === 0){return "";}ENTITY_DECODER.innerHTML = value;return ENTITY_DECODER.value;}function resolvePollTitle(rawTitle){const decoded = decodeHtmlEntities(rawTitle);if (typeof decoded === "string"){const trimmed = decoded.trim();if (trimmed.length){return trimmed;}}return "Poll";}function injectCSS(){if (document.getElementById(CSS_ID)) return;const style = document.createElement("style");style.id = CSS_ID;style.textContent = POLL_OVERLAY_CSS;document.head.appendChild(style);}function createVideoOverlay(){if (videoOverlay) return videoOverlay;const videowrap = document.getElementById("videowrap");if (!videowrap) return null;const overlay = document.createElement("div");overlay.id = "btfw-poll-video-overlay";overlay.innerHTML = ` <div class="btfw-poll-video-content"> <div class="btfw-poll-video-header"> <h3 class="btfw-poll-video-title">Poll Title</h3> <button class="btfw-poll-video-close" type="button">&times;</button> </div> <div class="btfw-poll-options-grid"> <!-- Options populated by JS --> </div> <div class="btfw-poll-footer"> <div class="btfw-poll-info"> <span class="btfw-poll-votes">0 votes</span> </div> <button class="btfw-poll-end-btn" style="display:none;">End Poll</button> </div> </div> `;videowrap.appendChild(overlay);videoOverlay = overlay;const closeBtn = overlay.querySelector(".btfw-poll-video-close");closeBtn.addEventListener("click",hideVideoOverlay);const endBtn = overlay.querySelector(".btfw-poll-end-btn");endBtn.addEventListener("click",() =>{if (window.socket && window.socket.emit){try{window.socket.emit("closePoll");}catch (e){console.error("Failed to end poll:",e);}}});return overlay;}function canEndPoll(){return window.CLIENT && window.CLIENT.rank >= 2;}function getOriginalPollButtons(){// Only look at the active poll (previous polls remain in the DOM as history) // Using .well without the .active qualifier would pick up historical poll // buttons too,which changes the length of the NodeList once a poll has // been closed. That caused syncOverlayFromDom to abort on subsequent polls // because the overlay button count and source button count no longer // matched,leaving vote counts frozen until a page refresh. return document.querySelectorAll("#pollwrap .well.active .option button");}function stopPollDomObserver(){if (pollDomObserver){pollDomObserver.disconnect();pollDomObserver = null;observedPollElement = null;}}function startPollDomObserver(){stopPollDomObserver();if (!videoOverlay || !videoOverlay.classList.contains("btfw-poll-active")){return;}const pollWell = document.querySelector("#pollwrap .well.active");if (!pollWell){setTimeout(() =>{if (!pollDomObserver){startPollDomObserver();}},150);return;}observedPollElement = pollWell;pollDomObserver = new MutationObserver(() =>{if (observedPollElement && !document.contains(observedPollElement)){stopPollDomObserver();setTimeout(() =>{if (!pollDomObserver){startPollDomObserver();}},120);return;}syncOverlayFromDom();});pollDomObserver.observe(pollWell,{childList:true,subtree:true,characterData:true,attributes:true});syncOverlayFromDom();}function syncOverlayFromDom(){if (!videoOverlay) return;const overlayButtons = videoOverlay.querySelectorAll(".btfw-poll-option-btn");const originalButtons = getOriginalPollButtons();if (!overlayButtons.length || overlayButtons.length !== originalButtons.length){return;}const newVotes = [];overlayButtons.forEach((button,index) =>{const originalButton = originalButtons[index];const voteCount = parseInt(originalButton?.textContent) || 0;button.textContent = voteCount.toString();if (originalButton?.classList.contains("active")){button.classList.add("active");userVotes.add(index);}else{button.classList.remove("active");userVotes.delete(index);}newVotes.push(voteCount);});if (newVotes.length){const votesSpan = videoOverlay.querySelector(".btfw-poll-votes");if (votesSpan){const totalVotes = newVotes.reduce((sum,count) => sum + count,0);votesSpan.textContent = `${totalVotes}vote${totalVotes !== 1 ? 's':''}`;}if (currentPoll){currentPoll.votes = newVotes;}}}function attemptVote(optionIndex,attempt = 0){const originalButtons = getOriginalPollButtons();if (originalButtons && originalButtons[optionIndex]){originalButtons[optionIndex].click();setTimeout(() =>{syncOverlayFromDom();},120);return;}if (attempt >= 4){emitVoteFallback(optionIndex);return;}setTimeout(() =>{attemptVote(optionIndex,attempt + 1);},100);}function emitVoteFallback(optionIndex){if (!window.socket || typeof window.socket.emit !== "function"){return false;}const pollId = currentPoll && (currentPoll.id ?? currentPoll.pollId ?? currentPoll.pollID ?? currentPoll.poll_id);const attempts = [];const basePayloads = [optionIndex,{option:optionIndex}];if (pollId != null){basePayloads.push({poll:pollId,option:optionIndex});basePayloads.push({id:pollId,option:optionIndex});}const events = ["vote","votePoll"];events.forEach((event) =>{basePayloads.forEach((payload) =>{attempts.push({event,payload});});});attempts.forEach(({event,payload},index) =>{setTimeout(() =>{try{window.socket.emit(event,payload);}catch (err){if (index === attempts.length - 1){console.warn("[poll-overlay] Failed to emit vote via socket",err);}}},index * 25);});setTimeout(() =>{syncOverlayFromDom();},attempts.length * 25 + 150);return attempts.length > 0;}function showVideoOverlay(poll){const overlay = createVideoOverlay();if (!overlay || !poll) return;// FIXED:Create fresh poll data without contamination from previous polls const resolvedTitle = resolvePollTitle(poll.title);currentPoll ={...poll,title:resolvedTitle,votes:poll.votes ? [...poll.votes]:new Array(poll.options?.length || 0).fill(0)};userVotes.clear();// Reset user votes for new poll const title = overlay.querySelector(".btfw-poll-video-title");const optionsGrid = overlay.querySelector(".btfw-poll-options-grid");const endBtn = overlay.querySelector(".btfw-poll-end-btn");if (title) title.textContent = resolvedTitle;if (endBtn){endBtn.style.display = canEndPoll() ? "block":"none";}if (optionsGrid && poll.options){optionsGrid.innerHTML = "";poll.options.forEach((option,index) =>{const optionRow = document.createElement("div");optionRow.className = "btfw-poll-option-row";const btn = document.createElement("button");btn.className = "btfw-poll-option-btn";btn.dataset.optionIndex = index;const optionText = document.createElement("span");optionText.className = "btfw-poll-option-text";optionText.textContent = decodeHtmlEntities(option);// FIXED:Use currentPoll.votes (cleaned data) instead of poll.votes const voteCount = currentPoll.votes[index] || 0;btn.textContent = voteCount.toString();btn.addEventListener("click",() =>{try{attemptVote(index);}catch (e){console.error("Failed to trigger poll vote:",e);}if (poll.multi){if (userVotes.has(index)){userVotes.delete(index);btn.classList.remove("active");}else{userVotes.add(index);btn.classList.add("active");}}else{userVotes.clear();optionsGrid.querySelectorAll(".btfw-poll-option-btn").forEach(b =>{b.classList.remove("active");});userVotes.add(index);btn.classList.add("active");}});optionRow.appendChild(btn);optionRow.appendChild(optionText);optionsGrid.appendChild(optionRow);});}// FIXED:Use currentPoll instead of poll parameter updateVoteDisplay(currentPoll);overlay.classList.add("btfw-poll-active");setTimeout(() =>{syncOverlayFromDom();startPollDomObserver();},200);}function hideVideoOverlay(){if (videoOverlay){videoOverlay.classList.remove("btfw-poll-active");currentPoll = null;userVotes.clear();stopPollDomObserver();}}function updateVoteDisplay(poll){if (!videoOverlay || !poll) return;// FIXED:Don't merge with old currentPoll data - just update votes if (currentPoll && poll.votes){currentPoll.votes = [...poll.votes];// Fresh copy,no contamination}const votesSpan = videoOverlay.querySelector(".btfw-poll-votes");const optionsGrid = videoOverlay.querySelector(".btfw-poll-options-grid");if (optionsGrid && poll.votes){const buttons = optionsGrid.querySelectorAll(".btfw-poll-option-btn");const originalPollButtons = getOriginalPollButtons();let mirroredActiveState = false;buttons.forEach((btn,index) =>{const voteCount = poll.votes[index] || 0;btn.textContent = voteCount.toString();btn.classList.remove("active");});if (originalPollButtons.length === buttons.length){buttons.forEach((btn,index) =>{const originalBtn = originalPollButtons[index];if (originalBtn && originalBtn.classList.contains("active")){btn.classList.add("active");userVotes.add(index);mirroredActiveState = true;}else{userVotes.delete(index);}});}if (!mirroredActiveState && userVotes.size){userVotes.forEach((voteIndex) =>{const btn = buttons[voteIndex];if (btn){btn.classList.add("active");}});}}if (votesSpan && poll.votes){const totalVotes = poll.votes.reduce((sum,count) => sum + (count || 0),0);votesSpan.textContent = `${totalVotes}vote${totalVotes !== 1 ? 's':''}`;}if (!pollDomObserver && videoOverlay && videoOverlay.classList.contains("btfw-poll-active")){startPollDomObserver();}}function checkForExistingPoll(){const existingPoll = document.querySelector('#pollwrap .well.active');if (existingPoll){console.log("Found existing active poll,extracting data...");const titleElement = existingPoll.querySelector('h3');const optionElements = existingPoll.querySelectorAll('.option');if (titleElement && optionElements.length > 0){const pollData ={title:titleElement.textContent.trim(),options:[],votes:[],multi:false};optionElements.forEach((option,index) =>{const button = option.querySelector('button');const optionText = option.textContent.replace(button ? button.textContent:'','').trim();const voteCount = button ? parseInt(button.textContent) || 0:0;pollData.options.push(optionText);pollData.votes.push(voteCount);});console.log("Extracted poll data:",pollData);showVideoOverlay(pollData);return true;}}return false;}function wireSocketEvents(){if (socketEventsWired || !window.socket) return;try{// Listen for new polls window.socket.on("newPoll",(poll) =>{if (poll){showVideoOverlay(poll);}});// Listen for poll updates (vote counts) window.socket.on("updatePoll",(poll) =>{if (poll && currentPoll){updateVoteDisplay(poll);}});// Listen for poll closure window.socket.on("closePoll",() =>{hideVideoOverlay();});// Handle socket reconnection window.socket.on("connect",() =>{console.log("[poll-overlay] Socket reconnected,re-wiring events");socketEventsWired = false;setTimeout(() =>{wireSocketEvents();},500);});socketEventsWired = true;}catch (e){console.warn("[poll-overlay] Socket event wiring failed:",e);}}function waitForSocket(){return new Promise((resolve) =>{if (window.socket && window.socket.on){resolve();return;}let attempts = 0;const maxAttempts = 50;const checkSocket = () =>{attempts++;if (window.socket && window.socket.on){resolve();}else if (attempts < maxAttempts){setTimeout(checkSocket,100);}else{console.warn("[poll-overlay] Socket not available after 5 seconds");resolve();}};setTimeout(checkSocket,100);});}async function boot(){try{injectCSS();await waitForSocket();wireSocketEvents();setTimeout(() =>{checkForExistingPoll();},500);}catch (e){console.error("[poll-overlay] Boot failed:",e);}}if (document.readyState === "loading"){document.addEventListener("DOMContentLoaded",boot);}else{setTimeout(boot,0);}document.addEventListener("btfw:layoutReady",() =>{setTimeout(boot,200);});return{name:"feature:poll-overlay",showOverlay:showVideoOverlay,hideOverlay:hideVideoOverlay};});BTFW.define("feature:notify",[],async () =>{const $ = (s,r=document) => r.querySelector(s);const ENTITY_DECODER = document.createElement("textarea");function decodeHtmlEntities(value){if (typeof value !== "string"){if (value == null) return "";return String(value);}if (value === "") return "";ENTITY_DECODER.innerHTML = value;return ENTITY_DECODER.value;}const LS_ENABLED = "btfw:notify:enabled";const LS_JOIN_NOTICES= "btfw:chat:joinNotices";const MAX_VISIBLE = 3;const DEFAULT_TIMEOUT= 6000;let enabled = true;try{const v = localStorage.getItem(LS_ENABLED);if (v !== null) enabled = v === "1";}catch(e){}let joinNoticesEnabled = true;try{const stored = localStorage.getItem(LS_JOIN_NOTICES);if (stored !== null) joinNoticesEnabled = stored === "1";}catch(_){}document.addEventListener("btfw:chat:joinNoticesChanged",(ev)=>{if (!ev || !ev.detail) return;joinNoticesEnabled = !!ev.detail.enabled;});document.addEventListener("btfw:themeSettings:apply",(ev)=>{const value = ev?.detail?.values?.joinNotices;if (value != null) joinNoticesEnabled = !!value;});function ensureStack(){const buf = $("#messagebuffer");if (!buf) return null;const chatWrap = $("#chatwrap");const topbar = chatWrap?.querySelector(".btfw-chat-topbar");let stack = $("#btfw-notify-stack");if (!stack){stack = document.createElement("div");stack.id = "btfw-notify-stack";stack.setAttribute("role","region");stack.setAttribute("aria-live","polite");stack.setAttribute("aria-relevant","additions");}const inTopbar = !!topbar;stack.classList.toggle("btfw-notify-stack--topbar",inTopbar);stack.classList.toggle("btfw-notify-stack--buffer",!inTopbar);if (inTopbar){if (getComputedStyle(topbar).position === "static"){topbar.style.position = "relative";}if (stack.parentElement !== topbar) topbar.appendChild(stack);}else{const cs = getComputedStyle(buf);if (cs.position === "static") buf.style.position = "relative";if (stack.parentElement !== buf) buf.appendChild(stack);const first = buf.firstElementChild;if (first && first !== stack) buf.insertBefore(stack,first);}return stack;}function observeChat(){const cw = $("#chatwrap");if (!cw || cw._btfw_notify_obs) return;cw._btfw_notify_obs = true;new MutationObserver(() => ensureStack()).observe(cw,{childList:true,subtree:true});}const visible = [];const queued = [];function showNextFromQueue(){if (queued.length && visible.length < MAX_VISIBLE){const next = queued.shift();_mount(next);}}function notify(opts){if (!enabled) return null;const o = Object.assign({id:"n_"+Math.random().toString(36).slice(2),title:"",html:"",icon:"",kind:"info",timeout:DEFAULT_TIMEOUT,onClick:null,actions:[]},opts||{});o.el = buildCard(o);if (visible.length >= MAX_VISIBLE) queued.push(o);else _mount(o);return o;}function _mount(o){const stack = ensureStack();if (!stack){queued.push(o);return;}visible.push(o);stack.appendChild(o.el);if (o.timeout > 0){o.el.classList.add('btfw-notice--timed');startAutoclose(o);}else{o.el.classList.remove('btfw-notice--timed');const timer = o.el.querySelector('.btfw-notice-timer');if (timer) timer.remove();const progress = o.el.querySelector('.btfw-notice-progress');if (progress) progress.remove();}}function buildCard(o){const card = document.createElement("div");card.className = `btfw-notice btfw-notice--${o.kind}`;card.setAttribute("role","status");card.setAttribute("aria-live","polite");const shell = document.createElement("div");shell.className = "btfw-notice-shell";const iconWrap = document.createElement("div");iconWrap.className = "btfw-notice-iconwrap";if (o.icon){const icon = document.createElement("span");icon.className = "btfw-notice-icon";icon.innerHTML = o.icon;iconWrap.appendChild(icon);}else{iconWrap.classList.add("is-empty");}shell.appendChild(iconWrap);const content = document.createElement("div");content.className = "btfw-notice-content";const header = document.createElement("div");header.className = "btfw-notice-header";const title = document.createElement("strong");title.className = "btfw-notice-title";title.textContent = o.title || "";const closeBtn = document.createElement("button");closeBtn.className = "btfw-notice-close";closeBtn.type = "button";closeBtn.setAttribute("aria-label","Close");closeBtn.innerHTML = "&times;";header.appendChild(title);header.appendChild(closeBtn);content.appendChild(header);const body = document.createElement("div");body.className = "btfw-notice-body";if (o.html) body.innerHTML = o.html;content.appendChild(body);if (o.actions && o.actions.length){const row = document.createElement("div");row.className = "btfw-notice-actions";o.actions.forEach(a=>{const b = document.createElement("button");b.className = "btfw-notice-cta";b.type = "button";b.textContent = a.label || "Action";b.addEventListener("click",(ev)=>{ev.stopPropagation();a.onclick && a.onclick(ev);});row.appendChild(b);});content.appendChild(row);}if (o.timeout > 0){const timer = document.createElement("p");timer.className = "btfw-notice-timer";const label = document.createElement("span");label.className = "btfw-notice-timer-label";label.innerHTML = `This message will close in <span class="btfw-notice-timer-remaining"></span> seconds.`;const stop = document.createElement("button");stop.type = "button";stop.className = "btfw-notice-stop";stop.textContent = "Click to stop.";timer.appendChild(label);timer.appendChild(stop);content.appendChild(timer);}shell.appendChild(content);card.appendChild(shell);const progress = document.createElement("div");progress.className = "btfw-notice-progress";const bar = document.createElement("div");progress.appendChild(bar);card.appendChild(progress);card.addEventListener("click",(ev)=>{if (ev.target.closest(".btfw-notice-close")){ev.preventDefault();ev.stopPropagation();close(o);return;}if (typeof o.onClick === "function") o.onClick(ev);});card.addEventListener("mouseenter",()=> pause(o));card.addEventListener("mouseleave",()=> resume(o));return card;}function startAutoclose(o){const bar = o.el.querySelector(".btfw-notice-progress > div");const timer = o.el.querySelector(".btfw-notice-timer");const label = o.el.querySelector(".btfw-notice-timer-label");const remainingNode = o.el.querySelector(".btfw-notice-timer-remaining");const stopBtn = o.el.querySelector(".btfw-notice-stop");const state ={total:Math.max(0,o.timeout),remaining:Math.max(0,o.timeout),paused:false,manual:false,lastTick:Date.now(),lastDisplayedSecs:-1,intervalId:0,bar,label,timer,remainingNode};function render(){if (state.bar){const pct = state.total > 0 ? Math.max(0,Math.min(1,state.remaining / state.total)):0;state.bar.style.transform = `scaleX(${pct})`;}if (state.remainingNode){const secs = state.total > 0 ? Math.max(0,Math.ceil(state.remaining / 1000)):0;if (secs !== state.lastDisplayedSecs){state.remainingNode.textContent = String(secs);state.lastDisplayedSecs = secs;}}}render();state.intervalId = window.setInterval(()=>{if (state.manual || state.paused){state.lastTick = Date.now();return;}const now = Date.now();const dt = now - state.lastTick;state.lastTick = now;state.remaining = Math.max(0,state.remaining - dt);render();if (state.remaining <= 0){clearInterval(state.intervalId);state.intervalId = 0;close(o);}},140);o._state = state;if (stopBtn){stopBtn.addEventListener("click",(ev)=>{ev.preventDefault();ev.stopPropagation();if (state.manual) return;state.manual = true;state.paused = true;if (state.intervalId){clearInterval(state.intervalId);state.intervalId = 0;}o.el.classList.add("btfw-notice--pinned");if (state.timer) state.timer.classList.add("is-stopped");if (state.label) state.label.textContent = "Timer stopped.";if (state.remainingNode) state.remainingNode.textContent = "0";stopBtn.remove();},{once:true});}}function pause(o){const s=o._state;if (s){s.paused = true;s.lastTick = Date.now();}}function resume(o){const s=o._state;if (s && !s.manual){s.paused = false;s.lastTick = Date.now();}}function close(o){if (o._closed) return;o._closed = true;if (o._state?.intervalId) clearInterval(o._state.intervalId);o._state = null;if (o.el && o.el.parentNode){o.el.classList.add("btfw-notice--leaving");setTimeout(()=>{try{o.el.remove();}catch(_){};},160);}const i = visible.indexOf(o);if (i>=0) visible.splice(i,1);showNextFromQueue();}function closeAll(){visible.slice().forEach(close);queued.length=0;}const api ={notify,info:p => notify(Object.assign({kind:"info"},p||{})),success:p => notify(Object.assign({kind:"success"},p||{})),warn:p => notify(Object.assign({kind:"warn"},p||{})),error:p => notify(Object.assign({kind:"error"},p||{})),closeAll,setEnabled(v){enabled=!!v;try{localStorage.setItem(LS_ENABLED,enabled?"1":"0");}catch(e){}if(!enabled) closeAll();},isEnabled(){return !!enabled;}};const seen = new Map();function postOnce(key,ttlMs,builder){const now = Date.now();const exp = seen.get(key)||0;if (exp > now) return;seen.set(key,now + (ttlMs||1500));builder();}let socketWired = false;function wireSocketOnce(){if (socketWired) return;if (!window.socket || typeof window.socket.on !== "function") return;socketWired = true;try{const scheduleNowPlaying = (payload) =>{const direct = titleFromData(payload);if (direct){return postNowPlayingToast(direct);}const attemptFallback = (remaining,delay = 200) =>{if (remaining <= 0) return;setTimeout(() =>{const fallback = titleFromAnywhere();if (fallback && fallback !== "New media"){postNowPlayingToast(fallback);}else{attemptFallback(remaining - 1,delay);}},delay);};attemptFallback(3);};socket.on("changeMedia",scheduleNowPlaying);socket.on("setCurrent",scheduleNowPlaying);}catch(_){}try{socket.on("newPoll",(p)=>{const title = (p && p.title) ? String(p.title):"A new poll started";postOnce("poll:"+title,2000,()=>{const items = Array.isArray(p?.options) ? p.options .slice(0,4) .map(x=>`<li>${escapeHtml(decodeHtmlEntities(String(x)))}</li>`) .join(""):"";api.info({title:"Poll started",html:`<div class="poll-title">${escapeHtml(decodeHtmlEntities(title))}</div>${items?`<ul class="poll-opts">${items}</ul>`:""}`,icon:"ðŸ“Š"});});});}catch(_){}try{socket.on("addUser",(u)=>{const name = (u && (u.name || u.un)) ? (u.name || u.un):"Someone";if (!joinNoticesEnabled) return;postOnce("join:"+name,60000,()=>{api.success({title:"Joined",html:`<b>${escapeHtml(decodeHtmlEntities(name))}</b> entered the channel`,icon:"ðŸ‘‹",timeout:3500});});});}catch(_){}}function stripNowPlayingPrefix(value){return String(value || "").replace(/^\s*(?:currently|now)\s*playing\s*[:\-]\s*/i,"").trim();}function titleFromData(d){if (!d) return "";const candidates = [ d.title,d.currenttitle,d.currentTitle,d.media?.title,d.current?.media?.title,d.queue?.media?.title,d.queue?.current?.media?.title,d.queue?.item?.title,d.item?.media?.title,d.item?.title ];for (const candidate of candidates){if (candidate != null && String(candidate).trim()){return stripNowPlayingPrefix(candidate);}}return "";}function titleFromAnywhere(){const ct = $("#currenttitle");if (ct && ct.textContent) return stripNowPlayingPrefix(ct.textContent);return "New media";}function normaliseTitleKey(title){const value = (title == null) ? "":String(title);const trimmed = value.trim();if (!trimmed) return "__unknown__";return trimmed.toLowerCase();}function postNowPlayingToast(rawTitle){const decoded = decodeHtmlEntities(rawTitle || "");const cleaned = stripNowPlayingPrefix(decoded);const display = cleaned || "New media";const key = `np:${normaliseTitleKey(display)}`;postOnce(key,1500,() =>{api.info({title:"Now playing",html:`<div class="np-title">${escapeHtml(display)}</div>`,icon:"â–¶ï¸"});});}function escapeHtml(s){return s.replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}function boot(){ensureStack();observeChat();wireSocketOnce();}if (document.readyState === "loading") document.addEventListener("DOMContentLoaded",boot);else boot();document.addEventListener("btfw:layoutReady",()=> setTimeout(boot,50));window.BTFW_notify = api;return Object.assign({name:"feature:notify"},api);});BTFW.define("feature:notification-sounds",[],async () =>{const $ = (s,r=document) => r.querySelector(s);const STORAGE_KEY = "btfw:notify:sounds:v2";const SOUND_PRESETS = [{id:"soft-chime",name:"Soft chime",duration:0.8,steps:[{type:"sine",frequency:660,duration:0.28,attack:0.012,release:0.16,level:0.9},{type:"triangle",frequency:880,duration:0.26,delay:0.05,attack:0.01,release:0.14,level:0.75}]},{id:"bright-ping",name:"Bright ping",duration:0.7,steps:[{type:"square",frequency:1250,frequencyEnd:1320,duration:0.2,attack:0.006,release:0.12,level:0.85},{type:"sine",frequency:980,frequencyEnd:880,delay:0.18,duration:0.22,attack:0.01,release:0.16,level:0.6}]},{id:"digital-pop",name:"Digital pop",duration:0.65,steps:[{type:"square",frequency:420,frequencyEnd:260,duration:0.22,attack:0.008,release:0.16,level:0.9},{type:"sawtooth",frequency:640,frequencyEnd:520,delay:0.16,duration:0.18,attack:0.012,release:0.12,level:0.7}]},{id:"harmony-rise",name:"Harmony rise",duration:1.0,steps:[{type:"sine",frequency:540,frequencyEnd:620,duration:0.32,attack:0.014,release:0.18,level:0.85},{type:"sine",frequency:720,frequencyEnd:680,delay:0.18,duration:0.34,attack:0.012,release:0.2,level:0.75},{type:"triangle",frequency:430,frequencyEnd:360,delay:0.32,duration:0.42,attack:0.018,release:0.24,level:0.65}]},{id:"airy-bell",name:"Airy bell",duration:0.9,steps:[{type:"sine",frequency:780,duration:0.28,attack:0.012,release:0.2,level:0.75},{type:"triangle",frequency:520,frequencyEnd:470,delay:0.22,duration:0.34,attack:0.018,release:0.22,level:0.7},{type:"sine",frequency:1040,delay:0.1,duration:0.2,attack:0.008,release:0.14,level:0.6}]}];const GITHUB_SOUNDS_BASE = "https://raw.githubusercontent.com/BillTube/BillTube2/master/sounds/";const MP3_SOUND_PRESETS = [{id:"boop",name:"boop",url:GITHUB_SOUNDS_BASE + "146717_2437358-lq.mp3",duration:1.0},{id:"blip",name:"blip",url:GITHUB_SOUNDS_BASE + "146718_2437358-lq.mp3",duration:1.0},{id:"dingding",name:"dingding",url:GITHUB_SOUNDS_BASE + "264447_4322723-lq.mp3",duration:2.0},{id:"nyan",name:"nyan",url:GITHUB_SOUNDS_BASE + "336012_5953264-lq.mp3",duration:2.0},{id:"knocks",name:"knocks",url:GITHUB_SOUNDS_BASE + "383757_7146007-lq.mp3",duration:5.0},{id:"scary",name:"scary",url:GITHUB_SOUNDS_BASE + "419673_1904290-lq.mp3",duration:1.0},{id:"ping",name:"ping",url:GITHUB_SOUNDS_BASE + "506052_10991815-lq.mp3",duration:1.0}];SOUND_PRESETS.push(...MP3_SOUND_PRESETS);const SOUND_LOOKUP = new Map(SOUND_PRESETS.map(p => [p.id,p]));const EVENT_CONFIG = [{key:"join",title:"Someone joins",description:"Play a sound when a new viewer enters the channel.",muteLabel:"Mute join sound"},{key:"mention",title:"You are mentioned",description:"Alert me when my username appears in chat.",muteLabel:"Mute mention sound"},{key:"poll",title:"Poll starts",description:"Play an audible cue whenever a new poll opens.",muteLabel:"Mute poll sound"},{key:"video",title:"New video",description:"Notify me when playback switches to a new video.",muteLabel:"Mute video sound"}];const DEFAULTS ={join:{muted:true,volume:0.6,sound:"soft-chime"},mention:{muted:false,volume:0.75,sound:"blip"},poll:{muted:false,volume:0.85,sound:"knocks"},video:{muted:true,volume:0.65,sound:"airy-bell"}};const scratch = document.createElement("div");const dedupe = new Map();const ui = new Map();let liveSettings = loadSettings();let draftSettings = cloneSettings(liveSettings);let audioCtx = null;const audioBufferCache = new Map();function getAudioCtor(){return window.AudioContext || window.webkitAudioContext || null;}function ensureAudioContext(){if (audioCtx) return audioCtx;const Ctor = getAudioCtor();if (!Ctor) return null;try{audioCtx = new Ctor();}catch (_){audioCtx = null;}return audioCtx;}function resumeAudio(){const ctx = ensureAudioContext();if (!ctx) return null;if (ctx.state === "suspended"){ctx.resume().catch(()=>{});}return ctx;}function clamp01(value){const n = Number(value);if (!Number.isFinite(n)) return 0;return Math.min(Math.max(n,0),1);}function sanitizeSetting(key,value){const base = DEFAULTS[key];const obj = value && typeof value === "object" ? value:{};const soundId = SOUND_LOOKUP.has(obj.sound) ? obj.sound:base.sound;const volume = clamp01(obj.volume != null ? obj.volume:base.volume);const muted = obj.muted != null ? !!obj.muted:!!base.muted;return{muted,volume,sound:soundId};}function cloneSettings(source){const result ={};EVENT_CONFIG.forEach(cfg =>{const current = source && source[cfg.key];result[cfg.key] = sanitizeSetting(cfg.key,current);});return result;}function loadSettings(){try{const raw = localStorage.getItem(STORAGE_KEY);if (!raw) return cloneSettings(DEFAULTS);const parsed = JSON.parse(raw);return cloneSettings(parsed);}catch (_){return cloneSettings(DEFAULTS);}}function persist(settings){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(settings));}catch (_){}}function scheduleOscStep(ctx,destination,baseTime,step,volume){const delay = Math.max(0,Number(step.delay) || 0);const start = baseTime + delay;const duration = Math.max(0.08,Number(step.duration) || 0.2);const attack = Math.max(0.004,Math.min(step.attack != null ? step.attack:0.01,duration * 0.6));const release = Math.max(0.04,Math.min(step.release != null ? step.release:0.12,duration));const sustain = Math.max(0,duration - attack - release);const peak = clamp01(volume) * clamp01(step.level != null ? step.level:1);const osc = ctx.createOscillator();osc.type = step.type || "sine";const freq = Number(step.frequency) || 440;osc.frequency.setValueAtTime(freq,start);if (typeof step.frequencyEnd === "number" && step.frequencyEnd !== freq){osc.frequency.linearRampToValueAtTime(step.frequencyEnd,start + duration);}const gain = ctx.createGain();gain.gain.setValueAtTime(0.0001,start);gain.gain.linearRampToValueAtTime(peak,start + attack);if (sustain > 0){gain.gain.setValueAtTime(peak,start + attack + sustain);}gain.gain.linearRampToValueAtTime(0.0001,start + duration);osc.connect(gain);gain.connect(destination);const stopAt = start + duration + (step.tail != null ? step.tail:0.08);osc.start(start);osc.stop(stopAt);const cleanupDelay = Math.max(0,(stopAt - ctx.currentTime + 0.25) * 1000);setTimeout(() =>{try{gain.disconnect();}catch (_){}try{osc.disconnect();}catch (_){}},cleanupDelay);return stopAt;}async function loadAudioBuffer(url){if (audioBufferCache.has(url)) return audioBufferCache.get(url);const ctx = ensureAudioContext();if (!ctx) return null;try{const response = await fetch(url);if (!response.ok) throw new Error(`HTTP ${response.status}`);const arrayBuffer = await response.arrayBuffer();const audioBuffer = await ctx.decodeAudioData(arrayBuffer);audioBufferCache.set(url,audioBuffer);return audioBuffer;}catch (error){console.error(`Failed to load sound from ${url}:`,error);return null;}}function playAudioBuffer(buffer,volume){const ctx = resumeAudio();if (!ctx || !buffer) return;const source = ctx.createBufferSource();source.buffer = buffer;const gainNode = ctx.createGain();gainNode.gain.value = clamp01(volume);source.connect(gainNode);gainNode.connect(ctx.destination);source.start(0);setTimeout(() =>{try{gainNode.disconnect();}catch (_){}},(buffer.duration + 0.1) * 1000);}async function playPresetById(id,volume){const preset = SOUND_LOOKUP.get(id) || SOUND_PRESETS[0];if (!preset) return;if (preset.url){const buffer = await loadAudioBuffer(preset.url);if (buffer) playAudioBuffer(buffer,volume);return;}const ctx = resumeAudio();if (!ctx) return;const master = ctx.createGain();master.gain.value = clamp01(volume);master.connect(ctx.destination);const base = ctx.currentTime + 0.02;let maxStop = base;preset.steps.forEach(step =>{maxStop = Math.max(maxStop,scheduleOscStep(ctx,master,base,step,master.gain.value));});const cleanupDelay = Math.max(0,(maxStop - ctx.currentTime + 0.35) * 1000);setTimeout(() =>{try{master.disconnect();}catch (_){}},cleanupDelay);}function throttle(key,ttlMs){const now = Date.now();const expires = dedupe.get(key) || 0;if (expires > now) return true;dedupe.set(key,now + (ttlMs || 1000));return false;}function plainText(html){if (!html) return "";scratch.innerHTML = String(html);const text = scratch.textContent || scratch.innerText || "";scratch.textContent = "";return text;}function getOwnName(){try{if (window.CLIENT && typeof CLIENT.name === "string") return CLIENT.name;}catch (_){}return "";}function containsMention(text,name){if (!text || !name) return false;const lowerText = text.toLowerCase();const lowerName = name.toLowerCase();if (!lowerText.includes(lowerName)) return false;let idx = lowerText.indexOf(lowerName);while (idx !== -1){const before = idx === 0 ? " ":lowerText[idx - 1];const afterIndex = idx + lowerName.length;const after = afterIndex >= lowerText.length ? " ":lowerText[afterIndex];const beforeOk = !/[a-z0-9_]/i.test(before);const afterOk = !/[a-z0-9_]/i.test(after);if (beforeOk && afterOk) return true;idx = lowerText.indexOf(lowerName,idx + lowerName.length);}return false;}function shouldPlay(key){const cfg = liveSettings[key];if (!cfg) return false;if (cfg.muted) return false;if (!(cfg.volume > 0)) return false;if (!SOUND_LOOKUP.has(cfg.sound)) return false;return true;}function triggerSound(key){if (!shouldPlay(key)) return;const cfg = liveSettings[key];playPresetById(cfg.sound,cfg.volume);}function handleUserJoin(payload){if (!payload) return;const name = (payload.name || payload.un || "").trim();if (!name) return;if (name === getOwnName()) return;if (throttle("join:" + name.toLowerCase(),60000)) return;triggerSound("join");}function handleChatMessage(payload){if (!shouldPlay("mention")) return;const name = getOwnName();if (!name) return;if (payload && (payload.username === name || payload.name === name)) return;const text = plainText(payload && payload.msg);if (!containsMention(text,name)) return;if (throttle("mention:" + text.slice(0,40),1200)) return;triggerSound("mention");}function pollKey(poll){if (!poll || typeof poll !== "object") return "poll:?";const id = poll.id ?? poll.pollId ?? poll.pollID ?? poll.poll_id ?? poll.uid;if (id != null) return "poll:" + String(id);if (poll.title) return "poll:" + String(poll.title);return "poll:?";}function handlePoll(poll){const key = pollKey(poll);if (throttle(key,2500)) return;triggerSound("poll");}function mediaKey(media){if (!media || typeof media !== "object") return "media:?";const candidate = media.id ?? media.uid ?? media.guid ?? media.media?.id ?? media.media?.uid ?? media.media?.vid;if (candidate != null) return "media:" + String(candidate);if (media.media && media.media.title) return "media:" + String(media.media.title);if (media.title) return "media:" + String(media.title);return "media:?";}function handleMediaChange(media){if (!shouldPlay("video")) return;const key = mediaKey(media);if (throttle(key,2000)) return;triggerSound("video");}const socketState ={wired:false,socketRef:null,teardown:null,retryTimer:null};function detachSocket(){if (typeof socketState.teardown === "function"){try{socketState.teardown();}catch (_){}}socketState.teardown = null;socketState.wired = false;socketState.socketRef = null;}function wireSocketWatchers(){const sock = window.socket;if (socketState.socketRef && socketState.socketRef !== sock){detachSocket();}if (socketState.wired) return;if (!sock || typeof sock.on !== "function"){if (!socketState.retryTimer){socketState.retryTimer = setTimeout(() =>{socketState.retryTimer = null;wireSocketWatchers();},1000);}return;}const handlers = new Map([ ["addUser",handleUserJoin],["chatMsg",handleChatMessage],["newPoll",handlePoll],["changeMedia",handleMediaChange] ]);try{handlers.forEach((handler,event) =>{sock.on(event,handler);});}catch (_){if (!socketState.retryTimer){socketState.retryTimer = setTimeout(() =>{socketState.retryTimer = null;wireSocketWatchers();},1000);}return;}if (socketState.retryTimer){clearTimeout(socketState.retryTimer);socketState.retryTimer = null;}socketState.wired = true;socketState.socketRef = sock;socketState.teardown = () =>{handlers.forEach((handler,event) =>{if (typeof sock.off === "function"){try{sock.off(event,handler);}catch (_){}}else if (typeof sock.removeListener === "function"){try{sock.removeListener(event,handler);}catch (_){}}});};}function ensurePanel(){const container = $("#btfw-notify-sounds-body");if (!container || container._btfwNotifySounds) return;container._btfwNotifySounds = true;const audioSupported = !!getAudioCtor();const list = document.createElement("div");list.className = "btfw-notify-sound-list";EVENT_CONFIG.forEach(cfg =>{const row = buildRow(cfg);list.appendChild(row);});container.appendChild(list);if (!audioSupported){const warn = document.createElement("p");warn.className = "btfw-help";warn.textContent = "Your browser does not support the Web Audio API,so notification sounds cannot play.";container.appendChild(warn);}}function buildRow(cfg){const row = document.createElement("div");row.className = "btfw-notify-sound";row.dataset.notifyKey = cfg.key;const meta = document.createElement("div");meta.className = "btfw-notify-sound__meta";const title = document.createElement("h4");title.textContent = cfg.title;const desc = document.createElement("p");desc.textContent = cfg.description;meta.appendChild(title);meta.appendChild(desc);row.appendChild(meta);const controls = document.createElement("div");controls.className = "btfw-notify-sound__controls";const soundWrap = document.createElement("div");soundWrap.className = "btfw-ts-control";const soundLabel = document.createElement("label");soundLabel.className = "btfw-input__label";const soundId = `btfw-notify-${cfg.key}-sound`;soundLabel.setAttribute("for",soundId);soundLabel.textContent = "Sound";const soundSelectWrap = document.createElement("div");soundSelectWrap.className = "select is-small";const soundSelect = document.createElement("select");soundSelect.id = soundId;SOUND_PRESETS.forEach(preset =>{const opt = document.createElement("option");opt.value = preset.id;opt.textContent = preset.name;soundSelect.appendChild(opt);});soundSelectWrap.appendChild(soundSelect);soundWrap.appendChild(soundLabel);soundWrap.appendChild(soundSelectWrap);controls.appendChild(soundWrap);const volumeWrap = document.createElement("div");volumeWrap.className = "btfw-notify-volume";const volumeLabel = document.createElement("span");volumeLabel.className = "btfw-input__label";volumeLabel.textContent = "Volume";const volumeRangeWrap = document.createElement("div");volumeRangeWrap.className = "btfw-notify-volume-range";const volumeInput = document.createElement("input");volumeInput.type = "range";volumeInput.min = "0";volumeInput.max = "100";volumeInput.step = "5";volumeInput.id = `btfw-notify-${cfg.key}-volume`;const volumeValue = document.createElement("span");volumeValue.className = "btfw-notify-volume-value";volumeValue.textContent = "100%";volumeRangeWrap.appendChild(volumeInput);volumeRangeWrap.appendChild(volumeValue);volumeWrap.appendChild(volumeLabel);volumeWrap.appendChild(volumeRangeWrap);controls.appendChild(volumeWrap);const muteLabel = document.createElement("label");muteLabel.className = "checkbox btfw-checkbox";const muteInput = document.createElement("input");muteInput.type = "checkbox";muteInput.id = `btfw-notify-${cfg.key}-mute`;const muteText = document.createElement("span");muteText.textContent = cfg.muteLabel;muteLabel.appendChild(muteInput);muteLabel.appendChild(muteText);controls.appendChild(muteLabel);const previewBtn = document.createElement("button");previewBtn.type = "button";previewBtn.className = "button is-small is-link btfw-notify-preview";previewBtn.textContent = "Preview";controls.appendChild(previewBtn);row.appendChild(controls);ui.set(cfg.key,{row,soundSelect,volumeInput,volumeValue,muteInput,previewBtn});soundSelect.addEventListener("change",() =>{const state = draftSettings[cfg.key];if (!state) return;state.sound = SOUND_LOOKUP.has(soundSelect.value) ? soundSelect.value:state.sound;});volumeInput.addEventListener("input",() =>{const state = draftSettings[cfg.key];if (!state) return;const vol = clamp01(Number(volumeInput.value) / 100);state.volume = vol;volumeValue.textContent = `${Math.round(vol * 100)}%`;});muteInput.addEventListener("change",() =>{const state = draftSettings[cfg.key];if (!state) return;state.muted = !!muteInput.checked;row.classList.toggle("is-muted",state.muted);});previewBtn.addEventListener("click",(ev) =>{ev.preventDefault();const state = draftSettings[cfg.key];if (!state) return;const sound = SOUND_LOOKUP.has(state.sound) ? state.sound:DEFAULTS[cfg.key].sound;const vol = clamp01(state.volume != null ? state.volume:DEFAULTS[cfg.key].volume);playPresetById(sound,vol || 0.5);});return row;}function syncUI(){EVENT_CONFIG.forEach(cfg =>{const state = draftSettings[cfg.key];const refs = ui.get(cfg.key);if (!state || !refs) return;refs.soundSelect.value = SOUND_LOOKUP.has(state.sound) ? state.sound:DEFAULTS[cfg.key].sound;const vol = clamp01(state.volume != null ? state.volume:DEFAULTS[cfg.key].volume);refs.volumeInput.value = String(Math.round(vol * 100));refs.volumeValue.textContent = `${Math.round(vol * 100)}%`;refs.muteInput.checked = !!state.muted;refs.row.classList.toggle("is-muted",!!state.muted);});}function onThemeOpen(){ensurePanel();draftSettings = cloneSettings(liveSettings);syncUI();resumeAudio();}function applyDraft(){liveSettings = cloneSettings(draftSettings);persist(liveSettings);draftSettings = cloneSettings(liveSettings);syncUI();document.dispatchEvent(new CustomEvent("btfw:notificationSounds:changed",{detail:{settings:cloneSettings(liveSettings)}}));}document.addEventListener("btfw:themeSettings:open",onThemeOpen);document.addEventListener("btfw:themeSettings:apply",applyDraft);document.addEventListener("click",resumeAudio,{once:true});document.addEventListener("keydown",resumeAudio,{once:true});wireSocketWatchers();document.addEventListener("btfw:ready",() => setTimeout(wireSocketWatchers,0));return{getSettings(){return cloneSettings(liveSettings);},preview(key){const cfg = liveSettings[key];if (!cfg) return;playPresetById(cfg.sound,cfg.volume);}};});BTFW.define('feature:syncGuard',[],async ()=>({name:'feature:syncGuard',disabled:true}));BTFW.define("feature:local-subs",[],async () =>{const $ = (s,r=document)=>r.querySelector(s);const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));function getMediaType(){try{return window.PLAYER?.mediaType || null;}catch(_){return null;}}function isDirectMedia(){const type = (getMediaType() || "").toLowerCase();return type === "fi" || type === "gd";}function convertSRTtoVTT(srt){return "WEBVTT\n\n" + String(srt) .replace(/\r+/g,"") .replace(/^\d+\s+|\n\d+\s+/g,"") .replace(/(\d{2}):(\d{2}):(\d{2}),(\d{3})/g,"$1:$2:$3.$4");}function vttURLFromContent(txt){const blob = new Blob([txt],{type:"text/vtt"});return URL.createObjectURL(blob);}function removeOldTracksFromVideoEl(video){try{const tracks = video.querySelectorAll("track[kind='subtitles'],track[kind='captions']");tracks.forEach(t => t.remove());}catch(_){}}function addTrackToVideoEl(video,src,label="Subtitles"){const t = document.createElement("track");t.kind = "subtitles";t.src = src;t.label= label;t.default = true;video.appendChild(t);}function getVideoJS(){try{return (window.videojs && videojs("ytapiplayer")) || null;}catch(_){return null;}}function removeOldTracksFromVJS(vjs){try{const list = vjs.remoteTextTracks();for (let i = list.length - 1;i >= 0;i--){vjs.removeRemoteTextTrack(list[i]);}}catch(_){}}function addTrackToVJS(vjs,src,label="Subtitles"){try{vjs.addRemoteTextTrack({kind:"subtitles",src,default:true,label},false);}catch(_){}}function getActiveHTML5Video(){const v = $("#ytapiplayer video") || $("video");return v || null;}function pickAndLoad(){let input = $("#btfw-localsubs-input");if (!input){input = document.createElement("input");input.type = "file";input.accept = ".vtt,.srt";input.id = "btfw-localsubs-input";input.style.display = "none";document.body.appendChild(input);input.addEventListener("change",async (e)=>{const file = e.target.files && e.target.files[0];if (!file) return;const reader = new FileReader();reader.onload = function(ev){let text = String(ev.target.result || "");if (file.name.toLowerCase().endsWith(".srt")){text = convertSRTtoVTT(text);}const url = vttURLFromContent(text);const vjs = getVideoJS();if (vjs){removeOldTracksFromVJS(vjs);addTrackToVJS(vjs,url,file.name);}else{const video = getActiveHTML5Video();if (video){removeOldTracksFromVideoEl(video);addTrackToVideoEl(video,url,file.name);}else{console.warn("[local-subs] No compatible video element found.");}}};reader.readAsText(file);e.target.value = "";});}input.click();}function updateButtonVisibility(){const btn = $("#btfw-btn-localsubs");if (!btn) return;btn.style.display = isDirectMedia() ? "":"none";}function injectButton(){const overlay = $("#VideoOverlay");if (!overlay) return;let btn = $("#btfw-btn-localsubs");if (!btn){btn = document.createElement("button");btn.id = "btfw-btn-localsubs";btn.className = "button is-dark is-small btfw-vo-btn";btn.title = "Local Subtitles (VTT/SRT)";btn.innerHTML = `<i class="fa fa-closed-captioning"></i>`;btn.addEventListener("click",pickAndLoad);overlay.querySelector(".btfw-vo-buttons")?.appendChild(btn) || overlay.appendChild(btn);}updateButtonVisibility();}function wireChangeMedia(){try{if (window.socket && socket.on && !window._btfw_localsubs_wired){window._btfw_localsubs_wired = true;socket.on("changeMedia",()=>{const vjs = getVideoJS();if (vjs) removeOldTracksFromVJS(vjs);const v = getActiveHTML5Video();if (v) removeOldTracksFromVideoEl(v);setTimeout(updateButtonVisibility,0);});}}catch(_){}}function boot(){wireChangeMedia();injectButton();updateButtonVisibility();// Watch for overlay mount/remount const mo = new MutationObserver(()=>{injectButton();updateButtonVisibility();});mo.observe(document.body,{childList:true,subtree:true});}if (document.readyState === "loading") document.addEventListener("DOMContentLoaded",boot);else boot();return{name:"feature:local-subs"};});BTFW.define("feature:billcast",[],async () =>{const KEY = "btfw:billcast:enabled";// persisted toggle const BASE = (window.BTFW && BTFW.BASE ? BTFW.BASE.replace(/\/+$/,""):"");const SRC = BASE + "/modules/feature-billcaster.js";function getMediaType(){try{return window.PLAYER?.mediaType || null;}catch (_){return null;}}function isDirectMedia(){const type = (getMediaType() || "").toLowerCase();return type === "fi" || type === "gd";}function isEnabled(){try{const v = localStorage.getItem(KEY);return (v === null) ? true:v === "1";// default ON}catch (_){return true;}}function setEnabled(on){try{localStorage.setItem(KEY,on ? "1":"0");}catch(_){}}function loadScriptOnce(){return new Promise((resolve,reject) =>{if (window.__BTFW_BILLCAST_LOADED) return resolve(true);const s = document.createElement("script");s.src = SRC;s.async = true;s.defer = true;s.onload = () =>{window.__BTFW_BILLCAST_LOADED = true;resolve(true);};s.onerror = () => reject(new Error("Failed to load " + SRC));document.head.appendChild(s);});}async function enable(){if (window.__BTFW_BILLCAST_LOADED) return true;try{await loadScriptOnce();console.log("[billcast] loaded");return true;}catch (e){console.warn("[billcast] load failed:",e && e.message || e);return false;}}function disable(){// We can't safely unload the Cast sender once injected,// but we can hide/remove UI bits created by billcast.js. const castBtn = document.getElementById("castButton");const fbBtn = document.getElementById("fallbackButton");if (castBtn) castBtn.remove();if (fbBtn) fbBtn.remove();console.log("[billcast] disabled (UI hidden;script not reloaded again)");}// Theme Settings integration (expects your TS to dispatch this with values.billcastEnabled) function onThemeApply(ev){const values = ev && ev.detail && ev.detail.values ||{};if (typeof values.billcastEnabled === "boolean"){setEnabled(values.billcastEnabled);applyMediaState();}}function applyMediaState(){if (!isEnabled()){disable();return;}if (isDirectMedia()){enable();}else{disable();}}function boot(){document.addEventListener("btfw:themeSettings:apply",onThemeApply);applyMediaState();try{if (window.socket && typeof socket.on === "function"){socket.on("changeMedia",() =>{setTimeout(() => applyMediaState(),0);});}}catch (_){}}if (document.readyState === "loading"){document.addEventListener("DOMContentLoaded",boot);}else{boot();}return{name:"feature:billcast",enable,disable};});$(document).ready(function (){var session = null;var castPlayer = null;var CHECK_INTERVAL = 120000;var SYNC_THRESHOLD = 20;var player = null;var castAvailable = false;var syncInterval = null;function getMediaType(){try{return window.PLAYER && window.PLAYER.mediaType || null;}catch (err){return null;}}function isDirectMedia(){var type = getMediaType();if (typeof type === 'string'){type = type.toLowerCase();if (type === 'fi' || type === 'gd') return true;if (type) return false;}if (typeof getCurrentVideoSrc === 'function'){var src = getCurrentVideoSrc();if (typeof src === 'string' && src.length){var lower = src.toLowerCase();if (lower.indexOf('youtube.com') !== -1 || lower.indexOf('youtu.be') !== -1){return false;}return /(\.mp4|\.webm|\.ogg|\.ogv|\.mov)([#?]|$)/.test(lower);}}return false;}function $overlay(){var $o = $('#btfw-video-overlay');if ($o.length) return $o;$o = $('#VideoOverlay');if ($o.length) return $o;var $vw = $('#videowrap');if ($vw.length){$o = $('<div id="btfw-video-overlay" class="btfw-video-overlay"></div>') .css({position:'absolute',inset:0,'pointer-events':'none'}) .appendTo($vw);return $o;}return $();}function $voBar(){var $b = $('#btfw-vo-bar');if ($b.length) return $b;var $ov = $overlay();if ($ov.length){$b = $('<div id="btfw-vo-bar" class="btfw-vo-bar"></div>') .css({position:'absolute',top:'8px',right:'8px',left:'8px',display:'flex','justify-content':'space-between',gap:'6px','pointer-events':'none','z-index':1000}) .appendTo($ov);return $b;}return $();}function $voSection(side){var id = side === 'left' ? 'btfw-vo-left':'btfw-vo-right';var cls = 'btfw-vo-section btfw-vo-section--' + side;var $section = $('#' + id);if ($section.length) return $section;var $bar = $voBar();if (!$bar.length) return $();$section = $('<div></div>') .attr('id',id) .addClass(cls) .css({display:'flex','pointer-events':'auto',gap:'6px','flex-wrap':'wrap'});if (side === 'left'){$bar.prepend($section);}else{$bar.append($section);}$bar.attr('data-left-section','#btfw-vo-left');$bar.attr('data-right-section','#btfw-vo-right');return $section;}function whenVoBarReady(fn){if ($voBar().length) return fn();var mo = new MutationObserver(function (){if ($voBar().length){mo.disconnect();fn();}});mo.observe(document.body,{childList:true,subtree:true});}function initializePlayer(){if ($('#ytapiplayer').length){player = videojs('ytapiplayer');attachPlayerEventListeners();updateCastButtonVisibility();}else{setTimeout(initializePlayer,500);}}function attachPlayerEventListeners(){if (!player) return;player.on('play',function (){if (session && castPlayer && castPlayer.playerState !== chrome.cast.media.PlayerState.PLAYING){castPlayer.play( function (){console.log('Cast player resumed');},function (error){console.error('Error playing cast player:',error);});}});player.on('pause',function (){if (session && castPlayer && castPlayer.playerState !== chrome.cast.media.PlayerState.PAUSED){castPlayer.pause(function (error){console.error('Error pausing cast player:',error);});}});player.on('seeked',function (){if (session && castPlayer){var currentTime = player.currentTime();if (castPlayer && castPlayer.sessionId === session.getSessionId()){var seekRequest = new chrome.cast.media.SeekRequest();seekRequest.currentTime = currentTime;castPlayer.seek(seekRequest,function (){console.log('Cast player synced after seek');},function (error){console.error('Error syncing cast player after seek:',error);});}else{console.error('Cannot seek:Invalid cast player session.');}}});player.on('loadstart',function (){stopSync();});player.on('loadeddata',function (){startSync();if (session) castCurrentVideo(0);updateCastButtonVisibility();});}function createCastButton(){if ($('#btfw-vo-cast').length) return $('#btfw-vo-cast');var $btn = $( '<button id="btfw-vo-cast" ' + 'class="btn btn-sm btn-default btfw-vo-adopted" ' + 'title="Cast to device" data-btfw-overlay="1">' + '<i class="fa-brands fa-chromecast"></i>' + '</button>' );$btn.on('click',function (){try{cast.framework.CastContext.getInstance().requestSession();}catch (e){alert('Cast framework not ready.');}});return $btn;}function createFallbackButton(){if ($('#btfw-vo-cast-fallback').length) return $('#btfw-vo-cast-fallback');var $btn = $( '<button id="btfw-vo-cast-fallback" ' + 'class="btn btn-sm btn-default btfw-vo-adopted" ' + 'title="Casting not available" data-btfw-overlay="1">' + '<i class="fa-solid fa-circle-info"></i>' + '</button>' );$btn.on('click',function (){alert('Casting is not available in this browser. Please use Google Chrome for casting.');});return $btn;}function initializeCastButton(){var $left = $voSection('left');if (!$left.length){whenVoBarReady(initializeCastButton);return;}$('#btfw-vo-cast,#btfw-vo-cast-fallback').remove();var $btn = castAvailable ? createCastButton():createFallbackButton();if (!$btn || !$btn.length) return;$left.append($btn);updateCastButtonVisibility();}function updateCastButtonVisibility(){if (!isDirectMedia()){$('#btfw-vo-cast,#btfw-vo-cast-fallback').hide();if (session) stopSync();return;}if (castAvailable){$('#btfw-vo-cast').show();$('#btfw-vo-cast-fallback').hide();if (session && !syncInterval) startSync();}else{$('#btfw-vo-cast').hide();$('#btfw-vo-cast-fallback').show();}}function initializeCastApi(){castAvailable = true;var context = cast.framework.CastContext.getInstance();context.setOptions({receiverApplicationId:chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,autoJoinPolicy:chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED});context.addEventListener( cast.framework.CastContextEventType.SESSION_STATE_CHANGED,sessionStateChanged );whenVoBarReady(initializeCastButton);}function sessionStateChanged(event){switch (event.sessionState){case cast.framework.SessionState.SESSION_STARTED:case cast.framework.SessionState.SESSION_RESUMED:{session = cast.framework.CastContext.getInstance().getCurrentSession();if (session) castPlayer = session.getMediaSession();waitForPlayer(function (){var t = (player && typeof player.currentTime === 'function') ? player.currentTime():0;castCurrentVideo(t);});startSync();break;}case cast.framework.SessionState.SESSION_ENDED:session = null;castPlayer = null;stopSync();break;}}function waitForPlayer(cb){if (player){cb();}else{setTimeout(function (){waitForPlayer(cb);},500);}}function getCurrentVideoSrc(){var $v = $('#ytapiplayer video');var $i = $('#ytapiplayer iframe');var src = null;if ($v.length > 0){src = $v.attr('src');if (!src){$v.find('source').each(function (){var s = $(this).attr('src');if (s){src = s;return false;}});}if (!src) src = $v.attr('data-src');}if (!src && $i.length > 0) src = $i.attr('src');return src;}function castCurrentVideo(currentTime){if (!session) return;var videoSrc = getCurrentVideoSrc();if (!videoSrc){console.error('Cannot cast:no video src');return;}if (!isDirectMedia()) return;var mimeType = getMimeType(videoSrc);var mediaInfo = new chrome.cast.media.MediaInfo(videoSrc,mimeType);var videoName = $('#currenttitle').text() || 'Unknown Title';var fullTitle = 'BillTube Cast:' + videoName;var metadata = new chrome.cast.media.GenericMediaMetadata();metadata.title = fullTitle;mediaInfo.metadata = metadata;var request = new chrome.cast.media.LoadRequest(mediaInfo);request.currentTime = currentTime || 0;request.autoplay = true;session.loadMedia(request).then( function (){castPlayer = session.getMediaSession();updateCastButtonVisibility();},function (error){console.error('Error loading media:',error);});}function getMimeType(url){var ext = url.split('.').pop().split(/#|\?/)[0].toLowerCase();switch (ext){case 'mp4':return 'video/mp4';case 'webm':return 'video/webm';case 'ogg':case 'ogv':return 'video/ogg';case 'mov':return 'video/quicktime';default:console.warn('Unknown extension;defaulting to video/mp4');return 'video/mp4';}}function startSync(){if (!syncInterval) syncInterval = setInterval(syncPlaybackTime,CHECK_INTERVAL);}function stopSync(){if (syncInterval){clearInterval(syncInterval);syncInterval = null;}}function syncPlaybackTime(){if (session && castPlayer && player && typeof player.currentTime === 'function'){var localTime = player.currentTime();var startTime = Date.now();castPlayer.getStatus(null,function (status){var endTime = Date.now();var latency = (endTime - startTime) / 2000;var castTime = status.currentTime + latency;if (Math.abs(localTime - castTime) > SYNC_THRESHOLD){if (castPlayer && castPlayer.sessionId === session.getSessionId()){var seekRequest = new chrome.cast.media.SeekRequest();seekRequest.currentTime = localTime;castPlayer.seek(seekRequest,function (){console.log('Cast synced to local');},function (error){console.error('Cast sync error:',error);});}else{console.error('Invalid cast session;stopping sync.');stopSync();}}});}else{stopSync();}}if (window.socket && typeof window.socket.on === 'function'){socket.on("changeMedia",function (){waitForYtapiplayer(function (){initializePlayer();if (player && typeof player.ready === 'function'){player.ready(function (){if (session) castCurrentVideo(0);updateCastButtonVisibility();});}});});}function waitForYtapiplayer(cb){if ($('#ytapiplayer').length > 0) cb();else setTimeout(function (){waitForYtapiplayer(cb);},500);}var castScript = document.createElement('script');castScript.src = 'https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1';document.head.appendChild(castScript);window['__onGCastApiAvailable'] = function (isAvailable){if (isAvailable) initializeCastApi();else{castAvailable = false;whenVoBarReady(initializeCastButton);}};$(window).on('beforeunload',function (){if (session) session.endSession(true);});initializePlayer();whenVoBarReady(initializeCastButton);});BTFW.define("feature:overlays",["core"],async function(){function mountHost(){if(document.getElementById("btfw-overlay-root")) return;var root=document.createElement("div");root.id="btfw-overlay-root";document.body.appendChild(root);}function openModal(opts){mountHost();var root=document.getElementById("btfw-overlay-root");var wrap=document.createElement("div");wrap.className="btfw-overlay";wrap.innerHTML="<div class='btfw-backdrop'></div><div class='btfw-modal'><button class='btfw-close' aria-label='Close'>&times;</button><div class='btfw-modal-body'></div></div>";var body=wrap.querySelector(".btfw-modal-body");if (opts && opts.content){if (typeof opts.content==="string") body.innerHTML=opts.content;else body.appendChild(opts.content);}function close(){wrap.remove();}wrap.querySelector(".btfw-backdrop").addEventListener("click",close);wrap.querySelector(".btfw-close").addEventListener("click",close);document.addEventListener("keydown",function esc(e){if(e.key==="Escape"){close();document.removeEventListener("keydown",esc);}});root.appendChild(wrap);return{close,el:wrap,body};}function openDrawer(opts){mountHost();var side = (opts && opts.side) || "right";var root=document.getElementById("btfw-overlay-root");var wrap=document.createElement("div");wrap.className="btfw-overlay btfw-drawer btfw-"+side;wrap.innerHTML="<div class='btfw-backdrop'></div><div class='btfw-panel'><div class='btfw-drawer-header'><span class='title'></span><button class='btfw-close'>&times;</button></div><div class='btfw-drawer-body'></div></div>";wrap.querySelector(".title").textContent = (opts && opts.title) || "";var body=wrap.querySelector(".btfw-drawer-body");if (opts && opts.content){if (typeof opts.content==="string") body.innerHTML=opts.content;else body.appendChild(opts.content);}function close(){wrap.remove();}wrap.querySelector(".btfw-backdrop").addEventListener("click",close);wrap.querySelector(".btfw-close").addEventListener("click",close);root.appendChild(wrap);return{close,el:wrap,body};}window.BTFW_overlays ={openModal,openDrawer};return{openModal,openDrawer};});BTFW.define("feature:userlistOverlay",["core","bridge"],async function(){var{ids}=BTFW.require("bridge");var isOpen=false,panel=null,stash=null;function ensurePanel(){if(panel && panel.parentNode) return panel;var chatCol = document.getElementById("btfw-chatcol") || document.body;panel = document.createElement("div");panel.className="btfw-chat-overlay";panel.style.display="none";panel.innerHTML = "<div class='btfw-chat-overlay-head'><span>Connected Users</span><button class='btfw-close'>&times;</button></div><div class='btfw-chat-overlay-body'></div>";panel.querySelector(".btfw-close").addEventListener("click",toggle);chatCol.appendChild(panel);return panel;}function open(){var map=ids();var p=ensurePanel();var body = p.querySelector(".btfw-chat-overlay-body");if (map.userList){map.userList.style.display="";stash = map.userList.parentNode;body.appendChild(map.userList);}else{body.textContent = "No user list found.";}p.style.display="block";isOpen=true;}function close(){var map=ids();if (map.userList && stash){stash.appendChild(map.userList);map.userList.style.display="none";stash=null;}if(panel) panel.style.display="none";isOpen=false;}function toggle(){isOpen?close():open();}var ul = ids().userList;if (ul) ul.style.display="none";window.BTFW_userlist ={open,close,toggle};return{open,close,toggle};});BTFW.define("feature:ratings",[],async () =>{const configuredEndpoint = [ (() =>{try{return window.BTFW_THEME_ADMIN?.integrations?.ratings?.endpoint || "";}catch (_){return "";}})(),(() =>{try{return window.BTFW_CONFIG?.ratings?.endpoint || "";}catch (_){return "";}})(),(() =>{try{return document?.body?.dataset?.btfwRatingsEndpoint || "";}catch (_){return "";}})(),(() =>{try{return window.BTFW_RATINGS_ENDPOINT || "";}catch (_){return "";}})() ].map((value) => (typeof value === "string" ? value.trim():"")) .find(Boolean) || "";const shouldLoad = configuredEndpoint.length > 0;if (!shouldLoad){try{window.BTFW_CONFIG = window.BTFW_CONFIG ||{};window.BTFW_CONFIG.shouldLoadRatings = false;}catch (_){}return{name:"feature:ratings",disabled:true};}try{window.BTFW_CONFIG = window.BTFW_CONFIG ||{};if (typeof window.BTFW_CONFIG.ratings !== "object"){window.BTFW_CONFIG.ratings ={};}if (!window.BTFW_CONFIG.ratings.endpoint){window.BTFW_CONFIG.ratings.endpoint = configuredEndpoint;}window.BTFW_CONFIG.shouldLoadRatings = true;}catch (_){}const motion = await BTFW.init("util:motion");const STAR_VALUES = [1,2,3,4,5];const DEFAULT_MIN_RANK = 1;// Require at least registered users by default;higher via BTFW_CONFIG.ratings.minRank const CHECK_INTERVAL_MS = 1200;const STATS_DEBOUNCE_MS = 400;const STATS_REFRESH_INTERVAL_MS = 20000;const MIN_MEDIA_DURATION_SECONDS = 60 * 60;const FINAL_WINDOW_SECONDS = 15 * 60;const TIME_TOLERANCE_SECONDS = 1;const PLAYBACK_POLL_INTERVAL_MS = 5000;const LS_ANON_ID_KEY = "btfw:ratings:anonid";const LS_SELF_PREFIX = "btfw:ratings:self:";// + mediaKey const state ={enabled:false,container:null,stars:[],statusNode:null,selfNode:null,errorNode:null,announcedStart:false,lookup:null,currentMedia:null,currentKey:"",stats:null,lastVote:null,isSubmitting:false,lastStatsRequest:0,statsTimer:null,playbackTimer:null,endpoint:configuredEndpoint || null,channel:null,playback:{currentTime:0,duration:0,lastUpdate:0,},};const leaderboardState ={modal:null,scrollEl:null,listEl:null,loadingEl:null,errorEl:null,loading:false,items:[],abortController:null,tmdbKey:null,tmdbCache:new Map(),};// ---------- Small helpers ---------- function $(sel,root = document){return root.querySelector(sel);}function getClient(){try{return window.CLIENT || window.client || null;}catch{return null;}}function getChannelObj(){try{return window.CHANNEL || window.channel || null;}catch{return null;}}function getPlayerInstance(){try{return window.PLAYER || window.player || window.Player || null;}catch (_){return null;}}function safeEvaluate(candidate){if (typeof candidate === "function"){try{return candidate();}catch (_){return undefined;}}return candidate;}function pickLargestPositive(candidates){let best = 0;for (const candidate of candidates){const value = safeEvaluate(candidate);const num = Number(value);if (Number.isFinite(num) && num > best){best = num;}}return best > 0 ? best:NaN;}function pickFirstNonNegative(candidates){for (const candidate of candidates){const value = safeEvaluate(candidate);const num = Number(value);if (Number.isFinite(num) && num >= 0){return num;}}return NaN;}const UNWANTED_TITLE_WORDS = [ "Extended","Director's Cut","Directors Cut","Unrated","Theatrical Cut",];function cleanTitleForSearch(title){if (!title) return "";let result = String(title);for (const word of UNWANTED_TITLE_WORDS){const regex = new RegExp(`\\b${word}\\b`,"gi");result = result.replace(regex,"");}return result.replace(/\s{2,}/g," ").trim();}function parseTitleForSearch(originalTitle){const raw = String(originalTitle || "").trim();if (!raw){return{title:"",year:""};}let title = raw;let year = "";let match = raw.match(/(.+)\s*\((\d{4})\)/);if (match){title = match[1].trim();year = match[2];}if (!year){match = title.match(/(.+?)\s+(\d{4})\s*$/);if (match){title = match[1].trim();year = match[2];}}return{title:cleanTitleForSearch(title),year};}function updatePlaybackFromPlayer(){const player = getPlayerInstance();const media = state.currentMedia;let updated = false;const duration = pickLargestPositive([ () => player?.getDuration?.(),() => player?.getLength?.(),() => player?.mediaLength,() => player?.media?.seconds,() => player?.media?.duration,() => player?.player?.getDuration?.(),() => (typeof player?.player?.duration === "function" ? player.player.duration():player?.player?.duration),() => player?.player?.currentMedia?.duration,() => player?.videojs?.duration?.(),() => (typeof player?.duration === "function" ? player.duration():player?.duration),() => media?.duration,() => state.lookup?.duration,() => state.lookup?.seconds,() => state.playback.duration,]);if (Number.isFinite(duration) && duration > 0){if (!Number.isFinite(state.playback.duration) || Math.abs(state.playback.duration - duration) > 0.5){updated = true;}state.playback.duration = duration;if (media) media.duration = duration;}const currentTime = pickFirstNonNegative([ () => player?.getTime?.(),() => player?.getCurrentTime?.(),() => (typeof player?.currentTime === "function" ? player.currentTime():player?.currentTime),() => player?.media?.currentTime,() => player?.player?.getCurrentTime?.(),() => (typeof player?.player?.currentTime === "function" ? player.player.currentTime():player?.player?.currentTime),() => player?.videojs?.currentTime?.(),() => media?.currentTime,() => state.playback.currentTime,]);if (Number.isFinite(currentTime) && currentTime >= 0){if (!Number.isFinite(state.playback.currentTime) || Math.abs(state.playback.currentTime - currentTime) > 0.3){updated = true;}state.playback.currentTime = currentTime;state.playback.lastUpdate = Date.now();if (media) media.currentTime = currentTime;}return updated;}function getEffectiveDuration(){const duration = pickLargestPositive([ state.playback.duration,state.currentMedia?.duration,state.lookup?.duration,state.lookup?.seconds,]);return Number.isFinite(duration) && duration > 0 ? duration:NaN;}function getEffectiveCurrentTime(duration){const current = pickFirstNonNegative([ state.playback.currentTime,state.currentMedia?.currentTime,]);if (!Number.isFinite(current) || current < 0) return NaN;if (Number.isFinite(duration) && duration > 0){return Math.min(current,duration);}return current;}function shouldDisplayRatings(duration,currentTime){if (!Number.isFinite(duration) || !Number.isFinite(currentTime)) return false;if (duration < MIN_MEDIA_DURATION_SECONDS) return false;const remaining = duration - currentTime;return remaining <= (FINAL_WINDOW_SECONDS + TIME_TOLERANCE_SECONDS);}function stopPlaybackPolling(){if (state.playbackTimer){clearTimeout(state.playbackTimer);state.playbackTimer = null;}}function startPlaybackPolling(){stopPlaybackPolling();if (!state.currentMedia) return;const tick = () =>{if (!state.currentMedia){stopPlaybackPolling();return;}updateVisibility();state.playbackTimer = setTimeout(tick,PLAYBACK_POLL_INTERVAL_MS);};state.playbackTimer = setTimeout(tick,PLAYBACK_POLL_INTERVAL_MS);}function resolveChannelName(){if (state.channel) return state.channel;const ch = getChannelObj();const fromConfig = window.BTFW_CONFIG?.channelName;const fromBody = document.body?.dataset?.channel || "";const name = (ch?.name || fromConfig || fromBody || window.CHANNELNAME || "").toString().trim();state.channel = name || "default";return state.channel;}function getConfiguredMinRank(){const cfgRank = Number(window.BTFW_CONFIG?.ratings?.minRank);const bodyRank = Number(document.body?.dataset?.btfwRatingsMinRank);const ranks = [cfgRank,bodyRank].filter((v) => Number.isFinite(v) && v >= 0);return ranks.length ? Math.max(DEFAULT_MIN_RANK,...ranks):DEFAULT_MIN_RANK;}function getClientRank(){const c = getClient();const r = Number(c?.rank);return Number.isFinite(r) ? r:NaN;}function isEligible(){// Registered users by default;allow higher gates via config when desired const minRank = getConfiguredMinRank();const rank = getClientRank();if (Number.isFinite(rank) && rank >= minRank) return true;// Also allow if admin/owner by permission API (when present) try{if (typeof window.hasPermission === "function"){if (window.hasPermission("chanadmin") || window.hasPermission("owner")) return true;}}catch{}try{const c = getClient();if (c?.hasPermission){if (c.hasPermission("chanadmin") || c.hasPermission("owner")) return true;}}catch{}return false;}function waitForEligibility(){if (state.enabled || state.container) return;if (isEligible()){state.enabled = true;boot();return;}setTimeout(waitForEligibility,CHECK_INTERVAL_MS);}function ensureStyles(){if (document.getElementById("btfw-ratings-style")) return;const style = document.createElement("style");style.id = "btfw-ratings-style";style.textContent = ` #btfw-ratings-wrapper{width:100%;}#btfw-ratings{display:flex;flex-direction:row-reverse;align-items:center;align-content:center;gap:8px;width:100%;margin:0;padding-top:10px;font-size:13px;font-family:inherit;color:var(--btfw-chat-dim,rgba(222,229,255,.72));position:relative;border-top:0px solid rgba(255,255,255,.08);}#btfw-ratings[hidden]{display:none !important;}#btfw-ratings .btfw-ratings__header{display:flex;align-items:center;gap:8px;width:100%;}#btfw-ratings .btfw-ratings__label{font-size:12px;opacity:.78;letter-spacing:.02em;text-transform:uppercase;}#btfw-ratings .btfw-ratings__actions{margin-left:auto;display:flex;align-items:center;gap:4px;}#btfw-ratings .btfw-ratings__actions button{display:inline-flex;align-items:center;justify-content:center;min-width:0;}#btfw-ratings .btfw-ratings__stars{display:flex;align-items:center;gap:3px;}#btfw-ratings .btfw-ratings__stars button{appearance:none;border:none;background:none;color:rgba(255,255,255,.32);cursor:pointer;padding:0 2px;font-size:18px;line-height:1;transition:color .15s ease;}#btfw-ratings[data-loading="true"] .btfw-ratings__stars button,#btfw-ratings[data-disabled="true"] .btfw-ratings__stars button{cursor:default;pointer-events:none;opacity:.55;}#btfw-ratings .btfw-ratings__stars button[data-active="true"],#btfw-ratings .btfw-ratings__stars button:hover,#btfw-ratings .btfw-ratings__stars button:focus-visible{color:var(--btfw-rating-accent,#ffd166);}#btfw-ratings .btfw-ratings__meta-group{display:flex;flex-wrap:wrap;align-items:center;gap:8px;font-size:12px;opacity:.8;}#btfw-ratings .btfw-ratings__meta{white-space:nowrap;}#btfw-ratings .btfw-ratings__self{font-size:12px;opacity:.9;color:var(--btfw-rating-accent,#ffd166);}#btfw-ratings .btfw-ratings__error{font-size:11px;color:#ff879d;}#btfw-ratings .btfw-ratings__refresh,#btfw-ratings .btfw-ratings__list{appearance:none;border:none;background:none;color:rgba(255,255,255,.45);cursor:pointer;padding:0 4px;font-size:14px;line-height:1;transition:color .15s ease;}#btfw-ratings .btfw-ratings__list{font-size:13px;}#btfw-ratings .btfw-ratings__refresh:hover,#btfw-ratings .btfw-ratings__refresh:focus-visible,#btfw-ratings .btfw-ratings__list:hover,#btfw-ratings .btfw-ratings__list:focus-visible{color:rgba(255,255,255,.82);}#btfw-ratings-modal .modal-card{width:min(92vw,960px);max-height:90vh;display:flex;flex-direction:column;}#btfw-ratings-modal .modal-card-head,#btfw-ratings-modal .modal-card-foot{background:rgba(12,14,22,.92);color:#fff;}#btfw-ratings-modal .modal-card-head{border-bottom:1px solid rgba(255,255,255,.08);}#btfw-ratings-modal .modal-card-foot{border-top:1px solid rgba(255,255,255,.08);justify-content:flex-end;}#btfw-ratings-modal .modal-card-title{font-size:1.125rem;}#btfw-ratings-modal .modal-card-body{background:rgba(12,14,22,.88);padding:18px;color:#f4f6ff;}#btfw-ratings-modal .btfw-ratings-modal__scroll{max-height:min(70vh,640px);overflow-y:auto;padding-right:6px;}#btfw-ratings-modal .btfw-ratings-modal__loading,#btfw-ratings-modal .btfw-ratings-modal__error{font-size:0.95rem;text-align:center;padding:24px 12px;}#btfw-ratings-modal .btfw-ratings-modal__error{color:#ff879d;}#btfw-ratings-modal .btfw-ratings-modal__list{display:flex;flex-direction:column;gap:12px;}#btfw-ratings-modal .btfw-ratings-modal__list[data-layout="grid"]{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;}#btfw-ratings-modal .btfw-ratings-modal__item{display:flex;gap:12px;background:rgba(255,255,255,0.04);border-radius:10px;padding:12px;color:inherit;text-decoration:none;min-height:120px;}#btfw-ratings-modal .btfw-ratings-modal__list[data-layout="grid"] .btfw-ratings-modal__item{flex-direction:column;min-height:0;}#btfw-ratings-modal .btfw-ratings-modal__poster{position:relative;flex:0 0 auto;width:84px;aspect-ratio:2 / 3;border-radius:8px;overflow:hidden;background:rgba(255,255,255,0.07);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:1.25rem;color:rgba(255,255,255,0.64);text-transform:uppercase;}#btfw-ratings-modal .btfw-ratings-modal__poster img{width:100%;height:100%;object-fit:cover;display:block;}#btfw-ratings-modal .btfw-ratings-modal__poster img[hidden]{display:none !important;}#btfw-ratings-modal .btfw-ratings-modal__poster[data-has-poster="true"] .btfw-ratings-modal__poster-fallback{display:none !important;}#btfw-ratings-modal .btfw-ratings-modal__list[data-layout="grid"] .btfw-ratings-modal__poster{width:100%;}#btfw-ratings-modal .btfw-ratings-modal__details{display:flex;flex-direction:column;gap:6px;flex:1 1 auto;}#btfw-ratings-modal .btfw-ratings-modal__title{font-size:1rem;font-weight:600;display:flex;align-items:center;flex-wrap:wrap;gap:6px;}#btfw-ratings-modal .btfw-ratings-modal__rank{display:inline-flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.12);color:var(--btfw-rating-accent,#ffd166);border-radius:999px;font-size:0.75rem;padding:2px 8px;letter-spacing:0.04em;text-transform:uppercase;}#btfw-ratings-modal .btfw-ratings-modal__name{flex:1 1 auto;}#btfw-ratings-modal .btfw-ratings-modal__year{opacity:0.7;font-size:0.9rem;}#btfw-ratings-modal .btfw-ratings-modal__scoreline{display:flex;align-items:center;gap:8px;font-size:0.95rem;}#btfw-ratings-modal .btfw-ratings-modal__avg{font-weight:600;color:var(--btfw-rating-accent,#ffd166);}#btfw-ratings-modal .btfw-ratings-modal__votes{font-size:0.85rem;opacity:0.85;}#btfw-ratings-modal .btfw-ratings-modal__stars{position:relative;display:inline-block;font-size:0.9rem;line-height:1;letter-spacing:2px;min-width:5ch;}#btfw-ratings-modal .btfw-ratings-modal__stars-base{color:rgba(255,255,255,0.18);}#btfw-ratings-modal .btfw-ratings-modal__stars-fill{color:var(--btfw-rating-accent,#ffd166);position:absolute;inset:0;overflow:hidden;white-space:nowrap;}#btfw-ratings-modal .btfw-ratings-modal__empty{padding:36px 12px;text-align:center;opacity:0.85;font-size:0.95rem;}@media (max-width:720px){#btfw-ratings{padding-top:6px;font-size:12px;}#btfw-ratings .btfw-ratings__label{letter-spacing:0.01em;}#btfw-ratings .btfw-ratings__header{flex-wrap:wrap;}#btfw-ratings .btfw-ratings__actions{width:100%;justify-content:flex-start;margin-left:0;}#btfw-ratings .btfw-ratings__actions button{padding:0 2px;}#btfw-ratings-modal .modal-card{width:94vw;}}`;document.head.appendChild(style);}function ensureEndpoint(){if (state.endpoint) return state.endpoint;const cfg = window.BTFW_CONFIG?.ratings ||{};const candidates = [ document.body?.dataset?.btfwRatingsEndpoint,cfg.endpoint,window.BTFW_RATINGS_ENDPOINT,window.BTFW_CONFIG?.ratingsEndpoint,window.BTFW_RATINGS_API,(() =>{try{return localStorage.getItem("btfw:ratings:endpoint") || null;}catch{return null;}})() ];const endpoint = candidates.find((v) => typeof v === "string" && v.trim().length > 0);if (endpoint){state.endpoint = endpoint.trim().replace(/\/$/,"");return state.endpoint;}return null;}function escapeHtml(value){return String(value ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");}function sanitizePosterUrl(url){const str = String(url ?? "").trim();if (!str) return "";if (/^https?:/i.test(str) || /^data:image\//i.test(str) || /^blob:/i.test(str)) return str;if (str.startsWith("//")) return `https:${str}`;return "";}function formatVotes(votes){const num = Number(votes);const safe = Number.isFinite(num) && num >= 0 ? num:0;let formatted = String(safe);try{formatted = safe.toLocaleString();}catch (_){}return `${formatted}vote${safe === 1 ? "":"s"}`;}function buildStarDisplay(avg){const clamped = Math.min(5,Math.max(0,Number(avg) || 0));const pct = (clamped / 5) * 100;return ` <span class="btfw-ratings-modal__stars" aria-hidden="true"> <span class="btfw-ratings-modal__stars-base">â˜…â˜…â˜…â˜…â˜…</span> <span class="btfw-ratings-modal__stars-fill" style="width:${pct}%">â˜…â˜…â˜…â˜…â˜…</span> </span> `;}function pickString(candidates){for (const candidate of candidates){const value = safeEvaluate(candidate);if (value == null) continue;const str = String(value).trim();if (str) return str;}return "";}function pickNumber(candidates){for (const candidate of candidates){const value = safeEvaluate(candidate);const num = Number(value);if (Number.isFinite(num)) return num;}return NaN;}function extractYear(raw){const yearSource = pickString([ raw?.year,raw?.releaseYear,raw?.release_year,raw?.releaseDate,raw?.release_date,raw?.firstAirDate,raw?.first_air_date,raw?.date,raw?.media?.year,raw?.media?.releaseDate,raw?.media?.released,raw?.tmdb?.release_date,raw?.tmdb?.first_air_date,]);if (!yearSource) return "";const match = yearSource.match(/(19|20)\d{2}/);return match ? match[0]:"";}function resolveTMDBKey(){try{const cfg = (window.BTFW_CONFIG && typeof window.BTFW_CONFIG === "object") ? window.BTFW_CONFIG:{};const tmdbObj = (cfg.tmdb && typeof cfg.tmdb === "object") ? cfg.tmdb:{};const cfgKey = typeof tmdbObj.apiKey === "string" ? tmdbObj.apiKey.trim():"";const legacyCfg = typeof cfg.tmdbKey === "string" ? cfg.tmdbKey.trim():"";let lsKey = "";try{lsKey = (localStorage.getItem("btfw:tmdb:key") || "").trim();}catch (_){}const g = (v) => (v == null ? "":String(v)).trim();const globalKey = g(window.TMDB_API_KEY) || g(window.BTFW_TMDB_KEY) || g(window.tmdb_key);const bodyKey = g(document.body?.dataset?.tmdbKey);const key = cfgKey || legacyCfg || lsKey || globalKey || bodyKey;return key || null;}catch (_){return null;}}function ensureLeaderboardModal(){if (leaderboardState.modal?.isConnected) return leaderboardState.modal;const modal = document.createElement("div");modal.id = "btfw-ratings-modal";modal.className = "modal";modal.dataset.btfwModalState = "closed";modal.setAttribute("hidden","");modal.setAttribute("aria-hidden","true");modal.innerHTML = ` <div class="modal-background"></div> <div class="modal-card btfw-modal" role="dialog" aria-modal="true" aria-labelledby="btfw-ratings-modal-title"> <header class="modal-card-head"> <p class="modal-card-title" id="btfw-ratings-modal-title">Community Ratings</p> <button class="delete" type="button" aria-label="Close"></button> </header> <section class="modal-card-body"> <div class="btfw-ratings-modal__scroll"> <div class="btfw-ratings-modal__loading">Loading ratingsâ€¦</div> <div class="btfw-ratings-modal__error" hidden></div> <div class="btfw-ratings-modal__list" hidden aria-live="polite"></div> </div> </section> <footer class="modal-card-foot"> <button type="button" class="button is-link btfw-ratings-modal__close">Close</button> </footer> </div> `;document.body.appendChild(modal);modal.querySelector(".modal-background")?.addEventListener("click",closeLeaderboardModal);modal.querySelector(".delete")?.addEventListener("click",closeLeaderboardModal);modal.querySelector(".btfw-ratings-modal__close")?.addEventListener("click",closeLeaderboardModal);modal.addEventListener("keydown",(event) =>{if (event.key === "Escape") closeLeaderboardModal();});leaderboardState.modal = modal;leaderboardState.scrollEl = modal.querySelector(".btfw-ratings-modal__scroll");leaderboardState.listEl = modal.querySelector(".btfw-ratings-modal__list");leaderboardState.loadingEl = modal.querySelector(".btfw-ratings-modal__loading");leaderboardState.errorEl = modal.querySelector(".btfw-ratings-modal__error");return modal;}function setLeaderboardLoading(isLoading){leaderboardState.loading = !!isLoading;if (leaderboardState.loadingEl){leaderboardState.loadingEl.hidden = !isLoading;}if (isLoading && leaderboardState.listEl){leaderboardState.listEl.setAttribute("hidden","");}}function setLeaderboardError(message){if (!leaderboardState.errorEl) return;if (message){leaderboardState.errorEl.hidden = false;leaderboardState.errorEl.textContent = message;}else{leaderboardState.errorEl.hidden = true;leaderboardState.errorEl.textContent = "";}}function normalizeLeaderboardPayload(payload){if (!payload) return [];if (Array.isArray(payload)) return payload;const keys = ["items","results","list","entries","data","movies","records","leaderboard","ratings"];for (const key of keys){const value = payload[key];if (Array.isArray(value)) return value;}if (typeof payload === "object"){const values = Object.values(payload);if (values.length && values.every((item) => item && typeof item === "object")){return values;}}return [];}function normalizeLeaderboardItem(raw){if (!raw || typeof raw !== "object") return null;const title = pickString([ raw.title,raw.name,raw.mediaTitle,raw.displayTitle,raw.media?.title,raw.lookup?.title,]);if (!title) return null;const parsedTitle = parseTitleForSearch(title);const avg = Math.min(5,Math.max(0,pickNumber([ raw.avg,raw.average,raw.score,raw.rating,raw.mean,raw.averageScore,]) || 0));const votes = Math.max(0,Math.round(pickNumber([ raw.votes,raw.voteCount,raw.count,raw.totalVotes,raw.ratingCount,raw.total,]) || 0));const posterPath = pickString([ raw.posterPath,raw.poster_path,raw.poster,raw.artwork,raw.image,raw.media?.poster,raw.media?.posterPath,raw.tmdb?.poster_path,]);let posterUrl = pickString([ raw.posterUrl,raw.posterURL,raw.imageUrl,raw.imageURL,raw.art,]);if (!posterUrl && posterPath){if (/^https?:/i.test(posterPath)){posterUrl = posterPath;}else if (posterPath.startsWith("//")){posterUrl = `https:${posterPath}`;}else if (posterPath.startsWith("/")){posterUrl = `https://image.tmdb.org/t/p/w342${posterPath}`;}}const safePoster = sanitizePosterUrl(posterUrl);const tmdbId = pickString([raw.tmdbId,raw.tmdb_id,raw.tmdb?.id]);const tmdbType = pickString([raw.tmdbType,raw.tmdb_type,raw.type,raw.mediaType,raw.media_type,raw.tmdb?.media_type]);let year = extractYear(raw);if (!year){year = parsedTitle.year;}const id = pickString([raw.mediaKey,raw.key,raw.id,raw.media?.id,raw.media?.key]) || title;return{id,title,avg:Number.isFinite(avg) ? avg:0,votes:Number.isFinite(votes) ? votes:0,posterUrl:safePoster,tmdbId:tmdbId || "",tmdbType:tmdbType || "",year,searchTitle:parsedTitle.title || cleanTitleForSearch(title),searchYear:parsedTitle.year || year || "",};}function sortLeaderboardItems(items){return items.sort((a,b) =>{if (b.avg !== a.avg) return b.avg - a.avg;if (b.votes !== a.votes) return b.votes - a.votes;return a.title.localeCompare(b.title,undefined,{sensitivity:"base"});});}function renderLeaderboardItem(item,index){const title = escapeHtml(item.title);const avg = Number(item.avg) || 0;const avgText = avg ? avg.toFixed(2):"0.00";const votesText = formatVotes(item.votes);const poster = item.posterUrl ? escapeHtml(item.posterUrl):"";const fallback = escapeHtml((item.title || "?").trim().charAt(0) || "?");const year = item.year ? `<span class="btfw-ratings-modal__year">(${escapeHtml(item.year)})</span>`:"";return ` <article class="btfw-ratings-modal__item" data-index="${index}"> <div class="btfw-ratings-modal__poster" data-has-poster="${item.posterUrl ? "true":"false"}"> <img src="${poster}" alt="Poster for ${title}" loading="lazy" ${item.posterUrl ? "":"hidden"}> <div class="btfw-ratings-modal__poster-fallback"${item.posterUrl ? " hidden":""}aria-hidden="true">${fallback}</div> </div> <div class="btfw-ratings-modal__details"> <div class="btfw-ratings-modal__title"> <span class="btfw-ratings-modal__rank">#${index + 1}</span> <span class="btfw-ratings-modal__name">${title}</span> ${year}</div> <div class="btfw-ratings-modal__scoreline"> ${buildStarDisplay(avg)}<span class="btfw-ratings-modal__avg">${avgText}â˜…</span> </div> <div class="btfw-ratings-modal__votes">${escapeHtml(votesText)}</div> </div> </article> `;}function renderLeaderboard(){const listEl = leaderboardState.listEl;if (!listEl) return;const items = Array.isArray(leaderboardState.items) ? leaderboardState.items:[];const useGrid = !!leaderboardState.tmdbKey || items.some((item) => item.posterUrl);listEl.dataset.layout = useGrid ? "grid":"list";if (!items.length){listEl.innerHTML = '<div class="btfw-ratings-modal__empty">No movies have been rated yet.</div>';listEl.removeAttribute("hidden");return;}listEl.innerHTML = items.map((item,index) => renderLeaderboardItem(item,index)).join("");listEl.removeAttribute("hidden");}function updatePosterElement(index,url){if (!leaderboardState.modal) return;const card = leaderboardState.modal.querySelector(`.btfw-ratings-modal__item[data-index="${index}"]`);if (!card) return;const poster = card.querySelector(".btfw-ratings-modal__poster");if (!poster) return;const img = poster.querySelector("img");const fallback = poster.querySelector(".btfw-ratings-modal__poster-fallback");if (url){if (img){img.src = url;img.removeAttribute("hidden");const name = card.querySelector(".btfw-ratings-modal__name")?.textContent?.trim() || "movie";img.alt = `Poster for ${name}`;}if (fallback) fallback.setAttribute("hidden","");poster.dataset.hasPoster = "true";}else{if (img){img.setAttribute("hidden","");img.removeAttribute("src");}if (fallback) fallback.removeAttribute("hidden");poster.dataset.hasPoster = "false";}}async function fetchPosterForItem(item){if (!item || !leaderboardState.tmdbKey) return null;const searchTitle = item.searchTitle || cleanTitleForSearch(item.title);if (!searchTitle) return null;const year = item.searchYear || item.year || "";const cacheParts = [];if (item.tmdbId) cacheParts.push(`id:${String(item.tmdbId).toLowerCase()}`);cacheParts.push(`t:${searchTitle.toLowerCase()}`);if (year) cacheParts.push(`y:${year}`);const cacheKey = cacheParts.join("::");if (leaderboardState.tmdbCache.has(cacheKey)){const cached = leaderboardState.tmdbCache.get(cacheKey);return cached || null;}const key = leaderboardState.tmdbKey;const normalizedType = String(item.tmdbType || "").toLowerCase();const normalizedId = String(item.tmdbId || "").trim();async function fetchPosterById(id,type){if (!id || !type) return null;const path = type === "tv" ? `tv/${id}`:type === "movie" ? `movie/${id}`:"";if (!path) return null;try{const url = new URL(`https://api.themoviedb.org/3/${path}`);url.searchParams.set("api_key",key);const response = await fetch(url.toString());if (!response.ok) return null;const json = await response.json();const posterPath = json?.poster_path;if (posterPath){return sanitizePosterUrl(`https://image.tmdb.org/t/p/w342${posterPath}`);}}catch (error){console.warn("[ratings] tmdb lookup by id failed",error);}return null;}if (normalizedId && (normalizedType === "movie" || normalizedType === "tv")){const directPoster = await fetchPosterById(normalizedId,normalizedType);if (directPoster){leaderboardState.tmdbCache.set(cacheKey,directPoster);return directPoster;}}const searchConfigs = [];if (normalizedType === "movie"){searchConfigs.push({path:"search/movie",type:"movie"});}else if (normalizedType === "tv"){searchConfigs.push({path:"search/tv",type:"tv"});}else{searchConfigs.push({path:"search/movie",type:"movie"});searchConfigs.push({path:"search/tv",type:"tv"});}searchConfigs.push({path:"search/multi",type:"multi"});for (const config of searchConfigs){try{const url = new URL(`https://api.themoviedb.org/3/${config.path}`);url.searchParams.set("api_key",key);url.searchParams.set("include_adult","false");url.searchParams.set("query",searchTitle);if (year){if (config.type === "movie" || config.type === "multi"){url.searchParams.set("year",year);url.searchParams.set("primary_release_year",year);}if (config.type === "tv" || config.type === "multi"){url.searchParams.set("first_air_date_year",year);}}const response = await fetch(url.toString());if (!response.ok) throw new Error(`HTTP ${response.status}`);const json = await response.json();const results = Array.isArray(json?.results) ? json.results:[];let chosen = null;for (const candidate of results){if (!candidate || !candidate.poster_path) continue;const candidateId = candidate.id != null ? String(candidate.id):"";if (normalizedId && candidateId === normalizedId){chosen = candidate;break;}if (!chosen){chosen = candidate;}if (config.type === "movie" || config.type === "tv"){break;}const candidateType = String(candidate.media_type || "").toLowerCase();if (normalizedType && candidateType === normalizedType) break;if (!normalizedType && (candidateType === "movie" || candidateType === "tv")) break;}if (chosen?.poster_path){const posterUrl = sanitizePosterUrl(`https://image.tmdb.org/t/p/w342${chosen.poster_path}`);leaderboardState.tmdbCache.set(cacheKey,posterUrl);return posterUrl;}}catch (error){console.warn("[ratings] tmdb lookup failed",error);}}leaderboardState.tmdbCache.set(cacheKey,"");return null;}async function hydrateLeaderboardPosters(items){if (!leaderboardState.tmdbKey) return;const limit = Math.min(items.length,60);for (let i = 0;i < limit;i += 1){const item = items[i];if (!item || item.posterUrl) continue;const poster = await fetchPosterForItem(item);if (poster){item.posterUrl = poster;updatePosterElement(i,poster);}if (!leaderboardState.modal || leaderboardState.modal.dataset.btfwModalState === "closed"){return;}}}async function fetchLeaderboardData(signal){const endpoint = ensureEndpoint();if (!endpoint) return [];const channel = resolveChannelName();const params = new URLSearchParams({channel});params.set("limit","200");params.set("min","1");const base = endpoint.replace(/\/$/,"");const paths = ["leaderboard","top","list","history",""];let lastError = null;for (const path of paths){const url = path ? `${base}/${path}`:base;const target = `${url}?${params.toString()}`;try{const response = await fetch(target,{signal,credentials:"omit"});if (response.status === 404 || response.status === 405){continue;}if (!response.ok){const text = await response.text().catch(() => "");throw new Error(`HTTP ${response.status}${text}`.trim());}const payload = await response.json();const normalized = normalizeLeaderboardPayload(payload) .map((item) => normalizeLeaderboardItem(item)) .filter(Boolean) .filter((item) => item.votes > 0);return sortLeaderboardItems(normalized);}catch (error){if (error?.name === "AbortError") throw error;lastError = error;}}if (lastError) throw lastError;return [];}async function loadLeaderboard(){const modal = ensureLeaderboardModal();const endpoint = ensureEndpoint();if (!endpoint){setLeaderboardLoading(false);setLeaderboardError("Ratings are disabled for this channel.");if (leaderboardState.listEl){leaderboardState.listEl.innerHTML = "";leaderboardState.listEl.setAttribute("hidden","");}return;}if (leaderboardState.abortController){leaderboardState.abortController.abort();}const controller = new AbortController();leaderboardState.abortController = controller;const nextKey = resolveTMDBKey();if (nextKey !== leaderboardState.tmdbKey){leaderboardState.tmdbCache.clear();}leaderboardState.tmdbKey = nextKey;if (leaderboardState.loadingEl) leaderboardState.loadingEl.textContent = "Loading ratingsâ€¦";setLeaderboardError("");setLeaderboardLoading(true);if (leaderboardState.scrollEl) leaderboardState.scrollEl.scrollTop = 0;try{const items = await fetchLeaderboardData(controller.signal);leaderboardState.items = items;renderLeaderboard();setLeaderboardLoading(false);await hydrateLeaderboardPosters(items);}catch (error){if (error?.name === "AbortError") return;console.warn("[ratings] leaderboard fetch failed",error);setLeaderboardLoading(false);setLeaderboardError("Unable to load rated movies right now.");if (leaderboardState.listEl){leaderboardState.listEl.innerHTML = "";leaderboardState.listEl.setAttribute("hidden","");}}finally{if (leaderboardState.abortController === controller){leaderboardState.abortController = null;}}if (modal){requestAnimationFrame(() =>{const closeBtn = modal.querySelector(".btfw-ratings-modal__close");if (!closeBtn) return;try{closeBtn.focus({preventScroll:true});}catch (_){try{closeBtn.focus();}catch (_){}}});}}function openLeaderboardModal(){const modal = ensureLeaderboardModal();motion.openModal(modal);loadLeaderboard();}function closeLeaderboardModal(){if (leaderboardState.abortController){leaderboardState.abortController.abort();leaderboardState.abortController = null;}if (leaderboardState.modal){motion.closeModal(leaderboardState.modal);}}function ensureAnonId(){try{let id = localStorage.getItem(LS_ANON_ID_KEY);if (id && id.length >= 8) return id;const bytes = new Uint8Array(12);(window.crypto || window.msCrypto).getRandomValues(bytes);id = Array.from(bytes).map((b) => b.toString(16).padStart(2,"0")).join("");localStorage.setItem(LS_ANON_ID_KEY,id);return id;}catch{return "anon" + Math.random().toString(36).slice(2,8);}}function hashString(input){let h = 2166136261;for (let i = 0;i < input.length;i++){h ^= input.charCodeAt(i);h = Math.imul(h,16777619);}return (h >>> 0).toString(16);}function stripTitlePrefix(title){return String(title || "").replace(/^\s*(?:currently|now)\s*playing\s*[:\-]\s*/i,"").replace(/[\s]+/g," ").trim();}function normalizeTitleForKey(raw){// lowercase,strip diacritics,remove punctuation,collapse spaces let s = String(raw || "").toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"");s = s.replace(/[\[\](){}:;\.,!?'"`~_|\\/+-]+/g," ");s = s.replace(/\s+/g," ").trim();return s;}function extractYearFromTitle(raw){const s = String(raw || "");const m = s.match(/(?:\(|\b)(19|20)\d{2}(?:\)|\b)(?!.*(19|20)\d{2})/);return m ? m[0].replace(/[()]/g,""):"";}function durationBucket(seconds){const sec = Number(seconds) || 0;return Math.round((sec / 60) / 5) * 5;}function deriveMediaKey(media,fallbackTitle){const duration = Number(media?.seconds ?? media?.duration ?? media?.length ?? 0) || 0;const titleRaw = stripTitlePrefix(media?.title || fallbackTitle || "");if (!titleRaw) return "";const year = extractYearFromTitle(titleRaw);const baseTitle = normalizeTitleForKey( year ? titleRaw.replace(new RegExp(`\\(?${year}\\)?`),""):titleRaw );if (!baseTitle) return "";const keyPayload = `t:${baseTitle}|y:${year || "na"}`;return `title:${hashString(keyPayload)}`;}function normalizeMediaData(media){if (!media || typeof media !== "object") return null;const lookupTitle = state.lookup?.canonical || state.lookup?.query || state.lookup?.original || "";const rawTitle = stripTitlePrefix(media.title || lookupTitle || "");const duration = Number(media.seconds ?? media.duration ?? media.length ?? 0) || 0;const currentTime = Number(media.currentTime ?? media.time ?? media.position ?? 0) || 0;const key = deriveMediaKey(media,rawTitle || lookupTitle);if (!key) return null;return{key,title:rawTitle,duration,currentTime,provider:(media.type || media.mediaType || media.provider || "").toString().trim(),id:(media.id || media.videoId || media.vid || media.uid || "").toString().trim()};}function ensureUI(){if (state.container?.isConnected) return state.container;ensureStyles();const topbarLeft = $("#chatwrap .btfw-chat-topbar .btfw-chat-topbar-left");const slot = $("#btfw-nowplaying-slot");const host = topbarLeft || slot || $("#chatwrap .btfw-chat-topbar") || $("#chatwrap") || document.body;let wrapper = host.querySelector("#btfw-ratings-wrapper");if (!wrapper){wrapper = document.createElement("div");wrapper.id = "btfw-ratings-wrapper";wrapper.className = "btfw-ratings-wrapper";if (topbarLeft && slot && slot.parentElement === topbarLeft){slot.insertAdjacentElement("afterend",wrapper);}else{host.appendChild(wrapper);}}const el = document.createElement("div");el.id = "btfw-ratings";el.hidden = true;el.innerHTML = ` <div class="btfw-ratings__header"> <span class="btfw-ratings__label">Rate</span> <div class="btfw-ratings__actions"> <button type="button" class="btfw-ratings__list" title="Show rated movies" aria-label="Show rated movies">â‰£</button> <button type="button" class="btfw-ratings__refresh" title="Refresh rating" aria-label="Refresh rating">âŸ³</button> </div> </div> <div class="btfw-ratings__stars" role="group" aria-label="Rate current media"> ${STAR_VALUES.map(v => `<button type="button" data-score="${v}" aria-label="Rate ${v}star${v===1?"":"s"}">â˜…</button>`).join("")}</div> <div class="btfw-ratings__meta-group"> <span class="btfw-ratings__meta" aria-live="polite"></span> <span class="btfw-ratings__self" hidden></span> </div> <span class="btfw-ratings__error" hidden></span> `;wrapper.appendChild(el);state.container = el;state.stars = Array.from(el.querySelectorAll("button[data-score]"));state.statusNode = el.querySelector(".btfw-ratings__meta");state.selfNode = el.querySelector(".btfw-ratings__self");state.errorNode = el.querySelector(".btfw-ratings__error");el.addEventListener("click",(ev) =>{const btn = ev.target?.closest?.("button[data-score]");if (!btn) return;const score = Number(btn.dataset.score);if (Number.isFinite(score)) submitVote(score);});el.addEventListener("mousemove",(ev) =>{const btn = ev.target?.closest?.("button[data-score]");if (!btn) return;const score = Number(btn.dataset.score);if (Number.isFinite(score)) highlightStars(score);});el.addEventListener("mouseleave",() => highlightStars(state.lastVote || 0));el.querySelector(".btfw-ratings__list")?.addEventListener("click",(event) =>{event.preventDefault();event.stopPropagation();openLeaderboardModal();});el.querySelector(".btfw-ratings__refresh")?.addEventListener("click",() => refreshStats(true));return el;}function highlightStars(score){state.stars.forEach((star) =>{const v = Number(star.dataset.score);star.dataset.active = v <= score ? "true":"false";});}function setStatus(text){if (state.statusNode) state.statusNode.textContent = text || "";}function setSelfStatus(text){if (!state.selfNode) return;if (text){state.selfNode.hidden = false;state.selfNode.textContent = text;}else{state.selfNode.hidden = true;state.selfNode.textContent = "";}}function setError(message){if (!state.errorNode) return;if (message){state.errorNode.hidden = false;state.errorNode.textContent = message;}else{state.errorNode.hidden = true;state.errorNode.textContent = "";}}function setLoading(val){if (state.container){state.isSubmitting = !!val;state.container.dataset.loading = val?"true":"false";}}function hideRatings(){if (!state.container) return;state.container.hidden = true;state.container.dataset.disabled = "true";}function showRatings(){if (!state.container) return;state.container.hidden = false;state.container.dataset.disabled = "false";if (state.stats && typeof state.stats.avg === "number"){const avg = state.stats.avg;const votes = state.stats.votes || 0;const avgText = votes > 0 ? `${avg.toFixed(2)}â˜… (${votes}vote${votes===1?"":"s"})`:"No ratings yet";setStatus(avgText);}else{setStatus("No ratings yet");}if (state.lastVote){setSelfStatus(`Your rating:${state.lastVote}â˜…`);highlightStars(state.lastVote);}else{setSelfStatus("");highlightStars(0);}}function updateVisibility(){if (!state.container) return;const endpoint = ensureEndpoint();if (!endpoint || !state.currentKey || !state.currentMedia){hideRatings();return;}updatePlaybackFromPlayer();const duration = getEffectiveDuration();const currentTime = getEffectiveCurrentTime(duration);if (!shouldDisplayRatings(duration,currentTime)){hideRatings();return;}showRatings();}function handleLookupEvent(event){if (!event?.detail) return;state.lookup ={...event.detail};if (!state.currentMedia && state.lookup?.original){const baseTitle = stripTitlePrefix(state.lookup.original);const key = deriveMediaKey({title:baseTitle,seconds:0},baseTitle);state.currentMedia ={key,title:baseTitle,duration:0,provider:"",id:""};state.currentKey = state.currentMedia.key;}updateVisibility();}function currentUsername(){try{return getClient()?.name || "";}catch{return "";}}function currentUserIdentifier(){return currentUsername() || ensureAnonId();}function buildUserKey(){const channel = resolveChannelName();const identity = currentUserIdentifier();return `u_${hashString(`${channel}::${identity}`)}`;}function scheduleStatsRefresh(){if (state.statsTimer){clearTimeout(state.statsTimer);state.statsTimer = null;}state.statsTimer = setTimeout(() => refreshStats(false),STATS_REFRESH_INTERVAL_MS);}async function refreshStats(force){if (!state.currentKey) return;const endpoint = ensureEndpoint();if (!endpoint){updateVisibility();return;}const now = Date.now();if (!force && now - state.lastStatsRequest < STATS_DEBOUNCE_MS) return;state.lastStatsRequest = now;const channel = resolveChannelName();const params = new URLSearchParams({channel,mediaKey:state.currentKey});try{params.set("userKey",buildUserKey());}catch{}const url = `${endpoint}/stats?${params.toString()}`;try{const resp = await fetch(url,{credentials:"omit"});if (!resp.ok) throw new Error(`HTTP ${resp.status}`);const payload = await resp.json();const u = Number(payload?.userScore);state.stats ={avg:Number(payload?.avg) || 0,votes:Number(payload?.votes) || 0,user:Number.isFinite(u) ? u:null,};if (state.stats.user){state.lastVote = state.stats.user;// persist optimistic self-vote cache try{localStorage.setItem(LS_SELF_PREFIX + state.currentKey,String(state.lastVote));}catch{}}else{// attempt to load cached self-vote if any try{const cached = Number(localStorage.getItem(LS_SELF_PREFIX + state.currentKey));if (Number.isFinite(cached) && cached >= 1 && cached <= 5){state.lastVote = cached;}}catch{}}setError("");}catch (err){console.warn("[ratings] stats fetch failed",err);setError("Stats unavailable");// fallback:load cached self vote for UI try{const cached = Number(localStorage.getItem(LS_SELF_PREFIX + state.currentKey));if (Number.isFinite(cached) && cached >= 1 && cached <= 5) state.lastVote = cached;}catch{}}updateVisibility();scheduleStatsRefresh();}async function submitVote(score){if (!state.currentKey || state.isSubmitting) return;const endpoint = ensureEndpoint();if (!endpoint){updateVisibility();return;}const channel = resolveChannelName();const media = state.currentMedia;if (!media) return;setLoading(true);setError("");const payload ={channel,mediaKey:state.currentKey,title:media.title || state.lookup?.canonical || state.lookup?.original || "",duration:media.duration || 0,userKey:buildUserKey(),score};try{const response = await fetch(`${endpoint}/rate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload),credentials:"omit"});if (!response.ok){const text = await response.text().catch(() => "");throw new Error(`HTTP ${response.status}:${text}`);}// optimistic update state.lastVote = score;try{localStorage.setItem(LS_SELF_PREFIX + state.currentKey,String(score));}catch{}highlightStars(score);setSelfStatus(`Your rating:${score}â˜…`);await refreshStats(true);}catch (error){console.warn("[ratings] vote failed",error);setError("Vote failed,try again");}finally{setLoading(false);}}function setMedia(media){stopPlaybackPolling();if (state.statsTimer){clearTimeout(state.statsTimer);state.statsTimer = null;}const normalized = normalizeMediaData(media);if (!normalized){state.currentMedia = null;state.currentKey = "";state.stats = null;state.lastVote = null;state.playback.currentTime = 0;state.playback.duration = 0;setSelfStatus("");highlightStars(0);updateVisibility();return;}state.currentMedia = normalized;state.currentKey = normalized.key;state.stats = null;state.lastVote = null;state.playback.currentTime = Number(normalized.currentTime) || 0;state.playback.duration = Number(normalized.duration) || 0;state.playback.lastUpdate = Date.now();setSelfStatus("");highlightStars(0);updatePlaybackFromPlayer();updateVisibility();refreshStats(true);startPlaybackPolling();}function handleMediaUpdate(data){if (!data) return;if (data.title && state.currentMedia) state.currentMedia.title = stripTitlePrefix(data.title);if (state.currentMedia){const durationUpdate = pickLargestPositive([ Number(data.seconds),Number(data.duration),Number(data.length),state.currentMedia.duration,state.playback.duration,]);if (Number.isFinite(durationUpdate) && durationUpdate > 0){state.currentMedia.duration = durationUpdate;state.playback.duration = durationUpdate;}}const nextCurrent = pickFirstNonNegative([ Number(data.currentTime),Number(data.time),Number(data.position),state.playback.currentTime,]);if (Number.isFinite(nextCurrent) && nextCurrent >= 0){state.playback.currentTime = nextCurrent;state.playback.lastUpdate = Date.now();if (state.currentMedia) state.currentMedia.currentTime = nextCurrent;}updateVisibility();}function bindSocketHandlers(){const s = window.socket;if (!s || typeof s.on !== "function") return;try{s.on("changeMedia",setMedia);s.on("setCurrent",setMedia);s.on("mediaUpdate",handleMediaUpdate);}catch (error){console.warn("[ratings] failed to bind socket handlers",error);}}function wrapCallbacks(){try{if (window.Callbacks && typeof window.Callbacks.changeMedia === "function"){const original = window.Callbacks.changeMedia;window.Callbacks.changeMedia = function wrapped(media){try{setMedia(media);}catch{}return original.apply(this,arguments);};}}catch (error){console.warn("[ratings] unable to wrap Callbacks.changeMedia",error);}}function announceActivation(){if (state.announcedStart) return;state.announcedStart = true;try{const notify = window.BTFW_notify;if (notify && typeof notify.info === "function"){notify.info({title:"Movie rating has started"});}else if (notify && typeof notify.notify === "function"){notify.notify({title:"Movie rating has started",kind:"info"});}}catch (_){}}function boot(){const ui = ensureUI();if (!ui){setTimeout(boot,800);return;}announceActivation();updateVisibility();bindSocketHandlers();wrapCallbacks();document.addEventListener("btfw:nowplayingLookup",handleLookupEvent,{passive:true});const s = window.socket;if (s && s.connected){try{s.emit("playerReady");}catch{}}}if (document.readyState === "loading") document.addEventListener("DOMContentLoaded",waitForEligibility);else waitForEligibility();return{name:"feature:ratings",refresh:() => refreshStats(true)};});