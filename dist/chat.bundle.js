BTFW.define("feature:chat",["feature:layout"],async({init:t})=>{const e=await t("util:motion"),n=(t,e=document)=>e.querySelector(t),o=window.BTFW&&BTFW.BASE?BTFW.BASE.replace(/\/+$/,""):"",r="Type your message hereâ€¦";function a(){const t=document.getElementById("chatline");if(!t)return!1;const e="function"==typeof t.getAttribute?t.getAttribute("placeholder"):t.placeholder;if(e&&e.trim().length>0)return!0;try{t.setAttribute("placeholder",r)}catch(e){t.placeholder=r}return!0}let s=null;function c(){if(!a()&&!s&&document.body){s=new MutationObserver(()=>{a()&&s&&(s.disconnect(),s=null)});try{s.observe(document.body,{childList:!0,subtree:!0})}catch(t){s=null}}}function i(t,e){if(!t)return;const n=document.querySelector("#chatwrap"),o=n&&n.querySelector(".btfw-chat-bottombar");if(!n||!o)return;const{margin:r=8,widthPx:a=560,widthVw:s=92,maxHpx:c=480,maxHvh:i=70}=e||{},l=n.getBoundingClientRect(),d=o.getBoundingClientRect(),u=Math.max(6,r),f=isFinite(s)?window.innerWidth*(s/100):a,m=Math.max(0,window.innerWidth-2*u),b=Math.max(0,l.width-2*u);let p=Math.min(a,f,m||a);b>0&&(p=Math.min(p,b));const h=Math.min(a,f,m||a);p<280&&h>=280&&(p=Math.min(h,Math.max(p,280))),(!Number.isFinite(p)||p<=0)&&(p=Math.min(a,f,m||a));const w=Math.max(u,l.right-p),g=Math.max(u,window.innerHeight-d.top+u),y=isFinite(i)?window.innerHeight*(i/100):c,v=Math.max(0,d.top-u),E=Math.min(c,y,v||c);t.style.position="fixed",t.style.left=`${Math.round(w)}px`,t.style.right="auto",t.style.bottom=`${Math.round(g)}px`,t.style.width=`${Math.round(p)}px`,t.style.maxWidth=`${Math.round(Math.min(a,f,Math.max(p,b||p,m||p)))}px`,Number.isFinite(E)&&E>0?t.style.maxHeight=`${Math.round(E)}px`:t.style.removeProperty("max-height"),t.style.zIndex=t.style.zIndex||"6002"}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",c,{once:!0}):c(),document.addEventListener("btfw:layoutReady",()=>setTimeout(a,0)),window.BTFW_positionPopoverAboveChatBar=i;let l,d=!1;function u(){const t=(t,e)=>window.BTFW_positionPopoverAboveChatBar&&window.BTFW_positionPopoverAboveChatBar(t,e),e=document.getElementById("btfw-emotes-pop");e&&"open"===e.dataset.btfwPopoverState&&t(e,{widthPx:560,widthVw:92,maxHpx:480,maxHvh:70});const n=document.querySelector('#btfw-ct-modal .btfw-ct-card[data-btfw-popover-state="open"]');n&&t(n,{widthPx:420,widthVw:92,maxHpx:360,maxHvh:60});const o=document.getElementById("btfw-userlist-pop");o&&"open"===o.dataset.btfwPopoverState&&t(o)}function f(){const t=n("#btfw-userlist-pop .btfw-popbody"),e=n("#userlist");t&&e&&e.parentElement!==t&&(e.classList.add("btfw-userlist-overlay"),e.classList.remove("btfw-userlist-overlay--open"),e.style.removeProperty("display"),e.style.removeProperty("position"),t.appendChild(e))}window.addEventListener("scroll",()=>{d||(document.body.classList.add("is-scrolling"),d=!0),clearTimeout(l),l=setTimeout(()=>{document.body.classList.remove("is-scrolling"),d=!1},150)},{passive:!0}),window.addEventListener("resize",u),window.addEventListener("scroll",u,!0),document.addEventListener("btfw:layoutReady",()=>setTimeout(u,0));const m=(()=>{let t=!1;const e=window.requestAnimationFrame||(t=>setTimeout(t,16));return()=>{t||(t=!0,e(()=>{t=!1,f()}))}})(),b={wired:!1,socketRef:null,teardown:null,retryTimer:null};function p(){const t=window.socket;if(b.wired&&b.socketRef&&b.socketRef!==t){if("function"==typeof b.teardown)try{b.teardown()}catch(t){}b.teardown=null,b.wired=!1,b.socketRef=null}if(b.retryTimer&&(clearTimeout(b.retryTimer),b.retryTimer=null),b.wired)return;if(!t||"function"!=typeof t.on)return void(b.retryTimer||(b.retryTimer=setTimeout(()=>{b.retryTimer=null,p()},1e3)));const e=["userlist","addUser","userLeave"],n=()=>{p(),m()};try{e.forEach(e=>t.on(e,n)),b.teardown=()=>{e.forEach(e=>{if("function"==typeof t.off)try{t.off(e,n)}catch(t){}else if("function"==typeof t.removeListener)try{t.removeListener(e,n)}catch(t){}})},b.wired=!0,b.socketRef=t,m()}catch(t){if(b.wired=!1,b.socketRef=null,"function"==typeof b.teardown)try{b.teardown()}catch(t){}b.teardown=null,b.retryTimer||(b.retryTimer=setTimeout(()=>{b.retryTimer=null,p()},1500))}}const h=(()=>{let t=!1;const e=()=>{p(),m()};return()=>{t||(t=!0,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e,{once:!0}):setTimeout(e,0),document.addEventListener("btfw:layoutReady",e),document.addEventListener("btfw:chat:barsReady",e))}})();function w(){const t=document.querySelector("#chatwrap .btfw-chat-bottombar");return t&&t.querySelector("#btfw-chat-actions")}const g=["#btfw-btn-emotes","#btfw-btn-gif","#btfw-chattools-btn","#btfw-ct-open","#btfw-chatcmds-btn","#btfw-users-toggle","#usercount"];function y(t){if(!t)return;const e=[];if(g.forEach(n=>{const o=t.querySelector(n);o&&o.parentElement===t&&!e.includes(o)&&e.push(o)}),e.length<=1)return;let n=!0;t:for(let t=0;t<e.length-1;t+=1)for(let o=t+1;o<e.length;o+=1){if(e[t].compareDocumentPosition(e[o])&Node.DOCUMENT_POSITION_PRECEDING){n=!1;break t}}if(n)return;const o=document.createElement("span");o.style.display="none",t.insertBefore(o,t.firstChild),e.forEach(e=>{e.parentElement===t&&t.insertBefore(e,o)}),o.remove()}const v=(()=>{let t=!1;const e=window.requestAnimationFrame||(t=>setTimeout(t,16));return()=>{t||(t=!0,e(()=>{t=!1,function(){const t=w();if(!t)return;const e=document.getElementById("btfw-gif-btn");e&&e.remove();const n=document.querySelector("#emotelistbtn, #emotelist");if(n&&(n.style.display="none"),!document.getElementById("btfw-btn-emotes")){const e=document.createElement("button");e.id="btfw-btn-emotes",e.className="button is-dark is-small btfw-chatbtn",e.title="Emotes / Emoji",e.innerHTML='<i class="fa fa-smile"></i>',t.appendChild(e)}if(!document.getElementById("btfw-btn-gif")){const e=document.createElement("button");e.id="btfw-btn-gif",e.className="button is-dark is-small btfw-chatbtn",e.title="GIFs",e.innerHTML='<i class="fa-solid fa-gif"></i>',t.appendChild(e)}["btfw-btn-emotes","btfw-btn-gif","btfw-chatcmds-btn","btfw-users-toggle","usercount"].forEach(e=>{const n=document.getElementById(e);n&&n.parentElement!==t&&t.appendChild(n)});const o=t.querySelector("#btfw-btn-gif");o&&(o.classList.add("btfw-chatbtn"),o.classList.add("button","is-dark","is-small"),o.title=o.title||"GIFs",o.querySelector("i.fa-solid.fa-gif")||(o.innerHTML='<i class="fa-solid fa-gif"></i>'));y(t)}()}))}})(),E={wired:!1,socketRef:null,teardown:null,retryTimer:null};function S(){const t=w();if(!t)return;const e=document._btfw_btn_obsTarget;if(e&&e!==t){const t=e._btfwNormalizeObserver;if(t&&"function"==typeof t.disconnect)try{t.disconnect()}catch(t){}e._btfwNormalizeObserver=null,document._btfw_btn_obsTarget=null}if(t._btfwNormalizeObserver)return;const n=new MutationObserver(()=>v());try{n.observe(t,{childList:!0}),t._btfwNormalizeObserver=n,document._btfw_btn_obsTarget=t}catch(t){v()}}function C(){const t=window.socket;if(E.wired&&E.socketRef&&E.socketRef!==t){if("function"==typeof E.teardown)try{E.teardown()}catch(t){}E.teardown=null,E.wired=!1,E.socketRef=null}if(E.retryTimer&&(clearTimeout(E.retryTimer),E.retryTimer=null),E.wired)return;if(!t||"function"!=typeof t.on)return void(E.retryTimer||(E.retryTimer=setTimeout(()=>{E.retryTimer=null,C()},1e3)));const e=["changeMedia","queue","setUserMeta","setAFK"],n=()=>{C(),S(),v()};try{e.forEach(e=>t.on(e,n)),E.teardown=()=>{e.forEach(e=>{if("function"==typeof t.off)try{t.off(e,n)}catch(t){}else if("function"==typeof t.removeListener)try{t.removeListener(e,n)}catch(t){}})},E.wired=!0,E.socketRef=t}catch(t){if(E.wired=!1,E.socketRef=null,"function"==typeof E.teardown)try{E.teardown()}catch(t){}E.teardown=null,E.retryTimer||(E.retryTimer=setTimeout(()=>{E.retryTimer=null,C()},1500))}}const k=(()=>{let t=!1;const e=()=>{C(),S(),v()};return()=>{t||(t=!0,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e,{once:!0}):setTimeout(e,0),document.addEventListener("btfw:layoutReady",e),document.addEventListener("btfw:chat:barsReady",e))}})();function T(t){if(!function(t){if(!t||1!==t.nodeType)return!1;const e=t.classList;if(!e||0===e.length)return!1;if(e.contains("chat-msg"))return!0;for(const t of e)if(t&&t.startsWith("chat-msg-"))return!0;return!1}(t))return;!!t.querySelector(".username")?(t.classList.add("btfw-new-user-msg"),t.classList.remove("btfw-continuation-msg")):(t.classList.add("btfw-continuation-msg"),t.classList.remove("btfw-new-user-msg"))}const _=(()=>{let t=!1;const e=window.requestAnimationFrame||(t=>setTimeout(t,16));return()=>{t||(t=!0,e(()=>{t=!1,function(){const t=M();if(!t)return;const e=t.children||[];for(const t of e)t&&1===t.nodeType&&T(t)}()}))}})(),L=new WeakSet;function M(){return document.getElementById("messagebuffer")||document.querySelector(".chat-messages, #chatbuffer, .message-buffer")}function x(){if(!M())return;const t=window.socket;t&&"function"==typeof t.on&&t.on("chatMsg",()=>{"function"==typeof window.scrollChat&&(window.scrollChat(),setTimeout(()=>window.scrollChat(),100),setTimeout(()=>window.scrollChat(),250))}),A(),"function"==typeof window.scrollChat&&setTimeout(()=>window.scrollChat(),80)}function A(){const t=M();if(!t)return;const e=[];t.querySelectorAll(".chat-msg, .message, [class*=message]").forEach(t=>{L.has(t)||(T(t),e.push(t))}),e.length&&e.forEach(t=>{L.add(t)})}const N=(()=>{let t=!1;const e=window.requestAnimationFrame||(t=>setTimeout(t,16));return()=>{t||(t=!0,e(()=>{t=!1,A()}))}})();function $(){N(),setTimeout(()=>A(),80)}const q={wired:!1,retryTimer:null,socketRef:null,teardown:null};function B(){const t=window.socket;if(q.wired&&q.socketRef&&q.socketRef!==t){if("function"==typeof q.teardown)try{q.teardown()}catch(t){}q.wired=!1,q.socketRef=null,q.teardown=null}if(!q.wired)if(t&&"function"==typeof t.on)try{t.on("chatMsg",$),q.wired=!0,q.socketRef=t,"function"==typeof t.off?q.teardown=()=>{try{t.off("chatMsg",$)}catch(t){}}:"function"==typeof t.removeListener?q.teardown=()=>{try{t.removeListener("chatMsg",$)}catch(t){}}:q.teardown=null,q.retryTimer&&(clearTimeout(q.retryTimer),q.retryTimer=null),N()}catch(t){q.wired=!1,q.retryTimer||(q.retryTimer=setTimeout(()=>{q.retryTimer=null,B()},1500))}else q.retryTimer||(q.retryTimer=setTimeout(()=>{q.retryTimer=null,B()},1e3))}function I(t){if(null==t)return"";let e=String(t).trim();return e?(e.endsWith(":")&&(e=e.slice(0,-1).trimEnd()),e):""}function P(){const t=document.getElementById("messagebuffer");t&&!t._btfwNameContext&&(t._btfwNameContext=!0,t.addEventListener("click",t=>{if(0!==t.button)return;const e=t.target.closest(".username");if(!e)return;const n=I(e.textContent||"");if(!n)return;const o=function(t){const e=I(t);if(!e)return null;const n=document.querySelector(`#userlist li[data-name="${CSS.escape(e)}"]`);if(n)return n;const o=document.querySelectorAll("#userlist li, #userlist .userlist_item, #userlist .user"),r=e.toLowerCase();for(const t of o){const e=t.getAttribute&&t.getAttribute("data-name")||t.textContent||"";if(!e)continue;const n=I(e);if(n&&n.toLowerCase()===r)return t}return null}(n);if(!o)return;const r=e.getBoundingClientRect(),a=t.clientX||r.left+r.width/2,s=t.clientY||r.bottom+6,c=new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,view:window,clientX:a,clientY:s});o.dispatchEvent(c),t.preventDefault(),t.stopPropagation()},!0))}function F(){const t=document.getElementById("newmessages-indicator"),e=document.querySelector("#chatwrap .btfw-controls-row");if(!t||!e)return;const n=document.getElementById("messagebuffer");t.classList.add("btfw-newmessages"),t.style.position="",t.style.left="",t.style.right="",t.style.bottom="",t.style.top="";let o=document.querySelector("#chatwrap .btfw-newmessages-slot");if(o||(o=document.createElement("div"),o.className="btfw-newmessages-slot"),n&&n.parentNode){const t=n.parentNode;(o.parentNode!==t||o.previousElementSibling!==n)&&t.insertBefore(o,n.nextSibling)}else(!o.parentNode&&e.parentNode||o.parentNode===e.parentNode&&o.nextSibling!==e)&&e.parentNode.insertBefore(o,e);t.parentElement!==o&&o.appendChild(t)}function D(){if(n("#btfw-userlist-pop"))return;const t=document.createElement("div");t.id="btfw-userlist-backdrop",t.className="btfw-popover-backdrop",t.dataset.btfwPopoverState="closed",t.setAttribute("hidden",""),t.setAttribute("aria-hidden","true"),t.style.zIndex="6001",document.body.appendChild(t);const o=document.createElement("div");o.id="btfw-userlist-pop",o.className="btfw-popover btfw-userlist-pop",o.dataset.btfwPopoverState="closed",o.setAttribute("hidden",""),o.setAttribute("aria-hidden","true"),o.style.zIndex="6002",o.innerHTML='\n      <div class="btfw-pophead">\n        <span>Users</span>\n        <button class="btfw-popclose" aria-label="Close">&times;</button>\n      </div>\n      <div class="btfw-popbody"></div>\n    ',document.body.appendChild(o),f();const r=()=>{const r=n("#userlist");r&&r.classList.remove("btfw-userlist-overlay--open"),e.closePopover(o,{backdrop:t})};function a(){i(o)}t.addEventListener("click",r),o.querySelector(".btfw-popclose").addEventListener("click",r),document.addEventListener("keydown",t=>{"Escape"===t.key&&r()},!0),window.addEventListener("resize",a),window.addEventListener("scroll",a,!0),document._btfw_userlist_isOpen=()=>"open"===o.dataset.btfwPopoverState,document._btfw_userlist_open=()=>{f();const r=n("#userlist");r&&r.classList.add("btfw-userlist-overlay--open"),e.openPopover(o,{backdrop:t}),i(o)},document._btfw_userlist_close=r,document._btfw_userlist_position=a}function O(){!function(){const t=n("#chatwrap");if(!t)return;t.classList.add("btfw-chatwrap");let e=t.querySelector(".btfw-chat-topbar");e||(e=document.createElement("div"),e.className="btfw-chat-topbar",e.innerHTML='\n        <div class="btfw-chat-topbar-left">\n          <div class="btfw-chat-title" id="btfw-nowplaying-slot"></div>\n        </div>\n        <div class="btfw-chat-topbar-actions" id="btfw-chat-topbar-actions"></div>\n      ',t.prepend(e));let o=e.querySelector(".btfw-chat-topbar-left");if(o||(o=document.createElement("div"),o.className="btfw-chat-topbar-left",e.prepend(o)),!o.querySelector("#btfw-nowplaying-slot")){const t=document.createElement("div");t.id="btfw-nowplaying-slot",t.className="btfw-chat-title",o.appendChild(t)}let r=e.querySelector("#btfw-chat-topbar-actions");if(r||(r=document.createElement("div"),r.id="btfw-chat-topbar-actions",r.className="btfw-chat-topbar-actions",e.appendChild(r)),!r.querySelector("#btfw-mobile-modules-toggle")){const t=document.createElement("button");t.id="btfw-mobile-modules-toggle",t.className="button is-dark is-small btfw-chatbtn",t.title="Open navigation menu",t.setAttribute("aria-label","Open navigation menu"),t.innerHTML='<i class="fa fa-bars"></i>',r.appendChild(t)}let a=t.querySelector(".btfw-chat-bottombar");a||(a=document.createElement("div"),a.className="btfw-chat-bottombar",t.appendChild(a));let s=a.querySelector(".btfw-chat-composer");s||(s=document.createElement("div"),s.className="btfw-chat-composer",a.prepend(s));let c=s.querySelector("#btfw-chat-composer-main");c||(c=document.createElement("div"),c.id="btfw-chat-composer-main",c.className="btfw-chat-composer-main",s.prepend(c));let i=s.querySelector("#btfw-chat-actions")||a.querySelector("#btfw-chat-actions");i&&i.parentElement!==s&&s.appendChild(i),i||(i=document.createElement("div"),i.id="btfw-chat-actions",s.appendChild(i)),i.classList.add("btfw-chat-actions");const l=n("#btfw-gif-btn");l&&l.remove();const d=n("#btfw-theme-btn-chat");if(d&&d.remove(),!n("#btfw-btn-emotes")){const t=document.createElement("button");t.id="btfw-btn-emotes",t.className="button is-dark is-small btfw-chatbtn",t.title="Emotes / Emoji",t.innerHTML='<i class="fa fa-smile"></i>',i.appendChild(t)}const u=n("#emotelistbtn, #emotelist");if(u&&(u.style.display="none"),!n("#btfw-btn-gif")){const t=document.createElement("button");t.id="btfw-btn-gif",t.className="button is-dark is-small btfw-chatbtn",t.title="GIFs",t.innerHTML='<i class="fa fa-file-video-o"></i>',i.appendChild(t)}const f=n("#btfw-chatcmds-btn");if(f&&f.parentElement!==i&&(f.classList.add("button","is-dark","is-small","btfw-chatbtn"),i.appendChild(f)),!n("#btfw-users-toggle")){const t=document.createElement("button");t.id="btfw-users-toggle",t.className="button is-dark is-small btfw-chatbtn",t.title="Users",t.innerHTML='<i class="fa fa-users"></i>',i.appendChild(t)}const m=n("#messagebuffer");m&&m.classList.add("btfw-messagebuffer");const b=n("#chatcontrols,#chat-controls")||n("#chatline")&&n("#chatline").parentElement;b&&b.parentElement!==c&&(b.classList.add("btfw-controls-row"),c.appendChild(b)),v(),P(),F(),document.dispatchEvent(new CustomEvent("btfw:chat:barsReady",{detail:{topbar:e,bottombar:a,actions:r}}))}(),f(),F(),x(),N(),_()}const W=(()=>{let t=!1;const e=window.requestAnimationFrame||(t=>setTimeout(t,16));return()=>{t||(t=!0,e(()=>{t=!1,O()}))}})(),R={socket:null};function z(){const t=n("#usercount");if(!t)return;const e=(t.textContent||"").replace(/connected users/gi," ").replace(/connected user/gi," ").replace(/not connected/gi," ").replace(/\s+/g," ").trim();t.textContent=e||"0"}function H(){if(!n("#usercount"))return;z();const t=window.socket;t&&"function"==typeof t.on?R.socket!==t&&(R.socket=t,t.on("usercount",()=>{z()}),t.on("userlist",t=>{if(Array.isArray(t)){const e=n("#usercount");e&&(e.textContent=String(t.length))}z()})):setTimeout(H,500)}function j(t){const e=t.matches?.(".username,.nick,.name")?t:t.querySelector?.(".username,.nick,.name");if(!e)return;const n=(e.textContent||"").replace(":","").trim();if(!n)return;let o=0;for(let t=0;t<n.length;t++)o=n.charCodeAt(t)+((o<<5)-o);let r="#";for(let t=0;t<3;t++)r+=("00"+(o>>8*t&255).toString(16)).slice(-2);e.style.color=r}let U=!1;async function K(){document.dispatchEvent(new CustomEvent("btfw:openThemeSettings"));let t=n("#btfw-theme-modal");if(t)e.openModal(t);else if(await new Promise(t=>setTimeout(t,40)),t=n("#btfw-theme-modal"),t)e.openModal(t);else if(!U){U=!0;try{const a=o?`${o}/modules/feature-theme-settings.js`:"/modules/feature-theme-settings.js";await(r=a,new Promise((t,e)=>{const n=document.createElement("script");n.src=r,n.async=!0,n.defer=!0,n.onload=()=>t(!0),n.onerror=()=>e(new Error("Failed to load "+r)),document.head.appendChild(n)})),document.dispatchEvent(new CustomEvent("btfw:openThemeSettings")),await new Promise(t=>setTimeout(t,40)),t=n("#btfw-theme-modal"),t&&e.openModal(t)}catch(t){console.warn("[chat] Theme Settings lazy-load failed:",t.message||t)}finally{U=!1}var r}}function Y(){window._btfwChatClicksWired||(window._btfwChatClicksWired=!0,document.addEventListener("click",function(t){const e=t.target,n=e.closest&&e.closest("#btfw-btn-gif"),o=e.closest&&e.closest("#btfw-btn-emotes"),r=e.closest&&e.closest("#btfw-theme-btn-nav"),a=e.closest&&e.closest("#btfw-users-toggle"),s=e.closest&&e.closest("#btfw-chatcmds-btn");if(n)return t.preventDefault(),void document.dispatchEvent(new Event("btfw:openGifs"));if(o){t.preventDefault();const e=new Event("btfw:openEmotes");return document.dispatchEvent(e),void setTimeout(()=>{if(!document.querySelector(".btfw-emote-pop,.btfw-popover.btfw-emote-pop")){const t=document.querySelector("#emotelistbtn, #emotelist");t&&t.click()}},10)}return r?(t.preventDefault(),void K()):a?(t.preventDefault(),D(),void(document._btfw_userlist_isOpen&&document._btfw_userlist_isOpen()?document._btfw_userlist_close&&document._btfw_userlist_close():document._btfw_userlist_open&&document._btfw_userlist_open())):s?(t.preventDefault(),void document.dispatchEvent(new Event("btfw:openChatCmds"))):void 0},!0))}function G(){O(),B(),function(){if(document._btfw_userlist_watch?.disconnect)try{document._btfw_userlist_watch.disconnect()}catch(t){}document._btfw_userlist_watch=!0,h(),m(),p()}(),function(){const t=n("#chatwrap");if(!t)return;const e=t.querySelector(".btfw-chat-bottombar");if(!e)return;const o=e.querySelector("#btfw-chat-actions");if(!o)return;let r=o.querySelector("#usercount");r||(r=n("#usercount"),r&&r.parentElement!==o&&o.appendChild(r)),r||(r=document.createElement("div"),r.id="usercount",o.appendChild(r)),r.classList.add("btfw-usercount"),r.classList.remove("pointer"),r.title||(r.title="Connected users"),r.dataset.btfwUsercountBound||(r.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation()},!0),r.addEventListener("contextmenu",t=>{t.preventDefault(),t.stopPropagation()},!0),r.dataset.btfwUsercountBound="true"),z(),y(o),H()}(),D(),function(){const t=n("#chatwrap");if(!t||t._btfw_chat_obs)return;t._btfw_chat_obs=!0,new MutationObserver(()=>{W()}).observe(t,{childList:!0,subtree:!0});const e=n("#messagebuffer");e&&!e._btfw_color_obs&&(e._btfw_color_obs=!0,new MutationObserver(t=>{t.forEach(t=>{t.addedNodes.forEach(t=>{1===t.nodeType&&j(t)})})}).observe(e,{childList:!0}),Array.from(e.querySelectorAll(".username,.nick,.name")).forEach(j)),x()}(),_(),Y(),document._btfw_btn_watch||(document._btfw_btn_watch=!0,k(),S(),v(),C())}return document.addEventListener("btfw:themeSettings:apply",()=>{_()}),document.addEventListener("btfw:layoutReady",()=>setTimeout(G,50)),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",G):G(),{name:"feature:chat"}}),BTFW.define("feature:chat-tools",["feature:chat"],async({init:t})=>{const e=await t("util:motion"),n=(t,e=document)=>e.querySelector(t),o="btfw:chat:history",r="btfw:chat:stickColor",a=["#1abc9c","#16a085","#f1c40f","#f39c12","#2ecc71","#27ae60","#e67e22","#d35400","#3498db","#2980b9","#e74c3c","#c0392b","#9b59b6","#8e44ad","#0080a5","#34495e","#2c3e50","#87724b","#7300a7","#ec87bf","#d870ad","#f69785","#9ba37e","#b49255","#a94136"];try{localStorage.removeItem("btfw:chat:nameColor")}catch(t){}((t,e=document)=>Array.from(e.querySelectorAll(t)))("#messagebuffer .username, #messagebuffer .nick, #messagebuffer .name").forEach(t=>{try{t.style.color=""}catch(t){}});const s=()=>n("#chatline");function c(t){!function(t){const e=s();if(!e)return;const n=e.selectionStart??e.value.length,o=e.selectionEnd??e.value.length,r=e.value.slice(0,n),a=e.value.slice(n,o),c=e.value.slice(o);t(e,{a:n,b:o,before:r,mid:a,after:c})}((e,n)=>{const o=`[${t}]`,r=`[/${t}]`;if(e.value=n.before+o+n.mid+r+n.after,0===n.mid.length){const t=n.before.length+o.length;e.focus(),e.setSelectionRange(t,t)}else{const t=n.before.length+o.length,r=t+n.mid.length;e.focus(),e.setSelectionRange(t,r)}})}function i(t){return t?(t=t.trim(),/^[0-9a-f]{6}$/i.test(t)&&(t="#"+t),/^#[0-9a-f]{6}$/i.test(t)?t.toLowerCase():""):""}function l(){try{return localStorage.getItem(r)||""}catch(t){return""}}function d(t){try{localStorage.setItem(r,i(t)||"")}catch(t){}}function u(){const t=document.getElementById("chatwrap")||document.body;let e=document.getElementById("btfw-ct-modal");e||(e=document.createElement("div"),e.id="btfw-ct-modal",e.setAttribute("hidden",""),e.setAttribute("aria-hidden","true"),t.appendChild(e)),e.textContent="";const o=document.createElement("div");o.className="btfw-ct-card";const r=document.createElement("div");r.className="btfw-ct-cardhead";const s=document.createElement("span");s.textContent="Chat Tools";const c=document.createElement("button");c.className="btfw-ct-close",c.setAttribute("aria-label","Close"),c.innerHTML="&times;",r.appendChild(s),r.appendChild(c),o.appendChild(r);const i=document.createElement("div");i.className="btfw-ct-body";const d=document.createElement("div");d.className="btfw-ct-grid",[{tag:"b",html:"<strong>B</strong><span>Bold</span>"},{tag:"i",html:"<em>I</em><span>Italic</span>"},{tag:"u",html:"<u>U</u><span>Underline</span>"},{tag:"s",html:'<span style="text-decoration:line-through">S</span><span>Strike</span>'},{tag:"sp",html:"<span>ðŸ™ˆ</span><span>Spoiler</span>"}].forEach(({tag:t,html:e})=>{const n=document.createElement("button");n.className="btfw-ct-item",n.setAttribute("data-tag",t),n.innerHTML=e,d.appendChild(n)}),i.appendChild(d);const u=document.createElement("div");u.className="btfw-ct-color";const f=document.createElement("label");f.className="btfw-ct-keep";const m=document.createElement("input");m.type="checkbox",m.id="btfw-ct-keepcolor",f.appendChild(m),f.appendChild(document.createTextNode(" Keep color")),u.appendChild(f);const b=document.createElement("div");b.className="btfw-ct-swatch",b.id="btfw-ct-swatch",u.appendChild(b);const p=document.createElement("div");p.className="btfw-ct-hexrow",p.style.display="flex",p.style.gap="6px",p.style.alignItems="center",p.style.marginTop="6px";const h=document.createElement("input");h.id="btfw-ct-hex",h.type="text",h.placeholder="#rrggbb",h.maxLength=7,h.className="input is-small",h.style.maxWidth="120px";const w=document.createElement("button");w.id="btfw-ct-insertcolor",w.className="button is-small",w.textContent="Insert";const g=document.createElement("button");g.id="btfw-ct-clearcolor",g.className="button is-small",g.textContent="Clear Keep",p.appendChild(h),p.appendChild(w),p.appendChild(g),u.appendChild(p),i.appendChild(u);const y=document.createElement("div");y.className="btfw-ct-actions",y.style.display="flex",y.style.gap="6px",y.style.marginTop="8px",[{act:"clear",text:"Clear"},{act:"afk",text:"AFK"}].forEach(({act:t,text:e})=>{const n=document.createElement("button");n.className="btfw-ct-item button is-small",n.setAttribute("data-act",t),n.textContent=e,y.appendChild(n)}),i.appendChild(y),o.appendChild(i),e.appendChild(o),e.style.background="transparent",e.style.pointerEvents="none",function(){const t=n("#btfw-ct-keepcolor"),e=n("#btfw-ct-hex"),o=l&&l()||"";t&&(t.checked=!!o),e&&o&&(e.value=o)}();const v=e.querySelector(".btfw-ct-card");v&&(v.classList.add("btfw-popover"),v.style.pointerEvents="auto",v.dataset.btfwPopoverState="closed",v.setAttribute("hidden",""),v.setAttribute("aria-hidden","true"));const E=document.querySelector("#btfw-ct-swatch");return E&&!E.hasChildNodes()&&a.forEach(t=>{const e=document.createElement("button");e.className="btfw-ct-swatchbtn",e.style.background=t,e.dataset.color=t,E.appendChild(e)}),e}function f(){const t=n("#btfw-ct-modal");if(!t)return;const o=t.querySelector(".btfw-ct-card");if(!o)return t.setAttribute("hidden",""),void t.setAttribute("aria-hidden","true");e.closePopover(o).then(()=>{"open"!==o.dataset.btfwPopoverState&&(t.setAttribute("hidden",""),t.setAttribute("aria-hidden","true"))})}function m(){const t=document.getElementById("btfw-ct-modal");if(!t)return;const e=t.querySelector(".btfw-ct-card");if(!e)return;if(window.BTFW_positionPopoverAboveChatBar)return void window.BTFW_positionPopoverAboveChatBar(e,{widthPx:420,widthVw:92,maxHpx:360,maxHvh:60});const n=document.getElementById("chatcontrols")||document.getElementById("chat-controls")||document.getElementById("chatline")&&document.getElementById("chatline").parentElement;if(!n)return;const o=(n.offsetHeight||48)+12;e.style.position="fixed",e.style.right="8px",e.style.bottom=o+"px",e.style.maxHeight="60vh",e.style.width="min(420px,92vw)"}function b(){try{return JSON.parse(localStorage.getItem(o)||"[]")}catch(t){return[]}}let p=-1;function h(t){if(!t)return;const e=b();e[e.length-1]!==t&&(e.push(t),function(t){try{localStorage.setItem(o,JSON.stringify(t.slice(-50)))}catch(t){}}(e)),p=-1}function w(t){const e=s();if(!e)return;const n=b();n.length&&(-1===p&&(p=n.length),p+=t<0?-1:1,p=Math.max(0,Math.min(n.length-1,p)),e.value=n[p]||"",e.focus(),e.setSelectionRange(e.value.length,e.value.length))}function g(){if(window._btfwChatToolsWired)return;window._btfwChatToolsWired=!0,function(){const t=n("#chatwrap .btfw-chat-bottombar #btfw-chat-actions");if(!t)return;if(n("#btfw-chattools-btn")||n("#btfw-ct-open"))return;const e=document.createElement("button");e.id="btfw-chattools-btn",e.className="button is-dark is-small btfw-chatbtn",e.innerHTML='<span style="font-weight:700;letter-spacing:.5px;">Aa</span>';const o=t.querySelector("#btfw-chatcmds-btn")||t.querySelector("#btfw-users-toggle")||t.querySelector("#usercount");t.insertBefore(e,o||null)}(),u();const t=n("#btfw-chattools-btn")||n("#btfw-ct-open");t&&t.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const o=n("#btfw-ct-modal"),r=o?.querySelector?.(".btfw-ct-card");!(!r||"open"!==r.dataset.btfwPopoverState)?f():function(){const t=u();if(!t)return;!function(){const t=document.getElementById("btfw-ct-keepcolor"),e=document.getElementById("btfw-ct-hex"),n=l()||"";t&&(t.checked=!!n),e&&n&&(e.value=n),t&&t.checked&&!n&&(t.checked=!1)}(),t.removeAttribute("hidden"),t.removeAttribute("aria-hidden"),m();const n=t.querySelector(".btfw-ct-card");n&&e.openPopover(n)}()},{capture:!0}),document.addEventListener("click",t=>{if(t.target.closest&&t.target.closest(".btfw-ct-close"))return t.preventDefault(),void f();const e=t.target.closest&&t.target.closest("#btfw-ct-modal .btfw-ct-card"),o=t.target.closest&&t.target.closest(".btfw-ct-item[data-tag]");if(o&&e)return t.preventDefault(),c(o.dataset.tag),void f();if(t.target.closest&&t.target.closest('.btfw-ct-item[data-act="afk"]')&&e)return t.preventDefault(),window.socket?.emit&&window.socket.emit("chatMsg",{msg:"/afk"}),void f();if(t.target.closest&&t.target.closest('.btfw-ct-item[data-act="clear"]')&&e){t.preventDefault();const e=n("#messagebuffer");return e&&(e.innerHTML=""),void f()}const r=t.target.closest&&t.target.closest(".btfw-ct-swatchbtn");if(r&&e){t.preventDefault();const e=i(r.dataset.color||""),o=n("#btfw-ct-hex");o&&(o.value=e);const a=n("#btfw-ct-keepcolor");return void(a&&a.checked&&d(e))}if(t.target&&"btfw-ct-insertcolor"===t.target.id&&e){t.preventDefault();const e=n("#btfw-ct-hex"),o=i((e?.value||"").trim());if(o){!function(t){if(!(t=i(t)))return;const e=s();if(!e)return;const n=(e.value||"").replace(/^col:\s*#?[0-9a-fA-F]{6}:\s*/,""),o=`col:${t}:`,r=n&&!/^\s/.test(n)?" ":"";e.value=o+r+n;const a=e.value.length;e.focus(),e.setSelectionRange(a,a)}(o);const t=n("#btfw-ct-keepcolor");t&&t.checked&&d(o),f()}return}if(t.target&&"btfw-ct-clearcolor"===t.target.id&&e){t.preventDefault(),d("");const e=n("#btfw-ct-keepcolor");return void(e&&(e.checked=!1))}e||t.target.closest("#btfw-chattools-btn")||t.target.closest("#btfw-ct-open")||f()},!0),document.addEventListener("change",t=>{if(t.target&&"btfw-ct-keepcolor"===t.target.id){const e=n("#btfw-ct-hex"),o=i((e?.value||"").trim());return void(t.target.checked?o?d(o):(d(""),t.target.checked=!1):d(""))}},!0),document.addEventListener("input",t=>{if(t.target&&"btfw-ct-hex"===t.target.id){const e=n("#btfw-ct-keepcolor");if(e&&e.checked){d(i((t.target.value||"").trim()))}}},!0),document.addEventListener("keydown",t=>{"Escape"===t.key&&f()},!0);const o=s();o&&o.addEventListener("keydown",t=>{"Enter"!==t.key||t.shiftKey||(!function(){const t=l();if(!t)return;const e=s();if(!e)return;const n=(e.value||"").trimStart();/^col:\s*#?[0-9a-fA-F]{6}:/i.test(n)||(e.value=`col:${i(t)}:`+(n?" ":"")+n)}(),h(o.value.trim())),"ArrowUp"!==t.key||t.shiftKey||o.selectionStart!==o.selectionEnd||0!==o.selectionStart||(t.preventDefault(),w(-1)),"ArrowDown"!==t.key||t.shiftKey||o.selectionStart!==o.selectionEnd||o.selectionStart!==o.value.length||(t.preventDefault(),w(1))}),window.addEventListener("resize",m),n("#chatwrap")?.addEventListener("scroll",m,{passive:!0})}function y(){g(),m()}return document.addEventListener("btfw:layoutReady",()=>setTimeout(y,0)),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",y):y(),{name:"feature:chat-tools"}}),BTFW.define("feature:chat-filters",[],async()=>{const t=[{name:"monospace",source:"`(.+?)`",flags:"g",replace:"<code>\\1</code>",active:!0,filterlinks:!1},{name:"bold",source:"\\*(.+?)\\*",flags:"g",replace:"<strong>\\1</strong>",active:!0,filterlinks:!1},{name:"italic",source:"_(.+?)_",flags:"g",replace:"<em>\\1</em>",active:!0,filterlinks:!1},{name:"strike",source:"~~(.+?)~~",flags:"g",replace:"<s>\\1</s>",active:!0,filterlinks:!1},{name:"inline spoiler",source:"\\[sp\\](.*?)\\[\\/sp\\]",flags:"gi",replace:'<span class="spoiler">\\1</span>',active:!0,filterlinks:!1},{name:"partial quote",source:"&gt;(.+?)$",flags:"g",replace:'<span class="quote">&gt;\\1 </span>',active:!0,filterlinks:!1},{name:"italic text",source:"\\[i\\](.+?)\\[\\/i\\]",flags:"g",replace:"<em>\\1</em>",active:!0,filterlinks:!1},{name:"monospace text",source:"\\[code\\](.+?)\\[\\/code\\]",flags:"gi",replace:"<code>\\1</code>",active:!0,filterlinks:!1},{name:"bold text",source:"\\[b\\](.+?)\\[\\/b\\]",flags:"gi",replace:"<strong>\\1</strong>",active:!0,filterlinks:!1},{name:"striked text",source:"\\[s\\](.+?)\\[\\/s\\]",flags:"gi",replace:"<s>\\1</s>",active:!0,filterlinks:!1},{name:"short spoiler",source:"\\[sp\\]",flags:"g",replace:'<span class="spoiler">',active:!0,filterlinks:!1},{name:"closing font style",source:"\\[\\/\\]",flags:"g",replace:"<span>",active:!0,filterlinks:!1},{name:"chat colors (premium)",source:"col:(.*?):",flags:"g",replace:'<span style="color:\\1" class="chatcolor">',active:!0,filterlinks:!1},{name:"giphy",source:"https?://(?|media\\d\\.giphy\\.com/media/(?:[^/]+/)?([^ /\\n]+)/giphy\\.gif|i\\.giphy\\.com/([^ /\\n]+)\\.gif|giphy\\.com/gifs/(?:.*-)?([^ /\\n]+))",flags:"gi",replace:'<img class="giphy chat-picture" src="https://media.giphy.com/media/\\1/200_s.gif" />',active:!0,filterlinks:!0},{name:"tenor",source:"(https?://media\\.tenor\\.com/[^\\s]+\\.gif)",flags:"gi",replace:'<img class="tenor chat-picture" src="\\0" />',active:!0,filterlinks:!0},{name:"TMDB",source:"\\[tmdbcard\\]([^|]+)\\|([^|]+)\\|([^|]+)\\|([^|]+)\\|([^\\[]+)\\[\\/tmdbcard\\]",flags:"g",replace:'<div class="tmdb-card"><img class="tmdb-card__poster" src="https://image.tmdb.org/t/p/w342\\5" alt="\\1 poster" onerror="this.style.display=\'none\'"><div class="tmdb-card__content"><div class="tmdb-card__title">\\1 <span class="tmdb-card__year">(\\2)</span></div><div class="tmdb-card__rating">â˜… \\3</div><div class="tmdb-card__overview">\\4</div></div></div>',active:!0,filterlinks:!0}];function e(){return window.jQuery&&"function"==typeof window.jQuery?window.jQuery:window.$&&"function"==typeof window.$?window.$:null}function n(e){const n=e("#cs-chatfilters-exporttext");if(n&&n.length)try{n.val(JSON.stringify(t,null,2)),console.info("[BTFW chat-filters] Imported custom chat filters into text field.",t)}catch(t){console.error("[BTFW chat-filters] Error serializing custom filters:",t)}else console.error("[BTFW chat-filters] Unable to find export text field.")}return function(){const t=e();if(!t)return void console.warn("[BTFW chat-filters] jQuery not available; cannot attach import button.");const o=()=>function(t){const e=t("#cs-chatfilters");if(!e||!e.length)return void console.error("[BTFW chat-filters] Chat filter menu not found.");if(e.find("#btfw-add-custom-filter-button").length)return;const o=t('<button id="btfw-add-custom-filter-button" class="btn btn-sm btn-primary" style="margin-top: 10px;">Import Required BillTube Chat Filters</button>');o.on("click",function(e){e.preventDefault(),n(t)}),e.append(o)}(t);"loading"===document.readyState?document.addEventListener("DOMContentLoaded",o,{once:!0}):o()}(),{importCustomChatFiltersToTextarea:t=>n(t||e())}}),BTFW.define("feature:chat-username-colors",[],async()=>{const t="btfw:chat:unameColors";function e(){try{return"1"===(localStorage.getItem(t)??"1")}catch(t){return!0}}const n=["#6D4DF6","#2CB1BC","#F29D49","#E85D75","#5AC26A","#B980F0","#59A1FF","#ED6A5E","#F2C94C","#00B894","#E84393","#0984E3","#55EFC4","#FAB1A0","#A29BFE"];function o(t){const e=function(t){if(!t)return null;const e=document.querySelector(`#userlist li[data-name="${CSS.escape(t)}"]`);if(e)return e;const n=document.querySelectorAll("#userlist li, #userlist .userlist_item, #userlist .user");for(const e of n){const n=(e.textContent||"").trim();if(n&&n.replace(/\s+/g,"").toLowerCase().startsWith(t.toLowerCase()))return e}return null}(t);return e?.getAttribute?.("data-color")||e?.style?.color||null||function(t){let e=0;for(let n=0;n<t.length;n++)e=Math.imul(31,e)+t.charCodeAt(n)|0;const o=Math.abs(e)%n.length;return n[o]}(t)}function r(t){if(!t)return;(t.matches?.(".username")?[t]:t.querySelectorAll?.(".username")||[]).forEach(t=>{const n=(t.textContent||"").trim().replace(/:\s*$/,"");n&&function(t,n){if(!t||!n)return;if(!e())return t.style.removeProperty("--btfw-name-color"),void t.classList.remove("btfw-username-colored");const r=o(n);t.style.setProperty("--btfw-name-color",r),t.classList.add("btfw-username-colored")}(t,n)})}function a(){const t=document.getElementById("messagebuffer");t&&r(t)}function s(){a();const t=document.getElementById("messagebuffer");if(t&&!t._btfwNameColorMO){const e=new MutationObserver(t=>{for(const e of t)"childList"===e.type&&e.addedNodes&&e.addedNodes.forEach(t=>{1===t.nodeType&&r(t)})});e.observe(t,{childList:!0,subtree:!0}),t._btfwNameColorMO=e}}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",s):s(),{name:"feature:chat-username-colors",getEnabled:e,setEnabled:function(e){try{localStorage.setItem(t,e?"1":"0")}catch(t){}a()},reapply:a}}),BTFW.define("feature:chatMedia",[],async()=>{const t=(t,e=document)=>Array.from(e.querySelectorAll(t)),e="btfw:chat:emoteSize",n="btfw:chat:gifAutoplay",o={sm:100,md:130,lg:170},r="#messagebuffer img.giphy.chat-picture, #messagebuffer img.tenor.chat-picture";function a(){try{return localStorage.getItem(e)||"md"}catch(t){return"md"}}function s(){try{return localStorage.getItem(n)??"1"}catch(t){return"1"}}function c(e){const n=o[e]||o.md;document.documentElement.style.setProperty("--btfw-emote-size",n+"px"),t(r).forEach(m)}const i=t=>t.classList.contains("giphy")||/media\d\.giphy\.com\/media\/.+\/.+\.gif/i.test(t.src),l=t=>t.classList.contains("tenor")||/media\.tenor\.com\/.+\.gif/i.test(t.src),d=t=>t.replace(/\/200_s\.gif$/i,"/200.gif"),u=t=>t.replace(/\/200\.gif$/i,"/200_s.gif");function f(t,e){e&&t.src!==e&&(t.src=e)}function m(t){t.hasAttribute("width")&&t.removeAttribute("width"),t.hasAttribute("height")&&t.removeAttribute("height");const e="var(--btfw-emote-size)";t.style.setProperty("width","auto","important"),t.style.setProperty("height","auto","important"),t.style.setProperty("max-width",e,"important"),t.style.setProperty("max-height",e,"important"),t.style.setProperty("object-fit","contain"),t.style.setProperty("vertical-align","middle"),t.style.setProperty("border-radius","8px"),t.style.setProperty("margin","2px 3px")}function b(t){!function(t){t.classList.contains("channel-emote")||t.classList.add("channel-emote")}(t),m(t),t._btfwWired||(t._btfwWired=!0);const e="1"===s();i(t)?e?(f(t,d(t.src)),t.onmouseenter=null,t.onmouseleave=null):(f(t,u(t.src)),t.onmouseenter=()=>{f(t,d(t.src))},t.onmouseleave=()=>{f(t,u(t.src))}):l(t)&&(t.onmouseenter=null,t.onmouseleave=null)}function p(t){if(!t)return;const e=t.matches&&t.matches(r)?[t]:[];(e.length?e:t.querySelectorAll?t.querySelectorAll(r):[]).forEach(b)}function h(){t(r).forEach(b)}function w(){const t=((t,e=document)=>e.querySelector(t))("#messagebuffer");if(t&&p(t),t&&!t._btfwMediaMO){const e=new MutationObserver(t=>{for(const e of t)"childList"===e.type&&e.addedNodes&&e.addedNodes.forEach(t=>{1===t.nodeType&&p(t)})});e.observe(t,{childList:!0,subtree:!0}),t._btfwMediaMO=e}c(a()),h(),console.log("[BTFW] chatMedia ready (runtime sizing)")}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",w):w(),{name:"feature:chatMedia",setEmoteSize:function(t){o[t]||(t="md");try{localStorage.setItem(e,t)}catch(t){}c(t)},getEmoteSize:a,setGifAutoplayOn:function(t){try{localStorage.setItem(n,t?"1":"0")}catch(t){}h()},getGifAutoplayOn:()=>"1"===s()}}),BTFW.define("feature:chat-avatars",[],async()=>{const t="btfw:chat:avatars",e=`${t}:urls:v1`,n=new Map,o=function(){try{const t=localStorage.getItem(e);if(!t)return new Map;const n=JSON.parse(t);if(!Array.isArray(n))return new Map;const o=new Map;return n.forEach(t=>{if(!Array.isArray(t)||t.length<2)return;const[e,n]=t;"string"==typeof e&&n&&"string"==typeof n.url&&n.url&&o.set(e,{url:n.url,ts:n.ts||0})}),o}catch(t){return new Map}}();let r=null,a=!1;let s=function(){try{const e=localStorage.getItem(t);if("off"===e||"big"===e||"small"===e)return e}catch(t){}return"big"}();function c(t){return(t||"").trim().toLowerCase()}function i(){a||(a=!0),r||(r=setTimeout(()=>{if(r=null,a){a=!1;try{const t=JSON.stringify(Array.from(o.entries()));localStorage.setItem(e,t)}catch(t){}}},250))}function l(t,e){const n=c(t);if(!n||!e)return;const r=o.get(n);r&&r.url===e?(r.ts=Date.now(),o.delete(n),o.set(n,r)):(o.delete(n),o.set(n,{url:e,ts:Date.now()}),function(){for(;o.size>200;){const t=o.keys().next().value;if(!t)break;o.delete(t)}}()),i()}function d(t){try{const e=function(t){if(!t)return null;const e=document.querySelector(`#userlist li[data-name="${CSS.escape(t)}"]`);if(e)return e;const n=document.querySelectorAll("#userlist li, #userlist .userlist_item, #userlist .user");for(const e of n){const n=(e.textContent||"").trim();if(n&&n.replace(/\s+/g,"").toLowerCase().startsWith(t.toLowerCase()))return e}return null}(t);if(!e||!window.jQuery)return"";const n=window.jQuery(e),o=n.data&&n.data("profile");return o&&o.image||""}catch(t){return""}}function u(t,e){const o=`${t}-${e}`;if(n.has(o))return n.get(o);const r=["#1abc9c","#16a085","#f1c40f","#f39c12","#2ecc71","#27ae60","#e67e22","#d35400","#3498db","#2980b9","#e74c3c","#c0392b","#9b59b6","#8e44ad","#0080a5","#34495e","#2c3e50","#87724b","#7300a7","#ec87bf","#d870ad","#f69785","#9ba37e","#b49255","#a94136"],a=(t||"?").trim(),s=r[(a.codePointAt(0)||63)%r.length],c=a.slice(0,2).toUpperCase(),i=e||24,l=`<svg xmlns="http://www.w3.org/2000/svg" width="${i}" height="${i}"><rect width="100%" height="100%" fill="${s}"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#fff" font-family="Inter,Arial,sans-serif" font-size="${Math.round(.5*i)}" font-weight="600">${c}</text></svg>`,d="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(l)));if(n.size>=200){const t=n.keys().next().value;n.delete(t)}return n.set(o,d),d}function f(t){const e=t&&t.currentTarget;if(!e||"svg"===e.dataset.avatarFallback)return;const n=e.dataset.avatarKey||"",r=e.dataset.avatarUrl||"",a=parseInt(e.dataset.avatarSize||"",10)||24,s=e.dataset.avatarLabel||e.alt||"";n&&function(t,e){if(!t)return;const n=o.get(t);!n||e&&n.url!==e||(o.delete(t),i())}(n,r);const c=u(s,a);e.dataset.avatarFallback="svg",e.dataset.avatarUrl="",e.src=c}function m(t,e,{key:n,label:o,size:r,type:a}){if(!t||!e)return;const s="svg"===a?"svg":"url";n&&(t.dataset.avatarKey=n),o&&(t.dataset.avatarLabel=o,t.alt=o),null==r||Number.isNaN(r)||(t.dataset.avatarSize=`${r}`),t.dataset.avatarFallback=s,t.dataset.avatarUrl="url"===s?e:"",t.src=e}function b(t){if("off"===s)return;const e=t.querySelector(".username");if(!e)return;const n=(e.textContent||"").trim().replace(/:\s*$/,"");if(!n)return;const r=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--btfw-avatar-size").trim()||"24px",10)||24,a=t.querySelector(".btfw-chat-avatar");if(a){const t=c(n),e=a.getAttribute("src")||"",o=e.startsWith("data:image/svg+xml");return m(a,e||u(n,r),{key:t,label:n,size:r,type:o?"svg":"url"}),!o&&e&&l(n,e),void(a._btfwAvatarErrorBound||(a.addEventListener("error",f),a._btfwAvatarErrorBound=!0))}const i=c(n),b=function(t){if(!t)return"";const e=o.get(t);return e&&e.url||""}(i),p=d(n)||"";let h=p||b,w="url";p?b!==p?(l(n,p),function(t,e,n){const o=c(t);if(!o||!e)return;document.querySelectorAll("#messagebuffer .btfw-chat-avatar[data-avatar-key]").forEach(r=>{r.dataset.avatarKey===o&&m(r,e,{key:o,label:r.dataset.avatarLabel||t,size:n||parseInt(r.dataset.avatarSize||"",10)||24,type:"url"})})}(n,p,r)):l(n,p):b&&(h=b,l(n,b)),h||(h=u(n,r),w="svg");const g=document.createElement("img");g.className="btfw-chat-avatar",m(g,h,{key:i,label:n,size:r,type:w}),g.loading="lazy",g.decoding="async",g._btfwAvatarErrorBound||(g.addEventListener("error",f),g._btfwAvatarErrorBound=!0);const y=document.createElement("span");y.className="btfw-chat-avatarwrap",y.appendChild(g),e.parentNode.insertBefore(y,e),t.classList.add("btfw-has-avatar")}let p=null;function h(t){if(!t)return;const e=t.querySelector(".username"),n=t.querySelector(".btfw-chat-avatarwrap");if(!(Array.from(t.classList||[]).some(t=>"chat-msg"===t||t.startsWith("chat-msg-"))||!!n))return;if(!e)return void(p=null);const o=(e.textContent||"").trim().replace(/:\s*$/,"");if(!o||!n)return void(p=null);const r="off"!==s&&p&&p===o;t.classList.toggle("btfw-compact",r),n.style.display=r?"none":"",p=o}function w(){if("off"===s)return void g();p=null;const t=document.getElementById("messagebuffer");if(!t)return;Array.from(t.children||[]).forEach(t=>{b(t),h(t)})}function g(){p=null;const t=document.getElementById("messagebuffer");t&&(t.querySelectorAll(".btfw-chat-avatarwrap").forEach(t=>t.remove()),t.querySelectorAll(".btfw-has-avatar").forEach(t=>t.classList.remove("btfw-has-avatar","btfw-compact")))}function y(t){const e=document.getElementById("chatwrap");e&&(e.classList.remove("btfw-avatars-off","btfw-avatars-small","btfw-avatars-big"),e.classList.add(`btfw-avatars-${t}`));const n="big"===t?40:"off"===t?0:28;document.documentElement.style.setProperty("--btfw-avatar-size",`${n}px`),n>0&&document.querySelectorAll("#messagebuffer .btfw-chat-avatar").forEach(t=>{t.hasAttribute("loading")||(t.loading="lazy"),t.hasAttribute("decoding")||(t.decoding="async")})}function v(){y(s),w();const t=document.getElementById("messagebuffer");if(t&&!t._btfwAvMO){const e=new Set;let n;const o=()=>{n=null,e.forEach(t=>{t&&1===t.nodeType&&t.isConnected&&function(t){if(!t)return;(t.matches&&t.matches("#messagebuffer > div")?[t]:t.querySelectorAll?t.querySelectorAll("#messagebuffer > div"):[]).forEach(t=>{b(t),h(t)})}(t)}),e.clear()},r=new MutationObserver(t=>{let r=!1;for(const n of t)"childList"===n.type&&n.addedNodes&&n.addedNodes.forEach(t=>{t&&1===t.nodeType&&(e.add(t),r=!0)});r&&(clearTimeout(n),n=setTimeout(o,50))});r.observe(t,{childList:!0,subtree:!1}),t._btfwAvMO=r}}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",v):v(),{name:"feature:chat-avatars",reflow:w,setMode:function(e){const n="off"===e||"big"===e?e:"small";s=n,y(n),"off"===n?g():w(),function(e){try{localStorage.setItem(t,e)}catch(t){}}(n)},getMode:function(){return s},getCacheStats:()=>({svgCacheSize:n.size,svgCacheMaxSize:200,urlCacheSize:o.size,urlCacheLimit:200})}}),BTFW.define("feature:chat-timestamps",[],async()=>{const t="btfw:chat:ts:show",e="btfw:chat:ts:fmt";function n(){try{return"1"===(localStorage.getItem(t)??"1")}catch(t){return!0}}function o(){try{return localStorage.getItem(e)||"24"}catch(t){return"24"}}function r(t){document.body.classList.toggle("btfw-ts-hide",!t)}function a(t,e){if(!t)return;const n=(t.textContent||"").trim(),o=n.match(/^\[([^\]]+)\]$/);if(!o)return;const r=o[1].trim();let a=0,s=0,c=null,i=r.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);if(i)a=parseInt(i[1],10),s=parseInt(i[2],10),c=i[3].toUpperCase();else{let t=r.match(/^(\d{1,2}):(\d{2})$/);if(!t)return;a=parseInt(t[1],10),s=parseInt(t[2],10)}let l="";if("12"===e){let t=a%12;0===t&&(t=12);const e=c||(a>=12?"PM":"AM");l=`[${t}:${String(s).padStart(2,"0")} ${e}]`}else{let t=a;"AM"===c&&12===a&&(t=0),"PM"===c&&a<12&&(t=a+12),l=`[${String(t).padStart(2,"0")}:${String(s).padStart(2,"0")}]`}l!==n&&(t.textContent=l)}function s(t){((t,e=document)=>Array.from(e.querySelectorAll(t)))("#messagebuffer .timestamp").forEach(e=>a(e,t))}function c(t){if(!t)return;(t.matches?.(".timestamp")?[t]:t.querySelectorAll?.(".timestamp")||[]).forEach(t=>a(t,o()))}function i(){r(n()),s(o());const t=((t,e=document)=>e.querySelector(t))("#messagebuffer");if(t&&!t._btfwTsMO){const e=new MutationObserver(t=>{for(const e of t)"childList"===e.type&&e.addedNodes&&e.addedNodes.forEach(t=>{1===t.nodeType&&c(t)})});e.observe(t,{childList:!0,subtree:!0}),t._btfwTsMO=e}}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",i):i(),{name:"feature:chat-timestamps",getShow:n,setShow:function(e){try{localStorage.setItem(t,e?"1":"0")}catch(t){}r(e)},getFmt:o,setFmt:function(t){try{localStorage.setItem(e,t)}catch(t){}s(t)},reapply:()=>{r(n()),s(o())}}}),BTFW.define("feature:chat-ignore",[],async()=>{const t=(t,e=document)=>e.querySelector(t),e="btfw:chat:ignore",n=new WeakSet;let o=new Set;function r(){try{localStorage.setItem(e,JSON.stringify(Array.from(o)))}catch(t){}}function a(t){return o.has((t||"").toLowerCase())}function s(e){if(!e)return;const n=e.toLowerCase();o.has(n)||(o.add(n),r(),f(e,!0),function(e){const n=t("#messagebuffer");if(!n)return;const o=e.toLowerCase();for(const t of n.children){if(1!==t.nodeType)continue;d(t).toLowerCase()===o&&(t.style.display="none",t.setAttribute("data-btfw-ignored","true"))}}(e))}function c(e){if(!e)return;const n=e.toLowerCase();o.has(n)&&(o.delete(n),r(),f(e,!1),function(e){const n=t("#messagebuffer");if(!n)return;const o=e.toLowerCase();for(const t of n.children)if(1===t.nodeType&&t.getAttribute("data-btfw-ignored")){d(t).toLowerCase()===o&&(t.style.display="",t.removeAttribute("data-btfw-ignored"))}}(e))}function i(t){a(t)?c(t):s(t)}!function(){try{const t=localStorage.getItem(e),n=t?JSON.parse(t):[];return o=new Set(n.map(t=>String(t).toLowerCase())),o}catch(t){return o=new Set,o}}();const l=new WeakMap;function d(t){if(l.has(t))return l.get(t);const e=t.querySelector(".username");if(!e)return l.set(t,""),"";const n=(e.textContent||"").trim().replace(/:\s*$/,"");return l.set(t,n),n}function u(t){if(n.has(t))return;const e=d(t);e&&a(e)&&(t.style.display="none",t.setAttribute("data-btfw-ignored","true")),n.add(t)}function f(t,e){const n=document.querySelector(`#userlist li[data-name="${CSS.escape(t)}"]`);if(n){n.classList.toggle("btfw-muted",e);const t=n.querySelector(".btfw-mute-chip");t&&(t.textContent=e?"Unmute":"Mute")}}function m(t){if(t._btfwMuteChip)return;t._btfwMuteChip=!0;const e=t.getAttribute("data-name")||(t.textContent||"").trim();if(!e)return;const n=document.createElement("button");n.type="button",n.className="btfw-mute-chip",n.textContent=a(e)?"Unmute":"Mute",n.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),i(e),n.textContent=a(e)?"Unmute":"Mute"}),t.appendChild(n),t.classList.toggle("btfw-muted",a(e))}function b(){(function(){const e=window.socket;return!(!e||"function"!=typeof e.on||(e.on("chatMsg",e=>{setTimeout(()=>{const e=t("#messagebuffer");if(!e)return;const o=e.lastElementChild;o&&!n.has(o)&&u(o)},10)}),0))})()||function(){const e=t("#messagebuffer");if(!e||e._btfwIgnoreMO)return;const n=new MutationObserver(t=>{for(const e of t)if("childList"===e.type&&e.addedNodes)for(const t of e.addedNodes)1===t.nodeType&&u(t)});n.observe(e,{childList:!0,subtree:!1}),e._btfwIgnoreMO=n}(),function(){const e=t("#messagebuffer");if(e)for(const t of e.children)1===t.nodeType&&u(t)}(),function(){const e=t("#userlist");if(!e||e._btfwIgnoreWired)return;e._btfwIgnoreWired=!0,e.querySelectorAll("li").forEach(t=>{t._btfwMuteChip||m(t)}),new MutationObserver(t=>{for(const e of t)if("childList"===e.type&&e.addedNodes)for(const t of e.addedNodes)1===t.nodeType&&"LI"===t.tagName&&m(t)}).observe(e,{childList:!0,subtree:!1})}()}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",b):b(),{name:"feature:chat-ignore",has:a,add:s,remove:c,toggle:i,list:()=>Array.from(o)}}),BTFW.define("feature:chat-commands",[],async()=>{const t=(t,e=document)=>e.querySelector(t),e=(t,e=document)=>Array.from(e.querySelectorAll(t)),n=await BTFW.init("util:motion");function o(t){try{if(window.socket?.emit)return socket.emit("chatMsg",{msg:t}),!0}catch(t){}return!1}function r(e){const n=t("#messagebuffer");if(!n)return;const o=document.createElement("div");o.className="server-msg btfw-cmd",o.textContent=e,n.appendChild(o),n.scrollTop=n.scrollHeight}function a(){try{return window.CLIENT&&CLIENT.name?CLIENT.name:""}catch(t){return""}}function s(t){return function(){try{return window.CLIENT&&0|CLIENT.rank||0}catch(t){return 0}}()>=t}function c(){const t=document.getElementById("currenttitle")||document.querySelector(".currenttitle");let e=(t?.textContent||"").trim();return e=e.replace(/^\s*(?:currently|now)\s*playing\s*[:\-]\s*/i,"").trim(),e}const i="https://trivia-worker.billtube.workers.dev";let l=!1,d="",u=new Set,f=null;function m(t){const e=document.createElement("textarea");return e.innerHTML=t,e.value}async function b(){try{const t=await fetch(`${i}/leaderboard`),e=await t.json();let n="ðŸŽ‰ Leaderboard:\n";e.forEach(({username:t,score:e})=>{n+=`${function(t){const e={a:"a",b:"b",c:"c",d:"d",e:"e",f:"f",g:"g",h:"h",i:"i",j:"j",k:"k",l:"l",m:"m",n:"n",o:"o",p:"p",q:"q",r:"r",s:"s",t:"t",u:"u",v:"v",w:"w",x:"x",y:"y",z:"z",A:"A",B:"B",C:"C",D:"D",E:"E",F:"F",G:"G",H:"H",I:"I",J:"J",K:"K",L:"L",M:"M",N:"N",O:"O",P:"P",Q:"Q",R:"R",S:"S",T:"T",U:"U",V:"V",W:"W",X:"X",Y:"Y",Z:"Z"};return String(t||"").split("").map(t=>e[t]||t).join("")}(t)}: ${e} points\n`}),o(n)}catch(t){console.error("[trivia] leaderboard failed:",t)}}async function p(){if(!s(2))return"col:#a52a2a:You do not have permission to start a trivia question.";if(l)return"col:#a52a2a:A trivia question is already active!";const t=await async function(){try{const t=await fetch("https://opentdb.com/api.php?amount=1&type=multiple"),e=await t.json();if(e.results&&e.results.length>0){const t=e.results[0];d=m(t.correct_answer.toLowerCase());const n=[...t.incorrect_answers,t.correct_answer].map(m).sort(()=>Math.random()-.5),o=["#ffa500","#ff4500","#1e90ff","#32cd32"],r=n.map((t,e)=>`col:${o[e%o.length]}:${t}`);return`ðŸŽ¬ [code]Trivia: ${m(t.question)}[/code] \nOptions: ${r.join(", ")}`}return"[i]No trivia question available at the moment.[/i]"}catch(t){return console.error("[trivia] OpenTDB error:",t),"Error fetching trivia question. Please try again later."}}();return l=!0,u.clear(),o("!trivia"),o(t),clearTimeout(f),f=setTimeout(()=>{l&&(l=!1,o(`col:#a52a2a:â° Time's up! The correct answer was: ${d}`))},3e4),""}function h(t){const e=t?.username||"",n=(t?.msg||"").trim();l&&e&&n&&(u.has(e)||n.toLowerCase()===d&&(u.add(e),l=!1,clearTimeout(f),async function(t){try{await fetch(`${i}/updateScore`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t})})}catch(t){console.error("[trivia] updateScore failed:",t)}}(e).then(()=>b()).catch(()=>{}),o(`col:#008000:ðŸŽ‰ ${e} got the right answer! Their score has been updated.`)))}function w(){try{const t=window.BTFW_CONFIG&&"object"==typeof window.BTFW_CONFIG?window.BTFW_CONFIG:{},e=t.tmdb&&"object"==typeof t.tmdb?t.tmdb:{},n="string"==typeof e.apiKey?e.apiKey.trim():"",o="string"==typeof t.tmdbKey?t.tmdbKey.trim():"";let r="";try{r=(localStorage.getItem("btfw:tmdb:key")||"").trim()}catch(t){}const a=t=>(null==t?"":String(t)).trim(),s=a(window.TMDB_API_KEY)||a(window.BTFW_TMDB_KEY)||a(window.tmdb_key),c=(document.body?.dataset?.tmdbKey||"").trim();return n||o||r||s||c||null}catch(t){return null}}function g(t){if(!t)return"";let e=" "+t+" ";e=e.replace(/\[[^\]]*\]/g," "),e=e.replace(/\(([^)]*)\)/g,(t,e)=>/^\s*\d{4}\s*$/.test(e)?t:" "),e=e.replace(/\b(?:official\s*trailer|trailer|teaser|lyrics|mv|amv|full\s*episode|episode\s*\d+|season\s*\d+)\b/gi," "),e=e.replace(/\b(?:\d{3,4}p|[48]k|hdr|dolby(?:\s+vision)?|remaster|extended|uncut|subbed|dubbed)\b/gi," "),e=e.replace(/\s{2,}/g," ").trim();const n=e.split(/\s[-â€“|:]\s/);return n.length>1&&n[0].length>=3&&(e=n[0].trim()),e=function(t){const e=String(t||"").trim();if(!e)return"";if(/\(\s*(?:19|20)\d{2}\s*\)\s*$/.test(e))return e;const n=/(?:^|[\s,;:|/-])((?:19|20)\d{2})\s*$/.exec(e);if(!n)return e;const o=n[1],r=e.slice(0,n.index).replace(/[\s,;:|/-]+$/,"").trim();return r?`${r} (${o})`:e}(e),e||t}const y=new Map;function v(t,e,{desc:n="",usage:o="",cooldownMs:r=800,aliases:a=[]}={}){y.set(t,{name:t,handler:e,desc:n,usage:o,cooldownMs:r,last:0,aliases:a}),a.forEach(e=>y.set(e,y.get(t)))}function E(){return Array.from(new Set(Array.from(y.values()).map(t=>t.name))).sort()}function S(t){try{const e=t.currentTarget;if(!e)return;if("Enter"===t.key&&!t.shiftKey){const n=function(t){if(!t||t.length<2)return null;if(t.startsWith("/me "))return{name:"/me",args:[t.slice(4)]};if("!"!==t[0])return null;const e=t.slice(1).trim().split(/\s+/);return{name:(e.shift()||"").toLowerCase(),args:e,raw:t}}(e.value.trim());if(!n)return;const s=y.get(n.name);if(!s)return;const c=Date.now();if(c-s.last<(s.cooldownMs||800))return t.preventDefault(),void r("Command is on cooldownâ€¦");s.last=c,t.preventDefault();const i={args:n.args,raw:n.raw,user:a()},l=s.handler(i);l instanceof Promise?l.then(t=>{"string"==typeof t&&t&&o(t)}).catch(t=>r(String(t))):"string"==typeof l&&l&&o(l),e.value=""}}catch(t){}}function C(){return`\n      <div class="content">\n        <p>Type these in chat. Some require moderator permissions.</p>\n        <div class="table-container">\n          <table class="table is-fullwidth is-striped is-narrow">\n            <thead><tr><th>Command</th><th>Description</th><th>Usage</th></tr></thead>\n            <tbody>${E().map(t=>{const e=y.get(t);return`<tr><td><code>!${t}</code></td><td>${e?.desc||""}</td><td><code>${e?.usage||"!"+t}</code></td></tr>`}).join("")}</tbody>\n          </table>\n        </div>\n      </div>`}function k(){const e=function(){let e=t("#btfw-cmds-modal");if(e)return e;e=document.createElement("div"),e.id="btfw-cmds-modal",e.className="modal",e.dataset.btfwModalState="closed",e.setAttribute("hidden",""),e.setAttribute("aria-hidden","true"),e.innerHTML=`\n      <div class="modal-background"></div>\n      <div class="modal-card btfw-modal">\n        <header class="modal-card-head">\n          <p class="modal-card-title">Chat Commands</p>\n          <button class="delete" aria-label="close"></button>\n        </header>\n        <section class="modal-card-body">${C()}</section>\n        <footer class="modal-card-foot">\n          <button class="button is-link" id="btfw-cmds-close">Close</button>\n        </footer>\n      </div>`,document.body.appendChild(e);const o=()=>n.closeModal(e);return t(".modal-background",e).addEventListener("click",o),t(".delete",e).addEventListener("click",o),t("#btfw-cmds-close",e).addEventListener("click",o),e}(),o=e.querySelector(".modal-card-body");o&&(o.innerHTML=C()),n.openModal(e)}function T(t){if(!t||t._btfwCmdBtn)return!1;const e=document.createElement("button");return e.id="btfw-chatcmds-btn",e.className="button is-dark is-small btfw-chatbtn",e.innerHTML='<i class="fa fa-question-circle" aria-hidden="true"></i>',e.title="Commands",e.addEventListener("click",t=>{t.preventDefault(),k()}),t.appendChild(e),t._btfwCmdBtn=!0,!0}function _(){let e=!1;const n=t("#btfw-chat-bottombar");if(n&&(e=T(n)),!e){const n=t("#btfw-chat-topbar");n&&(e=T(n))}if(!e){const e=t("#chatwrap");if(e&&!t("#btfw-chatcmds-float")){const t=document.createElement("div");t.id="btfw-chatcmds-float",t.style.position="absolute",t.style.right="8px",t.style.bottom="42px",t.style.zIndex="1100",e.appendChild(t),T(t)}}}function L(){const e=t("#chatline");e&&!e._btfwCmds&&(e._btfwCmds=!0,e.addEventListener("keydown",S,!0)),function(){try{window.socket&&socket.on&&socket.on("chatMsg",h)}catch(t){}}(),_(),function(){const e=document.body;new MutationObserver(()=>{(t("#btfw-chat-bottombar")||t("#btfw-chat-topbar"))&&_()}).observe(e,{childList:!0,subtree:!0})}()}return v("help",()=>`Commands: ${E().map(t=>"!"+t).join(", ")}  â€”  Click the â€œ?â€ button below chat for details.`,{desc:"List commands",usage:"!help"}),v("leaderboard",async()=>(await b(),""),{desc:"Show trivia leaderboard",usage:"!leaderboard"}),v("trivia",async()=>await p()||"",{desc:"Start one trivia question (rank â‰¥2)",usage:"!trivia"}),v("summary",async t=>{const e=t.args.length?t.args.join(" "):c();if(!e)return"No current title, try: !summary <title>";const n=g(e),r=await async function(t){const e=w();if(!e)return'TMDB key missing. Open Theme Settings â†’ General â†’ Integrations to add your TMDB API key, or set one of:\nwindow.BTFW_CONFIG.tmdb = { apiKey: "KEY" };\nlocalStorage.setItem("btfw:tmdb:key","KEY");\nwindow.tmdb_key = "KEY";';try{let n;if(/^tt\d+$/.test(t.trim())){const o=`https://api.themoviedb.org/3/find/${encodeURIComponent(t.trim())}?api_key=${e}&external_source=imdb_id`,r=await fetch(o);if(!r.ok)throw new Error(`HTTP ${r.status}`);const a=await r.json();n=(a.movie_results||[])[0]||(a.tv_results||[])[0]}else{const o=t.match(/\b(19|20)\d{2}\b/),r=o?o[0]:"";let a=t;r&&(a=t.replace(/\s*\(?\s*(19|20)\d{2}\s*\)?\s*/g," ").trim());const s=encodeURIComponent(a);if(r){const t=`https://api.themoviedb.org/3/search/movie?api_key=${e}&query=${s}&primary_release_year=${r}&include_adult=false&language=en-US`,o=await fetch(t);if(o.ok){const t=await o.json();t.results&&t.results.length>0&&(n=t.results[0],n.media_type="movie")}}if(!n&&r){const t=`https://api.themoviedb.org/3/search/tv?api_key=${e}&query=${s}&first_air_date_year=${r}&include_adult=false&language=en-US`,o=await fetch(t);if(o.ok){const t=await o.json();t.results&&t.results.length>0&&(n=t.results[0],n.media_type="tv")}}if(!n){const t=`https://api.themoviedb.org/3/search/multi?api_key=${e}&query=${s}&include_adult=false&language=en-US`,o=await fetch(t);if(!o.ok)throw new Error(`HTTP ${o.status}`);n=((await o.json()).results||[])[0]}}if(!n)return"No TMDB result.";const o=n.media_type||(n.title?"movie":"tv"),r=n.title||n.name||t,a=(n.release_date||n.first_air_date||"").slice(0,4),s="number"==typeof n.vote_average?n.vote_average.toFixed(1):"n/a";let c=n.overview||"";if(!c&&n.id){const t=`https://api.themoviedb.org/3/${o}/${n.id}?api_key=${e}&language=en-US`,r=await fetch(t);r.ok&&(c=(await r.json()).overview||"")}return c||(c="No summary available."),c.length>150&&(c=c.substring(0,147)+"..."),c=c.replace(/\|/g,"&#124;"),`[tmdbcard]${r}|${a}|${s}|${c}|${n.poster_path||""}[/tmdbcard]`}catch(t){return console.error("[summary] TMDB error",t),`TMDB error: ${t.message||t}`}}(n);return o(r),""},{desc:"TMDB summary for current or given title",usage:"!summary [title]"}),v("cast",async t=>{const e=t.args.length?t.args.join(" "):c();if(!e)return"No current title, try: !cast <title>";const n=g(e),r=await async function(t){const e=w();if(!e)return"TMDB key missing. Configure your API key first.";try{const n=/^tt\d+$/.test(t.trim());let o,r="movie";if(n){const n=`https://api.themoviedb.org/3/find/${encodeURIComponent(t.trim())}?api_key=${e}&external_source=imdb_id`,a=await fetch(n);if(!a.ok)throw new Error(`HTTP ${a.status}`);const s=await a.json(),c=(s.movie_results||[])[0]||(s.tv_results||[])[0];if(!c)return"No TMDB result.";o=c.id,r=c.media_type||(s.movie_results?.[0]?"movie":"tv")}else{const n=t.match(/\b(19|20)\d{2}\b/),a=n?n[0]:"";let s=t;a&&(s=t.replace(/\s*\(?\s*(19|20)\d{2}\s*\)?\s*/g," ").trim());const c=encodeURIComponent(s);let i;if(a){const t=`https://api.themoviedb.org/3/search/movie?api_key=${e}&query=${c}&primary_release_year=${a}&include_adult=false&language=en-US`,n=await fetch(t);if(n.ok){const t=await n.json();t.results&&t.results.length>0&&(i=t.results[0],r="movie")}}if(!i&&a){const t=`https://api.themoviedb.org/3/search/tv?api_key=${e}&query=${c}&first_air_date_year=${a}&include_adult=false&language=en-US`,n=await fetch(t);if(n.ok){const t=await n.json();t.results&&t.results.length>0&&(i=t.results[0],r="tv")}}if(!i){const t=`https://api.themoviedb.org/3/search/multi?api_key=${e}&query=${c}&include_adult=false&language=en-US`,n=await fetch(t);if(!n.ok)throw new Error(`HTTP ${n.status}`);i=((await n.json()).results||[])[0],i&&(r=i.media_type||(i.title?"movie":"tv"))}if(!i)return"No TMDB result.";o=i.id}const a=`https://api.themoviedb.org/3/${r}/${o}/credits?api_key=${e}`,s=await fetch(a);if(!s.ok)throw new Error(`HTTP ${s.status}`);const c=(await s.json()).cast||[];if(!c.length)return"No cast information available.";return`col:#87ceeb:Cast: ${c.slice(0,8).map(t=>{const e=t.character?` (${t.character})`:"";return`${t.name}${e}`}).join(", ")}`}catch(t){return console.error("[cast] TMDB error",t),`TMDB error: ${t.message||t}`}}(n);return o(r),""},{desc:"Show cast for current or given title",usage:"!cast [title]"}),v("pick",t=>{const e=t.args.join(" ").split(/[,|]/).map(t=>t.trim()).filter(Boolean);return e.length<2?"Usage: !pick a, b, c":(o(`ðŸŽ¯ I choose: ${e[Math.floor(Math.random()*e.length)]}`),"")},{desc:"Pick randomly",usage:"!pick a, b, c"}),v("ask",()=>{const t=["Yes.","No.","Maybe.","Probably.","Probably not.","Absolutely.","Definitely not.","Ask again later."];return o(t[Math.floor(Math.random()*t.length)]),""},{desc:"Magic-8",usage:"!ask <q>"}),v("time",()=>{const t=new Date;return o(`[${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}]`),""},{desc:"Current time",usage:"!time"}),v("dice",()=>(o(`ðŸŽ² ${1+Math.floor(5*Math.random())}`),""),{desc:"Roll 1â€“5",usage:"!dice"}),v("roll",()=>(o(String(Math.floor(1e3*Math.random())).padStart(3,"0")),""),{desc:"Random 000â€“999",usage:"!roll"}),v("skip",()=>s(2)?(function(){try{socket.emit("voteskip")}catch(t){}}(),""):"You lack permission to voteskip.",{desc:"Vote skip",usage:"!skip"}),v("next",()=>s(2)?(function(){try{socket.emit("playNext")}catch(t){}}(),""):"You lack permission to play next.",{desc:"Play next",usage:"!next"}),v("bump",()=>{if(!s(2))return"You lack permission to move items.";return function(){try{const n=e("#queue .queue_entry");if(n.length<2)return"Not enough items to bump.";const o=t("#queue .queue_active");if(!o)return"No active item found.";const r=n[n.length-1],a=r.getAttribute("data-uid")||r.dataset?.uid,s=o.getAttribute("data-uid")||o.dataset?.uid;return a&&s?(socket.emit("moveMedia",{from:a,after:s}),null):"Missing media UID."}catch(t){return"Bump failed."}}()||""},{desc:"Move last after current",usage:"!bump"}),v("add",t=>{if(!s(2))return"You lack permission to add.";const e=t.args.join(" ").trim();if(!e)return"Usage: !add <url>";const n=function(t){try{if("function"==typeof window.parseMediaLink){const e=parseMediaLink(t);return e?(socket.emit("queue",{id:e.id,type:e.type,pos:"end",ttl:e.title||t}),null):"Couldnâ€™t parse media link."}return socket.emit("queue",{id:t,type:"url",pos:"end",ttl:t}),null}catch(t){return"Queue add failed."}}(e);return n||""},{desc:"Queue URL",usage:"!add <url>"}),v("now",()=>{const t=c();return t?(o(`now: ${t}`),""):"No current media."},{desc:"Show current title",usage:"!now"}),v("sm",()=>{const t=function(){try{if(window.CHANNEL?.emotes){const t=CHANNEL.emotes;if(Array.isArray(t))return t.map(t=>t.name||t);if("object"==typeof t)return Object.keys(t)}}catch(t){}const t=e("#emotelist img, #emotelist .emote");return t.length?t.map(t=>t.getAttribute("title")||t.getAttribute("alt")||t.dataset?.name).filter(Boolean):[]}();return t.length?(o(t[Math.floor(Math.random()*t.length)]),""):"No channel emotes found."},{desc:"Random channel emote",usage:"!sm"}),v("/me",t=>{const e=(t.args[0]||"").trim();return e&&o(`/me ${e}`),""}),document.addEventListener("btfw:layoutReady",()=>setTimeout(L,0)),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",L):L(),{name:"feature:chat-commands"}});